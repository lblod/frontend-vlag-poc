{"version":3,"file":"index.js","sources":["../src/-private/cache.ts"],"sourcesContent":["/**\n * @module @ember-data/json-api\n */\nimport { assert } from '@ember/debug';\nimport { schedule } from '@ember/runloop';\n\nimport { LOG_MUTATIONS, LOG_OPERATIONS } from '@ember-data/debugging';\nimport { DEBUG } from '@ember-data/env';\nimport { graphFor, peekGraph } from '@ember-data/graph/-private';\nimport type { LocalRelationshipOperation } from '@ember-data/graph/-private/graph/-operations';\nimport type { ImplicitRelationship } from '@ember-data/graph/-private/graph/index';\nimport type BelongsToRelationship from '@ember-data/graph/-private/relationships/state/belongs-to';\nimport type ManyRelationship from '@ember-data/graph/-private/relationships/state/has-many';\nimport { StructuredErrorDocument } from '@ember-data/request/-private/types';\nimport { StoreRequestInfo } from '@ember-data/store/-private/cache-handler';\nimport type { IdentifierCache } from '@ember-data/store/-private/caches/identifier-cache';\nimport type { ResourceBlob } from '@ember-data/types/cache/aliases';\nimport type { Change } from '@ember-data/types/cache/change';\nimport type {\n  CollectionResourceDataDocument,\n  ResourceDocument,\n  ResourceErrorDocument,\n  ResourceMetaDocument,\n  SingleResourceDataDocument,\n  StructuredDataDocument,\n  StructuredDocument,\n} from '@ember-data/types/cache/document';\nimport type { StableDocumentIdentifier } from '@ember-data/types/cache/identifier';\nimport type { Cache, ChangedAttributesHash, MergeOperation } from '@ember-data/types/q/cache';\nimport type { CacheStoreWrapper } from '@ember-data/types/q/cache-store-wrapper';\nimport type {\n  CollectionResourceDocument,\n  CollectionResourceRelationship,\n  ExistingResourceObject,\n  SingleResourceDocument,\n  SingleResourceRelationship,\n} from '@ember-data/types/q/ember-data-json-api';\nimport type { StableExistingRecordIdentifier, StableRecordIdentifier } from '@ember-data/types/q/identifier';\nimport type { AttributesHash, JsonApiError, JsonApiResource } from '@ember-data/types/q/record-data-json-api';\nimport type { AttributeSchema, RelationshipSchema } from '@ember-data/types/q/record-data-schemas';\n\nfunction isImplicit(\n  relationship: ManyRelationship | ImplicitRelationship | BelongsToRelationship\n): relationship is ImplicitRelationship {\n  return relationship.definition.isImplicit;\n}\n\nconst EMPTY_ITERATOR = {\n  iterator() {\n    return {\n      next() {\n        return { done: true, value: undefined };\n      },\n    };\n  },\n};\n\ninterface CachedResource {\n  id: string | null;\n  remoteAttrs: Record<string, unknown> | null;\n  localAttrs: Record<string, unknown> | null;\n  inflightAttrs: Record<string, unknown> | null;\n  changes: Record<string, unknown[]> | null;\n  errors: JsonApiError[] | null;\n  isNew: boolean;\n  isDeleted: boolean;\n  isDeletionCommitted: boolean;\n}\n\nfunction makeCache(): CachedResource {\n  return {\n    id: null,\n    remoteAttrs: null,\n    localAttrs: null,\n    inflightAttrs: null,\n    changes: null,\n    errors: null,\n    isNew: false,\n    isDeleted: false,\n    isDeletionCommitted: false,\n  };\n}\n\n/**\n  A JSON:API Cache implementation.\n\n  What cache the store uses is configurable. Using a different\n  implementation can be achieved by implementing the store's\n  createCache hook.\n\n  This is the cache implementation used by `ember-data`.\n\n  ```js\n  import Cache from '@ember-data/json-api';\n  import Store from '@ember-data/store';\n\n  export default class extends Store {\n    createCache(wrapper) {\n      return new Cache(wrapper);\n    }\n  }\n  ```\n\n  @class Cache\n  @public\n */\n\nexport default class JSONAPICache implements Cache {\n  /**\n   * The Cache Version that this implementation implements.\n   *\n   * @type {'2'}\n   * @public\n   * @property version\n   */\n  declare version: '2';\n  declare __storeWrapper: CacheStoreWrapper;\n  declare __cache: Map<StableRecordIdentifier, CachedResource>;\n  declare __destroyedCache: Map<StableRecordIdentifier, CachedResource>;\n  declare __documents: Map<string, StructuredDocument<ResourceDocument>>;\n\n  constructor(storeWrapper: CacheStoreWrapper) {\n    this.version = '2';\n    this.__storeWrapper = storeWrapper;\n    this.__cache = new Map();\n    this.__destroyedCache = new Map();\n    this.__documents = new Map();\n  }\n\n  // Cache Management\n  // ================\n\n  /**\n   * Cache the response to a request\n   *\n   * Implements `Cache.put`.\n   *\n   * Expects a StructuredDocument whose `content` member is a JsonApiDocument.\n   *\n   * ```js\n   * cache.put({\n   *   request: { url: 'https://api.example.com/v1/user/1' },\n   *   content: {\n   *     data: {\n   *       type: 'user',\n   *       id: '1',\n   *       attributes: {\n   *         name: 'Chris'\n   *       }\n   *     }\n   *   }\n   * })\n   * ```\n   *\n   * > **Note:** The nested `content` and `data` members are not a mistake. This is because\n   * > there are two separate concepts involved here, the `StructuredDocument` which contains\n   * > the context of a given Request that has been issued with the returned contents as its\n   * > `content` property, and a `JSON:API Document` which is the json contents returned by\n   * > this endpoint and which uses its `data` property to signify which resources are the\n   * > primary resources associated with the request.\n   *\n   * StructuredDocument's with urls will be cached as full documents with\n   * associated resource membership order and contents preserved but linked\n   * into the cache.\n   *\n   * @method put\n   * @param {StructuredDocument} doc\n   * @returns {ResourceDocument}\n   * @public\n   */\n  put<T extends SingleResourceDocument>(doc: StructuredDocument<T>): SingleResourceDataDocument;\n  put<T extends CollectionResourceDocument>(doc: StructuredDocument<T>): CollectionResourceDataDocument;\n  put<T extends ResourceErrorDocument>(doc: StructuredErrorDocument<T>): ResourceErrorDocument;\n  put<T extends ResourceMetaDocument>(doc: StructuredDataDocument<T>): ResourceMetaDocument;\n  put(doc: StructuredDocument<ResourceDocument>): ResourceDocument {\n    assert(\n      `Expected a JSON:API Document as the content provided to the cache, received ${doc.content}`,\n      doc instanceof Error || (typeof doc.content === 'object' && doc.content !== null)\n    );\n    if (isErrorDocument(doc)) {\n      return this._putDocument(doc as StructuredErrorDocument<ResourceErrorDocument>);\n    } else if (isMetaDocument(doc)) {\n      return this._putDocument(doc);\n    }\n\n    const jsonApiDoc = doc.content as SingleResourceDocument | CollectionResourceDocument;\n    let included = jsonApiDoc.included;\n    let i: number, length: number;\n    const { identifierCache } = this.__storeWrapper;\n\n    if (included) {\n      for (i = 0, length = included.length; i < length; i++) {\n        putOne(this, identifierCache, included[i]);\n      }\n    }\n\n    if (Array.isArray(jsonApiDoc.data)) {\n      length = jsonApiDoc.data.length;\n      let identifiers: StableExistingRecordIdentifier[] = [];\n\n      for (i = 0; i < length; i++) {\n        identifiers.push(putOne(this, identifierCache, jsonApiDoc.data[i]));\n      }\n      return this._putDocument(doc as StructuredDataDocument<CollectionResourceDocument>, identifiers);\n    }\n\n    if (jsonApiDoc.data === null) {\n      return this._putDocument(doc as StructuredDataDocument<SingleResourceDocument>, null);\n    }\n\n    assert(\n      `Expected a resource object in the 'data' property in the document provided to the cache, but was ${typeof jsonApiDoc.data}`,\n      typeof jsonApiDoc.data === 'object'\n    );\n\n    let identifier = putOne(this, identifierCache, jsonApiDoc.data);\n    return this._putDocument(doc as StructuredDataDocument<SingleResourceDocument>, identifier);\n  }\n\n  _putDocument<T extends ResourceErrorDocument>(doc: StructuredErrorDocument<T>): ResourceErrorDocument;\n  _putDocument<T extends ResourceMetaDocument>(doc: StructuredDataDocument<T>): ResourceMetaDocument;\n  _putDocument<T extends SingleResourceDocument>(\n    doc: StructuredDataDocument<T>,\n    data: StableExistingRecordIdentifier | null\n  ): SingleResourceDataDocument;\n  _putDocument<T extends CollectionResourceDocument>(\n    doc: StructuredDataDocument<T>,\n    data: StableExistingRecordIdentifier[]\n  ): CollectionResourceDataDocument;\n  _putDocument<T extends ResourceDocument>(\n    doc: StructuredDocument<T>,\n    data?: StableExistingRecordIdentifier[] | StableExistingRecordIdentifier | null\n  ): SingleResourceDataDocument | CollectionResourceDataDocument | ResourceErrorDocument | ResourceMetaDocument {\n    // @ts-expect-error narrowing within is just horrible  in TS :/\n    const resourceDocument: SingleResourceDataDocument | CollectionResourceDataDocument | ResourceErrorDocument =\n      isErrorDocument(doc) ? fromStructuredError(doc) : fromBaseDocument(doc);\n\n    if (data !== undefined) {\n      (resourceDocument as SingleResourceDataDocument | CollectionResourceDataDocument).data = data;\n    }\n\n    const request = doc.request as StoreRequestInfo | undefined;\n    const identifier = request ? this.__storeWrapper.identifierCache.getOrCreateDocumentIdentifier(request) : null;\n\n    if (identifier) {\n      resourceDocument.lid = identifier.lid;\n\n      // @ts-expect-error\n      doc.content = resourceDocument;\n      const hasExisting = this.__documents.has(identifier.lid);\n      this.__documents.set(identifier.lid, doc as StructuredDocument<ResourceDocument>);\n\n      this.__storeWrapper.notifyChange(identifier, hasExisting ? 'updated' : 'added');\n    }\n\n    return resourceDocument;\n  }\n\n  /**\n   * Update the \"remote\" or \"canonical\" (persisted) state of the Cache\n   * by merging new information into the existing state.\n   *\n   * Note: currently the only valid resource operation is a MergeOperation\n   * which occurs when a collision of identifiers is detected.\n   *\n   * @method patch\n   * @public\n   * @param {Operation} op the operation to perform\n   * @returns {void}\n   */\n  patch(op: MergeOperation): void {\n    if (LOG_OPERATIONS) {\n      try {\n        let _data = JSON.parse(JSON.stringify(op));\n        // eslint-disable-next-line no-console\n        console.log(`EmberData | Operation - patch ${op.op}`, _data);\n      } catch (e) {\n        // eslint-disable-next-line no-console\n        console.log(`EmberData | Operation - patch ${op.op}`, op);\n      }\n    }\n    if (op.op === 'mergeIdentifiers') {\n      const cache = this.__cache.get(op.record);\n      if (cache) {\n        this.__cache.set(op.value, cache);\n        this.__cache.delete(op.record);\n      }\n      graphFor(this.__storeWrapper).update(op, true);\n    }\n  }\n\n  /**\n   * Update the \"local\" or \"current\" (unpersisted) state of the Cache\n   *\n   * @method mutate\n   * @param {Mutation} mutation\n   * @returns {void}\n   * @public\n   */\n  mutate(mutation: LocalRelationshipOperation): void {\n    if (LOG_MUTATIONS) {\n      try {\n        let _data = JSON.parse(JSON.stringify(mutation));\n        // eslint-disable-next-line no-console\n        console.log(`EmberData | Mutation - update ${mutation.op}`, _data);\n      } catch (e) {\n        // eslint-disable-next-line no-console\n        console.log(`EmberData | Mutation - update ${mutation.op}`, mutation);\n      }\n    }\n    graphFor(this.__storeWrapper).update(mutation, false);\n  }\n\n  /**\n   * Peek resource data from the Cache.\n   *\n   * In development, if the return value\n   * is JSON the return value\n   * will be deep-cloned and deep-frozen\n   * to prevent mutation thereby enforcing cache\n   * Immutability.\n   *\n   * This form of peek is useful for implementations\n   * that want to feed raw-data from cache to the UI\n   * or which want to interact with a blob of data\n   * directly from the presentation cache.\n   *\n   * An implementation might want to do this because\n   * de-referencing records which read from their own\n   * blob is generally safer because the record does\n   * not require retainining connections to the Store\n   * and Cache to present data on a per-field basis.\n   *\n   * This generally takes the place of `getAttr` as\n   * an API and may even take the place of `getRelationship`\n   * depending on implementation specifics, though this\n   * latter usage is less recommended due to the advantages\n   * of the Graph handling necessary entanglements and\n   * notifications for relational data.\n   *\n   * @method peek\n   * @public\n   * @param {StableRecordIdentifier | StableDocumentIdentifier} identifier\n   * @returns {ResourceDocument | ResourceBlob | null} the known resource data\n   */\n  peek(identifier: StableRecordIdentifier): ResourceBlob | null;\n  peek(identifier: StableDocumentIdentifier): ResourceDocument | null;\n  peek(identifier: StableDocumentIdentifier | StableRecordIdentifier): ResourceBlob | ResourceDocument | null {\n    if ('type' in identifier) {\n      const peeked = this.__safePeek(identifier, false);\n\n      if (!peeked) {\n        return null;\n      }\n\n      const { type, id, lid } = identifier;\n      const attributes = Object.assign({}, peeked.remoteAttrs, peeked.inflightAttrs, peeked.localAttrs);\n      const relationships = {};\n\n      const graph = graphFor(this.__storeWrapper);\n      const rels = graph.identifiers.get(identifier);\n      if (rels) {\n        Object.keys(rels).forEach((key) => {\n          const rel = rels[key]!;\n          if (rel.definition.isImplicit) {\n            return;\n          }\n          relationships[key] = (rel as ManyRelationship | BelongsToRelationship).getData();\n        });\n      }\n      return {\n        type,\n        id,\n        lid,\n        attributes,\n        relationships,\n      };\n    }\n\n    const document = this.peekRequest(identifier);\n\n    if (document) {\n      if ('content' in document) return document.content;\n    }\n    return null;\n  }\n\n  /**\n   * Peek the Cache for the existing request data associated with\n   * a cacheable request\n   *\n   * @method peekRequest\n   * @param {StableDocumentIdentifier}\n   * @returns {StableDocumentIdentifier | null}\n   * @public\n   */\n  peekRequest(identifier: StableDocumentIdentifier): StructuredDocument<ResourceDocument> | null {\n    return this.__documents.get(identifier.lid) || null;\n  }\n\n  /**\n   * Push resource data from a remote source into the cache for this identifier\n   *\n   * @method upsert\n   * @public\n   * @param identifier\n   * @param data\n   * @param hasRecord\n   * @returns {void | string[]} if `hasRecord` is true then calculated key changes should be returned\n   */\n  upsert(\n    identifier: StableRecordIdentifier,\n    data: JsonApiResource,\n    calculateChanges?: boolean | undefined\n  ): void | string[] {\n    let changedKeys: string[] | undefined;\n    const peeked = this.__safePeek(identifier, false);\n    const existed = !!peeked;\n    const cached = peeked || this._createCache(identifier);\n\n    const isLoading = _isLoading(peeked, this.__storeWrapper, identifier) || !recordIsLoaded(peeked);\n    let isUpdate = !_isEmpty(peeked) && !isLoading;\n\n    if (LOG_OPERATIONS) {\n      try {\n        let _data = JSON.parse(JSON.stringify(data));\n        // eslint-disable-next-line no-console\n        console.log(`EmberData | Operation - upsert (${existed ? 'merge' : 'insert'})`, _data);\n      } catch (e) {\n        // eslint-disable-next-line no-console\n        console.log(`EmberData | Operation - upsert (${existed ? 'merge' : 'insert'})`, data);\n      }\n    }\n\n    if (cached.isNew) {\n      cached.isNew = false;\n      this.__storeWrapper.notifyChange(identifier, 'identity');\n      this.__storeWrapper.notifyChange(identifier, 'state');\n    }\n\n    if (calculateChanges) {\n      changedKeys = existed ? calculateChangedKeys(cached, data.attributes) : Object.keys(data.attributes || {});\n    }\n\n    cached.remoteAttrs = Object.assign(cached.remoteAttrs || Object.create(null), data.attributes);\n    if (cached.localAttrs) {\n      if (patchLocalAttributes(cached)) {\n        this.__storeWrapper.notifyChange(identifier, 'state');\n      }\n    }\n\n    if (!isUpdate) {\n      this.__storeWrapper.notifyChange(identifier, 'added');\n    }\n\n    if (data.id) {\n      cached.id = data.id;\n    }\n\n    if (data.relationships) {\n      setupRelationships(this.__storeWrapper, identifier, data);\n    }\n\n    if (changedKeys && changedKeys.length) {\n      notifyAttributes(this.__storeWrapper, identifier, changedKeys);\n    }\n\n    return changedKeys;\n  }\n\n  // Cache Forking Support\n  // =====================\n\n  /**\n   * Create a fork of the cache from the current state.\n   *\n   * Applications should typically not call this method themselves,\n   * preferring instead to fork at the Store level, which will\n   * utilize this method to fork the cache.\n   *\n   * @method fork\n   * @internal\n   * @returns Promise<Cache>\n   */\n  fork(): Promise<Cache> {\n    throw new Error(`Not Implemented`);\n  }\n\n  /**\n   * Merge a fork back into a parent Cache.\n   *\n   * Applications should typically not call this method themselves,\n   * preferring instead to merge at the Store level, which will\n   * utilize this method to merge the caches.\n   *\n   * @method merge\n   * @param {Cache} cache\n   * @public\n   * @returns Promise<void>\n   */\n  merge(cache: Cache): Promise<void> {\n    throw new Error(`Not Implemented`);\n  }\n\n  /**\n   * Generate the list of changes applied to all\n   * record in the store.\n   *\n   * Each individual resource or document that has\n   * been mutated should be described as an individual\n   * `Change` entry in the returned array.\n   *\n   * A `Change` is described by an object containing up to\n   * three properties: (1) the `identifier` of the entity that\n   * changed; (2) the `op` code of that change being one of\n   * `upsert` or `remove`, and if the op is `upsert` a `patch`\n   * containing the data to merge into the cache for the given\n   * entity.\n   *\n   * This `patch` is opaque to the Store but should be understood\n   * by the Cache and may expect to be utilized by an Adapter\n   * when generating data during a `save` operation.\n   *\n   * It is generally recommended that the `patch` contain only\n   * the updated state, ignoring fields that are unchanged\n   *\n   * ```ts\n   * interface Change {\n   *  identifier: StableRecordIdentifier | StableDocumentIdentifier;\n   *  op: 'upsert' | 'remove';\n   *  patch?: unknown;\n   * }\n   * ```\n   *\n   * @method diff\n   * @public\n   */\n  diff(): Promise<Change[]> {\n    throw new Error(`Not Implemented`);\n  }\n\n  // SSR Support\n  // ===========\n\n  /**\n   * Serialize the entire contents of the Cache into a Stream\n   * which may be fed back into a new instance of the same Cache\n   * via `cache.hydrate`.\n   *\n   * @method dump\n   * @returns {Promise<ReadableStream>}\n   * @public\n   */\n  dump(): Promise<ReadableStream<unknown>> {\n    throw new Error(`Not Implemented`);\n  }\n\n  /**\n   * hydrate a Cache from a Stream with content previously serialized\n   * from another instance of the same Cache, resolving when hydration\n   * is complete.\n   *\n   * This method should expect to be called both in the context of restoring\n   * the Cache during application rehydration after SSR **AND** at unknown\n   * times during the lifetime of an already booted application when it is\n   * desired to bulk-load additional information into the cache. This latter\n   * behavior supports optimizing pre/fetching of data for route transitions\n   * via data-only SSR modes.\n   *\n   * @method hydrate\n   * @param {ReadableStream} stream\n   * @returns {Promise<void>}\n   * @public\n   */\n  hydrate(stream: ReadableStream<unknown>): Promise<void> {\n    throw new Error('Not Implemented');\n  }\n\n  // Resource Support\n  // ================\n\n  /**\n   * [LIFECYCLE] Signal to the cache that a new record has been instantiated on the client\n   *\n   * It returns properties from options that should be set on the record during the create\n   * process. This return value behavior is deprecated.\n   *\n   * @method clientDidCreate\n   * @public\n   * @param identifier\n   * @param createArgs\n   */\n  clientDidCreate(\n    identifier: StableRecordIdentifier,\n    options?: Record<string, unknown> | undefined\n  ): Record<string, unknown> {\n    if (LOG_MUTATIONS) {\n      try {\n        let _data = options ? JSON.parse(JSON.stringify(options)) : options;\n        // eslint-disable-next-line no-console\n        console.log(`EmberData | Mutation - clientDidCreate ${identifier.lid}`, _data);\n      } catch (e) {\n        // eslint-disable-next-line no-console\n        console.log(`EmberData | Mutation - clientDidCreate ${identifier.lid}`, options);\n      }\n    }\n    const cached = this._createCache(identifier);\n    cached.isNew = true;\n    let createOptions = {};\n\n    if (options !== undefined) {\n      const storeWrapper = this.__storeWrapper;\n      let attributeDefs = storeWrapper.getSchemaDefinitionService().attributesDefinitionFor(identifier);\n      let relationshipDefs = storeWrapper.getSchemaDefinitionService().relationshipsDefinitionFor(identifier);\n      const graph = graphFor(storeWrapper);\n      let propertyNames = Object.keys(options);\n\n      for (let i = 0; i < propertyNames.length; i++) {\n        let name = propertyNames[i];\n        let propertyValue = options[name];\n\n        if (name === 'id') {\n          continue;\n        }\n\n        const fieldType: AttributeSchema | RelationshipSchema | undefined =\n          relationshipDefs[name] || attributeDefs[name];\n        let kind = fieldType !== undefined ? ('kind' in fieldType ? fieldType.kind : 'attribute') : null;\n        let relationship;\n\n        switch (kind) {\n          case 'attribute':\n            this.setAttr(identifier, name, propertyValue);\n            break;\n          case 'belongsTo':\n            this.mutate({\n              op: 'replaceRelatedRecord',\n              field: name,\n              record: identifier,\n              value: propertyValue as StableRecordIdentifier | null,\n            });\n            relationship = graph.get(identifier, name);\n            relationship.state.hasReceivedData = true;\n            relationship.state.isEmpty = false;\n            break;\n          case 'hasMany':\n            this.mutate({\n              op: 'replaceRelatedRecords',\n              field: name,\n              record: identifier,\n              value: propertyValue as StableRecordIdentifier[],\n            });\n            relationship = graph.get(identifier, name);\n            relationship.state.hasReceivedData = true;\n            relationship.state.isEmpty = false;\n            break;\n          default:\n            // reflect back (pass-thru) unknown properties\n            createOptions[name] = propertyValue;\n        }\n      }\n    }\n\n    this.__storeWrapper.notifyChange(identifier, 'added');\n\n    return createOptions;\n  }\n\n  /**\n   * [LIFECYCLE] Signals to the cache that a resource\n   * will be part of a save transaction.\n   *\n   * @method willCommit\n   * @public\n   * @param identifier\n   */\n  willCommit(identifier: StableRecordIdentifier): void {\n    const cached = this.__peek(identifier, false);\n    cached.inflightAttrs = cached.localAttrs;\n    cached.localAttrs = null;\n  }\n\n  /**\n   * [LIFECYCLE] Signals to the cache that a resource\n   * was successfully updated as part of a save transaction.\n   *\n   * @method didCommit\n   * @public\n   * @param identifier\n   * @param data\n   */\n  didCommit(\n    committedIdentifier: StableRecordIdentifier,\n    result: StructuredDataDocument<SingleResourceDocument>\n  ): SingleResourceDataDocument {\n    const payload = result.content;\n    const operation = result.request!.op;\n    const data = payload && payload.data;\n\n    if (!data) {\n      assert(\n        `Your ${committedIdentifier.type} record was saved to the server, but the response does not have an id and no id has been set client side. Records must have ids. Please update the server response to provide an id in the response or generate the id on the client side either before saving the record or while normalizing the response.`,\n        committedIdentifier.id\n      );\n    }\n\n    const { identifierCache } = this.__storeWrapper;\n    const existingId = committedIdentifier.id;\n    const identifier: StableRecordIdentifier =\n      operation !== 'deleteRecord' && data\n        ? identifierCache.updateRecordIdentifier(committedIdentifier, data)\n        : committedIdentifier;\n\n    const cached = this.__peek(identifier, false);\n    if (cached.isDeleted) {\n      graphFor(this.__storeWrapper).push({\n        op: 'deleteRecord',\n        record: identifier,\n        isNew: false,\n      });\n      cached.isDeletionCommitted = true;\n      this.__storeWrapper.notifyChange(identifier, 'removed');\n      // TODO @runspired should we early exit here?\n    }\n\n    if (DEBUG) {\n      if (cached.isNew && !identifier.id && (typeof data?.id !== 'string' || data.id.length > 0)) {\n        const error = new Error(`Expected an id ${String(identifier)} in response ${JSON.stringify(data)}`);\n        //@ts-expect-error\n        error.isAdapterError = true;\n        //@ts-expect-error\n        error.code = 'InvalidError';\n        throw error;\n      }\n    }\n\n    cached.isNew = false;\n    let newCanonicalAttributes: AttributesHash | undefined;\n    if (data) {\n      if (data.id && !cached.id) {\n        cached.id = data.id;\n      }\n      if (identifier === committedIdentifier && identifier.id !== existingId) {\n        this.__storeWrapper.notifyChange(identifier, 'identity');\n      }\n\n      assert(\n        `Expected the ID received for the primary '${identifier.type}' resource being saved to match the current id '${cached.id}' but received '${identifier.id}'.`,\n        identifier.id === cached.id\n      );\n\n      if (data.relationships) {\n        setupRelationships(this.__storeWrapper, identifier, data);\n      }\n      newCanonicalAttributes = data.attributes;\n    }\n    let changedKeys = calculateChangedKeys(cached, newCanonicalAttributes);\n\n    cached.remoteAttrs = Object.assign(\n      cached.remoteAttrs || Object.create(null),\n      cached.inflightAttrs,\n      newCanonicalAttributes\n    );\n    cached.inflightAttrs = null;\n    patchLocalAttributes(cached);\n\n    if (cached.errors) {\n      cached.errors = null;\n      this.__storeWrapper.notifyChange(identifier, 'errors');\n    }\n\n    notifyAttributes(this.__storeWrapper, identifier, changedKeys);\n    this.__storeWrapper.notifyChange(identifier, 'state');\n\n    const included = payload && payload.included;\n    if (included) {\n      for (let i = 0, length = included.length; i < length; i++) {\n        putOne(this, identifierCache, included[i]);\n      }\n    }\n\n    return {\n      data: identifier as StableExistingRecordIdentifier,\n    };\n  }\n\n  /**\n   * [LIFECYCLE] Signals to the cache that a resource\n   * was update via a save transaction failed.\n   *\n   * @method commitWasRejected\n   * @public\n   * @param identifier\n   * @param errors\n   */\n  commitWasRejected(identifier: StableRecordIdentifier, errors?: JsonApiError[] | undefined): void {\n    const cached = this.__peek(identifier, false);\n    if (cached.inflightAttrs) {\n      let keys = Object.keys(cached.inflightAttrs);\n      if (keys.length > 0) {\n        let attrs = (cached.localAttrs = cached.localAttrs || Object.create(null));\n        for (let i = 0; i < keys.length; i++) {\n          if (attrs[keys[i]] === undefined) {\n            attrs[keys[i]] = cached.inflightAttrs[keys[i]];\n          }\n        }\n      }\n      cached.inflightAttrs = null;\n    }\n    if (errors) {\n      cached.errors = errors;\n    }\n    this.__storeWrapper.notifyChange(identifier, 'errors');\n  }\n\n  /**\n   * [LIFECYCLE] Signals to the cache that all data for a resource\n   * should be cleared.\n   *\n   * This method is a candidate to become a mutation\n   *\n   * @method unloadRecord\n   * @public\n   * @param identifier\n   */\n  unloadRecord(identifier: StableRecordIdentifier): void {\n    const storeWrapper = this.__storeWrapper;\n    // TODO this is necessary because\n    // we maintain memebership inside InstanceCache\n    // for peekAll, so even though we haven't created\n    // any data we think this exists.\n    // TODO can we eliminate that membership now?\n    if (!this.__cache.has(identifier)) {\n      // the graph may still need to unload identity\n      peekGraph(storeWrapper)?.unload(identifier);\n      return;\n    }\n    const removeFromRecordArray = !this.isDeletionCommitted(identifier);\n    let removed = false;\n    const cached = this.__peek(identifier, false);\n    peekGraph(storeWrapper)?.unload(identifier);\n\n    // effectively clearing these is ensuring that\n    // we report as `isEmpty` during teardown.\n    cached.localAttrs = null;\n    cached.remoteAttrs = null;\n    cached.inflightAttrs = null;\n\n    let relatedIdentifiers = _allRelatedIdentifiers(storeWrapper, identifier);\n    if (areAllModelsUnloaded(storeWrapper, relatedIdentifiers)) {\n      for (let i = 0; i < relatedIdentifiers.length; ++i) {\n        let identifier = relatedIdentifiers[i];\n        storeWrapper.notifyChange(identifier, 'removed');\n        removed = true;\n        storeWrapper.disconnectRecord(identifier);\n      }\n    }\n\n    this.__cache.delete(identifier);\n    this.__destroyedCache.set(identifier, cached);\n\n    /*\n     * The destroy cache is a hack to prevent applications\n     * from blowing up during teardown. Accessing state\n     * on a destroyed record is not safe, but historically\n     * was possible due to a combination of teardown timing\n     * and retention of cached state directly on the\n     * record itself.\n     *\n     * Once we have deprecated accessing state on a destroyed\n     * instance we may remove this. The timing isn't a huge deal\n     * as momentarily retaining the objects outside the bounds\n     * of a test won't cause issues.\n     */\n    if (this.__destroyedCache.size === 1) {\n      schedule('destroy', () => {\n        setTimeout(() => {\n          this.__destroyedCache.clear();\n        }, 100);\n      });\n    }\n\n    if (!removed && removeFromRecordArray) {\n      storeWrapper.notifyChange(identifier, 'removed');\n    }\n  }\n\n  // Granular Resource Data APIs\n  // ===========================\n\n  /**\n   * Retrieve the data for an attribute from the cache\n   *\n   * @method getAttr\n   * @public\n   * @param identifier\n   * @param field\n   * @returns {unknown}\n   */\n  getAttr(identifier: StableRecordIdentifier, attr: string): unknown {\n    const cached = this.__peek(identifier, true);\n    if (cached.localAttrs && attr in cached.localAttrs) {\n      return cached.localAttrs[attr];\n    } else if (cached.inflightAttrs && attr in cached.inflightAttrs) {\n      return cached.inflightAttrs[attr];\n    } else if (cached.remoteAttrs && attr in cached.remoteAttrs) {\n      return cached.remoteAttrs[attr];\n    } else {\n      const attrSchema = this.__storeWrapper.getSchemaDefinitionService().attributesDefinitionFor(identifier)[attr];\n      return getDefaultValue(attrSchema?.options);\n    }\n  }\n\n  /**\n   * Mutate the data for an attribute in the cache\n   *\n   * This method is a candidate to become a mutation\n   *\n   * @method setAttr\n   * @public\n   * @param identifier\n   * @param field\n   * @param value\n   */\n  setAttr(identifier: StableRecordIdentifier, attr: string, value: unknown): void {\n    const cached = this.__peek(identifier, false);\n    const existing =\n      cached.inflightAttrs && attr in cached.inflightAttrs\n        ? cached.inflightAttrs[attr]\n        : cached.remoteAttrs && attr in cached.remoteAttrs\n        ? cached.remoteAttrs[attr]\n        : undefined;\n    if (existing !== value) {\n      cached.localAttrs = cached.localAttrs || Object.create(null);\n      cached.localAttrs![attr] = value;\n      cached.changes = cached.changes || Object.create(null);\n      cached.changes![attr] = [existing, value];\n    } else if (cached.localAttrs) {\n      delete cached.localAttrs[attr];\n      delete cached.changes![attr];\n    }\n\n    this.__storeWrapper.notifyChange(identifier, 'attributes', attr);\n  }\n\n  /**\n   * Query the cache for the changed attributes of a resource.\n   *\n   * @method changedAttrs\n   * @public\n   * @param identifier\n   * @returns { <field>: [<old>, <new>] }\n   */\n  changedAttrs(identifier: StableRecordIdentifier): ChangedAttributesHash {\n    // TODO freeze in dev\n    return this.__peek(identifier, false).changes || Object.create(null);\n  }\n\n  /**\n   * Query the cache for whether any mutated attributes exist\n   *\n   * @method hasChangedAttrs\n   * @public\n   * @param identifier\n   * @returns {boolean}\n   */\n  hasChangedAttrs(identifier: StableRecordIdentifier): boolean {\n    const cached = this.__peek(identifier, true);\n\n    return (\n      (cached.inflightAttrs !== null && Object.keys(cached.inflightAttrs).length > 0) ||\n      (cached.localAttrs !== null && Object.keys(cached.localAttrs).length > 0)\n    );\n  }\n\n  /**\n   * Tell the cache to discard any uncommitted mutations to attributes\n   *\n   * This method is a candidate to become a mutation\n   *\n   * @method rollbackAttrs\n   * @public\n   * @param identifier\n   * @returns {string[]} the names of fields that were restored\n   */\n  rollbackAttrs(identifier: StableRecordIdentifier): string[] {\n    const cached = this.__peek(identifier, false);\n    let dirtyKeys: string[] | undefined;\n    cached.isDeleted = false;\n\n    if (cached.localAttrs !== null) {\n      dirtyKeys = Object.keys(cached.localAttrs);\n      cached.localAttrs = null;\n      cached.changes = null;\n    }\n\n    if (cached.isNew) {\n      graphFor(this.__storeWrapper).push({\n        op: 'deleteRecord',\n        record: identifier,\n        isNew: true,\n      });\n      cached.isDeleted = true;\n      cached.isNew = false;\n    }\n\n    cached.inflightAttrs = null;\n\n    if (cached.errors) {\n      cached.errors = null;\n      this.__storeWrapper.notifyChange(identifier, 'errors');\n    }\n\n    this.__storeWrapper.notifyChange(identifier, 'state');\n\n    if (dirtyKeys && dirtyKeys.length) {\n      notifyAttributes(this.__storeWrapper, identifier, dirtyKeys);\n    }\n\n    return dirtyKeys || [];\n  }\n\n  /**\n   * Query the cache for the current state of a relationship property\n   *\n   * @method getRelationship\n   * @public\n   * @param identifier\n   * @param field\n   * @returns resource relationship object\n   */\n  getRelationship(\n    identifier: StableRecordIdentifier,\n    field: string\n  ): SingleResourceRelationship | CollectionResourceRelationship {\n    return (graphFor(this.__storeWrapper).get(identifier, field) as BelongsToRelationship | ManyRelationship).getData();\n  }\n\n  // Resource State\n  // ===============\n\n  /**\n   * Update the cache state for the given resource to be marked\n   * as locally deleted, or remove such a mark.\n   *\n   * This method is a candidate to become a mutation\n   *\n   * @method setIsDeleted\n   * @public\n   * @param identifier\n   * @param isDeleted {boolean}\n   */\n  setIsDeleted(identifier: StableRecordIdentifier, isDeleted: boolean): void {\n    const cached = this.__peek(identifier, false);\n    cached.isDeleted = isDeleted;\n    if (cached.isNew) {\n      // TODO can we delete this since we will do this in unload?\n      graphFor(this.__storeWrapper).push({\n        op: 'deleteRecord',\n        record: identifier,\n        isNew: true,\n      });\n    }\n    this.__storeWrapper.notifyChange(identifier, 'state');\n  }\n\n  /**\n   * Query the cache for any validation errors applicable to the given resource.\n   *\n   * @method getErrors\n   * @public\n   * @param identifier\n   * @returns {JsonApiError[]}\n   */\n  getErrors(identifier: StableRecordIdentifier): JsonApiError[] {\n    return this.__peek(identifier, true).errors || [];\n  }\n\n  /**\n   * Query the cache for whether a given resource has any available data\n   *\n   * @method isEmpty\n   * @public\n   * @param identifier\n   * @returns {boolean}\n   */\n  isEmpty(identifier: StableRecordIdentifier): boolean {\n    const cached = this.__safePeek(identifier, true);\n    return cached ? cached.remoteAttrs === null && cached.inflightAttrs === null && cached.localAttrs === null : true;\n  }\n\n  /**\n   * Query the cache for whether a given resource was created locally and not\n   * yet persisted.\n   *\n   * @method isNew\n   * @public\n   * @param identifier\n   * @returns {boolean}\n   */\n  isNew(identifier: StableRecordIdentifier): boolean {\n    // TODO can we assert here?\n    return this.__safePeek(identifier, true)?.isNew || false;\n  }\n\n  /**\n   * Query the cache for whether a given resource is marked as deleted (but not\n   * necessarily persisted yet).\n   *\n   * @method isDeleted\n   * @public\n   * @param identifier\n   * @returns {boolean}\n   */\n  isDeleted(identifier: StableRecordIdentifier): boolean {\n    // TODO can we assert here?\n    return this.__safePeek(identifier, true)?.isDeleted || false;\n  }\n\n  /**\n   * Query the cache for whether a given resource has been deleted and that deletion\n   * has also been persisted.\n   *\n   * @method isDeletionCommitted\n   * @public\n   * @param identifier\n   * @returns {boolean}\n   */\n  isDeletionCommitted(identifier: StableRecordIdentifier): boolean {\n    // TODO can we assert here?\n    return this.__safePeek(identifier, true)?.isDeletionCommitted || false;\n  }\n\n  /**\n   * Private method used to populate an entry for the identifier\n   *\n   * @method _createCache\n   * @internal\n   * @param {StableRecordIdentifier} identifier\n   * @returns {CachedResource}\n   */\n  _createCache(identifier: StableRecordIdentifier): CachedResource {\n    assert(`Expected no resource data to yet exist in the cache`, !this.__cache.has(identifier));\n    const cache = makeCache();\n    this.__cache.set(identifier, cache);\n    return cache;\n  }\n\n  /**\n   * Peek whether we have cached resource data matching the identifier\n   * without asserting if the resource data is missing.\n   *\n   * @method __safePeek\n   * @param {StableRecordIdentifier} identifier\n   * @param {Boolean} allowDestroyed\n   * @internal\n   * @returns {CachedResource | undefined}\n   */\n  __safePeek(identifier: StableRecordIdentifier, allowDestroyed: boolean): CachedResource | undefined {\n    let resource = this.__cache.get(identifier);\n    if (!resource && allowDestroyed) {\n      resource = this.__destroyedCache.get(identifier);\n    }\n    return resource;\n  }\n\n  /**\n   * Peek whether we have cached resource data matching the identifier\n   * Asserts if the resource data is missing.\n   *\n   * @method __Peek\n   * @param {StableRecordIdentifier} identifier\n   * @param {Boolean} allowDestroyed\n   * @internal\n   * @returns {CachedResource}\n   */\n  __peek(identifier: StableRecordIdentifier, allowDestroyed: boolean): CachedResource {\n    let resource = this.__safePeek(identifier, allowDestroyed);\n    assert(\n      `Expected Cache to have a resource entry for the identifier ${String(identifier)} but none was found`,\n      resource\n    );\n    return resource;\n  }\n}\n\nfunction areAllModelsUnloaded(wrapper: CacheStoreWrapper, identifiers: StableRecordIdentifier[]): boolean {\n  for (let i = 0; i < identifiers.length; ++i) {\n    let identifier = identifiers[i];\n    if (wrapper.hasRecord(identifier)) {\n      return false;\n    }\n  }\n  return true;\n}\n\nfunction getLocalState(rel) {\n  if (rel.definition.kind === 'belongsTo') {\n    return rel.localState ? [rel.localState] : [];\n  }\n  return rel.localState;\n}\nfunction getRemoteState(rel) {\n  if (rel.definition.kind === 'belongsTo') {\n    return rel.remoteState ? [rel.remoteState] : [];\n  }\n  return rel.remoteState;\n}\n\nfunction getDefaultValue(options: { defaultValue?: unknown } | undefined) {\n  if (!options) {\n    return;\n  }\n  if (typeof options.defaultValue === 'function') {\n    // If anyone opens an issue for args not working right, we'll restore + deprecate it via a Proxy\n    // that lazily instantiates the record. We don't want to provide any args here\n    // because in a non @ember-data/model world they don't make sense.\n    return options.defaultValue();\n  } else {\n    let defaultValue = options.defaultValue;\n    assert(\n      `Non primitive defaultValues are not supported because they are shared between all instances. If you would like to use a complex object as a default value please provide a function that returns the complex object.`,\n      typeof defaultValue !== 'object' || defaultValue === null\n    );\n    return defaultValue;\n  }\n}\n\nfunction notifyAttributes(storeWrapper: CacheStoreWrapper, identifier: StableRecordIdentifier, keys?: string[]) {\n  if (!keys) {\n    storeWrapper.notifyChange(identifier, 'attributes');\n    return;\n  }\n\n  for (let i = 0; i < keys.length; i++) {\n    storeWrapper.notifyChange(identifier, 'attributes', keys[i]);\n  }\n}\n\n/*\n      TODO @deprecate IGOR DAVID\n      There seems to be a potential bug here, where we will return keys that are not\n      in the schema\n  */\nfunction calculateChangedKeys(cached: CachedResource, updates?: AttributesHash) {\n  let changedKeys: string[] = [];\n\n  if (updates) {\n    const keys = Object.keys(updates);\n    const length = keys.length;\n    const localAttrs = cached.localAttrs;\n\n    const original = Object.assign(Object.create(null), cached.remoteAttrs, cached.inflightAttrs);\n\n    for (let i = 0; i < length; i++) {\n      let key = keys[i];\n      let value = updates[key];\n\n      // A value in localAttrs means the user has a local change to\n      // this attribute. We never override this value when merging\n      // updates from the backend so we should not sent a change\n      // notification if the server value differs from the original.\n      if (localAttrs && localAttrs[key] !== undefined) {\n        continue;\n      }\n\n      if (original[key] !== value) {\n        changedKeys.push(key);\n      }\n    }\n  }\n\n  return changedKeys;\n}\n\nfunction cacheIsEmpty(cached: CachedResource | undefined): boolean {\n  return !cached || (cached.remoteAttrs === null && cached.inflightAttrs === null && cached.localAttrs === null);\n}\n\nfunction _isEmpty(peeked: CachedResource | undefined): boolean {\n  if (!peeked) {\n    return true;\n  }\n  const isNew = peeked.isNew;\n  const isDeleted = peeked.isDeleted;\n  const isEmpty = cacheIsEmpty(peeked);\n\n  return (!isNew || isDeleted) && isEmpty;\n}\n\nfunction recordIsLoaded(cached: CachedResource | undefined, filterDeleted: boolean = false): boolean {\n  if (!cached) {\n    return false;\n  }\n  const isNew = cached.isNew;\n  const isEmpty = cacheIsEmpty(cached);\n\n  // if we are new we must consider ourselves loaded\n  if (isNew) {\n    return !cached.isDeleted;\n  }\n  // even if we have a past request, if we are now empty we are not loaded\n  // typically this is true after an unloadRecord call\n\n  // if we are not empty, not new && we have a fulfilled request then we are loaded\n  // we should consider allowing for something to be loaded that is simply \"not empty\".\n  // which is how RecordState currently handles this case; however, RecordState is buggy\n  // in that it does not account for unloading.\n  return filterDeleted && cached.isDeletionCommitted ? false : !isEmpty;\n}\n\nfunction _isLoading(\n  peeked: CachedResource | undefined,\n  storeWrapper: CacheStoreWrapper,\n  identifier: StableRecordIdentifier\n): boolean {\n  // TODO refactor things such that the cache is not required to know\n  // about isLoading\n  // @ts-expect-error\n  const req = storeWrapper._store.getRequestStateService();\n  // const fulfilled = req.getLastRequestForRecord(identifier);\n  const isLoaded = recordIsLoaded(peeked);\n\n  return (\n    !isLoaded &&\n    // fulfilled === null &&\n    req.getPendingRequestsForRecord(identifier).some((req) => req.type === 'query')\n  );\n}\n\nfunction setupRelationships(\n  storeWrapper: CacheStoreWrapper,\n  identifier: StableRecordIdentifier,\n  data: JsonApiResource\n) {\n  // TODO @runspired iterating by definitions instead of by payload keys\n  // allows relationship payloads to be ignored silently if no relationship\n  // definition exists. Ensure there's a test for this and then consider\n  // moving this to an assertion. This check should possibly live in the graph.\n  const relationships = storeWrapper.getSchemaDefinitionService().relationshipsDefinitionFor(identifier);\n  const keys = Object.keys(relationships);\n  for (let i = 0; i < keys.length; i++) {\n    const relationshipName = keys[i];\n    const relationshipData = data.relationships![relationshipName];\n\n    if (!relationshipData) {\n      continue;\n    }\n\n    graphFor(storeWrapper).push({\n      op: 'updateRelationship',\n      record: identifier,\n      field: relationshipName,\n      value: relationshipData,\n    });\n  }\n}\n\nfunction patchLocalAttributes(cached: CachedResource): boolean {\n  const { localAttrs, remoteAttrs, inflightAttrs, changes } = cached;\n  if (!localAttrs) {\n    cached.changes = null;\n    return false;\n  }\n  let hasAppliedPatch = false;\n  let mutatedKeys = Object.keys(localAttrs);\n\n  for (let i = 0, length = mutatedKeys.length; i < length; i++) {\n    let attr = mutatedKeys[i];\n    const existing =\n      inflightAttrs && attr in inflightAttrs\n        ? inflightAttrs[attr]\n        : remoteAttrs && attr in remoteAttrs\n        ? remoteAttrs[attr]\n        : undefined;\n\n    if (existing === localAttrs[attr]) {\n      hasAppliedPatch = true;\n      delete localAttrs[attr];\n      delete changes![attr];\n    }\n  }\n  return hasAppliedPatch;\n}\n\nfunction putOne(\n  cache: JSONAPICache,\n  identifiers: IdentifierCache,\n  resource: ExistingResourceObject\n): StableExistingRecordIdentifier {\n  assert(\n    `You must include an 'id' for the resource data ${resource.type}`,\n    resource.id !== null && resource.id !== undefined && resource.id !== ''\n  );\n  assert(\n    `Missing Resource Type: received resource data with a type '${resource.type}' but no schema could be found with that name.`,\n    cache.__storeWrapper.getSchemaDefinitionService().doesTypeExist(resource.type)\n  );\n  let identifier: StableRecordIdentifier | undefined = identifiers.peekRecordIdentifier(resource);\n\n  if (identifier) {\n    identifier = identifiers.updateRecordIdentifier(identifier, resource);\n  } else {\n    identifier = identifiers.getOrCreateRecordIdentifier(resource);\n  }\n  cache.upsert(identifier, resource, cache.__storeWrapper.hasRecord(identifier));\n  // even if the identifier was not \"existing\" before, it is now\n  return identifier as StableExistingRecordIdentifier;\n}\n\n/*\n    Iterates over the set of internal models reachable from `this` across exactly one\n    relationship.\n  */\nfunction _directlyRelatedIdentifiersIterable(storeWrapper: CacheStoreWrapper, originating: StableRecordIdentifier) {\n  const graph = peekGraph(storeWrapper);\n  const initializedRelationships = graph?.identifiers.get(originating);\n\n  if (!initializedRelationships) {\n    return EMPTY_ITERATOR;\n  }\n\n  const initializedRelationshipsArr: Array<ManyRelationship | BelongsToRelationship> = [];\n  Object.keys(initializedRelationships).forEach((key) => {\n    const rel = initializedRelationships[key];\n    if (rel && !isImplicit(rel)) {\n      initializedRelationshipsArr.push(rel);\n    }\n  });\n\n  let i = 0;\n  let j = 0;\n  let k = 0;\n\n  const findNext = () => {\n    while (i < initializedRelationshipsArr.length) {\n      while (j < 2) {\n        let relatedIdentifiers =\n          j === 0 ? getLocalState(initializedRelationshipsArr[i]) : getRemoteState(initializedRelationshipsArr[i]);\n        while (k < relatedIdentifiers.length) {\n          let relatedIdentifier = relatedIdentifiers[k++];\n          if (relatedIdentifier !== null) {\n            return relatedIdentifier;\n          }\n        }\n        k = 0;\n        j++;\n      }\n      j = 0;\n      i++;\n    }\n    return undefined;\n  };\n\n  return {\n    iterator() {\n      return {\n        next: () => {\n          const value = findNext();\n          return { value, done: value === undefined };\n        },\n      };\n    },\n  };\n}\n\n/*\n      Computes the set of Identifiers reachable from this Identifier.\n\n      Reachability is determined over the relationship graph (ie a graph where\n      nodes are identifiers and edges are belongs to or has many\n      relationships).\n\n      Returns an array including `this` and all identifiers reachable\n      from `this.identifier`.\n    */\nfunction _allRelatedIdentifiers(\n  storeWrapper: CacheStoreWrapper,\n  originating: StableRecordIdentifier\n): StableRecordIdentifier[] {\n  let array: StableRecordIdentifier[] = [];\n  let queue: StableRecordIdentifier[] = [];\n  let seen = new Set();\n  queue.push(originating);\n  while (queue.length > 0) {\n    let identifier = queue.shift()!;\n    array.push(identifier);\n    seen.add(identifier);\n\n    const iterator = _directlyRelatedIdentifiersIterable(storeWrapper, originating).iterator();\n    for (let obj = iterator.next(); !obj.done; obj = iterator.next()) {\n      const identifier = obj.value;\n      if (identifier && !seen.has(identifier)) {\n        seen.add(identifier);\n        queue.push(identifier);\n      }\n    }\n  }\n\n  return array;\n}\n\nfunction isMetaDocument(\n  doc: StructuredDocument<ResourceDocument>\n): doc is StructuredDataDocument<ResourceMetaDocument> {\n  return (\n    !(doc instanceof Error) &&\n    doc.content &&\n    !('data' in doc.content) &&\n    !('included' in doc.content) &&\n    'meta' in doc.content\n  );\n}\n\nfunction isErrorDocument(\n  doc: StructuredDocument<ResourceDocument>\n): doc is StructuredErrorDocument<ResourceErrorDocument> {\n  return doc instanceof Error;\n}\n\nfunction fromBaseDocument(doc: StructuredDocument<ResourceDocument>): Partial<ResourceDocument> {\n  const resourceDocument = {} as Partial<ResourceDocument>;\n  const jsonApiDoc = doc.content;\n  if (jsonApiDoc) {\n    copyLinksAndMeta(resourceDocument, jsonApiDoc);\n  }\n  return resourceDocument;\n}\n\nfunction fromStructuredError(doc: StructuredErrorDocument<ResourceErrorDocument>): ResourceErrorDocument {\n  const errorDoc: ResourceErrorDocument = {} as ResourceErrorDocument;\n\n  if (doc.content) {\n    copyLinksAndMeta(errorDoc, doc.content);\n\n    if ('errors' in doc.content) {\n      errorDoc.errors = doc.content.errors;\n    } else if (typeof doc.error === 'object' && 'errors' in doc.error) {\n      errorDoc.errors = doc.error.errors as Array<object>;\n    } else {\n      errorDoc.errors = [{ title: doc.message }];\n    }\n  }\n\n  return errorDoc;\n}\n\nfunction copyLinksAndMeta(target: { links?: unknown; meta?: unknown }, source: object) {\n  if ('links' in source) {\n    target.links = source.links;\n  }\n  if ('meta' in source) {\n    target.meta = source.meta;\n  }\n}\n"],"names":["isImplicit","relationship","definition","EMPTY_ITERATOR","iterator","next","done","value","undefined","makeCache","id","remoteAttrs","localAttrs","inflightAttrs","changes","errors","isNew","isDeleted","isDeletionCommitted","JSONAPICache","constructor","storeWrapper","version","__storeWrapper","__cache","Map","__destroyedCache","__documents","put","doc","assert","content","Error","isErrorDocument","_putDocument","isMetaDocument","jsonApiDoc","included","i","length","identifierCache","putOne","Array","isArray","data","identifiers","push","identifier","resourceDocument","fromStructuredError","fromBaseDocument","request","getOrCreateDocumentIdentifier","lid","hasExisting","has","set","notifyChange","patch","op","macroCondition","getOwnConfig","debug","LOG_OPERATIONS","_data","JSON","parse","stringify","console","log","e","cache","get","record","delete","graphFor","update","mutate","mutation","LOG_MUTATIONS","peek","peeked","__safePeek","type","attributes","Object","assign","relationships","graph","rels","keys","forEach","key","rel","getData","document","peekRequest","upsert","calculateChanges","changedKeys","existed","cached","_createCache","isLoading","_isLoading","recordIsLoaded","isUpdate","_isEmpty","calculateChangedKeys","create","patchLocalAttributes","setupRelationships","notifyAttributes","fork","merge","diff","dump","hydrate","stream","clientDidCreate","options","createOptions","attributeDefs","getSchemaDefinitionService","attributesDefinitionFor","relationshipDefs","relationshipsDefinitionFor","propertyNames","name","propertyValue","fieldType","kind","setAttr","field","state","hasReceivedData","isEmpty","willCommit","__peek","didCommit","committedIdentifier","result","payload","operation","existingId","updateRecordIdentifier","env","DEBUG","error","String","isAdapterError","code","newCanonicalAttributes","commitWasRejected","attrs","unloadRecord","peekGraph","unload","removeFromRecordArray","removed","relatedIdentifiers","_allRelatedIdentifiers","areAllModelsUnloaded","disconnectRecord","size","schedule","setTimeout","clear","getAttr","attr","attrSchema","getDefaultValue","existing","changedAttrs","hasChangedAttrs","rollbackAttrs","dirtyKeys","getRelationship","setIsDeleted","getErrors","allowDestroyed","resource","wrapper","hasRecord","getLocalState","localState","getRemoteState","remoteState","defaultValue","updates","original","cacheIsEmpty","filterDeleted","req","_store","getRequestStateService","isLoaded","getPendingRequestsForRecord","some","relationshipName","relationshipData","hasAppliedPatch","mutatedKeys","doesTypeExist","peekRecordIdentifier","getOrCreateRecordIdentifier","_directlyRelatedIdentifiersIterable","originating","initializedRelationships","initializedRelationshipsArr","j","k","findNext","relatedIdentifier","array","queue","seen","Set","shift","add","obj","copyLinksAndMeta","errorDoc","title","message","target","source","links","meta"],"mappings":"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"}