"use strict";

var _reference = require("@glimmer/reference");

var _util = require("@glimmer/util");

var _opcodes = require("../../opcodes");

var _normalize = require("../../dom/normalize");

var _text = _interopRequireDefault(require("../../vm/content/text"));

var _vm = require("./vm");

var _manager = require("@glimmer/manager");

var _env = require("@glimmer/env");

var _curriedValue = require("../../curried-value");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function toContentType(value) {
  if ((0, _normalize.shouldCoerce)(value)) {
    return 2
    /* String */
    ;
  } else if ((0, _curriedValue.isCurriedType)(value, 0
  /* Component */
  ) || (0, _manager.hasInternalComponentManager)(value)) {
    return 0
    /* Component */
    ;
  } else if ((0, _curriedValue.isCurriedType)(value, 1
  /* Helper */
  ) || (0, _manager.hasInternalHelperManager)(value)) {
    return 1
    /* Helper */
    ;
  } else if ((0, _normalize.isSafeString)(value)) {
    return 4
    /* SafeString */
    ;
  } else if ((0, _normalize.isFragment)(value)) {
    return 5
    /* Fragment */
    ;
  } else if ((0, _normalize.isNode)(value)) {
    return 6
    /* Node */
    ;
  } else {
      return 2
      /* String */
      ;
    }
}

function toDynamicContentType(value) {
  if (!(0, _util.isObject)(value)) {
    return 2
    /* String */
    ;
  }

  if ((0, _curriedValue.isCurriedType)(value, 0
  /* Component */
  ) || (0, _manager.hasInternalComponentManager)(value)) {
    return 0
    /* Component */
    ;
  } else {
    if (_env.DEBUG && !(0, _curriedValue.isCurriedType)(value, 1
    /* Helper */
    ) && !(0, _manager.hasInternalHelperManager)(value)) {
      throw new Error("Attempted use a dynamic value as a component or helper, but that value did not have an associated component or helper manager. The value was: " + value);
    }

    return 1
    /* Helper */
    ;
  }
}

_opcodes.APPEND_OPCODES.add(76
/* ContentType */
, function (vm) {
  var reference = vm.stack.peek();
  vm.stack.push(toContentType((0, _reference.valueForRef)(reference)));

  if (!(0, _reference.isConstRef)(reference)) {
    vm.updateWith(new _vm.AssertFilter(reference, toContentType));
  }
});

_opcodes.APPEND_OPCODES.add(106
/* DynamicContentType */
, function (vm) {
  var reference = vm.stack.peek();
  vm.stack.push(toDynamicContentType((0, _reference.valueForRef)(reference)));

  if (!(0, _reference.isConstRef)(reference)) {
    vm.updateWith(new _vm.AssertFilter(reference, toDynamicContentType));
  }
});

_opcodes.APPEND_OPCODES.add(43
/* AppendHTML */
, function (vm) {
  var reference = vm.stack.pop();
  var rawValue = (0, _reference.valueForRef)(reference);
  var value = (0, _normalize.isEmpty)(rawValue) ? '' : String(rawValue);
  vm.elements().appendDynamicHTML(value);
});

_opcodes.APPEND_OPCODES.add(44
/* AppendSafeHTML */
, function (vm) {
  var reference = vm.stack.pop();
  var rawValue = (0, _reference.valueForRef)(reference).toHTML();
  var value = (0, _normalize.isEmpty)(rawValue) ? '' : rawValue;
  vm.elements().appendDynamicHTML(value);
});

_opcodes.APPEND_OPCODES.add(47
/* AppendText */
, function (vm) {
  var reference = vm.stack.pop();
  var rawValue = (0, _reference.valueForRef)(reference);
  var value = (0, _normalize.isEmpty)(rawValue) ? '' : String(rawValue);
  var node = vm.elements().appendDynamicText(value);

  if (!(0, _reference.isConstRef)(reference)) {
    vm.updateWith(new _text.default(node, reference, value));
  }
});

_opcodes.APPEND_OPCODES.add(45
/* AppendDocumentFragment */
, function (vm) {
  var reference = vm.stack.pop();
  var value = (0, _reference.valueForRef)(reference);
  vm.elements().appendDynamicFragment(value);
});

_opcodes.APPEND_OPCODES.add(46
/* AppendNode */
, function (vm) {
  var reference = vm.stack.pop();
  var value = (0, _reference.valueForRef)(reference);
  vm.elements().appendDynamicNode(value);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3J1bnRpbWUvbGliL2NvbXBpbGVkL29wY29kZXMvY29udGVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBOztBQVFBOztBQUVBOztBQUVBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsU0FBQSxhQUFBLENBQUEsS0FBQSxFQUFxQztBQUNuQyxNQUFJLDZCQUFKLEtBQUksQ0FBSixFQUF5QjtBQUN2QixXQUFBO0FBQUE7QUFBQTtBQURGLEdBQUEsTUFFTyxJQUNMLGlDQUFhLEtBQWIsRUFBbUI7QUFBQTtBQUFuQixPQUNBLDBDQUZLLEtBRUwsQ0FGSyxFQUdMO0FBQ0EsV0FBQTtBQUFBO0FBQUE7QUFKSyxHQUFBLE1BS0EsSUFDTCxpQ0FBYSxLQUFiLEVBQW1CO0FBQUE7QUFBbkIsT0FDQSx1Q0FGSyxLQUVMLENBRkssRUFHTDtBQUNBLFdBQUE7QUFBQTtBQUFBO0FBSkssR0FBQSxNQUtBLElBQUksNkJBQUosS0FBSSxDQUFKLEVBQXlCO0FBQzlCLFdBQUE7QUFBQTtBQUFBO0FBREssR0FBQSxNQUVBLElBQUksMkJBQUosS0FBSSxDQUFKLEVBQXVCO0FBQzVCLFdBQUE7QUFBQTtBQUFBO0FBREssR0FBQSxNQUVBLElBQUksdUJBQUosS0FBSSxDQUFKLEVBQW1CO0FBQ3hCLFdBQUE7QUFBQTtBQUFBO0FBREssR0FBQSxNQUVBO0FBQ0wsYUFBQTtBQUFBO0FBQUE7QUFDRDtBQUNGOztBQUVELFNBQUEsb0JBQUEsQ0FBQSxLQUFBLEVBQTRDO0FBQzFDLE1BQUksQ0FBQyxvQkFBTCxLQUFLLENBQUwsRUFBc0I7QUFDcEIsV0FBQTtBQUFBO0FBQUE7QUFDRDs7QUFFRCxNQUFJLGlDQUFhLEtBQWIsRUFBbUI7QUFBQTtBQUFuQixPQUErQywwQ0FBbkQsS0FBbUQsQ0FBbkQsRUFBaUc7QUFDL0YsV0FBQTtBQUFBO0FBQUE7QUFERixHQUFBLE1BRU87QUFDTCxR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QixHQUFzQixFQUF0QjtBQUVBLE1BQUksS0FBSyxHQUFTLDRCQUFsQixTQUFrQixDQUFsQjtBQUVBLEVBQUEsRUFBRSxDQUFGLFFBQUEsR0FBQSxxQkFBQSxDQUFBLEtBQUE7QUFMRixDQUFBOztBQVFBLHdCQUFBLEdBQUEsQ0FBa0I7QUFBQTtBQUFsQixFQUFtQyxVQUFELEVBQUMsRUFBTTtBQUN2QyxNQUFJLFNBQVMsR0FBUyxFQUFFLENBQUYsS0FBQSxDQUF0QixHQUFzQixFQUF0QjtBQUVBLE1BQUksS0FBSyxHQUFTLDRCQUFsQixTQUFrQixDQUFsQjtBQUVBLEVBQUEsRUFBRSxDQUFGLFFBQUEsR0FBQSxpQkFBQSxDQUFBLEtBQUE7QUFMRixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNDb25zdFJlZiwgdmFsdWVGb3JSZWYgfSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuaW1wb3J0IHtcbiAgY2hlY2ssXG4gIENoZWNrU3RyaW5nLFxuICBDaGVja1NhZmVTdHJpbmcsXG4gIENoZWNrTm9kZSxcbiAgQ2hlY2tEb2N1bWVudEZyYWdtZW50LFxufSBmcm9tICdAZ2xpbW1lci9kZWJ1Zyc7XG5pbXBvcnQgeyBpc09iamVjdCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5pbXBvcnQgeyBBUFBFTkRfT1BDT0RFUyB9IGZyb20gJy4uLy4uL29wY29kZXMnO1xuaW1wb3J0IHsgQ2hlY2tSZWZlcmVuY2UgfSBmcm9tICcuLy1kZWJ1Zy1zdHJpcCc7XG5pbXBvcnQgeyBpc0VtcHR5LCBpc1NhZmVTdHJpbmcsIGlzRnJhZ21lbnQsIGlzTm9kZSwgc2hvdWxkQ29lcmNlIH0gZnJvbSAnLi4vLi4vZG9tL25vcm1hbGl6ZSc7XG5pbXBvcnQgRHluYW1pY1RleHRDb250ZW50IGZyb20gJy4uLy4uL3ZtL2NvbnRlbnQvdGV4dCc7XG5pbXBvcnQgeyBDb250ZW50VHlwZSwgQ3VycmllZFR5cGUsIE9wIH0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBBc3NlcnRGaWx0ZXIgfSBmcm9tICcuL3ZtJztcbmltcG9ydCB7IGhhc0ludGVybmFsQ29tcG9uZW50TWFuYWdlciwgaGFzSW50ZXJuYWxIZWxwZXJNYW5hZ2VyIH0gZnJvbSAnQGdsaW1tZXIvbWFuYWdlcic7XG5pbXBvcnQgeyBERUJVRyB9IGZyb20gJ0BnbGltbWVyL2Vudic7XG5pbXBvcnQgeyBpc0N1cnJpZWRUeXBlIH0gZnJvbSAnLi4vLi4vY3VycmllZC12YWx1ZSc7XG5cbmZ1bmN0aW9uIHRvQ29udGVudFR5cGUodmFsdWU6IHVua25vd24pIHtcbiAgaWYgKHNob3VsZENvZXJjZSh2YWx1ZSkpIHtcbiAgICByZXR1cm4gQ29udGVudFR5cGUuU3RyaW5nO1xuICB9IGVsc2UgaWYgKFxuICAgIGlzQ3VycmllZFR5cGUodmFsdWUsIEN1cnJpZWRUeXBlLkNvbXBvbmVudCkgfHxcbiAgICBoYXNJbnRlcm5hbENvbXBvbmVudE1hbmFnZXIodmFsdWUgYXMgb2JqZWN0KVxuICApIHtcbiAgICByZXR1cm4gQ29udGVudFR5cGUuQ29tcG9uZW50O1xuICB9IGVsc2UgaWYgKFxuICAgIGlzQ3VycmllZFR5cGUodmFsdWUsIEN1cnJpZWRUeXBlLkhlbHBlcikgfHxcbiAgICBoYXNJbnRlcm5hbEhlbHBlck1hbmFnZXIodmFsdWUgYXMgb2JqZWN0KVxuICApIHtcbiAgICByZXR1cm4gQ29udGVudFR5cGUuSGVscGVyO1xuICB9IGVsc2UgaWYgKGlzU2FmZVN0cmluZyh2YWx1ZSkpIHtcbiAgICByZXR1cm4gQ29udGVudFR5cGUuU2FmZVN0cmluZztcbiAgfSBlbHNlIGlmIChpc0ZyYWdtZW50KHZhbHVlKSkge1xuICAgIHJldHVybiBDb250ZW50VHlwZS5GcmFnbWVudDtcbiAgfSBlbHNlIGlmIChpc05vZGUodmFsdWUpKSB7XG4gICAgcmV0dXJuIENvbnRlbnRUeXBlLk5vZGU7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIENvbnRlbnRUeXBlLlN0cmluZztcbiAgfVxufVxuXG5mdW5jdGlvbiB0b0R5bmFtaWNDb250ZW50VHlwZSh2YWx1ZTogdW5rbm93bikge1xuICBpZiAoIWlzT2JqZWN0KHZhbHVlKSkge1xuICAgIHJldHVybiBDb250ZW50VHlwZS5TdHJpbmc7XG4gIH1cblxuICBpZiAoaXNDdXJyaWVkVHlwZSh2YWx1ZSwgQ3VycmllZFR5cGUuQ29tcG9uZW50KSB8fCBoYXNJbnRlcm5hbENvbXBvbmVudE1hbmFnZXIodmFsdWUgYXMgb2JqZWN0KSkge1xuICAgIHJldHVybiBDb250ZW50VHlwZS5Db21wb25lbnQ7XG4gIH0gZWxzZSB7XG4gICAgaWYgKFxuICAgICAgREVCVUcgJiZcbiAgICAgICFpc0N1cnJpZWRUeXBlKHZhbHVlLCBDdXJyaWVkVHlwZS5IZWxwZXIpICYmXG4gICAgICAhaGFzSW50ZXJuYWxIZWxwZXJNYW5hZ2VyKHZhbHVlIGFzIG9iamVjdClcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEF0dGVtcHRlZCB1c2UgYSBkeW5hbWljIHZhbHVlIGFzIGEgY29tcG9uZW50IG9yIGhlbHBlciwgYnV0IHRoYXQgdmFsdWUgZGlkIG5vdCBoYXZlIGFuIGFzc29jaWF0ZWQgY29tcG9uZW50IG9yIGhlbHBlciBtYW5hZ2VyLiBUaGUgdmFsdWUgd2FzOiAke3ZhbHVlfWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIENvbnRlbnRUeXBlLkhlbHBlcjtcbiAgfVxufVxuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQ29udGVudFR5cGUsICh2bSkgPT4ge1xuICBsZXQgcmVmZXJlbmNlID0gY2hlY2sodm0uc3RhY2sucGVlaygpLCBDaGVja1JlZmVyZW5jZSk7XG5cbiAgdm0uc3RhY2sucHVzaCh0b0NvbnRlbnRUeXBlKHZhbHVlRm9yUmVmKHJlZmVyZW5jZSkpKTtcblxuICBpZiAoIWlzQ29uc3RSZWYocmVmZXJlbmNlKSkge1xuICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydEZpbHRlcihyZWZlcmVuY2UsIHRvQ29udGVudFR5cGUpKTtcbiAgfVxufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5EeW5hbWljQ29udGVudFR5cGUsICh2bSkgPT4ge1xuICBsZXQgcmVmZXJlbmNlID0gY2hlY2sodm0uc3RhY2sucGVlaygpLCBDaGVja1JlZmVyZW5jZSk7XG5cbiAgdm0uc3RhY2sucHVzaCh0b0R5bmFtaWNDb250ZW50VHlwZSh2YWx1ZUZvclJlZihyZWZlcmVuY2UpKSk7XG5cbiAgaWYgKCFpc0NvbnN0UmVmKHJlZmVyZW5jZSkpIHtcbiAgICB2bS51cGRhdGVXaXRoKG5ldyBBc3NlcnRGaWx0ZXIocmVmZXJlbmNlLCB0b0R5bmFtaWNDb250ZW50VHlwZSkpO1xuICB9XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkFwcGVuZEhUTUwsICh2bSkgPT4ge1xuICBsZXQgcmVmZXJlbmNlID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKTtcblxuICBsZXQgcmF3VmFsdWUgPSB2YWx1ZUZvclJlZihyZWZlcmVuY2UpO1xuICBsZXQgdmFsdWUgPSBpc0VtcHR5KHJhd1ZhbHVlKSA/ICcnIDogU3RyaW5nKHJhd1ZhbHVlKTtcblxuICB2bS5lbGVtZW50cygpLmFwcGVuZER5bmFtaWNIVE1MKHZhbHVlKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQXBwZW5kU2FmZUhUTUwsICh2bSkgPT4ge1xuICBsZXQgcmVmZXJlbmNlID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKTtcblxuICBsZXQgcmF3VmFsdWUgPSBjaGVjayh2YWx1ZUZvclJlZihyZWZlcmVuY2UpLCBDaGVja1NhZmVTdHJpbmcpLnRvSFRNTCgpO1xuICBsZXQgdmFsdWUgPSBpc0VtcHR5KHJhd1ZhbHVlKSA/ICcnIDogY2hlY2socmF3VmFsdWUsIENoZWNrU3RyaW5nKTtcblxuICB2bS5lbGVtZW50cygpLmFwcGVuZER5bmFtaWNIVE1MKHZhbHVlKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQXBwZW5kVGV4dCwgKHZtKSA9PiB7XG4gIGxldCByZWZlcmVuY2UgPSBjaGVjayh2bS5zdGFjay5wb3AoKSwgQ2hlY2tSZWZlcmVuY2UpO1xuXG4gIGxldCByYXdWYWx1ZSA9IHZhbHVlRm9yUmVmKHJlZmVyZW5jZSk7XG4gIGxldCB2YWx1ZSA9IGlzRW1wdHkocmF3VmFsdWUpID8gJycgOiBTdHJpbmcocmF3VmFsdWUpO1xuXG4gIGxldCBub2RlID0gdm0uZWxlbWVudHMoKS5hcHBlbmREeW5hbWljVGV4dCh2YWx1ZSk7XG5cbiAgaWYgKCFpc0NvbnN0UmVmKHJlZmVyZW5jZSkpIHtcbiAgICB2bS51cGRhdGVXaXRoKG5ldyBEeW5hbWljVGV4dENvbnRlbnQobm9kZSwgcmVmZXJlbmNlLCB2YWx1ZSkpO1xuICB9XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkFwcGVuZERvY3VtZW50RnJhZ21lbnQsICh2bSkgPT4ge1xuICBsZXQgcmVmZXJlbmNlID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKTtcblxuICBsZXQgdmFsdWUgPSBjaGVjayh2YWx1ZUZvclJlZihyZWZlcmVuY2UpLCBDaGVja0RvY3VtZW50RnJhZ21lbnQpO1xuXG4gIHZtLmVsZW1lbnRzKCkuYXBwZW5kRHluYW1pY0ZyYWdtZW50KHZhbHVlKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQXBwZW5kTm9kZSwgKHZtKSA9PiB7XG4gIGxldCByZWZlcmVuY2UgPSBjaGVjayh2bS5zdGFjay5wb3AoKSwgQ2hlY2tSZWZlcmVuY2UpO1xuXG4gIGxldCB2YWx1ZSA9IGNoZWNrKHZhbHVlRm9yUmVmKHJlZmVyZW5jZSksIENoZWNrTm9kZSk7XG5cbiAgdm0uZWxlbWVudHMoKS5hcHBlbmREeW5hbWljTm9kZSh2YWx1ZSk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiIn0=