function _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }

import { ConcreteBounds, NewElementBuilder } from '@glimmer/runtime';
var TEXT_NODE = 3;
var NEEDS_EXTRA_CLOSE = new WeakMap();

function currentNode(cursor) {
  var element = cursor.element,
      nextSibling = cursor.nextSibling;

  if (nextSibling === null) {
    return element.lastChild;
  } else {
    return nextSibling.previousSibling;
  }
}

var SerializeBuilder = /*#__PURE__*/function (_NewElementBuilder) {
  _inheritsLoose(SerializeBuilder, _NewElementBuilder);

  function SerializeBuilder() {
    var _this;

    _this = _NewElementBuilder.apply(this, arguments) || this;
    _this.serializeBlockDepth = 0;
    return _this;
  }

  var _proto = SerializeBuilder.prototype;

  _proto.__openBlock = function __openBlock() {
    var tagName = this.element.tagName;

    if (tagName !== 'TITLE' && tagName !== 'SCRIPT' && tagName !== 'STYLE') {
      var depth = this.serializeBlockDepth++;

      this.__appendComment("%+b:" + depth + "%");
    }

    _NewElementBuilder.prototype.__openBlock.call(this);
  };

  _proto.__closeBlock = function __closeBlock() {
    var tagName = this.element.tagName;

    _NewElementBuilder.prototype.__closeBlock.call(this);

    if (tagName !== 'TITLE' && tagName !== 'SCRIPT' && tagName !== 'STYLE') {
      var depth = --this.serializeBlockDepth;

      this.__appendComment("%-b:" + depth + "%");
    }
  };

  _proto.__appendHTML = function __appendHTML(html) {
    var tagName = this.element.tagName;

    if (tagName === 'TITLE' || tagName === 'SCRIPT' || tagName === 'STYLE') {
      return _NewElementBuilder.prototype.__appendHTML.call(this, html);
    } // Do we need to run the html tokenizer here?


    var first = this.__appendComment('%glmr%');

    if (tagName === 'TABLE') {
      var openIndex = html.indexOf('<');

      if (openIndex > -1) {
        var tr = html.slice(openIndex + 1, openIndex + 3);

        if (tr === 'tr') {
          html = "<tbody>" + html + "</tbody>";
        }
      }
    }

    if (html === '') {
      this.__appendComment('% %');
    } else {
      _NewElementBuilder.prototype.__appendHTML.call(this, html);
    }

    var last = this.__appendComment('%glmr%');

    return new ConcreteBounds(this.element, first, last);
  };

  _proto.__appendText = function __appendText(string) {
    var tagName = this.element.tagName;
    var current = currentNode(this);

    if (tagName === 'TITLE' || tagName === 'SCRIPT' || tagName === 'STYLE') {
      return _NewElementBuilder.prototype.__appendText.call(this, string);
    } else if (string === '') {
      return this.__appendComment('% %');
    } else if (current && current.nodeType === TEXT_NODE) {
      this.__appendComment('%|%');
    }

    return _NewElementBuilder.prototype.__appendText.call(this, string);
  };

  _proto.closeElement = function closeElement() {
    if (NEEDS_EXTRA_CLOSE.has(this.element)) {
      NEEDS_EXTRA_CLOSE["delete"](this.element);

      _NewElementBuilder.prototype.closeElement.call(this);
    }

    return _NewElementBuilder.prototype.closeElement.call(this);
  };

  _proto.openElement = function openElement(tag) {
    if (tag === 'tr') {
      if (this.element.tagName !== 'TBODY' && this.element.tagName !== 'THEAD' && this.element.tagName !== 'TFOOT') {
        this.openElement('tbody'); // This prevents the closeBlock comment from being re-parented
        // under the auto inserted tbody. Rehydration builder needs to
        // account for the insertion since it is injected here and not
        // really in the template.

        NEEDS_EXTRA_CLOSE.set(this.constructing, true);
        this.flushElement(null);
      }
    }

    return _NewElementBuilder.prototype.openElement.call(this, tag);
  };

  _proto.pushRemoteElement = function pushRemoteElement(element, cursorId, insertBefore) {
    if (insertBefore === void 0) {
      insertBefore = null;
    }

    var dom = this.dom;
    var script = dom.createElement('script');
    script.setAttribute('glmr', cursorId);
    dom.insertBefore(element, script, insertBefore);
    return _NewElementBuilder.prototype.pushRemoteElement.call(this, element, cursorId, insertBefore);
  };

  return SerializeBuilder;
}(NewElementBuilder);

export function serializeBuilder(env, cursor) {
  return SerializeBuilder.forInitialRender(env, cursor);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL25vZGUvbGliL3NlcmlhbGl6ZS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBUUEsU0FBQSxjQUFBLEVBQUEsaUJBQUEsUUFBQSxrQkFBQTtBQUlBLElBQU0sU0FBUyxHQUFmLENBQUE7QUFFQSxJQUFNLGlCQUFpQixHQUFHLElBQTFCLE9BQTBCLEVBQTFCOztBQUVBLFNBQUEsV0FBQSxDQUFBLE1BQUEsRUFDOEU7QUFBQSxNQUV4RSxPQUZ3RSxHQUU1RSxNQUY0RSxDQUV4RSxPQUZ3RTtBQUFBLE1BRTdELFdBRjZELEdBRTVFLE1BRjRFLENBRTdELFdBRjZEOztBQUk1RSxNQUFJLFdBQVcsS0FBZixJQUFBLEVBQTBCO0FBQ3hCLFdBQU8sT0FBTyxDQUFkLFNBQUE7QUFERixHQUFBLE1BRU87QUFDTCxXQUFPLFdBQVcsQ0FBbEIsZUFBQTtBQUNEO0FBQ0Y7O0lBRUQsZ0I7OztBQUFBLDhCQUFBO0FBQUE7OztBQUNVLFVBQUEsbUJBQUEsR0FBQSxDQUFBO0FBRFY7QUE0R0M7Ozs7U0F6R0MsVyxHQUFBLHVCQUFXO0FBQUEsUUFDSCxPQURHLEdBQ1MsS0FBbEIsT0FEUyxDQUNILE9BREc7O0FBR1QsUUFBSSxPQUFPLEtBQVAsT0FBQSxJQUF1QixPQUFPLEtBQTlCLFFBQUEsSUFBK0MsT0FBTyxLQUExRCxPQUFBLEVBQXdFO0FBQ3RFLFVBQUksS0FBSyxHQUFHLEtBQVosbUJBQVksRUFBWjs7QUFDQSxXQUFBLGVBQUEsVUFBQSxLQUFBO0FBQ0Q7O0FBRUQsaUNBQUEsV0FBQTtBQUNELEc7O1NBRUQsWSxHQUFBLHdCQUFZO0FBQUEsUUFDSixPQURJLEdBQ1EsS0FBbEIsT0FEVSxDQUNKLE9BREk7O0FBR1YsaUNBQUEsWUFBQTs7QUFFQSxRQUFJLE9BQU8sS0FBUCxPQUFBLElBQXVCLE9BQU8sS0FBOUIsUUFBQSxJQUErQyxPQUFPLEtBQTFELE9BQUEsRUFBd0U7QUFDdEUsVUFBSSxL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QUd3QztBQUFBLFFBQXRDLFlBQXNDO0FBQXRDLE1BQUEsWUFBc0MsR0FIdkIsSUFHdUI7QUFBQTs7QUFBQSxRQUVoQyxHQUZnQyxHQUV0QyxJQUZzQyxDQUVoQyxHQUZnQztBQUd0QyxRQUFJLE1BQU0sR0FBRyxHQUFHLENBQUgsYUFBQSxDQUFiLFFBQWEsQ0FBYjtBQUNBLElBQUEsTUFBTSxDQUFOLFlBQUEsQ0FBQSxNQUFBLEVBQUEsUUFBQTtBQUNBLElBQUEsR0FBRyxDQUFILFlBQUEsQ0FBQSxPQUFBLEVBQUEsTUFBQSxFQUFBLFlBQUE7QUFDQSx3Q0FBTyxpQkFBUCxZQUFPLE9BQVAsRUFBTyxRQUFQLEVBQUEsWUFBQTtBQUNELEc7OztFQTNHSCxpQjs7QUE4R0EsT0FBTSxTQUFBLGdCQUFBLENBQUEsR0FBQSxFQUFBLE1BQUEsRUFFK0Q7QUFFbkUsU0FBTyxnQkFBZ0IsQ0FBaEIsZ0JBQUEsQ0FBQSxHQUFBLEVBQVAsTUFBTyxDQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7XG4gIEJvdW5kcyxcbiAgRW52aXJvbm1lbnQsXG4gIE9wdGlvbixcbiAgRWxlbWVudEJ1aWxkZXIsXG4gIE1heWJlLFxuICBNb2RpZmllckluc3RhbmNlLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IENvbmNyZXRlQm91bmRzLCBOZXdFbGVtZW50QnVpbGRlciB9IGZyb20gJ0BnbGltbWVyL3J1bnRpbWUnO1xuaW1wb3J0IHsgUmVtb3RlTGl2ZUJsb2NrIH0gZnJvbSAnQGdsaW1tZXIvcnVudGltZSc7XG5pbXBvcnQgdHlwZSB7IFNpbXBsZUVsZW1lbnQsIFNpbXBsZU5vZGUsIFNpbXBsZVRleHQgfSBmcm9tICdAc2ltcGxlLWRvbS9pbnRlcmZhY2UnO1xuXG5jb25zdCBURVhUX05PREUgPSAzO1xuXG5jb25zdCBORUVEU19FWFRSQV9DTE9TRSA9IG5ldyBXZWFrTWFwPFNpbXBsZU5vZGU+KCk7XG5cbmZ1bmN0aW9uIGN1cnJlbnROb2RlKFxuICBjdXJzb3I6IEVsZW1lbnRCdWlsZGVyIHwgeyBlbGVtZW50OiBTaW1wbGVFbGVtZW50OyBuZXh0U2libGluZzogU2ltcGxlTm9kZSB9XG4pOiBPcHRpb248U2ltcGxlTm9kZT4ge1xuICBsZXQgeyBlbGVtZW50LCBuZXh0U2libGluZyB9ID0gY3Vyc29yO1xuXG4gIGlmIChuZXh0U2libGluZyA9PT0gbnVsbCkge1xuICAgIHJldHVybiBlbGVtZW50Lmxhc3RDaGlsZDtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbmV4dFNpYmxpbmcucHJldmlvdXNTaWJsaW5nO1xuICB9XG59XG5cbmNsYXNzIFNlcmlhbGl6ZUJ1aWxkZXIgZXh0ZW5kcyBOZXdFbGVtZW50QnVpbGRlciBpbXBsZW1lbnRzIEVsZW1lbnRCdWlsZGVyIHtcbiAgcHJpdmF0ZSBzZXJpYWxpemVCbG9ja0RlcHRoID0gMDtcblxuICBfX29wZW5CbG9jaygpOiB2b2lkIHtcbiAgICBsZXQgeyB0YWdOYW1lIH0gPSB0aGlzLmVsZW1lbnQ7XG5cbiAgICBpZiAodGFnTmFtZSAhPT0gJ1RJVExFJyAmJiB0YWdOYW1lICE9PSAnU0NSSVBUJyAmJiB0YWdOYW1lICE9PSAnU1RZTEUnKSB7XG4gICAgICBsZXQgZGVwdGggPSB0aGlzLnNlcmlhbGl6ZUJsb2NrRGVwdGgrKztcbiAgICAgIHRoaXMuX19hcHBlbmRDb21tZW50KGAlK2I6JHtkZXB0aH0lYCk7XG4gICAgfVxuXG4gICAgc3VwZXIuX19vcGVuQmxvY2soKTtcbiAgfVxuXG4gIF9fY2xvc2VCbG9jaygpOiB2b2lkIHtcbiAgICBsZXQgeyB0YWdOYW1lIH0gPSB0aGlzLmVsZW1lbnQ7XG5cbiAgICBzdXBlci5fX2Nsb3NlQmxvY2soKTtcblxuICAgIGlmICh0YWdOYW1lICE9PSAnVElUTEUnICYmIHRhZ05hbWUgIT09ICdTQ1JJUFQnICYmIHRhZ05hbWUgIT09ICdTVFlMRScpIHtcbiAgICAgIGxldCBkZXB0aCA9IC0tdGhpcy5zZXJpYWxpemVCbG9ja0RlcHRoO1xuICAgICAgdGhpcy5fX2FwcGVuZENvbW1lbnQoYCUtYjoke2RlcHRofSVgKTtcbiAgICB9XG4gIH1cblxuICBfX2FwcGVuZEhUTUwoaHRtbDogc3RyaW5nKTogQm91bmRzIHtcbiAgICBsZXQgeyB0YWdOYW1lIH0gPSB0aGlzLmVsZW1lbnQ7XG5cbiAgICBpZiAodGFnTmFtZSA9PT0gJ1RJVExFJyB8fCB0YWdOYW1lID09PSAnU0NSSVBUJyB8fCB0YWdOYW1lID09PSAnU1RZTEUnKSB7XG4gICAgICByZXR1cm4gc3VwZXIuX19hcHBlbmRIVE1MKGh0bWwpO1xuICAgIH1cblxuICAgIC8vIERvIHdlIG5lZWQgdG8gcnVuIHRoZSBodG1sIHRva2VuaXplciBoZXJlP1xuICAgIGxldCBmaXJzdCA9IHRoaXMuX19hcHBlbmRDb21tZW50KCclZ2xtciUnKTtcbiAgICBpZiAodGFnTmFtZSA9PT0gJ1RBQkxFJykge1xuICAgICAgbGV0IG9wZW5JbmRleCA9IGh0bWwuaW5kZXhPZignPCcpO1xuICAgICAgaWYgKG9wZW5JbmRleCA+IC0xKSB7XG4gICAgICAgIGxldCB0ciA9IGh0bWwuc2xpY2Uob3BlbkluZGV4ICsgMSwgb3BlbkluZGV4ICsgMyk7XG4gICAgICAgIGlmICh0ciA9PT0gJ3RyJykge1xuICAgICAgICAgIGh0bWwgPSBgPHRib2R5PiR7aHRtbH08L3Rib2R5PmA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGh0bWwgPT09ICcnKSB7XG4gICAgICB0aGlzLl9fYXBwZW5kQ29tbWVudCgnJSAlJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN1cGVyLl9fYXBwZW5kSFRNTChodG1sKTtcbiAgICB9XG5cbiAgICBsZXQgbGFzdCA9IHRoaXMuX19hcHBlbmRDb21tZW50KCclZ2xtciUnKTtcbiAgICByZXR1cm4gbmV3IENvbmNyZXRlQm91bmRzKHRoaXMuZWxlbWVudCwgZmlyc3QsIGxhc3QpO1xuICB9XG5cbiAgX19hcHBlbmRUZXh0KHN0cmluZzogc3RyaW5nKTogU2ltcGxlVGV4dCB7XG4gICAgbGV0IHsgdGFnTmFtZSB9ID0gdGhpcy5lbGVtZW50O1xuICAgIGxldCBjdXJyZW50ID0gY3VycmVudE5vZGUodGhpcyk7XG5cbiAgICBpZiAodGFnTmFtZSA9PT0gJ1RJVExFJyB8fCB0YWdOYW1lID09PSAnU0NSSVBUJyB8fCB0YWdOYW1lID09PSAnU1RZTEUnKSB7XG4gICAgICByZXR1cm4gc3VwZXIuX19hcHBlbmRUZXh0KHN0cmluZyk7XG4gICAgfSBlbHNlIGlmIChzdHJpbmcgPT09ICcnKSB7XG4gICAgICByZXR1cm4gKHRoaXMuX19hcHBlbmRDb21tZW50KCclICUnKSBhcyBhbnkpIGFzIFNpbXBsZVRleHQ7XG4gICAgfSBlbHNlIGlmIChjdXJyZW50ICYmIGN1cnJlbnQubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkge1xuICAgICAgdGhpcy5fX2FwcGVuZENvbW1lbnQoJyV8JScpO1xuICAgIH1cblxuICAgIHJldHVybiBzdXBlci5fX2FwcGVuZFRleHQoc3RyaW5nKTtcbiAgfVxuXG4gIGNsb3NlRWxlbWVudCgpOiBPcHRpb248TW9kaWZpZXJJbnN0YW5jZVtdPiB7XG4gICAgaWYgKE5FRURTX0VYVFJBX0NMT1NFLmhhcyh0aGlzLmVsZW1lbnQpKSB7XG4gICAgICBORUVEU19FWFRSQV9DTE9TRS5kZWxldGUodGhpcy5lbGVtZW50KTtcbiAgICAgIHN1cGVyLmNsb3NlRWxlbWVudCgpO1xuICAgIH1cblxuICAgIHJldHVybiBzdXBlci5jbG9zZUVsZW1lbnQoKTtcbiAgfVxuXG4gIG9wZW5FbGVtZW50KHRhZzogc3RyaW5nKSB7XG4gICAgaWYgKHRhZyA9PT0gJ3RyJykge1xuICAgICAgaWYgKFxuICAgICAgICB0aGlzLmVsZW1lbnQudGFnTmFtZSAhPT0gJ1RCT0RZJyAmJlxuICAgICAgICB0aGlzLmVsZW1lbnQudGFnTmFtZSAhPT0gJ1RIRUFEJyAmJlxuICAgICAgICB0aGlzLmVsZW1lbnQudGFnTmFtZSAhPT0gJ1RGT09UJ1xuICAgICAgKSB7XG4gICAgICAgIHRoaXMub3BlbkVsZW1lbnQoJ3Rib2R5Jyk7XG4gICAgICAgIC8vIFRoaXMgcHJldmVudHMgdGhlIGNsb3NlQmxvY2sgY29tbWVudCBmcm9tIGJlaW5nIHJlLXBhcmVudGVkXG4gICAgICAgIC8vIHVuZGVyIHRoZSBhdXRvIGluc2VydGVkIHRib2R5LiBSZWh5ZHJhdGlvbiBidWlsZGVyIG5lZWRzIHRvXG4gICAgICAgIC8vIGFjY291bnQgZm9yIHRoZSBpbnNlcnRpb24gc2luY2UgaXQgaXMgaW5qZWN0ZWQgaGVyZSBhbmQgbm90XG4gICAgICAgIC8vIHJlYWxseSBpbiB0aGUgdGVtcGxhdGUuXG4gICAgICAgIE5FRURTX0VYVFJBX0NMT1NFLnNldCh0aGlzLmNvbnN0cnVjdGluZyEsIHRydWUpO1xuICAgICAgICB0aGlzLmZsdXNoRWxlbWVudChudWxsKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gc3VwZXIub3BlbkVsZW1lbnQodGFnKTtcbiAgfVxuXG4gIHB1c2hSZW1vdGVFbGVtZW50KFxuICAgIGVsZW1lbnQ6IFNpbXBsZUVsZW1lbnQsXG4gICAgY3Vyc29ySWQ6IHN0cmluZyxcbiAgICBpbnNlcnRCZWZvcmU6IE1heWJlPFNpbXBsZU5vZGU+ID0gbnVsbFxuICApOiBPcHRpb248UmVtb3RlTGl2ZUJsb2NrPiB7XG4gICAgbGV0IHsgZG9tIH0gPSB0aGlzO1xuICAgIGxldCBzY3JpcHQgPSBkb20uY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgnZ2xtcicsIGN1cnNvcklkKTtcbiAgICBkb20uaW5zZXJ0QmVmb3JlKGVsZW1lbnQsIHNjcmlwdCwgaW5zZXJ0QmVmb3JlKTtcbiAgICByZXR1cm4gc3VwZXIucHVzaFJlbW90ZUVsZW1lbnQoZWxlbWVudCwgY3Vyc29ySWQsIGluc2VydEJlZm9yZSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlcmlhbGl6ZUJ1aWxkZXIoXG4gIGVudjogRW52aXJvbm1lbnQsXG4gIGN1cnNvcjogeyBlbGVtZW50OiBTaW1wbGVFbGVtZW50OyBuZXh0U2libGluZzogT3B0aW9uPFNpbXBsZU5vZGU+IH1cbik6IEVsZW1lbnRCdWlsZGVyIHtcbiAgcmV0dXJuIFNlcmlhbGl6ZUJ1aWxkZXIuZm9ySW5pdGlhbFJlbmRlcihlbnYsIGN1cnNvcik7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9