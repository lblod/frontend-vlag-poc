"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.serializeBuilder = serializeBuilder;

var _runtime = require("@glimmer/runtime");

function _inheritsLoose(subClass, superClass) {
  subClass.prototype = Object.create(superClass.prototype);
  subClass.prototype.constructor = subClass;
  subClass.__proto__ = superClass;
}

var TEXT_NODE = 3;
var NEEDS_EXTRA_CLOSE = new WeakMap();

function currentNode(cursor) {
  var element = cursor.element,
      nextSibling = cursor.nextSibling;

  if (nextSibling === null) {
    return element.lastChild;
  } else {
    return nextSibling.previousSibling;
  }
}

var SerializeBuilder = /*#__PURE__*/function (_NewElementBuilder) {
  _inheritsLoose(SerializeBuilder, _NewElementBuilder);

  function SerializeBuilder() {
    var _this;

    _this = _NewElementBuilder.apply(this, arguments) || this;
    _this.serializeBlockDepth = 0;
    return _this;
  }

  var _proto = SerializeBuilder.prototype;

  _proto.__openBlock = function __openBlock() {
    var tagName = this.element.tagName;

    if (tagName !== 'TITLE' && tagName !== 'SCRIPT' && tagName !== 'STYLE') {
      var depth = this.serializeBlockDepth++;

      this.__appendComment("%+b:" + depth + "%");
    }

    _NewElementBuilder.prototype.__openBlock.call(this);
  };

  _proto.__closeBlock = function __closeBlock() {
    var tagName = this.element.tagName;

    _NewElementBuilder.prototype.__closeBlock.call(this);

    if (tagName !== 'TITLE' && tagName !== 'SCRIPT' && tagName !== 'STYLE') {
      var depth = --this.serializeBlockDepth;

      this.__appendComment("%-b:" + depth + "%");
    }
  };

  _proto.__appendHTML = function __appendHTML(html) {
    var tagName = this.element.tagName;

    if (tagName === 'TITLE' || tagName === 'SCRIPT' || tagName === 'STYLE') {
      return _NewElementBuilder.prototype.__appendHTML.call(this, html);
    } // Do we need to run the html tokenizer here?


    var first = this.__appendComment('%glmr%');

    if (tagName === 'TABLE') {
      var openIndex = html.indexOf('<');

      if (openIndex > -1) {
        var tr = html.slice(openIndex + 1, openIndex + 3);

        if (tr === 'tr') {
          html = "<tbody>" + html + "</tbody>";
        }
      }
    }

    if (html === '') {
      this.__appendComment('% %');
    } else {
      _NewElementBuilder.prototype.__appendHTML.call(this, html);
    }

    var last = this.__appendComment('%glmr%');

    return new _runtime.ConcreteBounds(this.element, first, last);
  };

  _proto.__appendText = function __appendText(string) {
    var tagName = this.element.tagName;
    var current = currentNode(this);

    if (tagName === 'TITLE' || tagName === 'SCRIPT' || tagName === 'STYLE') {
      return _NewElementBuilder.prototype.__appendText.call(this, string);
    } else if (string === '') {
      return this.__appendComment('% %');
    } else if (current && current.nodeType === TEXT_NODE) {
      this.__appendComment('%|%');
    }

    return _NewElementBuilder.prototype.__appendText.call(this, string);
  };

  _proto.closeElement = function closeElement() {
    if (NEEDS_EXTRA_CLOSE.has(this.element)) {
      NEEDS_EXTRA_CLOSE["delete"](this.element);

      _NewElementBuilder.prototype.closeElement.call(this);
    }

    return _NewElementBuilder.prototype.closeElement.call(this);
  };

  _proto.openElement = function openElement(tag) {
    if (tag === 'tr') {
      if (this.element.tagName !== 'TBODY' && this.element.tagName !== 'THEAD' && this.element.tagName !== 'TFOOT') {
        this.openElement('tbody'); // This prevents the closeBlock comment from being re-parented
        // under the auto inserted tbody. Rehydration builder needs to
        // account for the insertion since it is injected here and not
        // really in the template.

        NEEDS_EXTRA_CLOSE.set(this.constructing, true);
        this.flushElement(null);
      }
    }

    return _NewElementBuilder.prototype.openElement.call(this, tag);
  };

  _proto.pushRemoteElement = function pushRemoteElement(element, cursorId, insertBefore) {
    if (insertBefore === void 0) {
      insertBefore = null;
    }

    var dom = this.dom;
    var script = dom.createElement('script');
    script.setAttribute('glmr', cursorId);
    dom.insertBefore(element, script, insertBefore);
    return _NewElementBuilder.prototype.pushRemoteElement.call(this, element, cursorId, insertBefore);
  };

  return SerializeBuilder;
}(_runtime.NewElementBuilder);

function serializeBuilder(env, cursor) {
  return SerializeBuilder.forInitialRender(env, cursor);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL25vZGUvbGliL3NlcmlhbGl6ZS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFRQTs7Ozs7Ozs7QUFJQSxJQUFNLFNBQVMsR0FBZixDQUFBO0FBRUEsSUFBTSxpQkFBaUIsR0FBRyxJQUExQixPQUEwQixFQUExQjs7QUFFQSxTQUFBLFdBQUEsQ0FBQSxNQUFBLEVBQzhFO0FBQUEsTUFFeEUsT0FGd0UsR0FFNUUsTUFGNEUsQ0FBQSxPQUFBO0FBQUEsTUFFN0QsV0FGNkQsR0FFNUUsTUFGNEUsQ0FBQSxXQUFBOztBQUk1RSxNQUFJLFdBQVcsS0FBZixJQUFBLEVBQTBCO0FBQ3hCLFdBQU8sT0FBTyxDQUFkLFNBQUE7QUFERixHQUFBLE1BRU87QUFDTCxXQUFPLFdBQVcsQ0FBbEIsZUFBQTtBQUNEO0FBQ0Y7O0lBRUQsZ0I7OztBQUFBLFdBQUEsZ0JBQUEsR0FBQTtBQUFBLFFBQUEsS0FBQTs7O0FBQ1UsSUFBQSxLQUFBLENBQUEsbUJBQUEsR0FBQSxDQUFBO0FBRFYsV0FBQSxLQUFBO0FBNEdDOzs7O1NBekdDLFcsR0FBQSxTQUFBLFdBQUEsR0FBVztBQUFBLFFBQ0gsT0FERyxHQUNTLEtBRFQsT0FDUyxDQURULE9BQUE7O0FBR1QsUUFBSSxPQUFPLEtBQVAsT0FBQSxJQUF1QixPQUFPLEtBQTlCLFFBQUEsSUFBK0MsT0FBTyxLQUExRCxPQUFBLEVBQXdFO0FBQ3RFLFVBQUksS0FBSyxHQUFHLEtBQVosbUJBQVksRUFBWjs7QUFDQSxXQUFBLGVBQUEsQ0FBQSxTQUFBLEtBQUEsR0FBQSxHQUFBO0FBQ0Q7O0FBRUQsSUFBQSxrQkFBQSxDQUFBLFNBQUEsQ0FBQSxXQUFBLENBQUEsSUFBQSxDQUFBLElBQUE7OztTQUdGLFksR0FBQSxTQUFBLFlBQUEsR0FBWTtBQUFBLFFBQ0osT0FESSxHQUNRLEtBRFIsT0FDUSxDQURSLE9BQUE7O0FBR1YsSUFBQSxrQkFBQSxDQUFBLFNBQUEsQ0FBQSxZQUFBLENBQUEsSUFBQSxDQUFBLElBQUE7O0FBRUEsUUFBSSxPQUFPLEtBQVAsT0FBQSxJQUF1QixPQUFPLEtBQTlCLFFBQUEsSUFBK0MsT0FBTyxLQUExRCxPQUFBLEVBQXdFO0FBQ3RFLFVBQUksS0FBSyxHQUFHLEVBQUUsS0FBZCxtQkFBQTs7QUFDQSxXQUFBLGVBQUEsQ0FBQSxTQUFBLEtBQUEsR0FBQSxHQUFBO0FBQ0Q7OztTQUdILFksR0FBQSxTQUFBLFlBQUEsQ0FBQSxJQUFBLEVBQXlCO0FBQUEsUUFDakIsT0FEaUIsR0FDTCxLQURLLE9BQ0wsQ0FESyxPQUFBOztBQUd2QixRQUFJLE9BQU8sS0FBUCxPQUFBLElBQXVCLE9BQU8sS0FBOUIsUUFBQSxJQUErQyxPQUFPLEtBQTFELE9BQUEsRUFBd0U7QUFDdEUsYUFBQSxrQkFBQSxDQUFBLFNBQUEsQ0FBQSxZQUFBLENBQUEsSUFBQSxDQUFBLElBQUEsRUFBQSxJQUFBLENBQUE7QUFKcUIsS0FBQSxDQU92Qjs7O0FBQ0EsUUFBSSxLQUFLLEdBQUcsS0FBQSxlQUFBLENBQVosUUFBWSxDQUFaOztBQUNBLFFBQUksT0FBTyxLQUFYLE9BQUEsRUFBeUI7QUFDdkIsVUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFKLE9BQUEsQ0FBaEIsR0FBZ0IsQ0FBaEI7O0FBQ0EsVUFBSSxTQUFTLEdBQUcsQ0FBaEIsQ0FBQSxFQUFvQjtBQUNsQixZQUFJLEVBQUUsR0FBRyxJQUFJLENBQUosS0FBQSxDQUFXLFNBQVMsR0FBcEIsQ0FBQSxFQUEwQixTQUFTLEdBQTVDLENBQVMsQ0FBVDs7QUFDQSxZQUFJLEVBQUUsS0FBTixJQUFBLEVBQWlCO0FBQ2YsVUFBQSxJQUFJLEdBQUEsWUFBSixJQUFJLEdBQUosVUFBQTtBQUNEO0FBQ0Y7QUFDRjs7QUFDRCxRQUFJLElBQUksS0FBUixFQUFBLEVBQWlCO0FBQ2YsV0FBQSxlQUFBLENBQUEsS0FBQTtBQURGLEtBQUEsTUFFTztBQUNMLE1BQUEsa0JBQUEsQ0FBQSxTQUFBLENBQUEsWUFBQSxDQUFBLElBQUEsQ0FBQSxJQUFBLEVBQUEsSUFBQTtBQUNEOztBQUVELFFBQUksSUFBSSxHQUFHLEtBQUEsZUFBQSxDQUFYLFFBQVcsQ0FBWDs7QUFDQSxXQUFPLElBQUEsdUJBQUEsQ0FBbUIsS0FBbkIsT0FBQSxFQUFBLEtBQUEsRUFBUCxJQUFPLENBQVA7OztTQUdGLFksR0FBQSxTQUFBLFlBQUEsQ0FBQSxNQUFBLEVBQTJCO0FBQUEsUUFDbkIsT0FEbUIsR0FDUCxLQURPLE9BQ1AsQ0FETyxPQUFBO0FBRXpCLFFBQUksT0FBTyxHQUFHLFdBQVcsQ0FBekIsSUFBeUIsQ0FBekI7O0FBRUEsUUFBSSxPQUFPLEtBQVAsT0FBQSxJQUF1QixPQUFPLEtBQTlCLFFBQUEsSUFBK0MsT0FBTyxLQUExRCxPQUFBLEVBQXdFO0FBQ3RFLGFBQUEsa0JBQUEsQ0FBQSxTQUFBLENBQUEsWUFBQSxDQUFBLElBQUEsQ0FBQSxJQUFBLEVBQUEsTUFBQSxDQUFBO0FBREYsS0FBQSxNQUVPLElBQUksTUFBTSxLQUFWLEVBQUEsRUFBbUI7QUFDeEIsYUFBUSxLQUFBLGVBQUEsQ0FBUixLQUFRLENBQVI7QUFESyxLQUFBLE1BRUEsSUFBSSxPQUFPLElBQUksT0FBTyxDQUFQLFFBQUEsS0FBZixTQUFBLEVBQStDO0FBQ3BELFdBQUEsZUFBQSxDQUFBLEtBQUE7QUFDRDs7QUFFRCxXQUFBLGtCQUFBLENBQUEsU0FBQSxDQUFBLFlBQUEsQ0FBQSxJQUFBLENBQUEsSUFBQSxFQUFBLE1BQUEsQ0FBQTs7O1NBR0YsWSxHQUFBLFNBQUEsWUFBQSxHQUFZO0FBQ1YsUUFBSSxpQkFBaUIsQ0FBakIsR0FBQSxDQUFzQixLQUExQixPQUFJLENBQUosRUFBeUM7QUFDdkMsTUFBQSxpQkFBQSxDQUFBLFFBQUEsQ0FBQSxDQUF5QixLQUF6QixPQUFBOztBQUNBLE1BQUEsa0JBQUEsQ0FBQSxTQUFBLENBQUEsWUFBQSxDQUFBLElBQUEsQ0FBQSxJQUFBO0FBQ0Q7O0FBRUQsV0FBQSxrQkFBQSxDQUFBLFNBQUEsQ0FBQSxZQUFBLENBQUEsSUFBQSxDQUFBLElBQUEsQ0FBQTs7O1NBR0YsVyxHQUFBLFNBQUEsV0FBQSxDQUFBLEdBQUEsRUFBdUI7QUFDckIsUUFBSSxHQUFHLEtBQVAsSUFBQSxFQUFrQjtBQUNoQixVQUNFLEtBQUEsT0FBQSxDQUFBLE9BQUEsS0FBQSxPQUFBLElBQ0EsS0FBQSxPQUFBLENBQUEsT0FBQSxLQURBLE9BQUEsSUFFQSxLQUFBLE9BQUEsQ0FBQSxPQUFBLEtBSEYsT0FBQSxFQUlFO0FBQ0EsYUFBQSxXQUFBLENBREEsT0FDQSxFQURBLENBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBQ0EsUUFBQSxpQkFBaUIsQ0FBakIsR0FBQSxDQUFzQixLQUF0QixZQUFBLEVBQUEsSUFBQTtBQUNBLGFBQUEsWUFBQSxDQUFBLElBQUE7QUFDRDtBQUNGOztBQUVELFdBQUEsa0JBQUEsQ0FBQSxTQUFBLENBQUEsV0FBQSxDQUFBLElBQUEsQ0FBQSxJQUFBLEVBQUEsR0FBQSxDQUFBOzs7U0FHRixpQixHQUFBLFNBQUEsaUJBQUEsQ0FBQSxPQUFBLEVBQUEsUUFBQSxFQUFBLFlBQUEsRUFHd0M7QUFBQSxRQUF0QyxZQUFzQyxLQUFBLEtBQUEsQ0FBQSxFQUFBO0FBQXRDLE1BQUEsWUFBc0MsR0FIdkIsSUFHZjtBQUFzQzs7QUFBQSxRQUVoQyxHQUZnQyxHQUFBLEtBQUEsR0FBQTtBQUd0QyxRQUFJLE1BQU0sR0FBRyxHQUFHLENBQUgsYUFBQSxDQUFiLFFBQWEsQ0FBYjtBQUNBLElBQUEsTUFBTSxDQUFOLFlBQUEsQ0FBQSxNQUFBLEVBQUEsUUFBQTtBQUNBLElBQUEsR0FBRyxDQUFILFlBQUEsQ0FBQSxPQUFBLEVBQUEsTUFBQSxFQUFBLFlBQUE7QUFDQSxXQUFBLGtCQUFBLENBQUEsU0FBQSxDQUFBLGlCQUFBLENBQUEsSUFBQSxDQUFBLElBQUEsRUFBQSxPQUFBLEVBQUEsUUFBQSxFQUFBLFlBQUEsQ0FBQTs7OztFQTFHSiwwQjs7QUE4R00sU0FBQSxnQkFBQSxDQUFBLEdBQUEsRUFBQSxNQUFBLEVBRStEO0FBRW5FLFNBQU8sZ0JBQWdCLENBQWhCLGdCQUFBLENBQUEsR0FBQSxFQUFQLE1BQU8sQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUge1xuICBCb3VuZHMsXG4gIEVudmlyb25tZW50LFxuICBPcHRpb24sXG4gIEVsZW1lbnRCdWlsZGVyLFxuICBNYXliZSxcbiAgTW9kaWZpZXJJbnN0YW5jZSxcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBDb25jcmV0ZUJvdW5kcywgTmV3RWxlbWVudEJ1aWxkZXIgfSBmcm9tICdAZ2xpbW1lci9ydW50aW1lJztcbmltcG9ydCB7IFJlbW90ZUxpdmVCbG9jayB9IGZyb20gJ0BnbGltbWVyL3J1bnRpbWUnO1xuaW1wb3J0IHR5cGUgeyBTaW1wbGVFbGVtZW50LCBTaW1wbGVOb2RlLCBTaW1wbGVUZXh0IH0gZnJvbSAnQHNpbXBsZS1kb20vaW50ZXJmYWNlJztcblxuY29uc3QgVEVYVF9OT0RFID0gMztcblxuY29uc3QgTkVFRFNfRVhUUkFfQ0xPU0UgPSBuZXcgV2Vha01hcDxTaW1wbGVOb2RlPigpO1xuXG5mdW5jdGlvbiBjdXJyZW50Tm9kZShcbiAgY3Vyc29yOiBFbGVtZW50QnVpbGRlciB8IHsgZWxlbWVudDogU2ltcGxlRWxlbWVudDsgbmV4dFNpYmxpbmc6IFNpbXBsZU5vZGUgfVxuKTogT3B0aW9uPFNpbXBsZU5vZGU+IHtcbiAgbGV0IHsgZWxlbWVudCwgbmV4dFNpYmxpbmcgfSA9IGN1cnNvcjtcblxuICBpZiAobmV4dFNpYmxpbmcgPT09IG51bGwpIHtcbiAgICByZXR1cm4gZWxlbWVudC5sYXN0Q2hpbGQ7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG5leHRTaWJsaW5nLnByZXZpb3VzU2libGluZztcbiAgfVxufVxuXG5jbGFzcyBTZXJpYWxpemVCdWlsZGVyIGV4dGVuZHMgTmV3RWxlbWVudEJ1aWxkZXIgaW1wbGVtZW50cyBFbGVtZW50QnVpbGRlciB7XG4gIHByaXZhdGUgc2VyaWFsaXplQmxvY2tEZXB0aCA9IDA7XG5cbiAgX19vcGVuQmxvY2soKTogdm9pZCB7XG4gICAgbGV0IHsgdGFnTmFtZSB9ID0gdGhpcy5lbGVtZW50O1xuXG4gICAgaWYgKHRhZ05hbWUgIT09ICdUSVRMRScgJiYgdGFnTmFtZSAhPT0gJ1NDUklQVCcgJiYgdGFnTmFtZSAhPT0gJ1NUWUxFJykge1xuICAgICAgbGV0IGRlcHRoID0gdGhpcy5zZXJpYWxpemVCbG9ja0RlcHRoKys7XG4gICAgICB0aGlzLl9fYXBwZW5kQ29tbWVudChgJStiOiR7ZGVwdGh9JWApO1xuICAgIH1cblxuICAgIHN1cGVyLl9fb3BlbkJsb2NrKCk7XG4gIH1cblxuICBfX2Nsb3NlQmxvY2soKTogdm9pZCB7XG4gICAgbGV0IHsgdGFnTmFtZSB9ID0gdGhpcy5lbGVtZW50O1xuXG4gICAgc3VwZXIuX19jbG9zZUJsb2NrKCk7XG5cbiAgICBpZiAodGFnTmFtZSAhPT0gJ1RJVExFJyAmJiB0YWdOYW1lICE9PSAnU0NSSVBUJyAmJiB0YWdOYW1lICE9PSAnU1RZTEUnKSB7XG4gICAgICBsZXQgZGVwdGggPSAtLXRoaXMuc2VyaWFsaXplQmxvY2tEZXB0aDtcbiAgICAgIHRoaXMuX19hcHBlbmRDb21tZW50KGAlLWI6JHtkZXB0aH0lYCk7XG4gICAgfVxuICB9XG5cbiAgX19hcHBlbmRIVE1MKGh0bWw6IHN0cmluZyk6IEJvdW5kcyB7XG4gICAgbGV0IHsgdGFnTmFtZSB9ID0gdGhpcy5lbGVtZW50O1xuXG4gICAgaWYgKHRhZ05hbWUgPT09ICdUSVRMRScgfHwgdGFnTmFtZSA9PT0gJ1NDUklQVCcgfHwgdGFnTmFtZSA9PT0gJ1NUWUxFJykge1xuICAgICAgcmV0dXJuIHN1cGVyLl9fYXBwZW5kSFRNTChodG1sKTtcbiAgICB9XG5cbiAgICAvLyBEbyB3ZSBuZWVkIHRvIHJ1biB0aGUgaHRtbCB0b2tlbml6ZXIgaGVyZT9cbiAgICBsZXQgZmlyc3QgPSB0aGlzLl9fYXBwZW5kQ29tbWVudCgnJWdsbXIlJyk7XG4gICAgaWYgKHRhZ05hbWUgPT09ICdUQUJMRScpIHtcbiAgICAgIGxldCBvcGVuSW5kZXggPSBodG1sLmluZGV4T2YoJzwnKTtcbiAgICAgIGlmIChvcGVuSW5kZXggPiAtMSkge1xuICAgICAgICBsZXQgdHIgPSBodG1sLnNsaWNlKG9wZW5JbmRleCArIDEsIG9wZW5JbmRleCArIDMpO1xuICAgICAgICBpZiAodHIgPT09ICd0cicpIHtcbiAgICAgICAgICBodG1sID0gYDx0Ym9keT4ke2h0bWx9PC90Ym9keT5gO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChodG1sID09PSAnJykge1xuICAgICAgdGhpcy5fX2FwcGVuZENvbW1lbnQoJyUgJScpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdXBlci5fX2FwcGVuZEhUTUwoaHRtbCk7XG4gICAgfVxuXG4gICAgbGV0IGxhc3QgPSB0aGlzLl9fYXBwZW5kQ29tbWVudCgnJWdsbXIlJyk7XG4gICAgcmV0dXJuIG5ldyBDb25jcmV0ZUJvdW5kcyh0aGlzLmVsZW1lbnQsIGZpcnN0LCBsYXN0KTtcbiAgfVxuXG4gIF9fYXBwZW5kVGV4dChzdHJpbmc6IHN0cmluZyk6IFNpbXBsZVRleHQge1xuICAgIGxldCB7IHRhZ05hbWUgfSA9IHRoaXMuZWxlbWVudDtcbiAgICBsZXQgY3VycmVudCA9IGN1cnJlbnROb2RlKHRoaXMpO1xuXG4gICAgaWYgKHRhZ05hbWUgPT09ICdUSVRMRScgfHwgdGFnTmFtZSA9PT0gJ1NDUklQVCcgfHwgdGFnTmFtZSA9PT0gJ1NUWUxFJykge1xuICAgICAgcmV0dXJuIHN1cGVyLl9fYXBwZW5kVGV4dChzdHJpbmcpO1xuICAgIH0gZWxzZSBpZiAoc3RyaW5nID09PSAnJykge1xuICAgICAgcmV0dXJuICh0aGlzLl9fYXBwZW5kQ29tbWVudCgnJSAlJykgYXMgYW55KSBhcyBTaW1wbGVUZXh0O1xuICAgIH0gZWxzZSBpZiAoY3VycmVudCAmJiBjdXJyZW50Lm5vZGVUeXBlID09PSBURVhUX05PREUpIHtcbiAgICAgIHRoaXMuX19hcHBlbmRDb21tZW50KCclfCUnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3VwZXIuX19hcHBlbmRUZXh0KHN0cmluZyk7XG4gIH1cblxuICBjbG9zZUVsZW1lbnQoKTogT3B0aW9uPE1vZGlmaWVySW5zdGFuY2VbXT4ge1xuICAgIGlmIChORUVEU19FWFRSQV9DTE9TRS5oYXModGhpcy5lbGVtZW50KSkge1xuICAgICAgTkVFRFNfRVhUUkFfQ0xPU0UuZGVsZXRlKHRoaXMuZWxlbWVudCk7XG4gICAgICBzdXBlci5jbG9zZUVsZW1lbnQoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3VwZXIuY2xvc2VFbGVtZW50KCk7XG4gIH1cblxuICBvcGVuRWxlbWVudCh0YWc6IHN0cmluZykge1xuICAgIGlmICh0YWcgPT09ICd0cicpIHtcbiAgICAgIGlmIChcbiAgICAgICAgdGhpcy5lbGVtZW50LnRhZ05hbWUgIT09ICdUQk9EWScgJiZcbiAgICAgICAgdGhpcy5lbGVtZW50LnRhZ05hbWUgIT09ICdUSEVBRCcgJiZcbiAgICAgICAgdGhpcy5lbGVtZW50LnRhZ05hbWUgIT09ICdURk9PVCdcbiAgICAgICkge1xuICAgICAgICB0aGlzLm9wZW5FbGVtZW50KCd0Ym9keScpO1xuICAgICAgICAvLyBUaGlzIHByZXZlbnRzIHRoZSBjbG9zZUJsb2NrIGNvbW1lbnQgZnJvbSBiZWluZyByZS1wYXJlbnRlZFxuICAgICAgICAvLyB1bmRlciB0aGUgYXV0byBpbnNlcnRlZCB0Ym9keS4gUmVoeWRyYXRpb24gYnVpbGRlciBuZWVkcyB0b1xuICAgICAgICAvLyBhY2NvdW50IGZvciB0aGUgaW5zZXJ0aW9uIHNpbmNlIGl0IGlzIGluamVjdGVkIGhlcmUgYW5kIG5vdFxuICAgICAgICAvLyByZWFsbHkgaW4gdGhlIHRlbXBsYXRlLlxuICAgICAgICBORUVEU19FWFRSQV9DTE9TRS5zZXQodGhpcy5jb25zdHJ1Y3RpbmchLCB0cnVlKTtcbiAgICAgICAgdGhpcy5mbHVzaEVsZW1lbnQobnVsbCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHN1cGVyLm9wZW5FbGVtZW50KHRhZyk7XG4gIH1cblxuICBwdXNoUmVtb3RlRWxlbWVudChcbiAgICBlbGVtZW50OiBTaW1wbGVFbGVtZW50LFxuICAgIGN1cnNvcklkOiBzdHJpbmcsXG4gICAgaW5zZXJ0QmVmb3JlOiBNYXliZTxTaW1wbGVOb2RlPiA9IG51bGxcbiAgKTogT3B0aW9uPFJlbW90ZUxpdmVCbG9jaz4ge1xuICAgIGxldCB7IGRvbSB9ID0gdGhpcztcbiAgICBsZXQgc2NyaXB0ID0gZG9tLmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoJ2dsbXInLCBjdXJzb3JJZCk7XG4gICAgZG9tLmluc2VydEJlZm9yZShlbGVtZW50LCBzY3JpcHQsIGluc2VydEJlZm9yZSk7XG4gICAgcmV0dXJuIHN1cGVyLnB1c2hSZW1vdGVFbGVtZW50KGVsZW1lbnQsIGN1cnNvcklkLCBpbnNlcnRCZWZvcmUpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemVCdWlsZGVyKFxuICBlbnY6IEVudmlyb25tZW50LFxuICBjdXJzb3I6IHsgZWxlbWVudDogU2ltcGxlRWxlbWVudDsgbmV4dFNpYmxpbmc6IE9wdGlvbjxTaW1wbGVOb2RlPiB9XG4pOiBFbGVtZW50QnVpbGRlciB7XG4gIHJldHVybiBTZXJpYWxpemVCdWlsZGVyLmZvckluaXRpYWxSZW5kZXIoZW52LCBjdXJzb3IpO1xufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==