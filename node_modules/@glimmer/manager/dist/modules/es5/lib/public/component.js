import { DEBUG } from '@glimmer/env';
import { createConstRef } from '@glimmer/reference';
import { registerDestructor } from '@glimmer/destroyable';
import { buildCapabilities, FROM_CAPABILITIES } from '../util/capabilities';
import { argsProxyFor } from '../util/args-proxy';
var CAPABILITIES = {
  dynamicLayout: false,
  dynamicTag: false,
  prepareArgs: false,
  createArgs: true,
  attributeHook: false,
  elementHook: false,
  createCaller: false,
  dynamicScope: true,
  updateHook: true,
  createInstance: true,
  wrapped: false,
  willDestroy: false,
  hasSubOwner: false
};
export function componentCapabilities(managerAPI, options) {
  if (options === void 0) {
    options = {};
  }

  if (DEBUG && managerAPI !== '3.13') {
    throw new Error('Invalid component manager compatibility specified');
  }

  var updateHook = Boolean(options.updateHook);
  return buildCapabilities({
    asyncLifeCycleCallbacks: Boolean(options.asyncLifecycleCallbacks),
    destructor: Boolean(options.destructor),
    updateHook: updateHook
  });
}
export function hasAsyncLifeCycleCallbacks(delegate) {
  return delegate.capabilities.asyncLifeCycleCallbacks;
}
export function hasUpdateHook(delegate) {
  return delegate.capabilities.updateHook;
}
export function hasAsyncUpdateHook(delegate) {
  return hasAsyncLifeCycleCallbacks(delegate) && hasUpdateHook(delegate);
}
export function hasDestructors(delegate) {
  return delegate.capabilities.destructor;
}
/**
  The CustomComponentManager allows addons to provide custom component
  implementations that integrate seamlessly into Ember. This is accomplished
  through a delegate, registered with the custom component manager, which
  implements a set of hooks that determine component behavior.

  To create a custom component manager, instantiate a new CustomComponentManager
  class and pass the delegate as the first argument:

  ```js
  let manager = new CustomComponentManager({
    // ...delegate implementation...
  });
  ```

  ## Delegate Hooks

  Throughout the lifecycle of a component, the component manager will invoke
  delegate hooks that are responsible for surfacing those lifecycle changes to
  the end developer.

  * `create()` - invoked when a new instance of a component should be created
  * `update()` - invoked when the arguments passed to a component change
  * `getContext()` - returns the object that should be
*/

export var CustomComponentManager = /*#__PURE__*/function () {
  function CustomComponentManager(factory) {
    this.factory = factory;
    this.componentManagerDelegates = new WeakMap();
  }

  var _proto = CustomComponentManager.prototype;

  _proto.getDelegateFor = function getDelegateFor(owner) {
    var componentManagerDelegates = this.componentManagerDelegates;
    var delegate = componentManagerDelegates.get(owner);

    if (delegate === undefined) {
      var factory = this.factory;
      delegate = factory(owner);

      if (DEBUG && !FROM_CAPABILITIES.has(delegate.capabilities)) {
        // TODO: This error message should make sense in both Ember and Glimmer https://github.com/glimmerjs/glimmer-vm/issues/1200
        throw new Error("Custom component managers must have a `capabilities` property that is the result of calling the `capabilities('3.13')` (imported via `import { capabilities } from '@ember/component';`). Received: `" + JSON.stringify(delegate.capabilities) + "` for: `" + delegate + "`");
      }

      componentManagerDelegates.set(owner, delegate);
    }

    return delegate;
  };

  _proto.create = function create(owner, definition, vmArgs) {
    var delegate = this.getDelegateFor(owner);
    var args = argsProxyFor(vmArgs.capture(), 'component');
    var component = delegate.createComponent(definition, args);
    return new CustomComponentState(component, delegate, args);
  };

  _proto.getDebugName = function getDebugName(definition) {
    return typeof definition === 'function' ? definition.name : definition.toString();
  };

  _proto.update = function update(bucket) {
    var delegate = bucket.delegate;

    if (hasUpdateHook(delegate)) {
      var component = bucket.component,
          args = bucket.args;
      delegate.updateComponent(component, args);
    }
  };

  _proto.didCreate = function didCreate(_ref) {
    var component = _ref.component,
        delegate = _ref.delegate;

    if (hasAsyncLifeCycleCallbacks(delegate)) {
      delegate.didCreateComponent(component);
    }
  };

  _proto.didUpdate = function didUpdate(_ref2) {
    var component = _ref2.component,
        delegate = _ref2.delegate;

    if (hasAsyncUpdateHook(delegate)) {
      delegate.didUpdateComponent(component);
    }
  };

  _proto.didRenderLayout = function didRenderLayout() {};

  _proto.didUpdateLayout = function didUpdateLayout() {};

  _proto.getSelf = function getSelf(_ref3) {
    var component = _ref3.component,
        delegate = _ref3.delegate;
    return createConstRef(delegate.getContext(component), 'this');
  };

  _proto.getDestroyable = function getDestroyable(bucket) {
    var delegate = bucket.delegate;

    if (hasDestructors(delegate)) {
      var component = bucket.component;
      registerDestructor(bucket, function () {
        return delegate.destroyComponent(component);
      });
      return bucket;
    }

    return null;
  };

  _proto.getCapabilities = function getCapabilities() {
    return CAPABILITIES;
  };

  return CustomComponentManager;
}();
/**
 * Stores internal state about a component instance after it's been created.
 */

export var CustomComponentState = function CustomComponentState(component, delegate, args) {
  this.component = component;
  this.delegate = delegate;
  this.args = args;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL21hbmFnZXIvbGliL3B1YmxpYy9jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsU0FBQSxLQUFBLFFBQUEsY0FBQTtBQWtCQSxTQUFBLGNBQUEsUUFBQSxvQkFBQTtBQUNBLFNBQUEsa0JBQUEsUUFBQSxzQkFBQTtBQUNBLFNBQUEsaUJBQUEsRUFBQSxpQkFBQSxRQUFBLHNCQUFBO0FBQ0EsU0FBQSxZQUFBLFFBQUEsb0JBQUE7QUFHQSxJQUFNLFlBQVksR0FBRztBQUNuQixFQUFBLGFBQWEsRUFETSxLQUFBO0FBRW5CLEVBQUEsVUFBVSxFQUZTLEtBQUE7QUFHbkIsRUFBQSxXQUFXLEVBSFEsS0FBQTtBQUluQixFQUFBLFVBQVUsRUFKUyxJQUFBO0FBS25CLEVBQUEsYUFBYSxFQUxNLEtBQUE7QUFNbkIsRUFBQSxXQUFXLEVBTlEsS0FBQTtBQU9uQixFQUFBLFlBQVksRUFQTyxLQUFBO0FBUW5CLEVBQUEsWUFBWSxFQVJPLElBQUE7QUFTbkIsRUFBQSxVQUFVLEVBVFMsSUFBQTtBQVVuQixFQUFBLGNBQWMsRUFWSyxJQUFBO0FBV25CLEVBQUEsT0FBTyxFQVhZLEtBQUE7QUFZbkIsRUFBQSxXQUFXLEVBWlEsS0FBQTtBQWFuQixFQUFBLFdBQVcsRUFBRTtBQWJNLENBQXJCO0FBZ0JBLE9BQU0sU0FBQSxxQkFBQSxDQUFBLFVBQUEsRUFFSixPQUZJLEVBRWdEO0FBQUEsTUFBcEQsT0FBb0Q7QUFBcEQsSUFBQSxPQUFvRCxHQUZoRCxFQUVnRDtBQUFBOztBQUVwRCxNQUFJLEtBQUssSUFBSSxVQUFVLEtBQXZCLE1BQUEsRUFBb0M7QUFDbEMsVUFBTSxJQUFBLEtBQUEsQ0FBTixtREFBTSxDQUFOO0FBQ0Q7O0FBRUQsTUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFFLE9BQWlELENBQTNFLFVBQXdCLENBQXhCO0FBRUEsU0FBTyxpQkFBaUIsQ0FBQztBQUN2QixJQUFBLHVCQUF1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QUFULENBQWxCO0FBQ0EsYUFBQSxNQUFBO0FBQ0Q7O0FBRUQsV0FBQSxJQUFBO0FBQ0QsR0F0Rkg7O0FBQUEsU0F3RkUsZUF4RkYsR0F3RkUsMkJBQWU7QUFDYixXQUFBLFlBQUE7QUFDRCxHQTFGSDs7QUFBQTtBQUFBO0FBNkZBOzs7O0FBR0EsV0FBTSxvQkFBTixHQUNFLDhCQUFBLFNBQUEsRUFBQSxRQUFBLEVBQUEsSUFBQSxFQUd3QjtBQUZmLE9BQUEsU0FBQSxHQUFBLFNBQUE7QUFDQSxPQUFBLFFBQUEsR0FBQSxRQUFBO0FBQ0EsT0FBQSxJQUFBLEdBQUEsSUFBQTtBQUNMLENBTE4iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBERUJVRyB9IGZyb20gJ0BnbGltbWVyL2Vudic7XG5pbXBvcnQge1xuICBBcmd1bWVudHMsXG4gIENvbXBvbmVudENhcGFiaWxpdGllcyxcbiAgQ29tcG9uZW50Q2FwYWJpbGl0aWVzVmVyc2lvbnMsXG4gIENvbXBvbmVudERlZmluaXRpb25TdGF0ZSxcbiAgQ29tcG9uZW50TWFuYWdlcixcbiAgQ29tcG9uZW50TWFuYWdlcldpdGhBc3luY0xpZmVDeWNsZUNhbGxiYWNrcyxcbiAgQ29tcG9uZW50TWFuYWdlcldpdGhBc3luY1VwZGF0ZUhvb2ssXG4gIENvbXBvbmVudE1hbmFnZXJXaXRoRGVzdHJ1Y3RvcnMsXG4gIENvbXBvbmVudE1hbmFnZXJXaXRoVXBkYXRlSG9vayxcbiAgRGVzdHJveWFibGUsXG4gIEludGVybmFsQ29tcG9uZW50Q2FwYWJpbGl0aWVzLFxuICBJbnRlcm5hbENvbXBvbmVudE1hbmFnZXIsXG4gIE9wdGlvbixcbiAgT3duZXIsXG4gIFZNQXJndW1lbnRzLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGNyZWF0ZUNvbnN0UmVmLCBSZWZlcmVuY2UgfSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuaW1wb3J0IHsgcmVnaXN0ZXJEZXN0cnVjdG9yIH0gZnJvbSAnQGdsaW1tZXIvZGVzdHJveWFibGUnO1xuaW1wb3J0IHsgYnVpbGRDYXBhYmlsaXRpZXMsIEZST01fQ0FQQUJJTElUSUVTIH0gZnJvbSAnLi4vdXRpbC9jYXBhYmlsaXRpZXMnO1xuaW1wb3J0IHsgYXJnc1Byb3h5Rm9yIH0gZnJvbSAnLi4vdXRpbC9hcmdzLXByb3h5JztcbmltcG9ydCB7IE1hbmFnZXJGYWN0b3J5IH0gZnJvbSAnLi9pbmRleCc7XG5cbmNvbnN0IENBUEFCSUxJVElFUyA9IHtcbiAgZHluYW1pY0xheW91dDogZmFsc2UsXG4gIGR5bmFtaWNUYWc6IGZhbHNlLFxuICBwcmVwYXJlQXJnczogZmFsc2UsXG4gIGNyZWF0ZUFyZ3M6IHRydWUsXG4gIGF0dHJpYnV0ZUhvb2s6IGZhbHNlLFxuICBlbGVtZW50SG9vazogZmFsc2UsXG4gIGNyZWF0ZUNhbGxlcjogZmFsc2UsXG4gIGR5bmFtaWNTY29wZTogdHJ1ZSxcbiAgdXBkYXRlSG9vazogdHJ1ZSxcbiAgY3JlYXRlSW5zdGFuY2U6IHRydWUsXG4gIHdyYXBwZWQ6IGZhbHNlLFxuICB3aWxsRGVzdHJveTogZmFsc2UsXG4gIGhhc1N1Yk93bmVyOiBmYWxzZSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21wb25lbnRDYXBhYmlsaXRpZXM8VmVyc2lvbiBleHRlbmRzIGtleW9mIENvbXBvbmVudENhcGFiaWxpdGllc1ZlcnNpb25zPihcbiAgbWFuYWdlckFQSTogVmVyc2lvbixcbiAgb3B0aW9uczogQ29tcG9uZW50Q2FwYWJpbGl0aWVzVmVyc2lvbnNbVmVyc2lvbl0gPSB7fVxuKTogQ29tcG9uZW50Q2FwYWJpbGl0aWVzIHtcbiAgaWYgKERFQlVHICYmIG1hbmFnZXJBUEkgIT09ICczLjEzJykge1xuICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjb21wb25lbnQgbWFuYWdlciBjb21wYXRpYmlsaXR5IHNwZWNpZmllZCcpO1xuICB9XG5cbiAgbGV0IHVwZGF0ZUhvb2sgPSBCb29sZWFuKChvcHRpb25zIGFzIENvbXBvbmVudENhcGFiaWxpdGllc1ZlcnNpb25zWyczLjEzJ10pLnVwZGF0ZUhvb2spO1xuXG4gIHJldHVybiBidWlsZENhcGFiaWxpdGllcyh7XG4gICAgYXN5bmNMaWZlQ3ljbGVDYWxsYmFja3M6IEJvb2xlYW4ob3B0aW9ucy5hc3luY0xpZmVjeWNsZUNhbGxiYWNrcyksXG4gICAgZGVzdHJ1Y3RvcjogQm9vbGVhbihvcHRpb25zLmRlc3RydWN0b3IpLFxuICAgIHVwZGF0ZUhvb2ssXG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzQXN5bmNMaWZlQ3ljbGVDYWxsYmFja3M8Q29tcG9uZW50SW5zdGFuY2U+KFxuICBkZWxlZ2F0ZTogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT5cbik6IGRlbGVnYXRlIGlzIENvbXBvbmVudE1hbmFnZXJXaXRoQXN5bmNMaWZlQ3ljbGVDYWxsYmFja3M8Q29tcG9uZW50SW5zdGFuY2U+IHtcbiAgcmV0dXJuIGRlbGVnYXRlLmNhcGFiaWxpdGllcy5hc3luY0xpZmVDeWNsZUNhbGxiYWNrcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc1VwZGF0ZUhvb2s8Q29tcG9uZW50SW5zdGFuY2U+KFxuICBkZWxlZ2F0ZTogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT5cbik6IGRlbGVnYXRlIGlzIENvbXBvbmVudE1hbmFnZXJXaXRoVXBkYXRlSG9vazxDb21wb25lbnRJbnN0YW5jZT4ge1xuICByZXR1cm4gZGVsZWdhdGUuY2FwYWJpbGl0aWVzLnVwZGF0ZUhvb2s7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNBc3luY1VwZGF0ZUhvb2s8Q29tcG9uZW50SW5zdGFuY2U+KFxuICBkZWxlZ2F0ZTogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT5cbik6IGRlbGVnYXRlIGlzIENvbXBvbmVudE1hbmFnZXJXaXRoQXN5bmNVcGRhdGVIb29rPENvbXBvbmVudEluc3RhbmNlPiB7XG4gIHJldHVybiBoYXNBc3luY0xpZmVDeWNsZUNhbGxiYWNrcyhkZWxlZ2F0ZSkgJiYgaGFzVXBkYXRlSG9vayhkZWxlZ2F0ZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNEZXN0cnVjdG9yczxDb21wb25lbnRJbnN0YW5jZT4oXG4gIGRlbGVnYXRlOiBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudEluc3RhbmNlPlxuKTogZGVsZWdhdGUgaXMgQ29tcG9uZW50TWFuYWdlcldpdGhEZXN0cnVjdG9yczxDb21wb25lbnRJbnN0YW5jZT4ge1xuICByZXR1cm4gZGVsZWdhdGUuY2FwYWJpbGl0aWVzLmRlc3RydWN0b3I7XG59XG5cbi8qKlxuICBUaGUgQ3VzdG9tQ29tcG9uZW50TWFuYWdlciBhbGxvd3MgYWRkb25zIHRvIHByb3ZpZGUgY3VzdG9tIGNvbXBvbmVudFxuICBpbXBsZW1lbnRhdGlvbnMgdGhhdCBpbnRlZ3JhdGUgc2VhbWxlc3NseSBpbnRvIEVtYmVyLiBUaGlzIGlzIGFjY29tcGxpc2hlZFxuICB0aHJvdWdoIGEgZGVsZWdhdGUsIHJlZ2lzdGVyZWQgd2l0aCB0aGUgY3VzdG9tIGNvbXBvbmVudCBtYW5hZ2VyLCB3aGljaFxuICBpbXBsZW1lbnRzIGEgc2V0IG9mIGhvb2tzIHRoYXQgZGV0ZXJtaW5lIGNvbXBvbmVudCBiZWhhdmlvci5cblxuICBUbyBjcmVhdGUgYSBjdXN0b20gY29tcG9uZW50IG1hbmFnZXIsIGluc3RhbnRpYXRlIGEgbmV3IEN1c3RvbUNvbXBvbmVudE1hbmFnZXJcbiAgY2xhc3MgYW5kIHBhc3MgdGhlIGRlbGVnYXRlIGFzIHRoZSBmaXJzdCBhcmd1bWVudDpcblxuICBgYGBqc1xuICBsZXQgbWFuYWdlciA9IG5ldyBDdXN0b21Db21wb25lbnRNYW5hZ2VyKHtcbiAgICAvLyAuLi5kZWxlZ2F0ZSBpbXBsZW1lbnRhdGlvbi4uLlxuICB9KTtcbiAgYGBgXG5cbiAgIyMgRGVsZWdhdGUgSG9va3NcblxuICBUaHJvdWdob3V0IHRoZSBsaWZlY3ljbGUgb2YgYSBjb21wb25lbnQsIHRoZSBjb21wb25lbnQgbWFuYWdlciB3aWxsIGludm9rZVxuICBkZWxlZ2F0ZSBob29rcyB0aGF0IGFyZSByZXNwb25zaWJsZSBmb3Igc3VyZmFjaW5nIHRob3NlIGxpZmVjeWNsZSBjaGFuZ2VzIHRvXG4gIHRoZSBlbmQgZGV2ZWxvcGVyLlxuXG4gICogYGNyZWF0ZSgpYCAtIGludm9rZWQgd2hlbiBhIG5ldyBpbnN0YW5jZSBvZiBhIGNvbXBvbmVudCBzaG91bGQgYmUgY3JlYXRlZFxuICAqIGB1cGRhdGUoKWAgLSBpbnZva2VkIHdoZW4gdGhlIGFyZ3VtZW50cyBwYXNzZWQgdG8gYSBjb21wb25lbnQgY2hhbmdlXG4gICogYGdldENvbnRleHQoKWAgLSByZXR1cm5zIHRoZSBvYmplY3QgdGhhdCBzaG91bGQgYmVcbiovXG5leHBvcnQgY2xhc3MgQ3VzdG9tQ29tcG9uZW50TWFuYWdlcjxPIGV4dGVuZHMgT3duZXIsIENvbXBvbmVudEluc3RhbmNlPlxuICBpbXBsZW1lbnRzIEludGVybmFsQ29tcG9uZW50TWFuYWdlcjxDdXN0b21Db21wb25lbnRTdGF0ZTxDb21wb25lbnRJbnN0YW5jZT4+IHtcbiAgcHJpdmF0ZSBjb21wb25lbnRNYW5hZ2VyRGVsZWdhdGVzID0gbmV3IFdlYWtNYXA8TywgQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT4+KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBmYWN0b3J5OiBNYW5hZ2VyRmFjdG9yeTxPLCBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudEluc3RhbmNlPj4pIHt9XG5cbiAgcHJpdmF0ZSBnZXREZWxlZ2F0ZUZvcihvd25lcjogTykge1xuICAgIGxldCB7IGNvbXBvbmVudE1hbmFnZXJEZWxlZ2F0ZXMgfSA9IHRoaXM7XG4gICAgbGV0IGRlbGVnYXRlID0gY29tcG9uZW50TWFuYWdlckRlbGVnYXRlcy5nZXQob3duZXIpO1xuXG4gICAgaWYgKGRlbGVnYXRlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGxldCB7IGZhY3RvcnkgfSA9IHRoaXM7XG4gICAgICBkZWxlZ2F0ZSA9IGZhY3Rvcnkob3duZXIpO1xuXG4gICAgICBpZiAoREVCVUcgJiYgIUZST01fQ0FQQUJJTElUSUVTIS5oYXMoZGVsZWdhdGUuY2FwYWJpbGl0aWVzKSkge1xuICAgICAgICAvLyBUT0RPOiBUaGlzIGVycm9yIG1lc3NhZ2Ugc2hvdWxkIG1ha2Ugc2Vuc2UgaW4gYm90aCBFbWJlciBhbmQgR2xpbW1lciBodHRwczovL2dpdGh1Yi5jb20vZ2xpbW1lcmpzL2dsaW1tZXItdm0vaXNzdWVzLzEyMDBcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDdXN0b20gY29tcG9uZW50IG1hbmFnZXJzIG11c3QgaGF2ZSBhIFxcYGNhcGFiaWxpdGllc1xcYCBwcm9wZXJ0eSB0aGF0IGlzIHRoZSByZXN1bHQgb2YgY2FsbGluZyB0aGUgXFxgY2FwYWJpbGl0aWVzKCczLjEzJylcXGAgKGltcG9ydGVkIHZpYSBcXGBpbXBvcnQgeyBjYXBhYmlsaXRpZXMgfSBmcm9tICdAZW1iZXIvY29tcG9uZW50JztcXGApLiBSZWNlaXZlZDogXFxgJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgIGRlbGVnYXRlLmNhcGFiaWxpdGllc1xuICAgICAgICAgICl9XFxgIGZvcjogXFxgJHtkZWxlZ2F0ZX1cXGBgXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGNvbXBvbmVudE1hbmFnZXJEZWxlZ2F0ZXMuc2V0KG93bmVyLCBkZWxlZ2F0ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlbGVnYXRlO1xuICB9XG5cbiAgY3JlYXRlKFxuICAgIG93bmVyOiBPLFxuICAgIGRlZmluaXRpb246IENvbXBvbmVudERlZmluaXRpb25TdGF0ZSxcbiAgICB2bUFyZ3M6IFZNQXJndW1lbnRzXG4gICk6IEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPiB7XG4gICAgbGV0IGRlbGVnYXRlID0gdGhpcy5nZXREZWxlZ2F0ZUZvcihvd25lcik7XG4gICAgbGV0IGFyZ3MgPSBhcmdzUHJveHlGb3Iodm1BcmdzLmNhcHR1cmUoKSwgJ2NvbXBvbmVudCcpO1xuXG4gICAgbGV0IGNvbXBvbmVudDogQ29tcG9uZW50SW5zdGFuY2UgPSBkZWxlZ2F0ZS5jcmVhdGVDb21wb25lbnQoZGVmaW5pdGlvbiwgYXJncyk7XG5cbiAgICByZXR1cm4gbmV3IEN1c3RvbUNvbXBvbmVudFN0YXRlKGNvbXBvbmVudCEsIGRlbGVnYXRlLCBhcmdzKTtcbiAgfVxuXG4gIGdldERlYnVnTmFtZShkZWZpbml0aW9uOiBDb21wb25lbnREZWZpbml0aW9uU3RhdGUpOiBzdHJpbmcge1xuICAgIHJldHVybiB0eXBlb2YgZGVmaW5pdGlvbiA9PT0gJ2Z1bmN0aW9uJyA/IGRlZmluaXRpb24ubmFtZSA6IGRlZmluaXRpb24udG9TdHJpbmcoKTtcbiAgfVxuXG4gIHVwZGF0ZShidWNrZXQ6IEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPik6IHZvaWQge1xuICAgIGxldCB7IGRlbGVnYXRlIH0gPSBidWNrZXQ7XG4gICAgaWYgKGhhc1VwZGF0ZUhvb2soZGVsZWdhdGUpKSB7XG4gICAgICBsZXQgeyBjb21wb25lbnQsIGFyZ3MgfSA9IGJ1Y2tldDtcblxuICAgICAgZGVsZWdhdGUudXBkYXRlQ29tcG9uZW50KGNvbXBvbmVudCwgYXJncyk7XG4gICAgfVxuICB9XG5cbiAgZGlkQ3JlYXRlKHsgY29tcG9uZW50LCBkZWxlZ2F0ZSB9OiBDdXN0b21Db21wb25lbnRTdGF0ZTxDb21wb25lbnRJbnN0YW5jZT4pOiB2b2lkIHtcbiAgICBpZiAoaGFzQXN5bmNMaWZlQ3ljbGVDYWxsYmFja3MoZGVsZWdhdGUpKSB7XG4gICAgICBkZWxlZ2F0ZS5kaWRDcmVhdGVDb21wb25lbnQoY29tcG9uZW50KTtcbiAgICB9XG4gIH1cblxuICBkaWRVcGRhdGUoeyBjb21wb25lbnQsIGRlbGVnYXRlIH06IEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPik6IHZvaWQge1xuICAgIGlmIChoYXNBc3luY1VwZGF0ZUhvb2soZGVsZWdhdGUpKSB7XG4gICAgICBkZWxlZ2F0ZS5kaWRVcGRhdGVDb21wb25lbnQoY29tcG9uZW50KTtcbiAgICB9XG4gIH1cblxuICBkaWRSZW5kZXJMYXlvdXQoKTogdm9pZCB7fVxuXG4gIGRpZFVwZGF0ZUxheW91dCgpOiB2b2lkIHt9XG5cbiAgZ2V0U2VsZih7IGNvbXBvbmVudCwgZGVsZWdhdGUgfTogQ3VzdG9tQ29tcG9uZW50U3RhdGU8Q29tcG9uZW50SW5zdGFuY2U+KTogUmVmZXJlbmNlIHtcbiAgICByZXR1cm4gY3JlYXRlQ29uc3RSZWYoZGVsZWdhdGUuZ2V0Q29udGV4dChjb21wb25lbnQpLCAndGhpcycpO1xuICB9XG5cbiAgZ2V0RGVzdHJveWFibGUoYnVja2V0OiBDdXN0b21Db21wb25lbnRTdGF0ZTxDb21wb25lbnRJbnN0YW5jZT4pOiBPcHRpb248RGVzdHJveWFibGU+IHtcbiAgICBjb25zdCB7IGRlbGVnYXRlIH0gPSBidWNrZXQ7XG5cbiAgICBpZiAoaGFzRGVzdHJ1Y3RvcnMoZGVsZWdhdGUpKSB7XG4gICAgICBjb25zdCB7IGNvbXBvbmVudCB9ID0gYnVja2V0O1xuXG4gICAgICByZWdpc3RlckRlc3RydWN0b3IoYnVja2V0LCAoKSA9PiBkZWxlZ2F0ZS5kZXN0cm95Q29tcG9uZW50KGNvbXBvbmVudCkpO1xuICAgICAgcmV0dXJuIGJ1Y2tldDtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGdldENhcGFiaWxpdGllcygpOiBJbnRlcm5hbENvbXBvbmVudENhcGFiaWxpdGllcyB7XG4gICAgcmV0dXJuIENBUEFCSUxJVElFUztcbiAgfVxufVxuXG4vKipcbiAqIFN0b3JlcyBpbnRlcm5hbCBzdGF0ZSBhYm91dCBhIGNvbXBvbmVudCBpbnN0YW5jZSBhZnRlciBpdCdzIGJlZW4gY3JlYXRlZC5cbiAqL1xuZXhwb3J0IGNsYXNzIEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPiB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBjb21wb25lbnQ6IENvbXBvbmVudEluc3RhbmNlLFxuICAgIHB1YmxpYyBkZWxlZ2F0ZTogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT4sXG4gICAgcHVibGljIGFyZ3M6IEFyZ3VtZW50c1xuICApIHt9XG59XG4iXSwic291cmNlUm9vdCI6IiJ9