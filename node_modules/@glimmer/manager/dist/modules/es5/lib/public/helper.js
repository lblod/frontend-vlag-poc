import { associateDestroyableChild } from '@glimmer/destroyable';
import { DEBUG } from '@glimmer/env';
import { createComputeRef, createConstRef, UNDEFINED_REFERENCE } from '@glimmer/reference';
import { buildCapabilities, FROM_CAPABILITIES } from '../util/capabilities';
import { argsProxyFor } from '../util/args-proxy';
export function helperCapabilities(managerAPI, options) {
  if (options === void 0) {
    options = {};
  }

  if (DEBUG && managerAPI !== '3.23') {
    throw new Error('Invalid helper manager compatibility specified');
  }

  if (DEBUG && (!(options.hasValue || options.hasScheduledEffect) || options.hasValue && options.hasScheduledEffect)) {
    throw new Error('You must pass either the `hasValue` OR the `hasScheduledEffect` capability when defining a helper manager. Passing neither, or both, is not permitted.');
  }

  if (DEBUG && options.hasScheduledEffect) {
    throw new Error('The `hasScheduledEffect` capability has not yet been implemented for helper managers. Please pass `hasValue` instead');
  }

  return buildCapabilities({
    hasValue: Boolean(options.hasValue),
    hasDestroyable: Boolean(options.hasDestroyable),
    hasScheduledEffect: Boolean(options.hasScheduledEffect)
  });
} ////////////

export function hasValue(manager) {
  return manager.capabilities.hasValue;
}
export function hasDestroyable(manager) {
  return manager.capabilities.hasDestroyable;
} ////////////

export var CustomHelperManager = /*#__PURE__*/function () {
  function CustomHelperManager(factory) {
    this.factory = factory;
    this.helperManagerDelegates = new WeakMap();
    this.undefinedDelegate = null;
  }

  var _proto = CustomHelperManager.prototype;

  _proto.getDelegateForOwner = function getDelegateForOwner(owner) {
    var delegate = this.helperManagerDelegates.get(owner);

    if (delegate === undefined) {
      var factory = this.factory;
      delegate = factory(owner);

      if (DEBUG && !FROM_CAPABILITIES.has(delegate.capabilities)) {
        // TODO: This error message should make sense in both Ember and Glimmer https://github.com/glimmerjs/glimmer-vm/issues/1200
        throw new Error("Custom helper managers must have a `capabilities` property that is the result of calling the `capabilities('3.23')` (imported via `import { capabilities } from '@ember/helper';`). Received: `" + JSON.stringify(delegate.capabilities) + "` for: `" + delegate + "`");
      }

      this.helperManagerDelegates.set(owner, delegate);
    }

    return delegate;
  };

  _proto.getDelegateFor = function getDelegateFor(owner) {
    if (owner === undefined) {
      var undefinedDelegate = this.undefinedDelegate;

      if (undefinedDelegate === null) {
        var factory = this.factory;
        this.undefinedDelegate = undefinedDelegate = factory(undefined);
      }

      return undefinedDelegate;
    } else {
      return this.getDelegateForOwner(owner);
    }
  };

  _proto.getHelper = function getHelper(definition) {
    var _this = this;

    return function (capturedArgs, owner) {
      var _a, _b;

      var manager = _this.getDelegateFor(owner);

      var args = argsProxyFor(capturedArgs, 'helper');
      var bucket = manager.createHelper(definition, args);

      if (hasValue(manager)) {
        var cache = createComputeRef(function () {
          return manager.getValue(bucket);
        }, null, DEBUG && manager.getDebugName && manager.getDebugName(definition));

        if (hasDestroyable(manager)) {
          associateDestroyableChild(cache, manager.getDestroyable(bucket));
        }

        return cache;
      } else if (hasDestroyable(manager)) {
        var ref = createConstRef(undefined, DEBUG && ((_b = (_a = manager.getDebugName) === null || _a === void 0 ? void 0 : _a.call(manager, definition)) !== null && _b !== void 0 ? _b : 'unknown helper'));
        associateDestroyableChild(ref, manager.getDestroyable(bucket));
        return ref;
      } else {
        return UNDEFINED_REFERENCE;
      }
    };
  };

  return CustomHelperManager;
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL21hbmFnZXIvbGliL3B1YmxpYy9oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsU0FBQSx5QkFBQSxRQUFBLHNCQUFBO0FBQ0EsU0FBQSxLQUFBLFFBQUEsY0FBQTtBQVlBLFNBQUEsZ0JBQUEsRUFBQSxjQUFBLEVBQUEsbUJBQUEsUUFBQSxvQkFBQTtBQUVBLFNBQUEsaUJBQUEsRUFBQSxpQkFBQSxRQUFBLHNCQUFBO0FBQ0EsU0FBQSxZQUFBLFFBQUEsb0JBQUE7QUFHQSxPQUFNLFNBQUEsa0JBQUEsQ0FBQSxVQUFBLEVBRUosT0FGSSxFQUVxQztBQUFBLE1BQXpDLE9BQXlDO0FBQXpDLElBQUEsT0FBeUMsR0FGckMsRUFFcUM7QUFBQTs7QUFFekMsTUFBSSxLQUFLLElBQUksVUFBVSxLQUF2QixNQUFBLEVBQW9DO0FBQ2xDLFVBQU0sSUFBQSxLQUFBLENBQU4sZ0RBQU0sQ0FBTjtBQUNEOztBQUVELE1BQ0UsS0FBSyxLQUNKLEVBQUUsT0FBTyxDQUFQLFFBQUEsSUFBb0IsT0FBTyxDQUE3QixrQkFBQSxLQUNFLE9BQU8sQ0FBUCxRQUFBLElBQW9CLE9BQU8sQ0FIaEMsa0JBQ08sQ0FEUCxFQUlFO0FBQ0EsVUFBTSxJQUFBLEtBQUEsQ0FBTix3SkFBTSxDQUFOO0FBR0Q7O0FBRUQsTUFBSSxLQUFLLElBQUksT0FBTyxDQUFwQixrQkFBQSxFQUF5QztBQUN2QyxVQUFNLElBQUEsS0FBQSxDQUFOLHNIQUFNLENBQU47QUFHRDs7QUFFRCxTQUFPLGlCQUFpQixDQUFDO0FBQ3ZCLElBQUEsUUFBUSxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBREYsUUFDTixDQURNO0FBRXZCLElBQUEsY0FBYyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBRlIsY0FFQSxDQUZBO0FBR3ZCLElBQUEsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBUixrQkFBQTtBQUhKLEdBQUQsQ0FBeEI7RUFPRjs7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QUksQ0FBQSxFQUFBLEdBQUEsQ0FBQSxFQUFBLEdBQUMsT0FBTyxDQUFSLFlBQUEsTUFBQSxJQUFBLElBQXFCLEVBQUEsS0FBQSxLQUFyQixDQUFBLEdBQXFCLEtBQXJCLENBQUEsR0FBcUIsRUFBQSxDQUFBLElBQUEsQ0FBcEIsT0FBb0IsRUFBckIsVUFBcUIsQ0FBckIsTUFBQSxJQUFBLElBQWtDLEVBQUEsS0FBQSxLQUFsQyxDQUFBLEdBQUEsRUFBQSxHQUZYLGdCQUVPLENBRmlCLENBQXhCO0FBS0EsUUFBQSx5QkFBeUIsQ0FBQSxHQUFBLEVBQU0sT0FBTyxDQUFQLGNBQUEsQ0FBL0IsTUFBK0IsQ0FBTixDQUF6QjtBQUVBLGVBQUEsR0FBQTtBQVJLLE9BQUEsTUFTQTtBQUNMLGVBQUEsbUJBQUE7QUFDRDtBQTdCSCxLQUFBO0FBK0JELEdBM0VIOztBQUFBO0FBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhc3NvY2lhdGVEZXN0cm95YWJsZUNoaWxkIH0gZnJvbSAnQGdsaW1tZXIvZGVzdHJveWFibGUnO1xuaW1wb3J0IHsgREVCVUcgfSBmcm9tICdAZ2xpbW1lci9lbnYnO1xuaW1wb3J0IHtcbiAgSGVscGVyLFxuICBIZWxwZXJDYXBhYmlsaXRpZXMsXG4gIEhlbHBlckNhcGFiaWxpdGllc1ZlcnNpb25zLFxuICBIZWxwZXJEZWZpbml0aW9uU3RhdGUsXG4gIEhlbHBlck1hbmFnZXIsXG4gIEhlbHBlck1hbmFnZXJXaXRoRGVzdHJveWFibGUsXG4gIEhlbHBlck1hbmFnZXJXaXRoVmFsdWUsXG4gIEludGVybmFsSGVscGVyTWFuYWdlcixcbiAgT3duZXIsXG59IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgY3JlYXRlQ29tcHV0ZVJlZiwgY3JlYXRlQ29uc3RSZWYsIFVOREVGSU5FRF9SRUZFUkVOQ0UgfSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuXG5pbXBvcnQgeyBidWlsZENhcGFiaWxpdGllcywgRlJPTV9DQVBBQklMSVRJRVMgfSBmcm9tICcuLi91dGlsL2NhcGFiaWxpdGllcyc7XG5pbXBvcnQgeyBhcmdzUHJveHlGb3IgfSBmcm9tICcuLi91dGlsL2FyZ3MtcHJveHknO1xuaW1wb3J0IHsgTWFuYWdlckZhY3RvcnkgfSBmcm9tICcuL2luZGV4JztcblxuZXhwb3J0IGZ1bmN0aW9uIGhlbHBlckNhcGFiaWxpdGllczxWZXJzaW9uIGV4dGVuZHMga2V5b2YgSGVscGVyQ2FwYWJpbGl0aWVzVmVyc2lvbnM+KFxuICBtYW5hZ2VyQVBJOiBWZXJzaW9uLFxuICBvcHRpb25zOiBQYXJ0aWFsPEhlbHBlckNhcGFiaWxpdGllcz4gPSB7fVxuKTogSGVscGVyQ2FwYWJpbGl0aWVzIHtcbiAgaWYgKERFQlVHICYmIG1hbmFnZXJBUEkgIT09ICczLjIzJykge1xuICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBoZWxwZXIgbWFuYWdlciBjb21wYXRpYmlsaXR5IHNwZWNpZmllZCcpO1xuICB9XG5cbiAgaWYgKFxuICAgIERFQlVHICYmXG4gICAgKCEob3B0aW9ucy5oYXNWYWx1ZSB8fCBvcHRpb25zLmhhc1NjaGVkdWxlZEVmZmVjdCkgfHxcbiAgICAgIChvcHRpb25zLmhhc1ZhbHVlICYmIG9wdGlvbnMuaGFzU2NoZWR1bGVkRWZmZWN0KSlcbiAgKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgJ1lvdSBtdXN0IHBhc3MgZWl0aGVyIHRoZSBgaGFzVmFsdWVgIE9SIHRoZSBgaGFzU2NoZWR1bGVkRWZmZWN0YCBjYXBhYmlsaXR5IHdoZW4gZGVmaW5pbmcgYSBoZWxwZXIgbWFuYWdlci4gUGFzc2luZyBuZWl0aGVyLCBvciBib3RoLCBpcyBub3QgcGVybWl0dGVkLidcbiAgICApO1xuICB9XG5cbiAgaWYgKERFQlVHICYmIG9wdGlvbnMuaGFzU2NoZWR1bGVkRWZmZWN0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgJ1RoZSBgaGFzU2NoZWR1bGVkRWZmZWN0YCBjYXBhYmlsaXR5IGhhcyBub3QgeWV0IGJlZW4gaW1wbGVtZW50ZWQgZm9yIGhlbHBlciBtYW5hZ2Vycy4gUGxlYXNlIHBhc3MgYGhhc1ZhbHVlYCBpbnN0ZWFkJ1xuICAgICk7XG4gIH1cblxuICByZXR1cm4gYnVpbGRDYXBhYmlsaXRpZXMoe1xuICAgIGhhc1ZhbHVlOiBCb29sZWFuKG9wdGlvbnMuaGFzVmFsdWUpLFxuICAgIGhhc0Rlc3Ryb3lhYmxlOiBCb29sZWFuKG9wdGlvbnMuaGFzRGVzdHJveWFibGUpLFxuICAgIGhhc1NjaGVkdWxlZEVmZmVjdDogQm9vbGVhbihvcHRpb25zLmhhc1NjaGVkdWxlZEVmZmVjdCksXG4gIH0pO1xufVxuXG4vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc1ZhbHVlKFxuICBtYW5hZ2VyOiBIZWxwZXJNYW5hZ2VyPHVua25vd24+XG4pOiBtYW5hZ2VyIGlzIEhlbHBlck1hbmFnZXJXaXRoVmFsdWU8dW5rbm93bj4ge1xuICByZXR1cm4gbWFuYWdlci5jYXBhYmlsaXRpZXMuaGFzVmFsdWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNEZXN0cm95YWJsZShcbiAgbWFuYWdlcjogSGVscGVyTWFuYWdlcjx1bmtub3duPlxuKTogbWFuYWdlciBpcyBIZWxwZXJNYW5hZ2VyV2l0aERlc3Ryb3lhYmxlPHVua25vd24+IHtcbiAgcmV0dXJuIG1hbmFnZXIuY2FwYWJpbGl0aWVzLmhhc0Rlc3Ryb3lhYmxlO1xufVxuXG4vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGNsYXNzIEN1c3RvbUhlbHBlck1hbmFnZXI8TyBleHRlbmRzIE93bmVyID0gT3duZXI+IGltcGxlbWVudHMgSW50ZXJuYWxIZWxwZXJNYW5hZ2VyPE8+IHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBmYWN0b3J5OiBNYW5hZ2VyRmFjdG9yeTxPIHwgdW5kZWZpbmVkLCBIZWxwZXJNYW5hZ2VyPHVua25vd24+Pikge31cblxuICBwcml2YXRlIGhlbHBlck1hbmFnZXJEZWxlZ2F0ZXMgPSBuZXcgV2Vha01hcDxPLCBIZWxwZXJNYW5hZ2VyPHVua25vd24+PigpO1xuICBwcml2YXRlIHVuZGVmaW5lZERlbGVnYXRlOiBIZWxwZXJNYW5hZ2VyPHVua25vd24+IHwgbnVsbCA9IG51bGw7XG5cbiAgcHJpdmF0ZSBnZXREZWxlZ2F0ZUZvck93bmVyKG93bmVyOiBPKSB7XG4gICAgbGV0IGRlbGVnYXRlID0gdGhpcy5oZWxwZXJNYW5hZ2VyRGVsZWdhdGVzLmdldChvd25lcik7XG5cbiAgICBpZiAoZGVsZWdhdGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgbGV0IHsgZmFjdG9yeSB9ID0gdGhpcztcbiAgICAgIGRlbGVnYXRlID0gZmFjdG9yeShvd25lcik7XG5cbiAgICAgIGlmIChERUJVRyAmJiAhRlJPTV9DQVBBQklMSVRJRVMhLmhhcyhkZWxlZ2F0ZS5jYXBhYmlsaXRpZXMpKSB7XG4gICAgICAgIC8vIFRPRE86IFRoaXMgZXJyb3IgbWVzc2FnZSBzaG91bGQgbWFrZSBzZW5zZSBpbiBib3RoIEVtYmVyIGFuZCBHbGltbWVyIGh0dHBzOi8vZ2l0aHViLmNvbS9nbGltbWVyanMvZ2xpbW1lci12bS9pc3N1ZXMvMTIwMFxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEN1c3RvbSBoZWxwZXIgbWFuYWdlcnMgbXVzdCBoYXZlIGEgXFxgY2FwYWJpbGl0aWVzXFxgIHByb3BlcnR5IHRoYXQgaXMgdGhlIHJlc3VsdCBvZiBjYWxsaW5nIHRoZSBcXGBjYXBhYmlsaXRpZXMoJzMuMjMnKVxcYCAoaW1wb3J0ZWQgdmlhIFxcYGltcG9ydCB7IGNhcGFiaWxpdGllcyB9IGZyb20gJ0BlbWJlci9oZWxwZXInO1xcYCkuIFJlY2VpdmVkOiBcXGAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgZGVsZWdhdGUuY2FwYWJpbGl0aWVzXG4gICAgICAgICAgKX1cXGAgZm9yOiBcXGAke2RlbGVnYXRlfVxcYGBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5oZWxwZXJNYW5hZ2VyRGVsZWdhdGVzLnNldChvd25lciwgZGVsZWdhdGUpO1xuICAgIH1cblxuICAgIHJldHVybiBkZWxlZ2F0ZTtcbiAgfVxuXG4gIGdldERlbGVnYXRlRm9yKG93bmVyOiBPIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKG93bmVyID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGxldCB7IHVuZGVmaW5lZERlbGVnYXRlIH0gPSB0aGlzO1xuXG4gICAgICBpZiAodW5kZWZpbmVkRGVsZWdhdGUgPT09IG51bGwpIHtcbiAgICAgICAgbGV0IHsgZmFjdG9yeSB9ID0gdGhpcztcbiAgICAgICAgdGhpcy51bmRlZmluZWREZWxlZ2F0ZSA9IHVuZGVmaW5lZERlbGVnYXRlID0gZmFjdG9yeSh1bmRlZmluZWQpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdW5kZWZpbmVkRGVsZWdhdGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmdldERlbGVnYXRlRm9yT3duZXIob3duZXIpO1xuICAgIH1cbiAgfVxuXG4gIGdldEhlbHBlcihkZWZpbml0aW9uOiBIZWxwZXJEZWZpbml0aW9uU3RhdGUpOiBIZWxwZXIge1xuICAgIHJldHVybiAoY2FwdHVyZWRBcmdzLCBvd25lcikgPT4ge1xuICAgICAgbGV0IG1hbmFnZXIgPSB0aGlzLmdldERlbGVnYXRlRm9yKG93bmVyIGFzIE8gfCB1bmRlZmluZWQpO1xuXG4gICAgICBjb25zdCBhcmdzID0gYXJnc1Byb3h5Rm9yKGNhcHR1cmVkQXJncywgJ2hlbHBlcicpO1xuICAgICAgY29uc3QgYnVja2V0ID0gbWFuYWdlci5jcmVhdGVIZWxwZXIoZGVmaW5pdGlvbiwgYXJncyk7XG5cbiAgICAgIGlmIChoYXNWYWx1ZShtYW5hZ2VyKSkge1xuICAgICAgICBsZXQgY2FjaGUgPSBjcmVhdGVDb21wdXRlUmVmKFxuICAgICAgICAgICgpID0+IChtYW5hZ2VyIGFzIEhlbHBlck1hbmFnZXJXaXRoVmFsdWU8dW5rbm93bj4pLmdldFZhbHVlKGJ1Y2tldCksXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICBERUJVRyAmJiBtYW5hZ2VyLmdldERlYnVnTmFtZSAmJiBtYW5hZ2VyLmdldERlYnVnTmFtZShkZWZpbml0aW9uKVxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChoYXNEZXN0cm95YWJsZShtYW5hZ2VyKSkge1xuICAgICAgICAgIGFzc29jaWF0ZURlc3Ryb3lhYmxlQ2hpbGQoY2FjaGUsIG1hbmFnZXIuZ2V0RGVzdHJveWFibGUoYnVja2V0KSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY2FjaGU7XG4gICAgICB9IGVsc2UgaWYgKGhhc0Rlc3Ryb3lhYmxlKG1hbmFnZXIpKSB7XG4gICAgICAgIGxldCByZWYgPSBjcmVhdGVDb25zdFJlZihcbiAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgREVCVUcgJiYgKG1hbmFnZXIuZ2V0RGVidWdOYW1lPy4oZGVmaW5pdGlvbikgPz8gJ3Vua25vd24gaGVscGVyJylcbiAgICAgICAgKTtcblxuICAgICAgICBhc3NvY2lhdGVEZXN0cm95YWJsZUNoaWxkKHJlZiwgbWFuYWdlci5nZXREZXN0cm95YWJsZShidWNrZXQpKTtcblxuICAgICAgICByZXR1cm4gcmVmO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFVOREVGSU5FRF9SRUZFUkVOQ0U7XG4gICAgICB9XG4gICAgfTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==