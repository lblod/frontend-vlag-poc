import { DEBUG } from '@glimmer/env';
import { createConstRef } from '@glimmer/reference';
import { registerDestructor } from '@glimmer/destroyable';
import { buildCapabilities, FROM_CAPABILITIES } from '../util/capabilities';
import { argsProxyFor } from '../util/args-proxy';
const CAPABILITIES = {
  dynamicLayout: false,
  dynamicTag: false,
  prepareArgs: false,
  createArgs: true,
  attributeHook: false,
  elementHook: false,
  createCaller: false,
  dynamicScope: true,
  updateHook: true,
  createInstance: true,
  wrapped: false,
  willDestroy: false,
  hasSubOwner: false
};
export function componentCapabilities(managerAPI, options = {}) {
  if (DEBUG && managerAPI !== '3.13') {
    throw new Error('Invalid component manager compatibility specified');
  }

  let updateHook = Boolean(options.updateHook);
  return buildCapabilities({
    asyncLifeCycleCallbacks: Boolean(options.asyncLifecycleCallbacks),
    destructor: Boolean(options.destructor),
    updateHook
  });
}
export function hasAsyncLifeCycleCallbacks(delegate) {
  return delegate.capabilities.asyncLifeCycleCallbacks;
}
export function hasUpdateHook(delegate) {
  return delegate.capabilities.updateHook;
}
export function hasAsyncUpdateHook(delegate) {
  return hasAsyncLifeCycleCallbacks(delegate) && hasUpdateHook(delegate);
}
export function hasDestructors(delegate) {
  return delegate.capabilities.destructor;
}
/**
  The CustomComponentManager allows addons to provide custom component
  implementations that integrate seamlessly into Ember. This is accomplished
  through a delegate, registered with the custom component manager, which
  implements a set of hooks that determine component behavior.

  To create a custom component manager, instantiate a new CustomComponentManager
  class and pass the delegate as the first argument:

  ```js
  let manager = new CustomComponentManager({
    // ...delegate implementation...
  });
  ```

  ## Delegate Hooks

  Throughout the lifecycle of a component, the component manager will invoke
  delegate hooks that are responsible for surfacing those lifecycle changes to
  the end developer.

  * `create()` - invoked when a new instance of a component should be created
  * `update()` - invoked when the arguments passed to a component change
  * `getContext()` - returns the object that should be
*/

export class CustomComponentManager {
  constructor(factory) {
    this.factory = factory;
    this.componentManagerDelegates = new WeakMap();
  }

  getDelegateFor(owner) {
    let {
      componentManagerDelegates
    } = this;
    let delegate = componentManagerDelegates.get(owner);

    if (delegate === undefined) {
      let {
        factory
      } = this;
      delegate = factory(owner);

      if (DEBUG && !FROM_CAPABILITIES.has(delegate.capabilities)) {
        // TODO: This error message should make sense in both Ember and Glimmer https://github.com/glimmerjs/glimmer-vm/issues/1200
        throw new Error(`Custom component managers must have a \`capabilities\` property that is the result of calling the \`capabilities('3.13')\` (imported via \`import { capabilities } from '@ember/component';\`). Received: \`${JSON.stringify(delegate.capabilities)}\` for: \`${delegate}\``);
      }

      componentManagerDelegates.set(owner, delegate);
    }

    return delegate;
  }

  create(owner, definition, vmArgs) {
    let delegate = this.getDelegateFor(owner);
    let args = argsProxyFor(vmArgs.capture(), 'component');
    let component = delegate.createComponent(definition, args);
    return new CustomComponentState(component, delegate, args);
  }

  getDebugName(definition) {
    return typeof definition === 'function' ? definition.name : definition.toString();
  }

  update(bucket) {
    let {
      delegate
    } = bucket;

    if (hasUpdateHook(delegate)) {
      let {
        component,
        args
      } = bucket;
      delegate.updateComponent(component, args);
    }
  }

  didCreate({
    component,
    delegate
  }) {
    if (hasAsyncLifeCycleCallbacks(delegate)) {
      delegate.didCreateComponent(component);
    }
  }

  didUpdate({
    component,
    delegate
  }) {
    if (hasAsyncUpdateHook(delegate)) {
      delegate.didUpdateComponent(component);
    }
  }

  didRenderLayout() {}

  didUpdateLayout() {}

  getSelf({
    component,
    delegate
  }) {
    return createConstRef(delegate.getContext(component), 'this');
  }

  getDestroyable(bucket) {
    const {
      delegate
    } = bucket;

    if (hasDestructors(delegate)) {
      const {
        component
      } = bucket;
      registerDestructor(bucket, () => delegate.destroyComponent(component));
      return bucket;
    }

    return null;
  }

  getCapabilities() {
    return CAPABILITIES;
  }

}
/**
 * Stores internal state about a component instance after it's been created.
 */

export class CustomComponentState {
  constructor(component, delegate, args) {
    this.component = component;
    this.delegate = delegate;
    this.args = args;
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL21hbmFnZXIvbGliL3B1YmxpYy9jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsU0FBUyxLQUFULFFBQXNCLGNBQXRCO0FBa0JBLFNBQVMsY0FBVCxRQUEwQyxvQkFBMUM7QUFDQSxTQUFTLGtCQUFULFFBQW1DLHNCQUFuQztBQUNBLFNBQVMsaUJBQVQsRUFBNEIsaUJBQTVCLFFBQXFELHNCQUFyRDtBQUNBLFNBQVMsWUFBVCxRQUE2QixvQkFBN0I7QUFHQSxNQUFNLFlBQVksR0FBRztBQUNuQixFQUFBLGFBQWEsRUFBRSxLQURJO0FBRW5CLEVBQUEsVUFBVSxFQUFFLEtBRk87QUFHbkIsRUFBQSxXQUFXLEVBQUUsS0FITTtBQUluQixFQUFBLFVBQVUsRUFBRSxJQUpPO0FBS25CLEVBQUEsYUFBYSxFQUFFLEtBTEk7QUFNbkIsRUFBQSxXQUFXLEVBQUUsS0FOTTtBQU9uQixFQUFBLFlBQVksRUFBRSxLQVBLO0FBUW5CLEVBQUEsWUFBWSxFQUFFLElBUks7QUFTbkIsRUFBQSxVQUFVLEVBQUUsSUFUTztBQVVuQixFQUFBLGNBQWMsRUFBRSxJQVZHO0FBV25CLEVBQUEsT0FBTyxFQUFFLEtBWFU7QUFZbkIsRUFBQSxXQUFXLEVBQUUsS0FaTTtBQWFuQixFQUFBLFdBQVcsRUFBRTtBQWJNLENBQXJCO0FBZ0JBLE9BQU0sU0FBVSxxQkFBVixDQUNKLFVBREksRUFFSixPQUFBLEdBQWtELEVBRjlDLEVBRWdEO0FBRXBELE1BQUksS0FBSyxJQUFJLFVBQVUsS0FBSyxNQUE1QixFQUFvQztBQUNsQyxVQUFNLElBQUksS0FBSixDQUFVLG1EQUFWLENBQU47QUFDRDs7QUFFRCxNQUFJLFVBQVUsR0FBRyxPQUFPLENBQUUsT0FBaUQsQ0FBQyxVQUFwRCxDQUF4QjtBQUVBLFNBQU8saUJBQWlCLENBQUM7QUFDdkIsSUFBQSx1QkFBdUIsRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLHVC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QUE7QUFDTDs7QUFMMkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBERUJVRyB9IGZyb20gJ0BnbGltbWVyL2Vudic7XG5pbXBvcnQge1xuICBBcmd1bWVudHMsXG4gIENvbXBvbmVudENhcGFiaWxpdGllcyxcbiAgQ29tcG9uZW50Q2FwYWJpbGl0aWVzVmVyc2lvbnMsXG4gIENvbXBvbmVudERlZmluaXRpb25TdGF0ZSxcbiAgQ29tcG9uZW50TWFuYWdlcixcbiAgQ29tcG9uZW50TWFuYWdlcldpdGhBc3luY0xpZmVDeWNsZUNhbGxiYWNrcyxcbiAgQ29tcG9uZW50TWFuYWdlcldpdGhBc3luY1VwZGF0ZUhvb2ssXG4gIENvbXBvbmVudE1hbmFnZXJXaXRoRGVzdHJ1Y3RvcnMsXG4gIENvbXBvbmVudE1hbmFnZXJXaXRoVXBkYXRlSG9vayxcbiAgRGVzdHJveWFibGUsXG4gIEludGVybmFsQ29tcG9uZW50Q2FwYWJpbGl0aWVzLFxuICBJbnRlcm5hbENvbXBvbmVudE1hbmFnZXIsXG4gIE9wdGlvbixcbiAgT3duZXIsXG4gIFZNQXJndW1lbnRzLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGNyZWF0ZUNvbnN0UmVmLCBSZWZlcmVuY2UgfSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuaW1wb3J0IHsgcmVnaXN0ZXJEZXN0cnVjdG9yIH0gZnJvbSAnQGdsaW1tZXIvZGVzdHJveWFibGUnO1xuaW1wb3J0IHsgYnVpbGRDYXBhYmlsaXRpZXMsIEZST01fQ0FQQUJJTElUSUVTIH0gZnJvbSAnLi4vdXRpbC9jYXBhYmlsaXRpZXMnO1xuaW1wb3J0IHsgYXJnc1Byb3h5Rm9yIH0gZnJvbSAnLi4vdXRpbC9hcmdzLXByb3h5JztcbmltcG9ydCB7IE1hbmFnZXJGYWN0b3J5IH0gZnJvbSAnLi9pbmRleCc7XG5cbmNvbnN0IENBUEFCSUxJVElFUyA9IHtcbiAgZHluYW1pY0xheW91dDogZmFsc2UsXG4gIGR5bmFtaWNUYWc6IGZhbHNlLFxuICBwcmVwYXJlQXJnczogZmFsc2UsXG4gIGNyZWF0ZUFyZ3M6IHRydWUsXG4gIGF0dHJpYnV0ZUhvb2s6IGZhbHNlLFxuICBlbGVtZW50SG9vazogZmFsc2UsXG4gIGNyZWF0ZUNhbGxlcjogZmFsc2UsXG4gIGR5bmFtaWNTY29wZTogdHJ1ZSxcbiAgdXBkYXRlSG9vazogdHJ1ZSxcbiAgY3JlYXRlSW5zdGFuY2U6IHRydWUsXG4gIHdyYXBwZWQ6IGZhbHNlLFxuICB3aWxsRGVzdHJveTogZmFsc2UsXG4gIGhhc1N1Yk93bmVyOiBmYWxzZSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21wb25lbnRDYXBhYmlsaXRpZXM8VmVyc2lvbiBleHRlbmRzIGtleW9mIENvbXBvbmVudENhcGFiaWxpdGllc1ZlcnNpb25zPihcbiAgbWFuYWdlckFQSTogVmVyc2lvbixcbiAgb3B0aW9uczogQ29tcG9uZW50Q2FwYWJpbGl0aWVzVmVyc2lvbnNbVmVyc2lvbl0gPSB7fVxuKTogQ29tcG9uZW50Q2FwYWJpbGl0aWVzIHtcbiAgaWYgKERFQlVHICYmIG1hbmFnZXJBUEkgIT09ICczLjEzJykge1xuICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjb21wb25lbnQgbWFuYWdlciBjb21wYXRpYmlsaXR5IHNwZWNpZmllZCcpO1xuICB9XG5cbiAgbGV0IHVwZGF0ZUhvb2sgPSBCb29sZWFuKChvcHRpb25zIGFzIENvbXBvbmVudENhcGFiaWxpdGllc1ZlcnNpb25zWyczLjEzJ10pLnVwZGF0ZUhvb2spO1xuXG4gIHJldHVybiBidWlsZENhcGFiaWxpdGllcyh7XG4gICAgYXN5bmNMaWZlQ3ljbGVDYWxsYmFja3M6IEJvb2xlYW4ob3B0aW9ucy5hc3luY0xpZmVjeWNsZUNhbGxiYWNrcyksXG4gICAgZGVzdHJ1Y3RvcjogQm9vbGVhbihvcHRpb25zLmRlc3RydWN0b3IpLFxuICAgIHVwZGF0ZUhvb2ssXG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzQXN5bmNMaWZlQ3ljbGVDYWxsYmFja3M8Q29tcG9uZW50SW5zdGFuY2U+KFxuICBkZWxlZ2F0ZTogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT5cbik6IGRlbGVnYXRlIGlzIENvbXBvbmVudE1hbmFnZXJXaXRoQXN5bmNMaWZlQ3ljbGVDYWxsYmFja3M8Q29tcG9uZW50SW5zdGFuY2U+IHtcbiAgcmV0dXJuIGRlbGVnYXRlLmNhcGFiaWxpdGllcy5hc3luY0xpZmVDeWNsZUNhbGxiYWNrcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc1VwZGF0ZUhvb2s8Q29tcG9uZW50SW5zdGFuY2U+KFxuICBkZWxlZ2F0ZTogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT5cbik6IGRlbGVnYXRlIGlzIENvbXBvbmVudE1hbmFnZXJXaXRoVXBkYXRlSG9vazxDb21wb25lbnRJbnN0YW5jZT4ge1xuICByZXR1cm4gZGVsZWdhdGUuY2FwYWJpbGl0aWVzLnVwZGF0ZUhvb2s7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNBc3luY1VwZGF0ZUhvb2s8Q29tcG9uZW50SW5zdGFuY2U+KFxuICBkZWxlZ2F0ZTogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT5cbik6IGRlbGVnYXRlIGlzIENvbXBvbmVudE1hbmFnZXJXaXRoQXN5bmNVcGRhdGVIb29rPENvbXBvbmVudEluc3RhbmNlPiB7XG4gIHJldHVybiBoYXNBc3luY0xpZmVDeWNsZUNhbGxiYWNrcyhkZWxlZ2F0ZSkgJiYgaGFzVXBkYXRlSG9vayhkZWxlZ2F0ZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNEZXN0cnVjdG9yczxDb21wb25lbnRJbnN0YW5jZT4oXG4gIGRlbGVnYXRlOiBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudEluc3RhbmNlPlxuKTogZGVsZWdhdGUgaXMgQ29tcG9uZW50TWFuYWdlcldpdGhEZXN0cnVjdG9yczxDb21wb25lbnRJbnN0YW5jZT4ge1xuICByZXR1cm4gZGVsZWdhdGUuY2FwYWJpbGl0aWVzLmRlc3RydWN0b3I7XG59XG5cbi8qKlxuICBUaGUgQ3VzdG9tQ29tcG9uZW50TWFuYWdlciBhbGxvd3MgYWRkb25zIHRvIHByb3ZpZGUgY3VzdG9tIGNvbXBvbmVudFxuICBpbXBsZW1lbnRhdGlvbnMgdGhhdCBpbnRlZ3JhdGUgc2VhbWxlc3NseSBpbnRvIEVtYmVyLiBUaGlzIGlzIGFjY29tcGxpc2hlZFxuICB0aHJvdWdoIGEgZGVsZWdhdGUsIHJlZ2lzdGVyZWQgd2l0aCB0aGUgY3VzdG9tIGNvbXBvbmVudCBtYW5hZ2VyLCB3aGljaFxuICBpbXBsZW1lbnRzIGEgc2V0IG9mIGhvb2tzIHRoYXQgZGV0ZXJtaW5lIGNvbXBvbmVudCBiZWhhdmlvci5cblxuICBUbyBjcmVhdGUgYSBjdXN0b20gY29tcG9uZW50IG1hbmFnZXIsIGluc3RhbnRpYXRlIGEgbmV3IEN1c3RvbUNvbXBvbmVudE1hbmFnZXJcbiAgY2xhc3MgYW5kIHBhc3MgdGhlIGRlbGVnYXRlIGFzIHRoZSBmaXJzdCBhcmd1bWVudDpcblxuICBgYGBqc1xuICBsZXQgbWFuYWdlciA9IG5ldyBDdXN0b21Db21wb25lbnRNYW5hZ2VyKHtcbiAgICAvLyAuLi5kZWxlZ2F0ZSBpbXBsZW1lbnRhdGlvbi4uLlxuICB9KTtcbiAgYGBgXG5cbiAgIyMgRGVsZWdhdGUgSG9va3NcblxuICBUaHJvdWdob3V0IHRoZSBsaWZlY3ljbGUgb2YgYSBjb21wb25lbnQsIHRoZSBjb21wb25lbnQgbWFuYWdlciB3aWxsIGludm9rZVxuICBkZWxlZ2F0ZSBob29rcyB0aGF0IGFyZSByZXNwb25zaWJsZSBmb3Igc3VyZmFjaW5nIHRob3NlIGxpZmVjeWNsZSBjaGFuZ2VzIHRvXG4gIHRoZSBlbmQgZGV2ZWxvcGVyLlxuXG4gICogYGNyZWF0ZSgpYCAtIGludm9rZWQgd2hlbiBhIG5ldyBpbnN0YW5jZSBvZiBhIGNvbXBvbmVudCBzaG91bGQgYmUgY3JlYXRlZFxuICAqIGB1cGRhdGUoKWAgLSBpbnZva2VkIHdoZW4gdGhlIGFyZ3VtZW50cyBwYXNzZWQgdG8gYSBjb21wb25lbnQgY2hhbmdlXG4gICogYGdldENvbnRleHQoKWAgLSByZXR1cm5zIHRoZSBvYmplY3QgdGhhdCBzaG91bGQgYmVcbiovXG5leHBvcnQgY2xhc3MgQ3VzdG9tQ29tcG9uZW50TWFuYWdlcjxPIGV4dGVuZHMgT3duZXIsIENvbXBvbmVudEluc3RhbmNlPlxuICBpbXBsZW1lbnRzIEludGVybmFsQ29tcG9uZW50TWFuYWdlcjxDdXN0b21Db21wb25lbnRTdGF0ZTxDb21wb25lbnRJbnN0YW5jZT4+IHtcbiAgcHJpdmF0ZSBjb21wb25lbnRNYW5hZ2VyRGVsZWdhdGVzID0gbmV3IFdlYWtNYXA8TywgQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT4+KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBmYWN0b3J5OiBNYW5hZ2VyRmFjdG9yeTxPLCBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudEluc3RhbmNlPj4pIHt9XG5cbiAgcHJpdmF0ZSBnZXREZWxlZ2F0ZUZvcihvd25lcjogTykge1xuICAgIGxldCB7IGNvbXBvbmVudE1hbmFnZXJEZWxlZ2F0ZXMgfSA9IHRoaXM7XG4gICAgbGV0IGRlbGVnYXRlID0gY29tcG9uZW50TWFuYWdlckRlbGVnYXRlcy5nZXQob3duZXIpO1xuXG4gICAgaWYgKGRlbGVnYXRlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGxldCB7IGZhY3RvcnkgfSA9IHRoaXM7XG4gICAgICBkZWxlZ2F0ZSA9IGZhY3Rvcnkob3duZXIpO1xuXG4gICAgICBpZiAoREVCVUcgJiYgIUZST01fQ0FQQUJJTElUSUVTIS5oYXMoZGVsZWdhdGUuY2FwYWJpbGl0aWVzKSkge1xuICAgICAgICAvLyBUT0RPOiBUaGlzIGVycm9yIG1lc3NhZ2Ugc2hvdWxkIG1ha2Ugc2Vuc2UgaW4gYm90aCBFbWJlciBhbmQgR2xpbW1lciBodHRwczovL2dpdGh1Yi5jb20vZ2xpbW1lcmpzL2dsaW1tZXItdm0vaXNzdWVzLzEyMDBcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDdXN0b20gY29tcG9uZW50IG1hbmFnZXJzIG11c3QgaGF2ZSBhIFxcYGNhcGFiaWxpdGllc1xcYCBwcm9wZXJ0eSB0aGF0IGlzIHRoZSByZXN1bHQgb2YgY2FsbGluZyB0aGUgXFxgY2FwYWJpbGl0aWVzKCczLjEzJylcXGAgKGltcG9ydGVkIHZpYSBcXGBpbXBvcnQgeyBjYXBhYmlsaXRpZXMgfSBmcm9tICdAZW1iZXIvY29tcG9uZW50JztcXGApLiBSZWNlaXZlZDogXFxgJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgIGRlbGVnYXRlLmNhcGFiaWxpdGllc1xuICAgICAgICAgICl9XFxgIGZvcjogXFxgJHtkZWxlZ2F0ZX1cXGBgXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGNvbXBvbmVudE1hbmFnZXJEZWxlZ2F0ZXMuc2V0KG93bmVyLCBkZWxlZ2F0ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlbGVnYXRlO1xuICB9XG5cbiAgY3JlYXRlKFxuICAgIG93bmVyOiBPLFxuICAgIGRlZmluaXRpb246IENvbXBvbmVudERlZmluaXRpb25TdGF0ZSxcbiAgICB2bUFyZ3M6IFZNQXJndW1lbnRzXG4gICk6IEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPiB7XG4gICAgbGV0IGRlbGVnYXRlID0gdGhpcy5nZXREZWxlZ2F0ZUZvcihvd25lcik7XG4gICAgbGV0IGFyZ3MgPSBhcmdzUHJveHlGb3Iodm1BcmdzLmNhcHR1cmUoKSwgJ2NvbXBvbmVudCcpO1xuXG4gICAgbGV0IGNvbXBvbmVudDogQ29tcG9uZW50SW5zdGFuY2UgPSBkZWxlZ2F0ZS5jcmVhdGVDb21wb25lbnQoZGVmaW5pdGlvbiwgYXJncyk7XG5cbiAgICByZXR1cm4gbmV3IEN1c3RvbUNvbXBvbmVudFN0YXRlKGNvbXBvbmVudCEsIGRlbGVnYXRlLCBhcmdzKTtcbiAgfVxuXG4gIGdldERlYnVnTmFtZShkZWZpbml0aW9uOiBDb21wb25lbnREZWZpbml0aW9uU3RhdGUpOiBzdHJpbmcge1xuICAgIHJldHVybiB0eXBlb2YgZGVmaW5pdGlvbiA9PT0gJ2Z1bmN0aW9uJyA/IGRlZmluaXRpb24ubmFtZSA6IGRlZmluaXRpb24udG9TdHJpbmcoKTtcbiAgfVxuXG4gIHVwZGF0ZShidWNrZXQ6IEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPik6IHZvaWQge1xuICAgIGxldCB7IGRlbGVnYXRlIH0gPSBidWNrZXQ7XG4gICAgaWYgKGhhc1VwZGF0ZUhvb2soZGVsZWdhdGUpKSB7XG4gICAgICBsZXQgeyBjb21wb25lbnQsIGFyZ3MgfSA9IGJ1Y2tldDtcblxuICAgICAgZGVsZWdhdGUudXBkYXRlQ29tcG9uZW50KGNvbXBvbmVudCwgYXJncyk7XG4gICAgfVxuICB9XG5cbiAgZGlkQ3JlYXRlKHsgY29tcG9uZW50LCBkZWxlZ2F0ZSB9OiBDdXN0b21Db21wb25lbnRTdGF0ZTxDb21wb25lbnRJbnN0YW5jZT4pOiB2b2lkIHtcbiAgICBpZiAoaGFzQXN5bmNMaWZlQ3ljbGVDYWxsYmFja3MoZGVsZWdhdGUpKSB7XG4gICAgICBkZWxlZ2F0ZS5kaWRDcmVhdGVDb21wb25lbnQoY29tcG9uZW50KTtcbiAgICB9XG4gIH1cblxuICBkaWRVcGRhdGUoeyBjb21wb25lbnQsIGRlbGVnYXRlIH06IEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPik6IHZvaWQge1xuICAgIGlmIChoYXNBc3luY1VwZGF0ZUhvb2soZGVsZWdhdGUpKSB7XG4gICAgICBkZWxlZ2F0ZS5kaWRVcGRhdGVDb21wb25lbnQoY29tcG9uZW50KTtcbiAgICB9XG4gIH1cblxuICBkaWRSZW5kZXJMYXlvdXQoKTogdm9pZCB7fVxuXG4gIGRpZFVwZGF0ZUxheW91dCgpOiB2b2lkIHt9XG5cbiAgZ2V0U2VsZih7IGNvbXBvbmVudCwgZGVsZWdhdGUgfTogQ3VzdG9tQ29tcG9uZW50U3RhdGU8Q29tcG9uZW50SW5zdGFuY2U+KTogUmVmZXJlbmNlIHtcbiAgICByZXR1cm4gY3JlYXRlQ29uc3RSZWYoZGVsZWdhdGUuZ2V0Q29udGV4dChjb21wb25lbnQpLCAndGhpcycpO1xuICB9XG5cbiAgZ2V0RGVzdHJveWFibGUoYnVja2V0OiBDdXN0b21Db21wb25lbnRTdGF0ZTxDb21wb25lbnRJbnN0YW5jZT4pOiBPcHRpb248RGVzdHJveWFibGU+IHtcbiAgICBjb25zdCB7IGRlbGVnYXRlIH0gPSBidWNrZXQ7XG5cbiAgICBpZiAoaGFzRGVzdHJ1Y3RvcnMoZGVsZWdhdGUpKSB7XG4gICAgICBjb25zdCB7IGNvbXBvbmVudCB9ID0gYnVja2V0O1xuXG4gICAgICByZWdpc3RlckRlc3RydWN0b3IoYnVja2V0LCAoKSA9PiBkZWxlZ2F0ZS5kZXN0cm95Q29tcG9uZW50KGNvbXBvbmVudCkpO1xuICAgICAgcmV0dXJuIGJ1Y2tldDtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGdldENhcGFiaWxpdGllcygpOiBJbnRlcm5hbENvbXBvbmVudENhcGFiaWxpdGllcyB7XG4gICAgcmV0dXJuIENBUEFCSUxJVElFUztcbiAgfVxufVxuXG4vKipcbiAqIFN0b3JlcyBpbnRlcm5hbCBzdGF0ZSBhYm91dCBhIGNvbXBvbmVudCBpbnN0YW5jZSBhZnRlciBpdCdzIGJlZW4gY3JlYXRlZC5cbiAqL1xuZXhwb3J0IGNsYXNzIEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPiB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBjb21wb25lbnQ6IENvbXBvbmVudEluc3RhbmNlLFxuICAgIHB1YmxpYyBkZWxlZ2F0ZTogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT4sXG4gICAgcHVibGljIGFyZ3M6IEFyZ3VtZW50c1xuICApIHt9XG59XG4iXSwic291cmNlUm9vdCI6IiJ9