import { DEBUG } from '@glimmer/env';
import { debugToString } from '@glimmer/util';
import { FEATURE_DEFAULT_HELPER_MANAGER } from '@glimmer/global-context';
import { CustomHelperManager } from '../public/helper';
import { FunctionHelperManager } from './defaults';
const COMPONENT_MANAGERS = new WeakMap();
const MODIFIER_MANAGERS = new WeakMap();
const HELPER_MANAGERS = new WeakMap(); ///////////

const getPrototypeOf = Object.getPrototypeOf;

function setManager(map, manager, obj) {
  if (DEBUG && (typeof obj !== 'object' || obj === null) && typeof obj !== 'function') {
    throw new Error(`Attempted to set a manager on a non-object value. Managers can only be associated with objects or functions. Value was ${debugToString(obj)}`);
  }

  if (DEBUG && map.has(obj)) {
    throw new Error(`Attempted to set the same type of manager multiple times on a value. You can only associate one manager of each type with a given value. Value was ${debugToString(obj)}`);
  }

  map.set(obj, manager);
  return obj;
}

function getManager(map, obj) {
  let pointer = obj;

  while (pointer !== undefined && pointer !== null) {
    const manager = map.get(pointer);

    if (manager !== undefined) {
      return manager;
    }

    pointer = getPrototypeOf(pointer);
  }

  return undefined;
} ///////////


export function setInternalModifierManager(manager, definition) {
  return setManager(MODIFIER_MANAGERS, manager, definition);
}
export function getInternalModifierManager(definition, isOptional) {
  if (DEBUG && typeof definition !== 'function' && (typeof definition !== 'object' || definition === null)) {
    throw new Error(`Attempted to use a value as a modifier, but it was not an object or function. Modifier definitions must be objects or functions with an associated modifier manager. The value was: ${definition}`);
  }

  const manager = getManager(MODIFIER_MANAGERS, definition);

  if (manager === undefined) {
    if (isOptional === true) {
      return null;
    } else if (DEBUG) {
      throw new Error(`Attempted to load a modifier, but there wasn't a modifier manager associated with the definition. The definition was: ${debugToString(definition)}`);
    }
  }

  return manager;
}
export function setInternalHelperManager(manager, definition) {
  return setManager(HELPER_MANAGERS, manager, definition);
}
const DEFAULT_MANAGER = new CustomHelperManager(() => new FunctionHelperManager());
export function getInternalHelperManager(definition, isOptional) {
  if (DEBUG && typeof definition !== 'function' && (typeof definition !== 'object' || definition === null)) {
    throw new Error(`Attempted to use a value as a helper, but it was not an object or function. Helper definitions must be objects or functions with an associated helper manager. The value was: ${definition}`);
  }

  let manager = getManager(HELPER_MANAGERS, definition);

  if (FEATURE_DEFAULT_HELPER_MANAGER) {
    // Functions are special-cased because functions are defined
    // as the "default" helper, per: https://github.com/emberjs/rfcs/pull/756
    if (manager === undefined && typeof definition === 'function') {
      manager = DEFAULT_MANAGER;
    }
  }

  if (manager) {
    return manager;
  } else if (isOptional === true) {
    return null;
  } else if (DEBUG) {
    throw new Error(`Attempted to load a helper, but there wasn't a helper manager associated with the definition. The definition was: ${debugToString(definition)}`);
  }

  return null;
}
export function setInternalComponentManager(factory, obj) {
  return setManager(COMPONENT_MANAGERS, factory, obj);
}
export function getInternalComponentManager(definition, isOptional) {
  if (DEBUG && typeof definition !== 'function' && (typeof definition !== 'object' || definition === null)) {
    throw new Error(`Attempted to use a value as a component, but it was not an object or function. Component definitions must be objects or functions with an associated component manager. The value was: ${definition}`);
  }

  const manager = getManager(COMPONENT_MANAGERS, definition);

  if (manager === undefined) {
    if (isOptional === true) {
      return null;
    } else if (DEBUG) {
      throw new Error(`Attempted to load a component, but there wasn't a component manager associated with the definition. The definition was: ${debugToString(definition)}`);
    }
  }

  return manager;
} ///////////

export function hasInternalComponentManager(definition) {
  return hasDefaultComponentManager(definition) || getManager(COMPONENT_MANAGERS, definition) !== undefined;
}
export function hasInternalHelperManager(definition) {
  return hasDefaultHelperManager(definition) || getManager(HELPER_MANAGERS, definition) !== undefined;
}
export function hasInternalModifierManager(definition) {
  return hasDefaultModifierManager(definition) || getManager(MODIFIER_MANAGERS, definition) !== undefined;
}

function hasDefaultComponentManager(_definition) {
  return false;
}

function hasDefaultHelperManager(definition) {
  if (FEATURE_DEFAULT_HELPER_MANAGER) {
    return typeof definition === 'function';
  }

  return false;
}

function hasDefaultModifierManager(_definition) {
  return false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL21hbmFnZXIvbGliL2ludGVybmFsL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFNBQVMsS0FBVCxRQUFzQixjQUF0QjtBQUNBLFNBQVMsYUFBVCxRQUF3QyxlQUF4QztBQUNBLFNBQVMsOEJBQVQsUUFBK0MseUJBQS9DO0FBT0EsU0FBUyxtQkFBVCxRQUFvQyxrQkFBcEM7QUFDQSxTQUFTLHFCQUFULFFBQXNDLFlBQXRDO0FBUUEsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLE9BQUosRUFBM0I7QUFFQSxNQUFNLGlCQUFpQixHQUFHLElBQUksT0FBSixFQUExQjtBQUVBLE1BQU0sZUFBZSxHQUFHLElBQUksT0FBSixFQUF4QixDLENBRUE7O0FBRUEsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLGNBQTlCOztBQUVBLFNBQVMsVUFBVCxDQUNFLEdBREYsRUFFRSxPQUZGLEVBR0UsR0FIRixFQUdVO0FBRVIsTUFBSSxLQUFLLEtBQUssT0FBTyxHQUFQLEtBQWUsUUFBZixJQUEyQixHQUFHLEtBQUssSUFBeEMsQ0FBTCxJQUFzRCxPQUFPLEdBQVAsS0FBZSxVQUF6RSxFQUFxRjtBQUNuRixVQUFNLElBQUksS0FBSixDQUNKLDBIQUEwSCxhQUFjLENBQ3RJLEdBRHNJLENBRXZJLEVBSEcsQ0FBTjtBQUtEOztBQUVELE1BQUksS0FBSyxJQUFJLEdBQUcsQ0FBQyxHQUFKLENBQVEsR0FBUixDQUFiLEVBQTJCO0FBQ3pCLFVBQU0sSUFBSSxLQUFKLENBQ0osc0pBQXNKLGFBQWMsQ0FDbEssR0FEa0ssQ0FFbkssRUFIRyxDQUFOO0FBS0Q7O0FBRUQsRUFBQSxHQUFHLENBQUMsR0FBSixDQUFRLEdBQVIsRUFBYSxPQUFiO0FBQ0EsU0FBTyxHQUFQO0FBQ0Q7O0FBRUQsU0FBUyxVQUFULENBQ0UsR0FERixFQUVFLEdBRkYsRUFFYTtBQUVYLE1BQUksT0FBTyxHQUFHLEdBQWQ7O0FBQ0EsU0FB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TyxLQUFQO0FBQ0Q7O0FBRUQsU0FBUyx5QkFBVCxDQUFtQyxXQUFuQyxFQUFzRDtBQUNwRCxTQUFPLEtBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERFQlVHIH0gZnJvbSAnQGdsaW1tZXIvZW52JztcbmltcG9ydCB7IGRlYnVnVG9TdHJpbmcsIF9XZWFrU2V0IH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBGRUFUVVJFX0RFRkFVTFRfSEVMUEVSX01BTkFHRVIgfSBmcm9tICdAZ2xpbW1lci9nbG9iYWwtY29udGV4dCc7XG5pbXBvcnQge1xuICBJbnRlcm5hbENvbXBvbmVudE1hbmFnZXIsXG4gIEludGVybmFsTW9kaWZpZXJNYW5hZ2VyLFxuICBIZWxwZXIsXG4gIE93bmVyLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IEN1c3RvbUhlbHBlck1hbmFnZXIgfSBmcm9tICcuLi9wdWJsaWMvaGVscGVyJztcbmltcG9ydCB7IEZ1bmN0aW9uSGVscGVyTWFuYWdlciB9IGZyb20gJy4vZGVmYXVsdHMnO1xuXG50eXBlIEludGVybmFsTWFuYWdlciA9XG4gIHwgSW50ZXJuYWxDb21wb25lbnRNYW5hZ2VyXG4gIHwgSW50ZXJuYWxNb2RpZmllck1hbmFnZXJcbiAgfCBDdXN0b21IZWxwZXJNYW5hZ2VyXG4gIHwgSGVscGVyO1xuXG5jb25zdCBDT01QT05FTlRfTUFOQUdFUlMgPSBuZXcgV2Vha01hcDxvYmplY3QsIEludGVybmFsQ29tcG9uZW50TWFuYWdlcj4oKTtcblxuY29uc3QgTU9ESUZJRVJfTUFOQUdFUlMgPSBuZXcgV2Vha01hcDxvYmplY3QsIEludGVybmFsTW9kaWZpZXJNYW5hZ2VyPigpO1xuXG5jb25zdCBIRUxQRVJfTUFOQUdFUlMgPSBuZXcgV2Vha01hcDxvYmplY3QsIEN1c3RvbUhlbHBlck1hbmFnZXIgfCBIZWxwZXI+KCk7XG5cbi8vLy8vLy8vLy8vXG5cbmNvbnN0IGdldFByb3RvdHlwZU9mID0gT2JqZWN0LmdldFByb3RvdHlwZU9mO1xuXG5mdW5jdGlvbiBzZXRNYW5hZ2VyPERlZiBleHRlbmRzIG9iamVjdD4oXG4gIG1hcDogV2Vha01hcDxvYmplY3QsIG9iamVjdD4sXG4gIG1hbmFnZXI6IG9iamVjdCxcbiAgb2JqOiBEZWZcbik6IERlZiB7XG4gIGlmIChERUJVRyAmJiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcgfHwgb2JqID09PSBudWxsKSAmJiB0eXBlb2Ygb2JqICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYEF0dGVtcHRlZCB0byBzZXQgYSBtYW5hZ2VyIG9uIGEgbm9uLW9iamVjdCB2YWx1ZS4gTWFuYWdlcnMgY2FuIG9ubHkgYmUgYXNzb2NpYXRlZCB3aXRoIG9iamVjdHMgb3IgZnVuY3Rpb25zLiBWYWx1ZSB3YXMgJHtkZWJ1Z1RvU3RyaW5nIShcbiAgICAgICAgb2JqXG4gICAgICApfWBcbiAgICApO1xuICB9XG5cbiAgaWYgKERFQlVHICYmIG1hcC5oYXMob2JqKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBBdHRlbXB0ZWQgdG8gc2V0IHRoZSBzYW1lIHR5cGUgb2YgbWFuYWdlciBtdWx0aXBsZSB0aW1lcyBvbiBhIHZhbHVlLiBZb3UgY2FuIG9ubHkgYXNzb2NpYXRlIG9uZSBtYW5hZ2VyIG9mIGVhY2ggdHlwZSB3aXRoIGEgZ2l2ZW4gdmFsdWUuIFZhbHVlIHdhcyAke2RlYnVnVG9TdHJpbmchKFxuICAgICAgICBvYmpcbiAgICAgICl9YFxuICAgICk7XG4gIH1cblxuICBtYXAuc2V0KG9iaiwgbWFuYWdlcik7XG4gIHJldHVybiBvYmo7XG59XG5cbmZ1bmN0aW9uIGdldE1hbmFnZXI8TSBleHRlbmRzIEludGVybmFsTWFuYWdlcj4oXG4gIG1hcDogV2Vha01hcDxvYmplY3QsIE0+LFxuICBvYmo6IG9iamVjdFxuKTogTSB8IHVuZGVmaW5lZCB7XG4gIGxldCBwb2ludGVyID0gb2JqO1xuICB3aGlsZSAocG9pbnRlciAhPT0gdW5kZWZpbmVkICYmIHBvaW50ZXIgIT09IG51bGwpIHtcbiAgICBjb25zdCBtYW5hZ2VyID0gbWFwLmdldChwb2ludGVyKTtcblxuICAgIGlmIChtYW5hZ2VyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBtYW5hZ2VyO1xuICAgIH1cblxuICAgIHBvaW50ZXIgPSBnZXRQcm90b3R5cGVPZihwb2ludGVyKTtcbiAgfVxuXG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cbi8vLy8vLy8vLy8vXG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRJbnRlcm5hbE1vZGlmaWVyTWFuYWdlcjxUIGV4dGVuZHMgb2JqZWN0PihcbiAgbWFuYWdlcjogSW50ZXJuYWxNb2RpZmllck1hbmFnZXIsXG4gIGRlZmluaXRpb246IFRcbik6IFQge1xuICByZXR1cm4gc2V0TWFuYWdlcihNT0RJRklFUl9NQU5BR0VSUywgbWFuYWdlciwgZGVmaW5pdGlvbik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRJbnRlcm5hbE1vZGlmaWVyTWFuYWdlcihkZWZpbml0aW9uOiBvYmplY3QpOiBJbnRlcm5hbE1vZGlmaWVyTWFuYWdlcjtcbmV4cG9ydCBmdW5jdGlvbiBnZXRJbnRlcm5hbE1vZGlmaWVyTWFuYWdlcihcbiAgZGVmaW5pdGlvbjogb2JqZWN0LFxuICBpc09wdGlvbmFsOiB0cnVlIHwgdW5kZWZpbmVkXG4pOiBJbnRlcm5hbE1vZGlmaWVyTWFuYWdlciB8IG51bGw7XG5leHBvcnQgZnVuY3Rpb24gZ2V0SW50ZXJuYWxNb2RpZmllck1hbmFnZXIoXG4gIGRlZmluaXRpb246IG9iamVjdCxcbiAgaXNPcHRpb25hbD86IHRydWUgfCB1bmRlZmluZWRcbik6IEludGVybmFsTW9kaWZpZXJNYW5hZ2VyIHwgbnVsbCB7XG4gIGlmIChcbiAgICBERUJVRyAmJlxuICAgIHR5cGVvZiBkZWZpbml0aW9uICE9PSAnZnVuY3Rpb24nICYmXG4gICAgKHR5cGVvZiBkZWZpbml0aW9uICE9PSAnb2JqZWN0JyB8fCBkZWZpbml0aW9uID09PSBudWxsKVxuICApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgQXR0ZW1wdGVkIHRvIHVzZSBhIHZhbHVlIGFzIGEgbW9kaWZpZXIsIGJ1dCBpdCB3YXMgbm90IGFuIG9iamVjdCBvciBmdW5jdGlvbi4gTW9kaWZpZXIgZGVmaW5pdGlvbnMgbXVzdCBiZSBvYmplY3RzIG9yIGZ1bmN0aW9ucyB3aXRoIGFuIGFzc29jaWF0ZWQgbW9kaWZpZXIgbWFuYWdlci4gVGhlIHZhbHVlIHdhczogJHtkZWZpbml0aW9ufWBcbiAgICApO1xuICB9XG5cbiAgY29uc3QgbWFuYWdlciA9IGdldE1hbmFnZXIoTU9ESUZJRVJfTUFOQUdFUlMsIGRlZmluaXRpb24pITtcblxuICBpZiAobWFuYWdlciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKGlzT3B0aW9uYWwgPT09IHRydWUpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH0gZWxzZSBpZiAoREVCVUcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEF0dGVtcHRlZCB0byBsb2FkIGEgbW9kaWZpZXIsIGJ1dCB0aGVyZSB3YXNuJ3QgYSBtb2RpZmllciBtYW5hZ2VyIGFzc29jaWF0ZWQgd2l0aCB0aGUgZGVmaW5pdGlvbi4gVGhlIGRlZmluaXRpb24gd2FzOiAke2RlYnVnVG9TdHJpbmchKFxuICAgICAgICAgIGRlZmluaXRpb25cbiAgICAgICAgKX1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBtYW5hZ2VyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0SW50ZXJuYWxIZWxwZXJNYW5hZ2VyPFQgZXh0ZW5kcyBvYmplY3QsIE8gZXh0ZW5kcyBPd25lcj4oXG4gIG1hbmFnZXI6IEN1c3RvbUhlbHBlck1hbmFnZXI8Tz4gfCBIZWxwZXI8Tz4sXG4gIGRlZmluaXRpb246IFRcbik6IFQge1xuICByZXR1cm4gc2V0TWFuYWdlcihIRUxQRVJfTUFOQUdFUlMsIG1hbmFnZXIsIGRlZmluaXRpb24pO1xufVxuXG5jb25zdCBERUZBVUxUX01BTkFHRVIgPSBuZXcgQ3VzdG9tSGVscGVyTWFuYWdlcigoKSA9PiBuZXcgRnVuY3Rpb25IZWxwZXJNYW5hZ2VyKCkpO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0SW50ZXJuYWxIZWxwZXJNYW5hZ2VyKGRlZmluaXRpb246IG9iamVjdCk6IEN1c3RvbUhlbHBlck1hbmFnZXIgfCBIZWxwZXI7XG5leHBvcnQgZnVuY3Rpb24gZ2V0SW50ZXJuYWxIZWxwZXJNYW5hZ2VyKFxuICBkZWZpbml0aW9uOiBvYmplY3QsXG4gIGlzT3B0aW9uYWw6IHRydWUgfCB1bmRlZmluZWRcbik6IEN1c3RvbUhlbHBlck1hbmFnZXIgfCBIZWxwZXIgfCBudWxsO1xuZXhwb3J0IGZ1bmN0aW9uIGdldEludGVybmFsSGVscGVyTWFuYWdlcihcbiAgZGVmaW5pdGlvbjogb2JqZWN0LFxuICBpc09wdGlvbmFsPzogdHJ1ZSB8IHVuZGVmaW5lZFxuKTogQ3VzdG9tSGVscGVyTWFuYWdlciB8IEhlbHBlciB8IG51bGwge1xuICBpZiAoXG4gICAgREVCVUcgJiZcbiAgICB0eXBlb2YgZGVmaW5pdGlvbiAhPT0gJ2Z1bmN0aW9uJyAmJlxuICAgICh0eXBlb2YgZGVmaW5pdGlvbiAhPT0gJ29iamVjdCcgfHwgZGVmaW5pdGlvbiA9PT0gbnVsbClcbiAgKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYEF0dGVtcHRlZCB0byB1c2UgYSB2YWx1ZSBhcyBhIGhlbHBlciwgYnV0IGl0IHdhcyBub3QgYW4gb2JqZWN0IG9yIGZ1bmN0aW9uLiBIZWxwZXIgZGVmaW5pdGlvbnMgbXVzdCBiZSBvYmplY3RzIG9yIGZ1bmN0aW9ucyB3aXRoIGFuIGFzc29jaWF0ZWQgaGVscGVyIG1hbmFnZXIuIFRoZSB2YWx1ZSB3YXM6ICR7ZGVmaW5pdGlvbn1gXG4gICAgKTtcbiAgfVxuXG4gIGxldCBtYW5hZ2VyID0gZ2V0TWFuYWdlcihIRUxQRVJfTUFOQUdFUlMsIGRlZmluaXRpb24pO1xuXG4gIGlmIChGRUFUVVJFX0RFRkFVTFRfSEVMUEVSX01BTkFHRVIpIHtcbiAgICAvLyBGdW5jdGlvbnMgYXJlIHNwZWNpYWwtY2FzZWQgYmVjYXVzZSBmdW5jdGlvbnMgYXJlIGRlZmluZWRcbiAgICAvLyBhcyB0aGUgXCJkZWZhdWx0XCIgaGVscGVyLCBwZXI6IGh0dHBzOi8vZ2l0aHViLmNvbS9lbWJlcmpzL3JmY3MvcHVsbC83NTZcbiAgICBpZiAobWFuYWdlciA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiBkZWZpbml0aW9uID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBtYW5hZ2VyID0gREVGQVVMVF9NQU5BR0VSO1xuICAgIH1cbiAgfVxuXG4gIGlmIChtYW5hZ2VyKSB7XG4gICAgcmV0dXJuIG1hbmFnZXI7XG4gIH0gZWxzZSBpZiAoaXNPcHRpb25hbCA9PT0gdHJ1ZSkge1xuICAgIHJldHVybiBudWxsO1xuICB9IGVsc2UgaWYgKERFQlVHKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYEF0dGVtcHRlZCB0byBsb2FkIGEgaGVscGVyLCBidXQgdGhlcmUgd2Fzbid0IGEgaGVscGVyIG1hbmFnZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBkZWZpbml0aW9uLiBUaGUgZGVmaW5pdGlvbiB3YXM6ICR7ZGVidWdUb1N0cmluZyEoXG4gICAgICAgIGRlZmluaXRpb25cbiAgICAgICl9YFxuICAgICk7XG4gIH1cblxuICByZXR1cm4gbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldEludGVybmFsQ29tcG9uZW50TWFuYWdlcjxUIGV4dGVuZHMgb2JqZWN0PihcbiAgZmFjdG9yeTogSW50ZXJuYWxDb21wb25lbnRNYW5hZ2VyLFxuICBvYmo6IFRcbik6IFQge1xuICByZXR1cm4gc2V0TWFuYWdlcihDT01QT05FTlRfTUFOQUdFUlMsIGZhY3RvcnksIG9iaik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRJbnRlcm5hbENvbXBvbmVudE1hbmFnZXIoZGVmaW5pdGlvbjogb2JqZWN0KTogSW50ZXJuYWxDb21wb25lbnRNYW5hZ2VyO1xuZXhwb3J0IGZ1bmN0aW9uIGdldEludGVybmFsQ29tcG9uZW50TWFuYWdlcihcbiAgZGVmaW5pdGlvbjogb2JqZWN0LFxuICBpc09wdGlvbmFsOiB0cnVlIHwgdW5kZWZpbmVkXG4pOiBJbnRlcm5hbENvbXBvbmVudE1hbmFnZXIgfCBudWxsO1xuZXhwb3J0IGZ1bmN0aW9uIGdldEludGVybmFsQ29tcG9uZW50TWFuYWdlcihcbiAgZGVmaW5pdGlvbjogb2JqZWN0LFxuICBpc09wdGlvbmFsPzogdHJ1ZSB8IHVuZGVmaW5lZFxuKTogSW50ZXJuYWxDb21wb25lbnRNYW5hZ2VyIHwgbnVsbCB7XG4gIGlmIChcbiAgICBERUJVRyAmJlxuICAgIHR5cGVvZiBkZWZpbml0aW9uICE9PSAnZnVuY3Rpb24nICYmXG4gICAgKHR5cGVvZiBkZWZpbml0aW9uICE9PSAnb2JqZWN0JyB8fCBkZWZpbml0aW9uID09PSBudWxsKVxuICApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgQXR0ZW1wdGVkIHRvIHVzZSBhIHZhbHVlIGFzIGEgY29tcG9uZW50LCBidXQgaXQgd2FzIG5vdCBhbiBvYmplY3Qgb3IgZnVuY3Rpb24uIENvbXBvbmVudCBkZWZpbml0aW9ucyBtdXN0IGJlIG9iamVjdHMgb3IgZnVuY3Rpb25zIHdpdGggYW4gYXNzb2NpYXRlZCBjb21wb25lbnQgbWFuYWdlci4gVGhlIHZhbHVlIHdhczogJHtkZWZpbml0aW9ufWBcbiAgICApO1xuICB9XG5cbiAgY29uc3QgbWFuYWdlciA9IGdldE1hbmFnZXIoQ09NUE9ORU5UX01BTkFHRVJTLCBkZWZpbml0aW9uKSE7XG5cbiAgaWYgKG1hbmFnZXIgPT09IHVuZGVmaW5lZCkge1xuICAgIGlmIChpc09wdGlvbmFsID09PSB0cnVlKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9IGVsc2UgaWYgKERFQlVHKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBBdHRlbXB0ZWQgdG8gbG9hZCBhIGNvbXBvbmVudCwgYnV0IHRoZXJlIHdhc24ndCBhIGNvbXBvbmVudCBtYW5hZ2VyIGFzc29jaWF0ZWQgd2l0aCB0aGUgZGVmaW5pdGlvbi4gVGhlIGRlZmluaXRpb24gd2FzOiAke2RlYnVnVG9TdHJpbmchKFxuICAgICAgICAgIGRlZmluaXRpb25cbiAgICAgICAgKX1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBtYW5hZ2VyO1xufVxuXG4vLy8vLy8vLy8vL1xuXG5leHBvcnQgZnVuY3Rpb24gaGFzSW50ZXJuYWxDb21wb25lbnRNYW5hZ2VyKGRlZmluaXRpb246IG9iamVjdCk6IGJvb2xlYW4ge1xuICByZXR1cm4gKFxuICAgIGhhc0RlZmF1bHRDb21wb25lbnRNYW5hZ2VyKGRlZmluaXRpb24pIHx8XG4gICAgZ2V0TWFuYWdlcihDT01QT05FTlRfTUFOQUdFUlMsIGRlZmluaXRpb24pICE9PSB1bmRlZmluZWRcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc0ludGVybmFsSGVscGVyTWFuYWdlcihkZWZpbml0aW9uOiBvYmplY3QpOiBib29sZWFuIHtcbiAgcmV0dXJuIChcbiAgICBoYXNEZWZhdWx0SGVscGVyTWFuYWdlcihkZWZpbml0aW9uKSB8fCBnZXRNYW5hZ2VyKEhFTFBFUl9NQU5BR0VSUywgZGVmaW5pdGlvbikgIT09IHVuZGVmaW5lZFxuICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzSW50ZXJuYWxNb2RpZmllck1hbmFnZXIoZGVmaW5pdGlvbjogb2JqZWN0KTogYm9vbGVhbiB7XG4gIHJldHVybiAoXG4gICAgaGFzRGVmYXVsdE1vZGlmaWVyTWFuYWdlcihkZWZpbml0aW9uKSB8fCBnZXRNYW5hZ2VyKE1PRElGSUVSX01BTkFHRVJTLCBkZWZpbml0aW9uKSAhPT0gdW5kZWZpbmVkXG4gICk7XG59XG5cbmZ1bmN0aW9uIGhhc0RlZmF1bHRDb21wb25lbnRNYW5hZ2VyKF9kZWZpbml0aW9uOiBvYmplY3QpOiBib29sZWFuIHtcbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5mdW5jdGlvbiBoYXNEZWZhdWx0SGVscGVyTWFuYWdlcihkZWZpbml0aW9uOiBvYmplY3QpOiBib29sZWFuIHtcbiAgaWYgKEZFQVRVUkVfREVGQVVMVF9IRUxQRVJfTUFOQUdFUikge1xuICAgIHJldHVybiB0eXBlb2YgZGVmaW5pdGlvbiA9PT0gJ2Z1bmN0aW9uJztcbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gaGFzRGVmYXVsdE1vZGlmaWVyTWFuYWdlcihfZGVmaW5pdGlvbjogb2JqZWN0KTogYm9vbGVhbiB7XG4gIHJldHVybiBmYWxzZTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=