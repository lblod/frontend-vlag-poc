"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.componentCapabilities = componentCapabilities;
exports.hasAsyncLifeCycleCallbacks = hasAsyncLifeCycleCallbacks;
exports.hasUpdateHook = hasUpdateHook;
exports.hasAsyncUpdateHook = hasAsyncUpdateHook;
exports.hasDestructors = hasDestructors;
exports.CustomComponentState = exports.CustomComponentManager = void 0;

var _env = require("@glimmer/env");

var _reference = require("@glimmer/reference");

var _destroyable = require("@glimmer/destroyable");

var _capabilities = require("../util/capabilities");

var _argsProxy = require("../util/args-proxy");

const CAPABILITIES = {
  dynamicLayout: false,
  dynamicTag: false,
  prepareArgs: false,
  createArgs: true,
  attributeHook: false,
  elementHook: false,
  createCaller: false,
  dynamicScope: true,
  updateHook: true,
  createInstance: true,
  wrapped: false,
  willDestroy: false,
  hasSubOwner: false
};

function componentCapabilities(managerAPI, options = {}) {
  if (_env.DEBUG && managerAPI !== '3.13') {
    throw new Error('Invalid component manager compatibility specified');
  }

  let updateHook = Boolean(options.updateHook);
  return (0, _capabilities.buildCapabilities)({
    asyncLifeCycleCallbacks: Boolean(options.asyncLifecycleCallbacks),
    destructor: Boolean(options.destructor),
    updateHook
  });
}

function hasAsyncLifeCycleCallbacks(delegate) {
  return delegate.capabilities.asyncLifeCycleCallbacks;
}

function hasUpdateHook(delegate) {
  return delegate.capabilities.updateHook;
}

function hasAsyncUpdateHook(delegate) {
  return hasAsyncLifeCycleCallbacks(delegate) && hasUpdateHook(delegate);
}

function hasDestructors(delegate) {
  return delegate.capabilities.destructor;
}
/**
  The CustomComponentManager allows addons to provide custom component
  implementations that integrate seamlessly into Ember. This is accomplished
  through a delegate, registered with the custom component manager, which
  implements a set of hooks that determine component behavior.

  To create a custom component manager, instantiate a new CustomComponentManager
  class and pass the delegate as the first argument:

  ```js
  let manager = new CustomComponentManager({
    // ...delegate implementation...
  });
  ```

  ## Delegate Hooks

  Throughout the lifecycle of a component, the component manager will invoke
  delegate hooks that are responsible for surfacing those lifecycle changes to
  the end developer.

  * `create()` - invoked when a new instance of a component should be created
  * `update()` - invoked when the arguments passed to a component change
  * `getContext()` - returns the object that should be
*/


class CustomComponentManager {
  constructor(factory) {
    this.factory = factory;
    this.componentManagerDelegates = new WeakMap();
  }

  getDelegateFor(owner) {
    let {
      componentManagerDelegates
    } = this;
    let delegate = componentManagerDelegates.get(owner);

    if (delegate === undefined) {
      let {
        factory
      } = this;
      delegate = factory(owner);

      if (_env.DEBUG && !_capabilities.FROM_CAPABILITIES.has(delegate.capabilities)) {
        // TODO: This error message should make sense in both Ember and Glimmer https://github.com/glimmerjs/glimmer-vm/issues/1200
        throw new Error(`Custom component managers must have a \`capabilities\` property that is the result of calling the \`capabilities('3.13')\` (imported via \`import { capabilities } from '@ember/component';\`). Received: \`${JSON.stringify(delegate.capabilities)}\` for: \`${delegate}\``);
      }

      componentManagerDelegates.set(owner, delegate);
    }

    return delegate;
  }

  create(owner, definition, vmArgs) {
    let delegate = this.getDelegateFor(owner);
    let args = (0, _argsProxy.argsProxyFor)(vmArgs.capture(), 'component');
    let component = delegate.createComponent(definition, args);
    return new CustomComponentState(component, delegate, args);
  }

  getDebugName(definition) {
    return typeof definition === 'function' ? definition.name : definition.toString();
  }

  update(bucket) {
    let {
      delegate
    } = bucket;

    if (hasUpdateHook(delegate)) {
      let {
        component,
        args
      } = bucket;
      delegate.updateComponent(component, args);
    }
  }

  didCreate({
    component,
    delegate
  }) {
    if (hasAsyncLifeCycleCallbacks(delegate)) {
      delegate.didCreateComponent(component);
    }
  }

  didUpdate({
    component,
    delegate
  }) {
    if (hasAsyncUpdateHook(delegate)) {
      delegate.didUpdateComponent(component);
    }
  }

  didRenderLayout() {}

  didUpdateLayout() {}

  getSelf({
    component,
    delegate
  }) {
    return (0, _reference.createConstRef)(delegate.getContext(component), 'this');
  }

  getDestroyable(bucket) {
    const {
      delegate
    } = bucket;

    if (hasDestructors(delegate)) {
      const {
        component
      } = bucket;
      (0, _destroyable.registerDestructor)(bucket, () => delegate.destroyComponent(component));
      return bucket;
    }

    return null;
  }

  getCapabilities() {
    return CAPABILITIES;
  }

}
/**
 * Stores internal state about a component instance after it's been created.
 */


exports.CustomComponentManager = CustomComponentManager;

class CustomComponentState {
  constructor(component, delegate, args) {
    this.component = component;
    this.delegate = delegate;
    this.args = args;
  }

}

exports.CustomComponentState = CustomComponentState;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL21hbmFnZXIvbGliL3B1YmxpYy9jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUE7O0FBa0JBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU0sWUFBWSxHQUFHO0FBQ25CLEVBQUEsYUFBYSxFQURNLEtBQUE7QUFFbkIsRUFBQSxVQUFVLEVBRlMsS0FBQTtBQUduQixFQUFBLFdBQVcsRUFIUSxLQUFBO0FBSW5CLEVBQUEsVUFBVSxFQUpTLElBQUE7QUFLbkIsRUFBQSxhQUFhLEVBTE0sS0FBQTtBQU1uQixFQUFBLFdBQVcsRUFOUSxLQUFBO0FBT25CLEVBQUEsWUFBWSxFQVBPLEtBQUE7QUFRbkIsRUFBQSxZQUFZLEVBUk8sSUFBQTtBQVNuQixFQUFBLFVBQVUsRUFUUyxJQUFBO0FBVW5CLEVBQUEsY0FBYyxFQVZLLElBQUE7QUFXbkIsRUFBQSxPQUFPLEVBWFksS0FBQTtBQVluQixFQUFBLFdBQVcsRUFaUSxLQUFBO0FBYW5CLEVBQUEsV0FBVyxFQUFFO0FBYk0sQ0FBckI7O0FBZ0JNLFNBQUEscUJBQUEsQ0FBQSxVQUFBLEVBRUosT0FBQSxHQUZJLEVBQUEsRUFFZ0Q7QUFFcEQsTUFBSSxjQUFTLFVBQVUsS0FBdkIsTUFBQSxFQUFvQztBQUNsQyxVQUFNLElBQUEsS0FBQSxDQUFOLG1EQUFNLENBQU47QUFDRDs7QUFFRCxNQUFJLFVBQVUsR0FBRyxPQUFPLENBQUUsT0FBaUQsQ0FBM0UsVUFBd0IsQ0FBeEI7QUFFQSxTQUFPLHFDQUFrQjtBQUN2QixJQUFBLHVCQUF1QixFQUFFLE9BQU8sQ0FBQyxPQUFPLENBRGpCLHVCQUNTLENBRFQ7QUFFdkIsSUFBQSxVQUFVLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FGSixVQUVKLENBRkk7QUFHdkIsSUFBQTtBQUh1QixHQUFsQixDQUFQO0FBS0Q7O0FBRUssU0FBQSwwQkFBQSxDQUFBLFFBQUEsRUFDeUM7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QUNoQyxNQUFBLFFBQVEsQ0FBUixrQkFBQSxDQUFBLFNBQUE7QUFDRDtBQUNGOztBQUVELEVBQUEsZUFBZSxHQUFBLENBQVc7O0FBRTFCLEVBQUEsZUFBZSxHQUFBLENBQVc7O0FBRTFCLEVBQUEsT0FBTyxDQUFDO0FBQUEsSUFBQSxTQUFBO0FBQWEsSUFBQTtBQUFiLEdBQUQsRUFBaUU7QUFDdEUsV0FBTywrQkFBZSxRQUFRLENBQVIsVUFBQSxDQUFELFNBQUMsQ0FBZixFQUFQLE1BQU8sQ0FBUDtBQUNEOztBQUVELEVBQUEsY0FBYyxDQUFBLE1BQUEsRUFBZ0Q7QUFDNUQsVUFBTTtBQUFFLE1BQUE7QUFBRixRQUFOLE1BQUE7O0FBRUEsUUFBSSxjQUFjLENBQWxCLFFBQWtCLENBQWxCLEVBQThCO0FBQzVCLFlBQU07QUFBRSxRQUFBO0FBQUYsVUFBTixNQUFBO0FBRUEsMkNBQWtCLE1BQWxCLEVBQTJCLE1BQU0sUUFBUSxDQUFSLGdCQUFBLENBQWpDLFNBQWlDLENBQWpDO0FBQ0EsYUFBQSxNQUFBO0FBQ0Q7O0FBRUQsV0FBQSxJQUFBO0FBQ0Q7O0FBRUQsRUFBQSxlQUFlLEdBQUE7QUFDYixXQUFBLFlBQUE7QUFDRDs7QUExRmdDO0FBNkZuQzs7Ozs7OztBQUdNLE1BQUEsb0JBQUEsQ0FBMkI7QUFDL0IsRUFBQSxXQUFBLENBQUEsU0FBQSxFQUFBLFFBQUEsRUFBQSxJQUFBLEVBR3dCO0FBRmYsU0FBQSxTQUFBLEdBQUEsU0FBQTtBQUNBLFNBQUEsUUFBQSxHQUFBLFFBQUE7QUFDQSxTQUFBLElBQUEsR0FBQSxJQUFBO0FBQ0w7O0FBTDJCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgREVCVUcgfSBmcm9tICdAZ2xpbW1lci9lbnYnO1xuaW1wb3J0IHtcbiAgQXJndW1lbnRzLFxuICBDb21wb25lbnRDYXBhYmlsaXRpZXMsXG4gIENvbXBvbmVudENhcGFiaWxpdGllc1ZlcnNpb25zLFxuICBDb21wb25lbnREZWZpbml0aW9uU3RhdGUsXG4gIENvbXBvbmVudE1hbmFnZXIsXG4gIENvbXBvbmVudE1hbmFnZXJXaXRoQXN5bmNMaWZlQ3ljbGVDYWxsYmFja3MsXG4gIENvbXBvbmVudE1hbmFnZXJXaXRoQXN5bmNVcGRhdGVIb29rLFxuICBDb21wb25lbnRNYW5hZ2VyV2l0aERlc3RydWN0b3JzLFxuICBDb21wb25lbnRNYW5hZ2VyV2l0aFVwZGF0ZUhvb2ssXG4gIERlc3Ryb3lhYmxlLFxuICBJbnRlcm5hbENvbXBvbmVudENhcGFiaWxpdGllcyxcbiAgSW50ZXJuYWxDb21wb25lbnRNYW5hZ2VyLFxuICBPcHRpb24sXG4gIE93bmVyLFxuICBWTUFyZ3VtZW50cyxcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBjcmVhdGVDb25zdFJlZiwgUmVmZXJlbmNlIH0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcbmltcG9ydCB7IHJlZ2lzdGVyRGVzdHJ1Y3RvciB9IGZyb20gJ0BnbGltbWVyL2Rlc3Ryb3lhYmxlJztcbmltcG9ydCB7IGJ1aWxkQ2FwYWJpbGl0aWVzLCBGUk9NX0NBUEFCSUxJVElFUyB9IGZyb20gJy4uL3V0aWwvY2FwYWJpbGl0aWVzJztcbmltcG9ydCB7IGFyZ3NQcm94eUZvciB9IGZyb20gJy4uL3V0aWwvYXJncy1wcm94eSc7XG5pbXBvcnQgeyBNYW5hZ2VyRmFjdG9yeSB9IGZyb20gJy4vaW5kZXgnO1xuXG5jb25zdCBDQVBBQklMSVRJRVMgPSB7XG4gIGR5bmFtaWNMYXlvdXQ6IGZhbHNlLFxuICBkeW5hbWljVGFnOiBmYWxzZSxcbiAgcHJlcGFyZUFyZ3M6IGZhbHNlLFxuICBjcmVhdGVBcmdzOiB0cnVlLFxuICBhdHRyaWJ1dGVIb29rOiBmYWxzZSxcbiAgZWxlbWVudEhvb2s6IGZhbHNlLFxuICBjcmVhdGVDYWxsZXI6IGZhbHNlLFxuICBkeW5hbWljU2NvcGU6IHRydWUsXG4gIHVwZGF0ZUhvb2s6IHRydWUsXG4gIGNyZWF0ZUluc3RhbmNlOiB0cnVlLFxuICB3cmFwcGVkOiBmYWxzZSxcbiAgd2lsbERlc3Ryb3k6IGZhbHNlLFxuICBoYXNTdWJPd25lcjogZmFsc2UsXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gY29tcG9uZW50Q2FwYWJpbGl0aWVzPFZlcnNpb24gZXh0ZW5kcyBrZXlvZiBDb21wb25lbnRDYXBhYmlsaXRpZXNWZXJzaW9ucz4oXG4gIG1hbmFnZXJBUEk6IFZlcnNpb24sXG4gIG9wdGlvbnM6IENvbXBvbmVudENhcGFiaWxpdGllc1ZlcnNpb25zW1ZlcnNpb25dID0ge31cbik6IENvbXBvbmVudENhcGFiaWxpdGllcyB7XG4gIGlmIChERUJVRyAmJiBtYW5hZ2VyQVBJICE9PSAnMy4xMycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY29tcG9uZW50IG1hbmFnZXIgY29tcGF0aWJpbGl0eSBzcGVjaWZpZWQnKTtcbiAgfVxuXG4gIGxldCB1cGRhdGVIb29rID0gQm9vbGVhbigob3B0aW9ucyBhcyBDb21wb25lbnRDYXBhYmlsaXRpZXNWZXJzaW9uc1snMy4xMyddKS51cGRhdGVIb29rKTtcblxuICByZXR1cm4gYnVpbGRDYXBhYmlsaXRpZXMoe1xuICAgIGFzeW5jTGlmZUN5Y2xlQ2FsbGJhY2tzOiBCb29sZWFuKG9wdGlvbnMuYXN5bmNMaWZlY3ljbGVDYWxsYmFja3MpLFxuICAgIGRlc3RydWN0b3I6IEJvb2xlYW4ob3B0aW9ucy5kZXN0cnVjdG9yKSxcbiAgICB1cGRhdGVIb29rLFxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc0FzeW5jTGlmZUN5Y2xlQ2FsbGJhY2tzPENvbXBvbmVudEluc3RhbmNlPihcbiAgZGVsZWdhdGU6IENvbXBvbmVudE1hbmFnZXI8Q29tcG9uZW50SW5zdGFuY2U+XG4pOiBkZWxlZ2F0ZSBpcyBDb21wb25lbnRNYW5hZ2VyV2l0aEFzeW5jTGlmZUN5Y2xlQ2FsbGJhY2tzPENvbXBvbmVudEluc3RhbmNlPiB7XG4gIHJldHVybiBkZWxlZ2F0ZS5jYXBhYmlsaXRpZXMuYXN5bmNMaWZlQ3ljbGVDYWxsYmFja3M7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNVcGRhdGVIb29rPENvbXBvbmVudEluc3RhbmNlPihcbiAgZGVsZWdhdGU6IENvbXBvbmVudE1hbmFnZXI8Q29tcG9uZW50SW5zdGFuY2U+XG4pOiBkZWxlZ2F0ZSBpcyBDb21wb25lbnRNYW5hZ2VyV2l0aFVwZGF0ZUhvb2s8Q29tcG9uZW50SW5zdGFuY2U+IHtcbiAgcmV0dXJuIGRlbGVnYXRlLmNhcGFiaWxpdGllcy51cGRhdGVIb29rO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzQXN5bmNVcGRhdGVIb29rPENvbXBvbmVudEluc3RhbmNlPihcbiAgZGVsZWdhdGU6IENvbXBvbmVudE1hbmFnZXI8Q29tcG9uZW50SW5zdGFuY2U+XG4pOiBkZWxlZ2F0ZSBpcyBDb21wb25lbnRNYW5hZ2VyV2l0aEFzeW5jVXBkYXRlSG9vazxDb21wb25lbnRJbnN0YW5jZT4ge1xuICByZXR1cm4gaGFzQXN5bmNMaWZlQ3ljbGVDYWxsYmFja3MoZGVsZWdhdGUpICYmIGhhc1VwZGF0ZUhvb2soZGVsZWdhdGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzRGVzdHJ1Y3RvcnM8Q29tcG9uZW50SW5zdGFuY2U+KFxuICBkZWxlZ2F0ZTogQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT5cbik6IGRlbGVnYXRlIGlzIENvbXBvbmVudE1hbmFnZXJXaXRoRGVzdHJ1Y3RvcnM8Q29tcG9uZW50SW5zdGFuY2U+IHtcbiAgcmV0dXJuIGRlbGVnYXRlLmNhcGFiaWxpdGllcy5kZXN0cnVjdG9yO1xufVxuXG4vKipcbiAgVGhlIEN1c3RvbUNvbXBvbmVudE1hbmFnZXIgYWxsb3dzIGFkZG9ucyB0byBwcm92aWRlIGN1c3RvbSBjb21wb25lbnRcbiAgaW1wbGVtZW50YXRpb25zIHRoYXQgaW50ZWdyYXRlIHNlYW1sZXNzbHkgaW50byBFbWJlci4gVGhpcyBpcyBhY2NvbXBsaXNoZWRcbiAgdGhyb3VnaCBhIGRlbGVnYXRlLCByZWdpc3RlcmVkIHdpdGggdGhlIGN1c3RvbSBjb21wb25lbnQgbWFuYWdlciwgd2hpY2hcbiAgaW1wbGVtZW50cyBhIHNldCBvZiBob29rcyB0aGF0IGRldGVybWluZSBjb21wb25lbnQgYmVoYXZpb3IuXG5cbiAgVG8gY3JlYXRlIGEgY3VzdG9tIGNvbXBvbmVudCBtYW5hZ2VyLCBpbnN0YW50aWF0ZSBhIG5ldyBDdXN0b21Db21wb25lbnRNYW5hZ2VyXG4gIGNsYXNzIGFuZCBwYXNzIHRoZSBkZWxlZ2F0ZSBhcyB0aGUgZmlyc3QgYXJndW1lbnQ6XG5cbiAgYGBganNcbiAgbGV0IG1hbmFnZXIgPSBuZXcgQ3VzdG9tQ29tcG9uZW50TWFuYWdlcih7XG4gICAgLy8gLi4uZGVsZWdhdGUgaW1wbGVtZW50YXRpb24uLi5cbiAgfSk7XG4gIGBgYFxuXG4gICMjIERlbGVnYXRlIEhvb2tzXG5cbiAgVGhyb3VnaG91dCB0aGUgbGlmZWN5Y2xlIG9mIGEgY29tcG9uZW50LCB0aGUgY29tcG9uZW50IG1hbmFnZXIgd2lsbCBpbnZva2VcbiAgZGVsZWdhdGUgaG9va3MgdGhhdCBhcmUgcmVzcG9uc2libGUgZm9yIHN1cmZhY2luZyB0aG9zZSBsaWZlY3ljbGUgY2hhbmdlcyB0b1xuICB0aGUgZW5kIGRldmVsb3Blci5cblxuICAqIGBjcmVhdGUoKWAgLSBpbnZva2VkIHdoZW4gYSBuZXcgaW5zdGFuY2Ugb2YgYSBjb21wb25lbnQgc2hvdWxkIGJlIGNyZWF0ZWRcbiAgKiBgdXBkYXRlKClgIC0gaW52b2tlZCB3aGVuIHRoZSBhcmd1bWVudHMgcGFzc2VkIHRvIGEgY29tcG9uZW50IGNoYW5nZVxuICAqIGBnZXRDb250ZXh0KClgIC0gcmV0dXJucyB0aGUgb2JqZWN0IHRoYXQgc2hvdWxkIGJlXG4qL1xuZXhwb3J0IGNsYXNzIEN1c3RvbUNvbXBvbmVudE1hbmFnZXI8TyBleHRlbmRzIE93bmVyLCBDb21wb25lbnRJbnN0YW5jZT5cbiAgaW1wbGVtZW50cyBJbnRlcm5hbENvbXBvbmVudE1hbmFnZXI8Q3VzdG9tQ29tcG9uZW50U3RhdGU8Q29tcG9uZW50SW5zdGFuY2U+PiB7XG4gIHByaXZhdGUgY29tcG9uZW50TWFuYWdlckRlbGVnYXRlcyA9IG5ldyBXZWFrTWFwPE8sIENvbXBvbmVudE1hbmFnZXI8Q29tcG9uZW50SW5zdGFuY2U+PigpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZmFjdG9yeTogTWFuYWdlckZhY3Rvcnk8TywgQ29tcG9uZW50TWFuYWdlcjxDb21wb25lbnRJbnN0YW5jZT4+KSB7fVxuXG4gIHByaXZhdGUgZ2V0RGVsZWdhdGVGb3Iob3duZXI6IE8pIHtcbiAgICBsZXQgeyBjb21wb25lbnRNYW5hZ2VyRGVsZWdhdGVzIH0gPSB0aGlzO1xuICAgIGxldCBkZWxlZ2F0ZSA9IGNvbXBvbmVudE1hbmFnZXJEZWxlZ2F0ZXMuZ2V0KG93bmVyKTtcblxuICAgIGlmIChkZWxlZ2F0ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBsZXQgeyBmYWN0b3J5IH0gPSB0aGlzO1xuICAgICAgZGVsZWdhdGUgPSBmYWN0b3J5KG93bmVyKTtcblxuICAgICAgaWYgKERFQlVHICYmICFGUk9NX0NBUEFCSUxJVElFUyEuaGFzKGRlbGVnYXRlLmNhcGFiaWxpdGllcykpIHtcbiAgICAgICAgLy8gVE9ETzogVGhpcyBlcnJvciBtZXNzYWdlIHNob3VsZCBtYWtlIHNlbnNlIGluIGJvdGggRW1iZXIgYW5kIEdsaW1tZXIgaHR0cHM6Ly9naXRodWIuY29tL2dsaW1tZXJqcy9nbGltbWVyLXZtL2lzc3Vlcy8xMjAwXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ3VzdG9tIGNvbXBvbmVudCBtYW5hZ2VycyBtdXN0IGhhdmUgYSBcXGBjYXBhYmlsaXRpZXNcXGAgcHJvcGVydHkgdGhhdCBpcyB0aGUgcmVzdWx0IG9mIGNhbGxpbmcgdGhlIFxcYGNhcGFiaWxpdGllcygnMy4xMycpXFxgIChpbXBvcnRlZCB2aWEgXFxgaW1wb3J0IHsgY2FwYWJpbGl0aWVzIH0gZnJvbSAnQGVtYmVyL2NvbXBvbmVudCc7XFxgKS4gUmVjZWl2ZWQ6IFxcYCR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgICBkZWxlZ2F0ZS5jYXBhYmlsaXRpZXNcbiAgICAgICAgICApfVxcYCBmb3I6IFxcYCR7ZGVsZWdhdGV9XFxgYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb21wb25lbnRNYW5hZ2VyRGVsZWdhdGVzLnNldChvd25lciwgZGVsZWdhdGUpO1xuICAgIH1cblxuICAgIHJldHVybiBkZWxlZ2F0ZTtcbiAgfVxuXG4gIGNyZWF0ZShcbiAgICBvd25lcjogTyxcbiAgICBkZWZpbml0aW9uOiBDb21wb25lbnREZWZpbml0aW9uU3RhdGUsXG4gICAgdm1BcmdzOiBWTUFyZ3VtZW50c1xuICApOiBDdXN0b21Db21wb25lbnRTdGF0ZTxDb21wb25lbnRJbnN0YW5jZT4ge1xuICAgIGxldCBkZWxlZ2F0ZSA9IHRoaXMuZ2V0RGVsZWdhdGVGb3Iob3duZXIpO1xuICAgIGxldCBhcmdzID0gYXJnc1Byb3h5Rm9yKHZtQXJncy5jYXB0dXJlKCksICdjb21wb25lbnQnKTtcblxuICAgIGxldCBjb21wb25lbnQ6IENvbXBvbmVudEluc3RhbmNlID0gZGVsZWdhdGUuY3JlYXRlQ29tcG9uZW50KGRlZmluaXRpb24sIGFyZ3MpO1xuXG4gICAgcmV0dXJuIG5ldyBDdXN0b21Db21wb25lbnRTdGF0ZShjb21wb25lbnQhLCBkZWxlZ2F0ZSwgYXJncyk7XG4gIH1cblxuICBnZXREZWJ1Z05hbWUoZGVmaW5pdGlvbjogQ29tcG9uZW50RGVmaW5pdGlvblN0YXRlKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdHlwZW9mIGRlZmluaXRpb24gPT09ICdmdW5jdGlvbicgPyBkZWZpbml0aW9uLm5hbWUgOiBkZWZpbml0aW9uLnRvU3RyaW5nKCk7XG4gIH1cblxuICB1cGRhdGUoYnVja2V0OiBDdXN0b21Db21wb25lbnRTdGF0ZTxDb21wb25lbnRJbnN0YW5jZT4pOiB2b2lkIHtcbiAgICBsZXQgeyBkZWxlZ2F0ZSB9ID0gYnVja2V0O1xuICAgIGlmIChoYXNVcGRhdGVIb29rKGRlbGVnYXRlKSkge1xuICAgICAgbGV0IHsgY29tcG9uZW50LCBhcmdzIH0gPSBidWNrZXQ7XG5cbiAgICAgIGRlbGVnYXRlLnVwZGF0ZUNvbXBvbmVudChjb21wb25lbnQsIGFyZ3MpO1xuICAgIH1cbiAgfVxuXG4gIGRpZENyZWF0ZSh7IGNvbXBvbmVudCwgZGVsZWdhdGUgfTogQ3VzdG9tQ29tcG9uZW50U3RhdGU8Q29tcG9uZW50SW5zdGFuY2U+KTogdm9pZCB7XG4gICAgaWYgKGhhc0FzeW5jTGlmZUN5Y2xlQ2FsbGJhY2tzKGRlbGVnYXRlKSkge1xuICAgICAgZGVsZWdhdGUuZGlkQ3JlYXRlQ29tcG9uZW50KGNvbXBvbmVudCk7XG4gICAgfVxuICB9XG5cbiAgZGlkVXBkYXRlKHsgY29tcG9uZW50LCBkZWxlZ2F0ZSB9OiBDdXN0b21Db21wb25lbnRTdGF0ZTxDb21wb25lbnRJbnN0YW5jZT4pOiB2b2lkIHtcbiAgICBpZiAoaGFzQXN5bmNVcGRhdGVIb29rKGRlbGVnYXRlKSkge1xuICAgICAgZGVsZWdhdGUuZGlkVXBkYXRlQ29tcG9uZW50KGNvbXBvbmVudCk7XG4gICAgfVxuICB9XG5cbiAgZGlkUmVuZGVyTGF5b3V0KCk6IHZvaWQge31cblxuICBkaWRVcGRhdGVMYXlvdXQoKTogdm9pZCB7fVxuXG4gIGdldFNlbGYoeyBjb21wb25lbnQsIGRlbGVnYXRlIH06IEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPik6IFJlZmVyZW5jZSB7XG4gICAgcmV0dXJuIGNyZWF0ZUNvbnN0UmVmKGRlbGVnYXRlLmdldENvbnRleHQoY29tcG9uZW50KSwgJ3RoaXMnKTtcbiAgfVxuXG4gIGdldERlc3Ryb3lhYmxlKGJ1Y2tldDogQ3VzdG9tQ29tcG9uZW50U3RhdGU8Q29tcG9uZW50SW5zdGFuY2U+KTogT3B0aW9uPERlc3Ryb3lhYmxlPiB7XG4gICAgY29uc3QgeyBkZWxlZ2F0ZSB9ID0gYnVja2V0O1xuXG4gICAgaWYgKGhhc0Rlc3RydWN0b3JzKGRlbGVnYXRlKSkge1xuICAgICAgY29uc3QgeyBjb21wb25lbnQgfSA9IGJ1Y2tldDtcblxuICAgICAgcmVnaXN0ZXJEZXN0cnVjdG9yKGJ1Y2tldCwgKCkgPT4gZGVsZWdhdGUuZGVzdHJveUNvbXBvbmVudChjb21wb25lbnQpKTtcbiAgICAgIHJldHVybiBidWNrZXQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBnZXRDYXBhYmlsaXRpZXMoKTogSW50ZXJuYWxDb21wb25lbnRDYXBhYmlsaXRpZXMge1xuICAgIHJldHVybiBDQVBBQklMSVRJRVM7XG4gIH1cbn1cblxuLyoqXG4gKiBTdG9yZXMgaW50ZXJuYWwgc3RhdGUgYWJvdXQgYSBjb21wb25lbnQgaW5zdGFuY2UgYWZ0ZXIgaXQncyBiZWVuIGNyZWF0ZWQuXG4gKi9cbmV4cG9ydCBjbGFzcyBDdXN0b21Db21wb25lbnRTdGF0ZTxDb21wb25lbnRJbnN0YW5jZT4ge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgY29tcG9uZW50OiBDb21wb25lbnRJbnN0YW5jZSxcbiAgICBwdWJsaWMgZGVsZWdhdGU6IENvbXBvbmVudE1hbmFnZXI8Q29tcG9uZW50SW5zdGFuY2U+LFxuICAgIHB1YmxpYyBhcmdzOiBBcmd1bWVudHNcbiAgKSB7fVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==