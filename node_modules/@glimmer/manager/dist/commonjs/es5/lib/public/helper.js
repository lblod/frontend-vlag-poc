"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.helperCapabilities = helperCapabilities;
exports.hasValue = hasValue;
exports.hasDestroyable = hasDestroyable;
exports.CustomHelperManager = void 0;

var _destroyable = require("@glimmer/destroyable");

var _env = require("@glimmer/env");

var _reference = require("@glimmer/reference");

var _capabilities = require("../util/capabilities");

var _argsProxy = require("../util/args-proxy");

function helperCapabilities(managerAPI, options) {
  if (options === void 0) {
    options = {};
  }

  if (_env.DEBUG && managerAPI !== '3.23') {
    throw new Error('Invalid helper manager compatibility specified');
  }

  if (_env.DEBUG && (!(options.hasValue || options.hasScheduledEffect) || options.hasValue && options.hasScheduledEffect)) {
    throw new Error('You must pass either the `hasValue` OR the `hasScheduledEffect` capability when defining a helper manager. Passing neither, or both, is not permitted.');
  }

  if (_env.DEBUG && options.hasScheduledEffect) {
    throw new Error('The `hasScheduledEffect` capability has not yet been implemented for helper managers. Please pass `hasValue` instead');
  }

  return (0, _capabilities.buildCapabilities)({
    hasValue: Boolean(options.hasValue),
    hasDestroyable: Boolean(options.hasDestroyable),
    hasScheduledEffect: Boolean(options.hasScheduledEffect)
  });
} ////////////


function hasValue(manager) {
  return manager.capabilities.hasValue;
}

function hasDestroyable(manager) {
  return manager.capabilities.hasDestroyable;
} ////////////


var CustomHelperManager = /*#__PURE__*/function () {
  function CustomHelperManager(factory) {
    this.factory = factory;
    this.helperManagerDelegates = new WeakMap();
    this.undefinedDelegate = null;
  }

  var _proto = CustomHelperManager.prototype;

  _proto.getDelegateForOwner = function getDelegateForOwner(owner) {
    var delegate = this.helperManagerDelegates.get(owner);

    if (delegate === undefined) {
      var factory = this.factory;
      delegate = factory(owner);

      if (_env.DEBUG && !_capabilities.FROM_CAPABILITIES.has(delegate.capabilities)) {
        // TODO: This error message should make sense in both Ember and Glimmer https://github.com/glimmerjs/glimmer-vm/issues/1200
        throw new Error("Custom helper managers must have a `capabilities` property that is the result of calling the `capabilities('3.23')` (imported via `import { capabilities } from '@ember/helper';`). Received: `" + JSON.stringify(delegate.capabilities) + "` for: `" + delegate + "`");
      }

      this.helperManagerDelegates.set(owner, delegate);
    }

    return delegate;
  };

  _proto.getDelegateFor = function getDelegateFor(owner) {
    if (owner === undefined) {
      var undefinedDelegate = this.undefinedDelegate;

      if (undefinedDelegate === null) {
        var factory = this.factory;
        this.undefinedDelegate = undefinedDelegate = factory(undefined);
      }

      return undefinedDelegate;
    } else {
      return this.getDelegateForOwner(owner);
    }
  };

  _proto.getHelper = function getHelper(definition) {
    var _this = this;

    return function (capturedArgs, owner) {
      var _a, _b;

      var manager = _this.getDelegateFor(owner);

      var args = (0, _argsProxy.argsProxyFor)(capturedArgs, 'helper');
      var bucket = manager.createHelper(definition, args);

      if (hasValue(manager)) {
        var cache = (0, _reference.createComputeRef)(function () {
          return manager.getValue(bucket);
        }, null, _env.DEBUG && manager.getDebugName && manager.getDebugName(definition));

        if (hasDestroyable(manager)) {
          (0, _destroyable.associateDestroyableChild)(cache, manager.getDestroyable(bucket));
        }

        return cache;
      } else if (hasDestroyable(manager)) {
        var ref = (0, _reference.createConstRef)(undefined, _env.DEBUG && ((_b = (_a = manager.getDebugName) === null || _a === void 0 ? void 0 : _a.call(manager, definition)) !== null && _b !== void 0 ? _b : 'unknown helper'));
        (0, _destroyable.associateDestroyableChild)(ref, manager.getDestroyable(bucket));
        return ref;
      } else {
        return _reference.UNDEFINED_REFERENCE;
      }
    };
  };

  return CustomHelperManager;
}();

exports.CustomHelperManager = CustomHelperManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL21hbmFnZXIvbGliL3B1YmxpYy9oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQVlBOztBQUVBOztBQUNBOztBQUdNLFNBQUEsa0JBQUEsQ0FBQSxVQUFBLEVBQUEsT0FBQSxFQUVxQztBQUFBLE1BQXpDLE9BQXlDLEtBQUEsS0FBQSxDQUFBLEVBQUE7QUFBekMsSUFBQSxPQUF5QyxHQUZyQyxFQUVKO0FBQXlDOztBQUV6QyxNQUFJLGNBQVMsVUFBVSxLQUF2QixNQUFBLEVBQW9DO0FBQ2xDLFVBQU0sSUFBQSxLQUFBLENBQU4sZ0RBQU0sQ0FBTjtBQUNEOztBQUVELE1BQ0UsZUFDQyxFQUFFLE9BQU8sQ0FBUCxRQUFBLElBQW9CLE9BQU8sQ0FBN0Isa0JBQUEsS0FDRSxPQUFPLENBQVAsUUFBQSxJQUFvQixPQUFPLENBSGhDLGtCQUNFLENBREYsRUFJRTtBQUNBLFVBQU0sSUFBQSxLQUFBLENBQU4sd0pBQU0sQ0FBTjtBQUdEOztBQUVELE1BQUksY0FBUyxPQUFPLENBQXBCLGtCQUFBLEVBQXlDO0FBQ3ZDLFVBQU0sSUFBQSxLQUFBLENBQU4sc0hBQU0sQ0FBTjtBQUdEOztBQUVELFNBQU8scUNBQWtCO0FBQ3ZCLElBQUEsUUFBUSxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBREYsUUFDTixDQURNO0FBRXZCLElBQUEsY0FBYyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBRlIsY0FFQSxDQUZBO0FBR3ZCLElBQUEsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBUixrQkFBQTtBQUhKLEdBQWxCLENBQVA7RUFPRjs7O0FBRU0sU0FBQSxRQUFBLENBQUEsT0FBQSxFQUMyQjtBQUUvQixTQUFPLE9BQU8sQ0FBUCxZQUFBLENBQVAsUUFBQTtBQUNEOztBQUVLLFNBQUEsY0FBQSxDQUFBLE9BQUEsRUFDMkI7QUFFL0IsU0FBTyxPQUFPLENBQVAsWUFB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SUFBcUIsRUFBQSxLQUFBLEtBQXJCLENBQUEsR0FBcUIsS0FBckIsQ0FBQSxHQUFxQixFQUFBLENBQUEsSUFBQSxDQUFwQixPQUFvQixFQUFyQixVQUFxQixDQUFyQixNQUFBLElBQUEsSUFBa0MsRUFBQSxLQUFBLEtBQWxDLENBQUEsR0FBQSxFQUFBLEdBRlgsZ0JBRUUsQ0FGUSxDQUFWO0FBS0Esb0RBQXlCLEdBQXpCLEVBQStCLE9BQU8sQ0FBUCxjQUFBLENBQS9CLE1BQStCLENBQS9CO0FBRUEsZUFBQSxHQUFBO0FBUkssT0FBQSxNQVNBO0FBQ0wsZUFBQSw4QkFBQTtBQUNEO0FBN0JILEtBQUE7QUE1Q0osR0FBQTs7QUFBQSxTQUFBLG1CQUFBO0FBQUEsQ0FBQSxFQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXNzb2NpYXRlRGVzdHJveWFibGVDaGlsZCB9IGZyb20gJ0BnbGltbWVyL2Rlc3Ryb3lhYmxlJztcbmltcG9ydCB7IERFQlVHIH0gZnJvbSAnQGdsaW1tZXIvZW52JztcbmltcG9ydCB7XG4gIEhlbHBlcixcbiAgSGVscGVyQ2FwYWJpbGl0aWVzLFxuICBIZWxwZXJDYXBhYmlsaXRpZXNWZXJzaW9ucyxcbiAgSGVscGVyRGVmaW5pdGlvblN0YXRlLFxuICBIZWxwZXJNYW5hZ2VyLFxuICBIZWxwZXJNYW5hZ2VyV2l0aERlc3Ryb3lhYmxlLFxuICBIZWxwZXJNYW5hZ2VyV2l0aFZhbHVlLFxuICBJbnRlcm5hbEhlbHBlck1hbmFnZXIsXG4gIE93bmVyLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGNyZWF0ZUNvbXB1dGVSZWYsIGNyZWF0ZUNvbnN0UmVmLCBVTkRFRklORURfUkVGRVJFTkNFIH0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcblxuaW1wb3J0IHsgYnVpbGRDYXBhYmlsaXRpZXMsIEZST01fQ0FQQUJJTElUSUVTIH0gZnJvbSAnLi4vdXRpbC9jYXBhYmlsaXRpZXMnO1xuaW1wb3J0IHsgYXJnc1Byb3h5Rm9yIH0gZnJvbSAnLi4vdXRpbC9hcmdzLXByb3h5JztcbmltcG9ydCB7IE1hbmFnZXJGYWN0b3J5IH0gZnJvbSAnLi9pbmRleCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBoZWxwZXJDYXBhYmlsaXRpZXM8VmVyc2lvbiBleHRlbmRzIGtleW9mIEhlbHBlckNhcGFiaWxpdGllc1ZlcnNpb25zPihcbiAgbWFuYWdlckFQSTogVmVyc2lvbixcbiAgb3B0aW9uczogUGFydGlhbDxIZWxwZXJDYXBhYmlsaXRpZXM+ID0ge31cbik6IEhlbHBlckNhcGFiaWxpdGllcyB7XG4gIGlmIChERUJVRyAmJiBtYW5hZ2VyQVBJICE9PSAnMy4yMycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgaGVscGVyIG1hbmFnZXIgY29tcGF0aWJpbGl0eSBzcGVjaWZpZWQnKTtcbiAgfVxuXG4gIGlmIChcbiAgICBERUJVRyAmJlxuICAgICghKG9wdGlvbnMuaGFzVmFsdWUgfHwgb3B0aW9ucy5oYXNTY2hlZHVsZWRFZmZlY3QpIHx8XG4gICAgICAob3B0aW9ucy5oYXNWYWx1ZSAmJiBvcHRpb25zLmhhc1NjaGVkdWxlZEVmZmVjdCkpXG4gICkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdZb3UgbXVzdCBwYXNzIGVpdGhlciB0aGUgYGhhc1ZhbHVlYCBPUiB0aGUgYGhhc1NjaGVkdWxlZEVmZmVjdGAgY2FwYWJpbGl0eSB3aGVuIGRlZmluaW5nIGEgaGVscGVyIG1hbmFnZXIuIFBhc3NpbmcgbmVpdGhlciwgb3IgYm90aCwgaXMgbm90IHBlcm1pdHRlZC4nXG4gICAgKTtcbiAgfVxuXG4gIGlmIChERUJVRyAmJiBvcHRpb25zLmhhc1NjaGVkdWxlZEVmZmVjdCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdUaGUgYGhhc1NjaGVkdWxlZEVmZmVjdGAgY2FwYWJpbGl0eSBoYXMgbm90IHlldCBiZWVuIGltcGxlbWVudGVkIGZvciBoZWxwZXIgbWFuYWdlcnMuIFBsZWFzZSBwYXNzIGBoYXNWYWx1ZWAgaW5zdGVhZCdcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIGJ1aWxkQ2FwYWJpbGl0aWVzKHtcbiAgICBoYXNWYWx1ZTogQm9vbGVhbihvcHRpb25zLmhhc1ZhbHVlKSxcbiAgICBoYXNEZXN0cm95YWJsZTogQm9vbGVhbihvcHRpb25zLmhhc0Rlc3Ryb3lhYmxlKSxcbiAgICBoYXNTY2hlZHVsZWRFZmZlY3Q6IEJvb2xlYW4ob3B0aW9ucy5oYXNTY2hlZHVsZWRFZmZlY3QpLFxuICB9KTtcbn1cblxuLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNWYWx1ZShcbiAgbWFuYWdlcjogSGVscGVyTWFuYWdlcjx1bmtub3duPlxuKTogbWFuYWdlciBpcyBIZWxwZXJNYW5hZ2VyV2l0aFZhbHVlPHVua25vd24+IHtcbiAgcmV0dXJuIG1hbmFnZXIuY2FwYWJpbGl0aWVzLmhhc1ZhbHVlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzRGVzdHJveWFibGUoXG4gIG1hbmFnZXI6IEhlbHBlck1hbmFnZXI8dW5rbm93bj5cbik6IG1hbmFnZXIgaXMgSGVscGVyTWFuYWdlcldpdGhEZXN0cm95YWJsZTx1bmtub3duPiB7XG4gIHJldHVybiBtYW5hZ2VyLmNhcGFiaWxpdGllcy5oYXNEZXN0cm95YWJsZTtcbn1cblxuLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBjbGFzcyBDdXN0b21IZWxwZXJNYW5hZ2VyPE8gZXh0ZW5kcyBPd25lciA9IE93bmVyPiBpbXBsZW1lbnRzIEludGVybmFsSGVscGVyTWFuYWdlcjxPPiB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZmFjdG9yeTogTWFuYWdlckZhY3Rvcnk8TyB8IHVuZGVmaW5lZCwgSGVscGVyTWFuYWdlcjx1bmtub3duPj4pIHt9XG5cbiAgcHJpdmF0ZSBoZWxwZXJNYW5hZ2VyRGVsZWdhdGVzID0gbmV3IFdlYWtNYXA8TywgSGVscGVyTWFuYWdlcjx1bmtub3duPj4oKTtcbiAgcHJpdmF0ZSB1bmRlZmluZWREZWxlZ2F0ZTogSGVscGVyTWFuYWdlcjx1bmtub3duPiB8IG51bGwgPSBudWxsO1xuXG4gIHByaXZhdGUgZ2V0RGVsZWdhdGVGb3JPd25lcihvd25lcjogTykge1xuICAgIGxldCBkZWxlZ2F0ZSA9IHRoaXMuaGVscGVyTWFuYWdlckRlbGVnYXRlcy5nZXQob3duZXIpO1xuXG4gICAgaWYgKGRlbGVnYXRlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGxldCB7IGZhY3RvcnkgfSA9IHRoaXM7XG4gICAgICBkZWxlZ2F0ZSA9IGZhY3Rvcnkob3duZXIpO1xuXG4gICAgICBpZiAoREVCVUcgJiYgIUZST01fQ0FQQUJJTElUSUVTIS5oYXMoZGVsZWdhdGUuY2FwYWJpbGl0aWVzKSkge1xuICAgICAgICAvLyBUT0RPOiBUaGlzIGVycm9yIG1lc3NhZ2Ugc2hvdWxkIG1ha2Ugc2Vuc2UgaW4gYm90aCBFbWJlciBhbmQgR2xpbW1lciBodHRwczovL2dpdGh1Yi5jb20vZ2xpbW1lcmpzL2dsaW1tZXItdm0vaXNzdWVzLzEyMDBcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBDdXN0b20gaGVscGVyIG1hbmFnZXJzIG11c3QgaGF2ZSBhIFxcYGNhcGFiaWxpdGllc1xcYCBwcm9wZXJ0eSB0aGF0IGlzIHRoZSByZXN1bHQgb2YgY2FsbGluZyB0aGUgXFxgY2FwYWJpbGl0aWVzKCczLjIzJylcXGAgKGltcG9ydGVkIHZpYSBcXGBpbXBvcnQgeyBjYXBhYmlsaXRpZXMgfSBmcm9tICdAZW1iZXIvaGVscGVyJztcXGApLiBSZWNlaXZlZDogXFxgJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgIGRlbGVnYXRlLmNhcGFiaWxpdGllc1xuICAgICAgICAgICl9XFxgIGZvcjogXFxgJHtkZWxlZ2F0ZX1cXGBgXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuaGVscGVyTWFuYWdlckRlbGVnYXRlcy5zZXQob3duZXIsIGRlbGVnYXRlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVsZWdhdGU7XG4gIH1cblxuICBnZXREZWxlZ2F0ZUZvcihvd25lcjogTyB8IHVuZGVmaW5lZCkge1xuICAgIGlmIChvd25lciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBsZXQgeyB1bmRlZmluZWREZWxlZ2F0ZSB9ID0gdGhpcztcblxuICAgICAgaWYgKHVuZGVmaW5lZERlbGVnYXRlID09PSBudWxsKSB7XG4gICAgICAgIGxldCB7IGZhY3RvcnkgfSA9IHRoaXM7XG4gICAgICAgIHRoaXMudW5kZWZpbmVkRGVsZWdhdGUgPSB1bmRlZmluZWREZWxlZ2F0ZSA9IGZhY3RvcnkodW5kZWZpbmVkKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHVuZGVmaW5lZERlbGVnYXRlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXREZWxlZ2F0ZUZvck93bmVyKG93bmVyKTtcbiAgICB9XG4gIH1cblxuICBnZXRIZWxwZXIoZGVmaW5pdGlvbjogSGVscGVyRGVmaW5pdGlvblN0YXRlKTogSGVscGVyIHtcbiAgICByZXR1cm4gKGNhcHR1cmVkQXJncywgb3duZXIpID0+IHtcbiAgICAgIGxldCBtYW5hZ2VyID0gdGhpcy5nZXREZWxlZ2F0ZUZvcihvd25lciBhcyBPIHwgdW5kZWZpbmVkKTtcblxuICAgICAgY29uc3QgYXJncyA9IGFyZ3NQcm94eUZvcihjYXB0dXJlZEFyZ3MsICdoZWxwZXInKTtcbiAgICAgIGNvbnN0IGJ1Y2tldCA9IG1hbmFnZXIuY3JlYXRlSGVscGVyKGRlZmluaXRpb24sIGFyZ3MpO1xuXG4gICAgICBpZiAoaGFzVmFsdWUobWFuYWdlcikpIHtcbiAgICAgICAgbGV0IGNhY2hlID0gY3JlYXRlQ29tcHV0ZVJlZihcbiAgICAgICAgICAoKSA9PiAobWFuYWdlciBhcyBIZWxwZXJNYW5hZ2VyV2l0aFZhbHVlPHVua25vd24+KS5nZXRWYWx1ZShidWNrZXQpLFxuICAgICAgICAgIG51bGwsXG4gICAgICAgICAgREVCVUcgJiYgbWFuYWdlci5nZXREZWJ1Z05hbWUgJiYgbWFuYWdlci5nZXREZWJ1Z05hbWUoZGVmaW5pdGlvbilcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoaGFzRGVzdHJveWFibGUobWFuYWdlcikpIHtcbiAgICAgICAgICBhc3NvY2lhdGVEZXN0cm95YWJsZUNoaWxkKGNhY2hlLCBtYW5hZ2VyLmdldERlc3Ryb3lhYmxlKGJ1Y2tldCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNhY2hlO1xuICAgICAgfSBlbHNlIGlmIChoYXNEZXN0cm95YWJsZShtYW5hZ2VyKSkge1xuICAgICAgICBsZXQgcmVmID0gY3JlYXRlQ29uc3RSZWYoXG4gICAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAgIERFQlVHICYmIChtYW5hZ2VyLmdldERlYnVnTmFtZT8uKGRlZmluaXRpb24pID8/ICd1bmtub3duIGhlbHBlcicpXG4gICAgICAgICk7XG5cbiAgICAgICAgYXNzb2NpYXRlRGVzdHJveWFibGVDaGlsZChyZWYsIG1hbmFnZXIuZ2V0RGVzdHJveWFibGUoYnVja2V0KSk7XG5cbiAgICAgICAgcmV0dXJuIHJlZjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBVTkRFRklORURfUkVGRVJFTkNFO1xuICAgICAgfVxuICAgIH07XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=