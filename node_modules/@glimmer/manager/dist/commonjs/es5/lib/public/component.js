"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.componentCapabilities = componentCapabilities;
exports.hasAsyncLifeCycleCallbacks = hasAsyncLifeCycleCallbacks;
exports.hasUpdateHook = hasUpdateHook;
exports.hasAsyncUpdateHook = hasAsyncUpdateHook;
exports.hasDestructors = hasDestructors;
exports.CustomComponentState = exports.CustomComponentManager = void 0;

var _env = require("@glimmer/env");

var _reference = require("@glimmer/reference");

var _destroyable = require("@glimmer/destroyable");

var _capabilities = require("../util/capabilities");

var _argsProxy = require("../util/args-proxy");

var CAPABILITIES = {
  dynamicLayout: false,
  dynamicTag: false,
  prepareArgs: false,
  createArgs: true,
  attributeHook: false,
  elementHook: false,
  createCaller: false,
  dynamicScope: true,
  updateHook: true,
  createInstance: true,
  wrapped: false,
  willDestroy: false,
  hasSubOwner: false
};

function componentCapabilities(managerAPI, options) {
  if (options === void 0) {
    options = {};
  }

  if (_env.DEBUG && managerAPI !== '3.13') {
    throw new Error('Invalid component manager compatibility specified');
  }

  var updateHook = Boolean(options.updateHook);
  return (0, _capabilities.buildCapabilities)({
    asyncLifeCycleCallbacks: Boolean(options.asyncLifecycleCallbacks),
    destructor: Boolean(options.destructor),
    updateHook: updateHook
  });
}

function hasAsyncLifeCycleCallbacks(delegate) {
  return delegate.capabilities.asyncLifeCycleCallbacks;
}

function hasUpdateHook(delegate) {
  return delegate.capabilities.updateHook;
}

function hasAsyncUpdateHook(delegate) {
  return hasAsyncLifeCycleCallbacks(delegate) && hasUpdateHook(delegate);
}

function hasDestructors(delegate) {
  return delegate.capabilities.destructor;
}
/**
  The CustomComponentManager allows addons to provide custom component
  implementations that integrate seamlessly into Ember. This is accomplished
  through a delegate, registered with the custom component manager, which
  implements a set of hooks that determine component behavior.

  To create a custom component manager, instantiate a new CustomComponentManager
  class and pass the delegate as the first argument:

  ```js
  let manager = new CustomComponentManager({
    // ...delegate implementation...
  });
  ```

  ## Delegate Hooks

  Throughout the lifecycle of a component, the component manager will invoke
  delegate hooks that are responsible for surfacing those lifecycle changes to
  the end developer.

  * `create()` - invoked when a new instance of a component should be created
  * `update()` - invoked when the arguments passed to a component change
  * `getContext()` - returns the object that should be
*/


var CustomComponentManager = /*#__PURE__*/function () {
  function CustomComponentManager(factory) {
    this.factory = factory;
    this.componentManagerDelegates = new WeakMap();
  }

  var _proto = CustomComponentManager.prototype;

  _proto.getDelegateFor = function getDelegateFor(owner) {
    var componentManagerDelegates = this.componentManagerDelegates;
    var delegate = componentManagerDelegates.get(owner);

    if (delegate === undefined) {
      var factory = this.factory;
      delegate = factory(owner);

      if (_env.DEBUG && !_capabilities.FROM_CAPABILITIES.has(delegate.capabilities)) {
        // TODO: This error message should make sense in both Ember and Glimmer https://github.com/glimmerjs/glimmer-vm/issues/1200
        throw new Error("Custom component managers must have a `capabilities` property that is the result of calling the `capabilities('3.13')` (imported via `import { capabilities } from '@ember/component';`). Received: `" + JSON.stringify(delegate.capabilities) + "` for: `" + delegate + "`");
      }

      componentManagerDelegates.set(owner, delegate);
    }

    return delegate;
  };

  _proto.create = function create(owner, definition, vmArgs) {
    var delegate = this.getDelegateFor(owner);
    var args = (0, _argsProxy.argsProxyFor)(vmArgs.capture(), 'component');
    var component = delegate.createComponent(definition, args);
    return new CustomComponentState(component, delegate, args);
  };

  _proto.getDebugName = function getDebugName(definition) {
    return typeof definition === 'function' ? definition.name : definition.toString();
  };

  _proto.update = function update(bucket) {
    var delegate = bucket.delegate;

    if (hasUpdateHook(delegate)) {
      var component = bucket.component,
          args = bucket.args;
      delegate.updateComponent(component, args);
    }
  };

  _proto.didCreate = function didCreate(_ref) {
    var component = _ref.component,
        delegate = _ref.delegate;

    if (hasAsyncLifeCycleCallbacks(delegate)) {
      delegate.didCreateComponent(component);
    }
  };

  _proto.didUpdate = function didUpdate(_ref2) {
    var component = _ref2.component,
        delegate = _ref2.delegate;

    if (hasAsyncUpdateHook(delegate)) {
      delegate.didUpdateComponent(component);
    }
  };

  _proto.didRenderLayout = function didRenderLayout() {};

  _proto.didUpdateLayout = function didUpdateLayout() {};

  _proto.getSelf = function getSelf(_ref3) {
    var component = _ref3.component,
        delegate = _ref3.delegate;
    return (0, _reference.createConstRef)(delegate.getContext(component), 'this');
  };

  _proto.getDestroyable = function getDestroyable(bucket) {
    var delegate = bucket.delegate;

    if (hasDestructors(delegate)) {
      var component = bucket.component;
      (0, _destroyable.registerDestructor)(bucket, function () {
        return delegate.destroyComponent(component);
      });
      return bucket;
    }

    return null;
  };

  _proto.getCapabilities = function getCapabilities() {
    return CAPABILITIES;
  };

  return CustomComponentManager;
}();
/**
 * Stores internal state about a component instance after it's been created.
 */


exports.CustomComponentManager = CustomComponentManager;

var CustomComponentState = function CustomComponentState(component, delegate, args) {
  this.component = component;
  this.delegate = delegate;
  this.args = args;
};

exports.CustomComponentState = CustomComponentState;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL21hbmFnZXIvbGliL3B1YmxpYy9jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUE7O0FBa0JBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLElBQU0sWUFBWSxHQUFHO0FBQ25CLEVBQUEsYUFBYSxFQURNLEtBQUE7QUFFbkIsRUFBQSxVQUFVLEVBRlMsS0FBQTtBQUduQixFQUFBLFdBQVcsRUFIUSxLQUFBO0FBSW5CLEVBQUEsVUFBVSxFQUpTLElBQUE7QUFLbkIsRUFBQSxhQUFhLEVBTE0sS0FBQTtBQU1uQixFQUFBLFdBQVcsRUFOUSxLQUFBO0FBT25CLEVBQUEsWUFBWSxFQVBPLEtBQUE7QUFRbkIsRUFBQSxZQUFZLEVBUk8sSUFBQTtBQVNuQixFQUFBLFVBQVUsRUFUUyxJQUFBO0FBVW5CLEVBQUEsY0FBYyxFQVZLLElBQUE7QUFXbkIsRUFBQSxPQUFPLEVBWFksS0FBQTtBQVluQixFQUFBLFdBQVcsRUFaUSxLQUFBO0FBYW5CLEVBQUEsV0FBVyxFQUFFO0FBYk0sQ0FBckI7O0FBZ0JNLFNBQUEscUJBQUEsQ0FBQSxVQUFBLEVBQUEsT0FBQSxFQUVnRDtBQUFBLE1BQXBELE9BQW9ELEtBQUEsS0FBQSxDQUFBLEVBQUE7QUFBcEQsSUFBQSxPQUFvRCxHQUZoRCxFQUVKO0FBQW9EOztBQUVwRCxNQUFJLGNBQVMsVUFBVSxLQUF2QixNQUFBLEVBQW9DO0FBQ2xDLFVBQU0sSUFBQSxLQUFBLENBQU4sbURBQU0sQ0FBTjtBQUNEOztBQUVELE1BQUksVUFBVSxHQUFHLE9BQU8sQ0FBRSxPQUFpRCxDQUEzRSxVQUF3QixDQUF4QjtBQUVBLFNBQU8scUNBQWtCO0FBQ3ZCLElBQUEsdUJBQXVCLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FEakIsdUJBQ1MsQ0FEVDtBQUV2QixJQUFBLFVBQVUsRUFBRSxPQUFPLENBQUMsT0FBTyxDQUZKLFVBRUosQ0FGSTtBQUd2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NUQsTUFENEQsQ0FBQSxRQUFBOztBQUc1RCxRQUFJLGNBQWMsQ0FBbEIsUUFBa0IsQ0FBbEIsRUFBOEI7QUFBQSxVQUNwQixTQURvQixHQUM1QixNQUQ0QixDQUFBLFNBQUE7QUFHNUIsMkNBQWtCLE1BQWxCLEVBQTJCLFlBQUE7QUFBQSxlQUFNLFFBQVEsQ0FBUixnQkFBQSxDQUFqQyxTQUFpQyxDQUFOO0FBQTNCLE9BQUE7QUFDQSxhQUFBLE1BQUE7QUFDRDs7QUFFRCxXQUFBLElBQUE7QUFyRkosR0FBQTs7QUFBQSxFQUFBLE1BQUEsQ0FBQSxlQUFBLEdBd0ZFLFNBQUEsZUFBQSxHQUFlO0FBQ2IsV0FBQSxZQUFBO0FBekZKLEdBQUE7O0FBQUEsU0FBQSxzQkFBQTtBQUFBLENBQUEsRUFBQTtBQTZGQTs7Ozs7OztBQUdBLElBQU0sb0JBQU4sR0FDRSxTQUFBLG9CQUFBLENBQUEsU0FBQSxFQUFBLFFBQUEsRUFBQSxJQUFBLEVBR3dCO0FBRmYsT0FBQSxTQUFBLEdBQUEsU0FBQTtBQUNBLE9BQUEsUUFBQSxHQUFBLFFBQUE7QUFDQSxPQUFBLElBQUEsR0FBQSxJQUFBO0FBSlgsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERFQlVHIH0gZnJvbSAnQGdsaW1tZXIvZW52JztcbmltcG9ydCB7XG4gIEFyZ3VtZW50cyxcbiAgQ29tcG9uZW50Q2FwYWJpbGl0aWVzLFxuICBDb21wb25lbnRDYXBhYmlsaXRpZXNWZXJzaW9ucyxcbiAgQ29tcG9uZW50RGVmaW5pdGlvblN0YXRlLFxuICBDb21wb25lbnRNYW5hZ2VyLFxuICBDb21wb25lbnRNYW5hZ2VyV2l0aEFzeW5jTGlmZUN5Y2xlQ2FsbGJhY2tzLFxuICBDb21wb25lbnRNYW5hZ2VyV2l0aEFzeW5jVXBkYXRlSG9vayxcbiAgQ29tcG9uZW50TWFuYWdlcldpdGhEZXN0cnVjdG9ycyxcbiAgQ29tcG9uZW50TWFuYWdlcldpdGhVcGRhdGVIb29rLFxuICBEZXN0cm95YWJsZSxcbiAgSW50ZXJuYWxDb21wb25lbnRDYXBhYmlsaXRpZXMsXG4gIEludGVybmFsQ29tcG9uZW50TWFuYWdlcixcbiAgT3B0aW9uLFxuICBPd25lcixcbiAgVk1Bcmd1bWVudHMsXG59IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgY3JlYXRlQ29uc3RSZWYsIFJlZmVyZW5jZSB9IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5pbXBvcnQgeyByZWdpc3RlckRlc3RydWN0b3IgfSBmcm9tICdAZ2xpbW1lci9kZXN0cm95YWJsZSc7XG5pbXBvcnQgeyBidWlsZENhcGFiaWxpdGllcywgRlJPTV9DQVBBQklMSVRJRVMgfSBmcm9tICcuLi91dGlsL2NhcGFiaWxpdGllcyc7XG5pbXBvcnQgeyBhcmdzUHJveHlGb3IgfSBmcm9tICcuLi91dGlsL2FyZ3MtcHJveHknO1xuaW1wb3J0IHsgTWFuYWdlckZhY3RvcnkgfSBmcm9tICcuL2luZGV4JztcblxuY29uc3QgQ0FQQUJJTElUSUVTID0ge1xuICBkeW5hbWljTGF5b3V0OiBmYWxzZSxcbiAgZHluYW1pY1RhZzogZmFsc2UsXG4gIHByZXBhcmVBcmdzOiBmYWxzZSxcbiAgY3JlYXRlQXJnczogdHJ1ZSxcbiAgYXR0cmlidXRlSG9vazogZmFsc2UsXG4gIGVsZW1lbnRIb29rOiBmYWxzZSxcbiAgY3JlYXRlQ2FsbGVyOiBmYWxzZSxcbiAgZHluYW1pY1Njb3BlOiB0cnVlLFxuICB1cGRhdGVIb29rOiB0cnVlLFxuICBjcmVhdGVJbnN0YW5jZTogdHJ1ZSxcbiAgd3JhcHBlZDogZmFsc2UsXG4gIHdpbGxEZXN0cm95OiBmYWxzZSxcbiAgaGFzU3ViT3duZXI6IGZhbHNlLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBvbmVudENhcGFiaWxpdGllczxWZXJzaW9uIGV4dGVuZHMga2V5b2YgQ29tcG9uZW50Q2FwYWJpbGl0aWVzVmVyc2lvbnM+KFxuICBtYW5hZ2VyQVBJOiBWZXJzaW9uLFxuICBvcHRpb25zOiBDb21wb25lbnRDYXBhYmlsaXRpZXNWZXJzaW9uc1tWZXJzaW9uXSA9IHt9XG4pOiBDb21wb25lbnRDYXBhYmlsaXRpZXMge1xuICBpZiAoREVCVUcgJiYgbWFuYWdlckFQSSAhPT0gJzMuMTMnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGNvbXBvbmVudCBtYW5hZ2VyIGNvbXBhdGliaWxpdHkgc3BlY2lmaWVkJyk7XG4gIH1cblxuICBsZXQgdXBkYXRlSG9vayA9IEJvb2xlYW4oKG9wdGlvbnMgYXMgQ29tcG9uZW50Q2FwYWJpbGl0aWVzVmVyc2lvbnNbJzMuMTMnXSkudXBkYXRlSG9vayk7XG5cbiAgcmV0dXJuIGJ1aWxkQ2FwYWJpbGl0aWVzKHtcbiAgICBhc3luY0xpZmVDeWNsZUNhbGxiYWNrczogQm9vbGVhbihvcHRpb25zLmFzeW5jTGlmZWN5Y2xlQ2FsbGJhY2tzKSxcbiAgICBkZXN0cnVjdG9yOiBCb29sZWFuKG9wdGlvbnMuZGVzdHJ1Y3RvciksXG4gICAgdXBkYXRlSG9vayxcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNBc3luY0xpZmVDeWNsZUNhbGxiYWNrczxDb21wb25lbnRJbnN0YW5jZT4oXG4gIGRlbGVnYXRlOiBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudEluc3RhbmNlPlxuKTogZGVsZWdhdGUgaXMgQ29tcG9uZW50TWFuYWdlcldpdGhBc3luY0xpZmVDeWNsZUNhbGxiYWNrczxDb21wb25lbnRJbnN0YW5jZT4ge1xuICByZXR1cm4gZGVsZWdhdGUuY2FwYWJpbGl0aWVzLmFzeW5jTGlmZUN5Y2xlQ2FsbGJhY2tzO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzVXBkYXRlSG9vazxDb21wb25lbnRJbnN0YW5jZT4oXG4gIGRlbGVnYXRlOiBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudEluc3RhbmNlPlxuKTogZGVsZWdhdGUgaXMgQ29tcG9uZW50TWFuYWdlcldpdGhVcGRhdGVIb29rPENvbXBvbmVudEluc3RhbmNlPiB7XG4gIHJldHVybiBkZWxlZ2F0ZS5jYXBhYmlsaXRpZXMudXBkYXRlSG9vaztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc0FzeW5jVXBkYXRlSG9vazxDb21wb25lbnRJbnN0YW5jZT4oXG4gIGRlbGVnYXRlOiBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudEluc3RhbmNlPlxuKTogZGVsZWdhdGUgaXMgQ29tcG9uZW50TWFuYWdlcldpdGhBc3luY1VwZGF0ZUhvb2s8Q29tcG9uZW50SW5zdGFuY2U+IHtcbiAgcmV0dXJuIGhhc0FzeW5jTGlmZUN5Y2xlQ2FsbGJhY2tzKGRlbGVnYXRlKSAmJiBoYXNVcGRhdGVIb29rKGRlbGVnYXRlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc0Rlc3RydWN0b3JzPENvbXBvbmVudEluc3RhbmNlPihcbiAgZGVsZWdhdGU6IENvbXBvbmVudE1hbmFnZXI8Q29tcG9uZW50SW5zdGFuY2U+XG4pOiBkZWxlZ2F0ZSBpcyBDb21wb25lbnRNYW5hZ2VyV2l0aERlc3RydWN0b3JzPENvbXBvbmVudEluc3RhbmNlPiB7XG4gIHJldHVybiBkZWxlZ2F0ZS5jYXBhYmlsaXRpZXMuZGVzdHJ1Y3Rvcjtcbn1cblxuLyoqXG4gIFRoZSBDdXN0b21Db21wb25lbnRNYW5hZ2VyIGFsbG93cyBhZGRvbnMgdG8gcHJvdmlkZSBjdXN0b20gY29tcG9uZW50XG4gIGltcGxlbWVudGF0aW9ucyB0aGF0IGludGVncmF0ZSBzZWFtbGVzc2x5IGludG8gRW1iZXIuIFRoaXMgaXMgYWNjb21wbGlzaGVkXG4gIHRocm91Z2ggYSBkZWxlZ2F0ZSwgcmVnaXN0ZXJlZCB3aXRoIHRoZSBjdXN0b20gY29tcG9uZW50IG1hbmFnZXIsIHdoaWNoXG4gIGltcGxlbWVudHMgYSBzZXQgb2YgaG9va3MgdGhhdCBkZXRlcm1pbmUgY29tcG9uZW50IGJlaGF2aW9yLlxuXG4gIFRvIGNyZWF0ZSBhIGN1c3RvbSBjb21wb25lbnQgbWFuYWdlciwgaW5zdGFudGlhdGUgYSBuZXcgQ3VzdG9tQ29tcG9uZW50TWFuYWdlclxuICBjbGFzcyBhbmQgcGFzcyB0aGUgZGVsZWdhdGUgYXMgdGhlIGZpcnN0IGFyZ3VtZW50OlxuXG4gIGBgYGpzXG4gIGxldCBtYW5hZ2VyID0gbmV3IEN1c3RvbUNvbXBvbmVudE1hbmFnZXIoe1xuICAgIC8vIC4uLmRlbGVnYXRlIGltcGxlbWVudGF0aW9uLi4uXG4gIH0pO1xuICBgYGBcblxuICAjIyBEZWxlZ2F0ZSBIb29rc1xuXG4gIFRocm91Z2hvdXQgdGhlIGxpZmVjeWNsZSBvZiBhIGNvbXBvbmVudCwgdGhlIGNvbXBvbmVudCBtYW5hZ2VyIHdpbGwgaW52b2tlXG4gIGRlbGVnYXRlIGhvb2tzIHRoYXQgYXJlIHJlc3BvbnNpYmxlIGZvciBzdXJmYWNpbmcgdGhvc2UgbGlmZWN5Y2xlIGNoYW5nZXMgdG9cbiAgdGhlIGVuZCBkZXZlbG9wZXIuXG5cbiAgKiBgY3JlYXRlKClgIC0gaW52b2tlZCB3aGVuIGEgbmV3IGluc3RhbmNlIG9mIGEgY29tcG9uZW50IHNob3VsZCBiZSBjcmVhdGVkXG4gICogYHVwZGF0ZSgpYCAtIGludm9rZWQgd2hlbiB0aGUgYXJndW1lbnRzIHBhc3NlZCB0byBhIGNvbXBvbmVudCBjaGFuZ2VcbiAgKiBgZ2V0Q29udGV4dCgpYCAtIHJldHVybnMgdGhlIG9iamVjdCB0aGF0IHNob3VsZCBiZVxuKi9cbmV4cG9ydCBjbGFzcyBDdXN0b21Db21wb25lbnRNYW5hZ2VyPE8gZXh0ZW5kcyBPd25lciwgQ29tcG9uZW50SW5zdGFuY2U+XG4gIGltcGxlbWVudHMgSW50ZXJuYWxDb21wb25lbnRNYW5hZ2VyPEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPj4ge1xuICBwcml2YXRlIGNvbXBvbmVudE1hbmFnZXJEZWxlZ2F0ZXMgPSBuZXcgV2Vha01hcDxPLCBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudEluc3RhbmNlPj4oKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZhY3Rvcnk6IE1hbmFnZXJGYWN0b3J5PE8sIENvbXBvbmVudE1hbmFnZXI8Q29tcG9uZW50SW5zdGFuY2U+Pikge31cblxuICBwcml2YXRlIGdldERlbGVnYXRlRm9yKG93bmVyOiBPKSB7XG4gICAgbGV0IHsgY29tcG9uZW50TWFuYWdlckRlbGVnYXRlcyB9ID0gdGhpcztcbiAgICBsZXQgZGVsZWdhdGUgPSBjb21wb25lbnRNYW5hZ2VyRGVsZWdhdGVzLmdldChvd25lcik7XG5cbiAgICBpZiAoZGVsZWdhdGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgbGV0IHsgZmFjdG9yeSB9ID0gdGhpcztcbiAgICAgIGRlbGVnYXRlID0gZmFjdG9yeShvd25lcik7XG5cbiAgICAgIGlmIChERUJVRyAmJiAhRlJPTV9DQVBBQklMSVRJRVMhLmhhcyhkZWxlZ2F0ZS5jYXBhYmlsaXRpZXMpKSB7XG4gICAgICAgIC8vIFRPRE86IFRoaXMgZXJyb3IgbWVzc2FnZSBzaG91bGQgbWFrZSBzZW5zZSBpbiBib3RoIEVtYmVyIGFuZCBHbGltbWVyIGh0dHBzOi8vZ2l0aHViLmNvbS9nbGltbWVyanMvZ2xpbW1lci12bS9pc3N1ZXMvMTIwMFxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEN1c3RvbSBjb21wb25lbnQgbWFuYWdlcnMgbXVzdCBoYXZlIGEgXFxgY2FwYWJpbGl0aWVzXFxgIHByb3BlcnR5IHRoYXQgaXMgdGhlIHJlc3VsdCBvZiBjYWxsaW5nIHRoZSBcXGBjYXBhYmlsaXRpZXMoJzMuMTMnKVxcYCAoaW1wb3J0ZWQgdmlhIFxcYGltcG9ydCB7IGNhcGFiaWxpdGllcyB9IGZyb20gJ0BlbWJlci9jb21wb25lbnQnO1xcYCkuIFJlY2VpdmVkOiBcXGAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgZGVsZWdhdGUuY2FwYWJpbGl0aWVzXG4gICAgICAgICAgKX1cXGAgZm9yOiBcXGAke2RlbGVnYXRlfVxcYGBcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgY29tcG9uZW50TWFuYWdlckRlbGVnYXRlcy5zZXQob3duZXIsIGRlbGVnYXRlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVsZWdhdGU7XG4gIH1cblxuICBjcmVhdGUoXG4gICAgb3duZXI6IE8sXG4gICAgZGVmaW5pdGlvbjogQ29tcG9uZW50RGVmaW5pdGlvblN0YXRlLFxuICAgIHZtQXJnczogVk1Bcmd1bWVudHNcbiAgKTogQ3VzdG9tQ29tcG9uZW50U3RhdGU8Q29tcG9uZW50SW5zdGFuY2U+IHtcbiAgICBsZXQgZGVsZWdhdGUgPSB0aGlzLmdldERlbGVnYXRlRm9yKG93bmVyKTtcbiAgICBsZXQgYXJncyA9IGFyZ3NQcm94eUZvcih2bUFyZ3MuY2FwdHVyZSgpLCAnY29tcG9uZW50Jyk7XG5cbiAgICBsZXQgY29tcG9uZW50OiBDb21wb25lbnRJbnN0YW5jZSA9IGRlbGVnYXRlLmNyZWF0ZUNvbXBvbmVudChkZWZpbml0aW9uLCBhcmdzKTtcblxuICAgIHJldHVybiBuZXcgQ3VzdG9tQ29tcG9uZW50U3RhdGUoY29tcG9uZW50ISwgZGVsZWdhdGUsIGFyZ3MpO1xuICB9XG5cbiAgZ2V0RGVidWdOYW1lKGRlZmluaXRpb246IENvbXBvbmVudERlZmluaXRpb25TdGF0ZSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHR5cGVvZiBkZWZpbml0aW9uID09PSAnZnVuY3Rpb24nID8gZGVmaW5pdGlvbi5uYW1lIDogZGVmaW5pdGlvbi50b1N0cmluZygpO1xuICB9XG5cbiAgdXBkYXRlKGJ1Y2tldDogQ3VzdG9tQ29tcG9uZW50U3RhdGU8Q29tcG9uZW50SW5zdGFuY2U+KTogdm9pZCB7XG4gICAgbGV0IHsgZGVsZWdhdGUgfSA9IGJ1Y2tldDtcbiAgICBpZiAoaGFzVXBkYXRlSG9vayhkZWxlZ2F0ZSkpIHtcbiAgICAgIGxldCB7IGNvbXBvbmVudCwgYXJncyB9ID0gYnVja2V0O1xuXG4gICAgICBkZWxlZ2F0ZS51cGRhdGVDb21wb25lbnQoY29tcG9uZW50LCBhcmdzKTtcbiAgICB9XG4gIH1cblxuICBkaWRDcmVhdGUoeyBjb21wb25lbnQsIGRlbGVnYXRlIH06IEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPik6IHZvaWQge1xuICAgIGlmIChoYXNBc3luY0xpZmVDeWNsZUNhbGxiYWNrcyhkZWxlZ2F0ZSkpIHtcbiAgICAgIGRlbGVnYXRlLmRpZENyZWF0ZUNvbXBvbmVudChjb21wb25lbnQpO1xuICAgIH1cbiAgfVxuXG4gIGRpZFVwZGF0ZSh7IGNvbXBvbmVudCwgZGVsZWdhdGUgfTogQ3VzdG9tQ29tcG9uZW50U3RhdGU8Q29tcG9uZW50SW5zdGFuY2U+KTogdm9pZCB7XG4gICAgaWYgKGhhc0FzeW5jVXBkYXRlSG9vayhkZWxlZ2F0ZSkpIHtcbiAgICAgIGRlbGVnYXRlLmRpZFVwZGF0ZUNvbXBvbmVudChjb21wb25lbnQpO1xuICAgIH1cbiAgfVxuXG4gIGRpZFJlbmRlckxheW91dCgpOiB2b2lkIHt9XG5cbiAgZGlkVXBkYXRlTGF5b3V0KCk6IHZvaWQge31cblxuICBnZXRTZWxmKHsgY29tcG9uZW50LCBkZWxlZ2F0ZSB9OiBDdXN0b21Db21wb25lbnRTdGF0ZTxDb21wb25lbnRJbnN0YW5jZT4pOiBSZWZlcmVuY2Uge1xuICAgIHJldHVybiBjcmVhdGVDb25zdFJlZihkZWxlZ2F0ZS5nZXRDb250ZXh0KGNvbXBvbmVudCksICd0aGlzJyk7XG4gIH1cblxuICBnZXREZXN0cm95YWJsZShidWNrZXQ6IEN1c3RvbUNvbXBvbmVudFN0YXRlPENvbXBvbmVudEluc3RhbmNlPik6IE9wdGlvbjxEZXN0cm95YWJsZT4ge1xuICAgIGNvbnN0IHsgZGVsZWdhdGUgfSA9IGJ1Y2tldDtcblxuICAgIGlmIChoYXNEZXN0cnVjdG9ycyhkZWxlZ2F0ZSkpIHtcbiAgICAgIGNvbnN0IHsgY29tcG9uZW50IH0gPSBidWNrZXQ7XG5cbiAgICAgIHJlZ2lzdGVyRGVzdHJ1Y3RvcihidWNrZXQsICgpID0+IGRlbGVnYXRlLmRlc3Ryb3lDb21wb25lbnQoY29tcG9uZW50KSk7XG4gICAgICByZXR1cm4gYnVja2V0O1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZ2V0Q2FwYWJpbGl0aWVzKCk6IEludGVybmFsQ29tcG9uZW50Q2FwYWJpbGl0aWVzIHtcbiAgICByZXR1cm4gQ0FQQUJJTElUSUVTO1xuICB9XG59XG5cbi8qKlxuICogU3RvcmVzIGludGVybmFsIHN0YXRlIGFib3V0IGEgY29tcG9uZW50IGluc3RhbmNlIGFmdGVyIGl0J3MgYmVlbiBjcmVhdGVkLlxuICovXG5leHBvcnQgY2xhc3MgQ3VzdG9tQ29tcG9uZW50U3RhdGU8Q29tcG9uZW50SW5zdGFuY2U+IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGNvbXBvbmVudDogQ29tcG9uZW50SW5zdGFuY2UsXG4gICAgcHVibGljIGRlbGVnYXRlOiBDb21wb25lbnRNYW5hZ2VyPENvbXBvbmVudEluc3RhbmNlPixcbiAgICBwdWJsaWMgYXJnczogQXJndW1lbnRzXG4gICkge31cbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=