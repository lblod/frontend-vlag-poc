function _createForOfIteratorHelperLoose(o, allowArrayLike) { var it; if (typeof Symbol === "undefined" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") { if (it) o = it; var i = 0; return function () { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }; } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); } it = o[Symbol.iterator](); return it.next.bind(it); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

import { exhausted, LOCAL_LOGGER } from '@glimmer/util';
import { deflateAttrName, deflateTagName } from '../../utils';
import { EXPR } from './expressions';

var WireStatements = /*#__PURE__*/function () {
  function WireStatements(statements) {
    this.statements = statements;
  }

  var _proto = WireStatements.prototype;

  _proto.toArray = function toArray() {
    return this.statements;
  };

  return WireStatements;
}();

export var ContentEncoder = /*#__PURE__*/function () {
  function ContentEncoder() {}

  var _proto2 = ContentEncoder.prototype;

  _proto2.list = function list(statements) {
    var out = [];

    for (var _iterator = _createForOfIteratorHelperLoose(statements), _step; !(_step = _iterator()).done;) {
      var statement = _step.value;
      var result = CONTENT.content(statement);

      if (result && result instanceof WireStatements) {
        out.push.apply(out, result.toArray());
      } else {
        out.push(result);
      }
    }

    return out;
  };

  _proto2.content = function content(stmt) {
    if (false
    /* LOCAL_SHOULD_LOG */
    ) {
        LOCAL_LOGGER.log("encoding", stmt);
      }

    return this.visitContent(stmt);
  };

  _proto2.visitContent = function visitContent(stmt) {
    switch (stmt.type) {
      case 'Debugger':
        return [26
        /* Debugger */
        , stmt.scope.getEvalInfo()];

      case 'AppendComment':
        return this.AppendComment(stmt);

      case 'AppendTextNode':
        return this.AppendTextNode(stmt);

      case 'AppendTrustedHTML':
        return this.AppendTrustedHTML(stmt);

      case 'Yield':
        return this.Yield(stmt);

      case 'Component':
        return this.Component(stmt);

      case 'SimpleElement':
        return this.SimpleElement(stmt);

      case 'InElement':
        return this.InElement(stmt);

      case 'InvokeBlock':
        return this.InvokeBlock(stmt);

      case 'If':
        return this.If(stmt);

      case 'Each':
        return this.Each(stmt);

      case 'With':
        return this.With(stmt);

      case 'Let':
        return this.Let(stmt);

      case 'WithDynamicVars':
        return this.WithDynamicVars(stmt);

      case 'InvokeComponent':
        return this.InvokeComponent(stmt);

      default:
        return exhausted(stmt);
    }
  };

  _proto2.Yield = function Yield(_ref) {
    var to = _ref.to,
        positional = _ref.positional;
    return [18
    /* Yield */
    , to, EXPR.Positional(positional)];
  };

  _proto2.InElement = function InElement(_ref2) {
    var guid = _ref2.guid,
        insertBefore = _ref2.insertBefore,
        destination = _ref2.destination,
        block = _ref2.block;
    var wireBlock = CONTENT.NamedBlock(block)[1]; // let guid = args.guid;

    var wireDestination = EXPR.expr(destination);
    var wireInsertBefore = EXPR.expr(insertBefore);

    if (wireInsertBefore === undefined) {
      return [40
      /* InElement */
      , wireBlock, guid, wireDestination];
    } else {
      return [40
      /* InElement */
      , wireBlock, guid, wireDestination, wireInsertBefore];
    }
  };

  _proto2.InvokeBlock = function InvokeBlock(_ref3) {
    var head = _ref3.head,
        args = _ref3.args,
        blocks = _ref3.blocks;
    return [6
    /* Block */
    , EXPR.expr(head)].concat(EXPR.Args(args), [CONTENT.NamedBlocks(blocks)]);
  };

  _proto2.AppendTrustedHTML = function AppendTrustedHTML(_ref4) {
    var html = _ref4.html;
    return [2
    /* TrustingAppend */
    , EXPR.expr(html)];
  };

  _proto2.AppendTextNode = function AppendTextNode(_ref5) {
    var text = _ref5.text;
    return [1
    /* Append */
    , EXPR.expr(text)];
  };

  _proto2.AppendComment = function AppendComment(_ref6) {
    var value = _ref6.value;
    return [3
    /* Comment */
    , value.chars];
  };

  _proto2.SimpleElement = function SimpleElement(_ref7) {
    var tag = _ref7.tag,
        params = _ref7.params,
        body = _ref7.body,
        dynamicFeatures = _ref7.dynamicFeatures;
    var op = dynamicFeatures ? 11
    /* OpenElementWithSplat */
    : 10
    /* OpenElement */
    ;
    return new WireStatements([[op, deflateTagName(tag.chars)]].concat(CONTENT.ElementParameters(params).toArray(), [[12
    /* FlushElement */
    ]], CONTENT.list(body), [[13
    /* CloseElement */
    ]]));
  };

  _proto2.Component = function Component(_ref8) {
    var tag = _ref8.tag,
        params = _ref8.params,
        args = _ref8.args,
        blocks = _ref8.blocks;
    var wireTag = EXPR.expr(tag);
    var wirePositional = CONTENT.ElementParameters(params);
    var wireNamed = EXPR.NamedArguments(args);
    var wireNamedBlocks = CONTENT.NamedBlocks(blocks);
    return [8
    /* Component */
    , wireTag, wirePositional.toPresentArray(), wireNamed, wireNamedBlocks];
  };

  _proto2.ElementParameters = function ElementParameters(_ref9) {
    var body = _ref9.body;
    return body.map(function (p) {
      return CONTENT.ElementParameter(p);
    });
  };

  _proto2.ElementParameter = function ElementParameter(param) {
    switch (param.type) {
      case 'SplatAttr':
        return [17
        /* AttrSplat */
        , param.symbol];

      case 'DynamicAttr':
        return [dynamicAttrOp(param.kind)].concat(dynamicAttr(param));

      case 'StaticAttr':
        return [staticAttrOp(param.kind)].concat(staticAttr(param));

      case 'Modifier':
        return [4
        /* Modifier */
        , EXPR.expr(param.callee)].concat(EXPR.Args(param.args));
    }
  };

  _proto2.NamedBlocks = function NamedBlocks(_ref10) {
    var blocks = _ref10.blocks;
    var names = [];
    var serializedBlocks = [];

    for (var _iterator2 = _createForOfIteratorHelperLoose(blocks.toArray()), _step2; !(_step2 = _iterator2()).done;) {
      var block = _step2.value;

      var _CONTENT$NamedBlock = CONTENT.NamedBlock(block),
          name = _CONTENT$NamedBlock[0],
          serializedBlock = _CONTENT$NamedBlock[1];

      names.push(name);
      serializedBlocks.push(serializedBlock);
    }

    return names.length > 0 ? [names, serializedBlocks] : null;
  };

  _proto2.NamedBlock = function NamedBlock(_ref11) {
    var name = _ref11.name,
        body = _ref11.body,
        scope = _ref11.scope;
    var nameChars = name.chars;

    if (nameChars === 'inverse') {
      nameChars = 'else';
    }

    return [nameChars, [CONTENT.list(body), scope.slots]];
  };

  _proto2.If = function If(_ref12) {
    var condition = _ref12.condition,
        block = _ref12.block,
        inverse = _ref12.inverse;
    return [41
    /* If */
    , EXPR.expr(condition), CONTENT.NamedBlock(block)[1], inverse ? CONTENT.NamedBlock(inverse)[1] : null];
  };

  _proto2.Each = function Each(_ref13) {
    var value = _ref13.value,
        key = _ref13.key,
        block = _ref13.block,
        inverse = _ref13.inverse;
    return [42
    /* Each */
    , EXPR.expr(value), key ? EXPR.expr(key) : null, CONTENT.NamedBlock(block)[1], inverse ? CONTENT.NamedBlock(inverse)[1] : null];
  };

  _proto2.With = function With(_ref14) {
    var value = _ref14.value,
        block = _ref14.block,
        inverse = _ref14.inverse;
    return [43
    /* With */
    , EXPR.expr(value), CONTENT.NamedBlock(block)[1], inverse ? CONTENT.NamedBlock(inverse)[1] : null];
  };

  _proto2.Let = function Let(_ref15) {
    var positional = _ref15.positional,
        block = _ref15.block;
    return [44
    /* Let */
    , EXPR.Positional(positional), CONTENT.NamedBlock(block)[1]];
  };

  _proto2.WithDynamicVars = function WithDynamicVars(_ref16) {
    var named = _ref16.named,
        block = _ref16.block;
    return [45
    /* WithDynamicVars */
    , EXPR.NamedArguments(named), CONTENT.NamedBlock(block)[1]];
  };

  _proto2.InvokeComponent = function InvokeComponent(_ref17) {
    var definition = _ref17.definition,
        args = _ref17.args,
        blocks = _ref17.blocks;
    return [46
    /* InvokeComponent */
    , EXPR.expr(definition), EXPR.Positional(args.positional), EXPR.NamedArguments(args.named), blocks ? CONTENT.NamedBlocks(blocks) : null];
  };

  return ContentEncoder;
}();
export var CONTENT = new ContentEncoder();

function staticAttr(_ref18) {
  var name = _ref18.name,
      value = _ref18.value,
      namespace = _ref18.namespace;
  var out = [deflateAttrName(name.chars), value.chars];

  if (namespace) {
    out.push(namespace);
  }

  return out;
}

function dynamicAttr(_ref19) {
  var name = _ref19.name,
      value = _ref19.value,
      namespace = _ref19.namespace;
  var out = [deflateAttrName(name.chars), EXPR.expr(value)];

  if (namespace) {
    out.push(namespace);
  }

  return out;
}

function staticAttrOp(kind) {
  if (kind.component) {
    return 24
    /* StaticComponentAttr */
    ;
  } else {
      return 14
      /* StaticAttr */
      ;
    }
}

function dynamicAttrOp(kind) {
  if (kind.component) {
    return kind.trusting ? 23
    /* TrustingComponentAttr */
    : 16
    /* ComponentAttr */
    ;
  } else {
    return kind.trusting ? 22
    /* TrustingDynamicAttr */
    : 15
    /* DynamicAttr */
    ;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi9wYXNzZXMvMi1lbmNvZGluZy9jb250ZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBLFNBQUEsU0FBQSxFQUFBLFlBQUEsUUFBQSxlQUFBO0FBR0EsU0FBQSxlQUFBLEVBQUEsY0FBQSxRQUFBLGFBQUE7QUFDQSxTQUFBLElBQUEsUUFBQSxlQUFBOztJQUdBLGM7QUFDRSwwQkFBQSxVQUFBLEVBQTRDO0FBQXhCLFNBQUEsVUFBQSxHQUFBLFVBQUE7QUFBNEI7Ozs7U0FFaEQsTyxHQUFBLG1CQUFPO0FBQ0wsV0FBTyxLQUFQLFVBQUE7QUFDRCxHOzs7OztBQUdILFdBQU0sY0FBTjtBQUFBOztBQUFBOztBQUFBLFVBQ0UsSUFERixHQUNFLGNBQUksVUFBSixFQUFnQztBQUM5QixRQUFJLEdBQUcsR0FBUCxFQUFBOztBQUVBLHlEQUFBLFVBQUEsd0NBQWtDO0FBQUEsVUFBbEMsU0FBa0M7QUFDaEMsVUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFQLE9BQUEsQ0FBYixTQUFhLENBQWI7O0FBRUEsVUFBSSxNQUFNLElBQUksTUFBTSxZQUFwQixjQUFBLEVBQWdEO0FBQzlDLFFBQUEsR0FBRyxDQUFILElBQUEsT0FBQSxHQUFHLEVBQVMsTUFBTSxDQUFsQixPQUFZLEVBQVQsQ0FBSDtBQURGLE9BQUEsTUFFTztBQUNMLFFBQUEsR0FBRyxDQUFILElBQUEsQ0FBQSxNQUFBO0FBQ0Q7QUFDRjs7QUFFRCxXQUFBLEdBQUE7QUFDRCxHQWZIOztBQUFBLFVBaUJFLE9BakJGLEdBaUJFLGlCQUFPLElBQVAsRUFBMkI7QUFDekIsUUFBQTtBQUFBO0FBQUEsTUFBc0I7QUFDcEIsUUFBQSxZQUFZLENBQVosR0FBQSxhQUFBLElBQUE7QUFDRDs7QUFFRCxXQUFPLEtBQUEsWUFBQSxDQUFQLElBQU8sQ0FBUDtBQUNELEdBdkJIOztBQUFBLFVBeUJVLFlBekJWLEdBeUJV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ZTtBQUFBO0FBQWYsTUFBaUQ7QUFBQTtBQUF4RDtBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTZXhwT3Bjb2RlcywgV2VsbEtub3duQXR0ck5hbWUsIFdpcmVGb3JtYXQgfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IExPQ0FMX1NIT1VMRF9MT0cgfSBmcm9tICdAZ2xpbW1lci9sb2NhbC1kZWJ1Zy1mbGFncyc7XG5pbXBvcnQgeyBleGhhdXN0ZWQsIExPQ0FMX0xPR0dFUiB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5pbXBvcnQgeyBPcHRpb25hbExpc3QgfSBmcm9tICcuLi8uLi9zaGFyZWQvbGlzdCc7XG5pbXBvcnQgeyBkZWZsYXRlQXR0ck5hbWUsIGRlZmxhdGVUYWdOYW1lIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgRVhQUiB9IGZyb20gJy4vZXhwcmVzc2lvbnMnO1xuaW1wb3J0ICogYXMgbWlyIGZyb20gJy4vbWlyJztcblxuY2xhc3MgV2lyZVN0YXRlbWVudHM8UyBleHRlbmRzIFdpcmVGb3JtYXQuU3RhdGVtZW50ID0gV2lyZUZvcm1hdC5TdGF0ZW1lbnQ+IHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzdGF0ZW1lbnRzOiByZWFkb25seSBTW10pIHt9XG5cbiAgdG9BcnJheSgpOiByZWFkb25seSBTW10ge1xuICAgIHJldHVybiB0aGlzLnN0YXRlbWVudHM7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIENvbnRlbnRFbmNvZGVyIHtcbiAgbGlzdChzdGF0ZW1lbnRzOiBtaXIuU3RhdGVtZW50W10pOiBXaXJlRm9ybWF0LlN0YXRlbWVudFtdIHtcbiAgICBsZXQgb3V0OiBXaXJlRm9ybWF0LlN0YXRlbWVudFtdID0gW107XG5cbiAgICBmb3IgKGxldCBzdGF0ZW1lbnQgb2Ygc3RhdGVtZW50cykge1xuICAgICAgbGV0IHJlc3VsdCA9IENPTlRFTlQuY29udGVudChzdGF0ZW1lbnQpO1xuXG4gICAgICBpZiAocmVzdWx0ICYmIHJlc3VsdCBpbnN0YW5jZW9mIFdpcmVTdGF0ZW1lbnRzKSB7XG4gICAgICAgIG91dC5wdXNoKC4uLnJlc3VsdC50b0FycmF5KCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3V0LnB1c2gocmVzdWx0KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgY29udGVudChzdG10OiBtaXIuU3RhdGVtZW50KTogV2lyZUZvcm1hdC5TdGF0ZW1lbnQgfCBXaXJlU3RhdGVtZW50cyB7XG4gICAgaWYgKExPQ0FMX1NIT1VMRF9MT0cpIHtcbiAgICAgIExPQ0FMX0xPR0dFUi5sb2coYGVuY29kaW5nYCwgc3RtdCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudmlzaXRDb250ZW50KHN0bXQpO1xuICB9XG5cbiAgcHJpdmF0ZSB2aXNpdENvbnRlbnQoc3RtdDogbWlyLlN0YXRlbWVudCk6IFdpcmVGb3JtYXQuU3RhdGVtZW50IHwgV2lyZVN0YXRlbWVudHMge1xuICAgIHN3aXRjaCAoc3RtdC50eXBlKSB7XG4gICAgICBjYXNlICdEZWJ1Z2dlcic6XG4gICAgICAgIHJldHVybiBbU2V4cE9wY29kZXMuRGVidWdnZXIsIHN0bXQuc2NvcGUuZ2V0RXZhbEluZm8oKV07XG4gICAgICBjYXNlICdBcHBlbmRDb21tZW50JzpcbiAgICAgICAgcmV0dXJuIHRoaXMuQXBwZW5kQ29tbWVudChzdG10KTtcbiAgICAgIGNhc2UgJ0FwcGVuZFRleHROb2RlJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuQXBwZW5kVGV4dE5vZGUoc3RtdCk7XG4gICAgICBjYXNlICdBcHBlbmRUcnVzdGVkSFRNTCc6XG4gICAgICAgIHJldHVybiB0aGlzLkFwcGVuZFRydXN0ZWRIVE1MKHN0bXQpO1xuICAgICAgY2FzZSAnWWllbGQnOlxuICAgICAgICByZXR1cm4gdGhpcy5ZaWVsZChzdG10KTtcbiAgICAgIGNhc2UgJ0NvbXBvbmVudCc6XG4gICAgICAgIHJldHVybiB0aGlzLkNvbXBvbmVudChzdG10KTtcbiAgICAgIGNhc2UgJ1NpbXBsZUVsZW1lbnQnOlxuICAgICAgICByZXR1cm4gdGhpcy5TaW1wbGVFbGVtZW50KHN0bXQpO1xuICAgICAgY2FzZSAnSW5FbGVtZW50JzpcbiAgICAgICAgcmV0dXJuIHRoaXMuSW5FbGVtZW50KHN0bXQpO1xuICAgICAgY2FzZSAnSW52b2tlQmxvY2snOlxuICAgICAgICByZXR1cm4gdGhpcy5JbnZva2VCbG9jayhzdG10KTtcbiAgICAgIGNhc2UgJ0lmJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuSWYoc3RtdCk7XG4gICAgICBjYXNlICdFYWNoJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuRWFjaChzdG10KTtcbiAgICAgIGNhc2UgJ1dpdGgnOlxuICAgICAgICByZXR1cm4gdGhpcy5XaXRoKHN0bXQpO1xuICAgICAgY2FzZSAnTGV0JzpcbiAgICAgICAgcmV0dXJuIHRoaXMuTGV0KHN0bXQpO1xuICAgICAgY2FzZSAnV2l0aER5bmFtaWNWYXJzJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuV2l0aER5bmFtaWNWYXJzKHN0bXQpO1xuICAgICAgY2FzZSAnSW52b2tlQ29tcG9uZW50JzpcbiAgICAgICAgcmV0dXJuIHRoaXMuSW52b2tlQ29tcG9uZW50KHN0bXQpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIGV4aGF1c3RlZChzdG10KTtcbiAgICB9XG4gIH1cblxuICBZaWVsZCh7IHRvLCBwb3NpdGlvbmFsIH06IG1pci5ZaWVsZCk6IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5ZaWVsZCB7XG4gICAgcmV0dXJuIFtTZXhwT3Bjb2Rlcy5ZaWVsZCwgdG8sIEVYUFIuUG9zaXRpb25hbChwb3NpdGlvbmFsKV07XG4gIH1cblxuICBJbkVsZW1lbnQoe1xuICAgIGd1aWQsXG4gICAgaW5zZXJ0QmVmb3JlLFxuICAgIGRlc3RpbmF0aW9uLFxuICAgIGJsb2NrLFxuICB9OiBtaXIuSW5FbGVtZW50KTogV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLkluRWxlbWVudCB7XG4gICAgbGV0IHdpcmVCbG9jayA9IENPTlRFTlQuTmFtZWRCbG9jayhibG9jaylbMV07XG4gICAgLy8gbGV0IGd1aWQgPSBhcmdzLmd1aWQ7XG4gICAgbGV0IHdpcmVEZXN0aW5hdGlvbiA9IEVYUFIuZXhwcihkZXN0aW5hdGlvbik7XG4gICAgbGV0IHdpcmVJbnNlcnRCZWZvcmUgPSBFWFBSLmV4cHIoaW5zZXJ0QmVmb3JlKTtcblxuICAgIGlmICh3aXJlSW5zZXJ0QmVmb3JlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBbU2V4cE9wY29kZXMuSW5FbGVtZW50LCB3aXJlQmxvY2ssIGd1aWQsIHdpcmVEZXN0aW5hdGlvbl07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBbU2V4cE9wY29kZXMuSW5FbGVtZW50LCB3aXJlQmxvY2ssIGd1aWQsIHdpcmVEZXN0aW5hdGlvbiwgd2lyZUluc2VydEJlZm9yZV07XG4gICAgfVxuICB9XG5cbiAgSW52b2tlQmxvY2soeyBoZWFkLCBhcmdzLCBibG9ja3MgfTogbWlyLkludm9rZUJsb2NrKTogV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLkJsb2NrIHtcbiAgICByZXR1cm4gW1NleHBPcGNvZGVzLkJsb2NrLCBFWFBSLmV4cHIoaGVhZCksIC4uLkVYUFIuQXJncyhhcmdzKSwgQ09OVEVOVC5OYW1lZEJsb2NrcyhibG9ja3MpXTtcbiAgfVxuXG4gIEFwcGVuZFRydXN0ZWRIVE1MKHsgaHRtbCB9OiBtaXIuQXBwZW5kVHJ1c3RlZEhUTUwpOiBXaXJlRm9ybWF0LlN0YXRlbWVudHMuVHJ1c3RpbmdBcHBlbmQge1xuICAgIHJldHVybiBbU2V4cE9wY29kZXMuVHJ1c3RpbmdBcHBlbmQsIEVYUFIuZXhwcihodG1sKV07XG4gIH1cblxuICBBcHBlbmRUZXh0Tm9kZSh7IHRleHQgfTogbWlyLkFwcGVuZFRleHROb2RlKTogV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLkFwcGVuZCB7XG4gICAgcmV0dXJuIFtTZXhwT3Bjb2Rlcy5BcHBlbmQsIEVYUFIuZXhwcih0ZXh0KV07XG4gIH1cblxuICBBcHBlbmRDb21tZW50KHsgdmFsdWUgfTogbWlyLkFwcGVuZENvbW1lbnQpOiBXaXJlRm9ybWF0LlN0YXRlbWVudHMuQ29tbWVudCB7XG4gICAgcmV0dXJuIFtTZXhwT3Bjb2Rlcy5Db21tZW50LCB2YWx1ZS5jaGFyc107XG4gIH1cblxuICBTaW1wbGVFbGVtZW50KHsgdGFnLCBwYXJhbXMsIGJvZHksIGR5bmFtaWNGZWF0dXJlcyB9OiBtaXIuU2ltcGxlRWxlbWVudCk6IFdpcmVTdGF0ZW1lbnRzIHtcbiAgICBsZXQgb3AgPSBkeW5hbWljRmVhdHVyZXMgPyBTZXhwT3Bjb2Rlcy5PcGVuRWxlbWVudFdpdGhTcGxhdCA6IFNleHBPcGNvZGVzLk9wZW5FbGVtZW50O1xuICAgIHJldHVybiBuZXcgV2lyZVN0YXRlbWVudHM8V2lyZUZvcm1hdC5TdGF0ZW1lbnQgfCBXaXJlRm9ybWF0LkVsZW1lbnRQYXJhbWV0ZXI+KFtcbiAgICAgIFtvcCwgZGVmbGF0ZVRhZ05hbWUodGFnLmNoYXJzKV0sXG4gICAgICAuLi5DT05URU5ULkVsZW1lbnRQYXJhbWV0ZXJzKHBhcmFtcykudG9BcnJheSgpLFxuICAgICAgW1NleHBPcGNvZGVzLkZsdXNoRWxlbWVudF0sXG4gICAgICAuLi5DT05URU5ULmxpc3QoYm9keSksXG4gICAgICBbU2V4cE9wY29kZXMuQ2xvc2VFbGVtZW50XSxcbiAgICBdKTtcbiAgfVxuXG4gIENvbXBvbmVudCh7IHRhZywgcGFyYW1zLCBhcmdzLCBibG9ja3MgfTogbWlyLkNvbXBvbmVudCk6IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5Db21wb25lbnQge1xuICAgIGxldCB3aXJlVGFnID0gRVhQUi5leHByKHRhZyk7XG4gICAgbGV0IHdpcmVQb3NpdGlvbmFsID0gQ09OVEVOVC5FbGVtZW50UGFyYW1ldGVycyhwYXJhbXMpO1xuICAgIGxldCB3aXJlTmFtZWQgPSBFWFBSLk5hbWVkQXJndW1lbnRzKGFyZ3MpO1xuXG4gICAgbGV0IHdpcmVOYW1lZEJsb2NrcyA9IENPTlRFTlQuTmFtZWRCbG9ja3MoYmxvY2tzKTtcblxuICAgIHJldHVybiBbXG4gICAgICBTZXhwT3Bjb2Rlcy5Db21wb25lbnQsXG4gICAgICB3aXJlVGFnLFxuICAgICAgd2lyZVBvc2l0aW9uYWwudG9QcmVzZW50QXJyYXkoKSxcbiAgICAgIHdpcmVOYW1lZCxcbiAgICAgIHdpcmVOYW1lZEJsb2NrcyxcbiAgICBdO1xuICB9XG5cbiAgRWxlbWVudFBhcmFtZXRlcnMoeyBib2R5IH06IG1pci5FbGVtZW50UGFyYW1ldGVycyk6IE9wdGlvbmFsTGlzdDxXaXJlRm9ybWF0LkVsZW1lbnRQYXJhbWV0ZXI+IHtcbiAgICByZXR1cm4gYm9keS5tYXAoKHApID0+IENPTlRFTlQuRWxlbWVudFBhcmFtZXRlcihwKSk7XG4gIH1cblxuICBFbGVtZW50UGFyYW1ldGVyKHBhcmFtOiBtaXIuRWxlbWVudFBhcmFtZXRlcik6IFdpcmVGb3JtYXQuRWxlbWVudFBhcmFtZXRlciB7XG4gICAgc3dpdGNoIChwYXJhbS50eXBlKSB7XG4gICAgICBjYXNlICdTcGxhdEF0dHInOlxuICAgICAgICByZXR1cm4gW1NleHBPcGNvZGVzLkF0dHJTcGxhdCwgcGFyYW0uc3ltYm9sXTtcbiAgICAgIGNhc2UgJ0R5bmFtaWNBdHRyJzpcbiAgICAgICAgcmV0dXJuIFtkeW5hbWljQXR0ck9wKHBhcmFtLmtpbmQpLCAuLi5keW5hbWljQXR0cihwYXJhbSldO1xuICAgICAgY2FzZSAnU3RhdGljQXR0cic6XG4gICAgICAgIHJldHVybiBbc3RhdGljQXR0ck9wKHBhcmFtLmtpbmQpLCAuLi5zdGF0aWNBdHRyKHBhcmFtKV07XG4gICAgICBjYXNlICdNb2RpZmllcic6XG4gICAgICAgIHJldHVybiBbU2V4cE9wY29kZXMuTW9kaWZpZXIsIEVYUFIuZXhwcihwYXJhbS5jYWxsZWUpLCAuLi5FWFBSLkFyZ3MocGFyYW0uYXJncyldO1xuICAgIH1cbiAgfVxuXG4gIE5hbWVkQmxvY2tzKHsgYmxvY2tzIH06IG1pci5OYW1lZEJsb2Nrcyk6IFdpcmVGb3JtYXQuQ29yZS5CbG9ja3Mge1xuICAgIGxldCBuYW1lczogc3RyaW5nW10gPSBbXTtcbiAgICBsZXQgc2VyaWFsaXplZEJsb2NrczogV2lyZUZvcm1hdC5TZXJpYWxpemVkSW5saW5lQmxvY2tbXSA9IFtdO1xuXG4gICAgZm9yIChsZXQgYmxvY2sgb2YgYmxvY2tzLnRvQXJyYXkoKSkge1xuICAgICAgbGV0IFtuYW1lLCBzZXJpYWxpemVkQmxvY2tdID0gQ09OVEVOVC5OYW1lZEJsb2NrKGJsb2NrKTtcblxuICAgICAgbmFtZXMucHVzaChuYW1lKTtcbiAgICAgIHNlcmlhbGl6ZWRCbG9ja3MucHVzaChzZXJpYWxpemVkQmxvY2spO1xuICAgIH1cblxuICAgIHJldHVybiBuYW1lcy5sZW5ndGggPiAwID8gW25hbWVzLCBzZXJpYWxpemVkQmxvY2tzXSA6IG51bGw7XG4gIH1cblxuICBOYW1lZEJsb2NrKHsgbmFtZSwgYm9keSwgc2NvcGUgfTogbWlyLk5hbWVkQmxvY2spOiBXaXJlRm9ybWF0LkNvcmUuTmFtZWRCbG9jayB7XG4gICAgbGV0IG5hbWVDaGFycyA9IG5hbWUuY2hhcnM7XG4gICAgaWYgKG5hbWVDaGFycyA9PT0gJ2ludmVyc2UnKSB7XG4gICAgICBuYW1lQ2hhcnMgPSAnZWxzZSc7XG4gICAgfVxuICAgIHJldHVybiBbbmFtZUNoYXJzLCBbQ09OVEVOVC5saXN0KGJvZHkpLCBzY29wZS5zbG90c11dO1xuICB9XG5cbiAgSWYoeyBjb25kaXRpb24sIGJsb2NrLCBpbnZlcnNlIH06IG1pci5JZik6IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5JZiB7XG4gICAgcmV0dXJuIFtcbiAgICAgIFNleHBPcGNvZGVzLklmLFxuICAgICAgRVhQUi5leHByKGNvbmRpdGlvbiksXG4gICAgICBDT05URU5ULk5hbWVkQmxvY2soYmxvY2spWzFdLFxuICAgICAgaW52ZXJzZSA/IENPTlRFTlQuTmFtZWRCbG9jayhpbnZlcnNlKVsxXSA6IG51bGwsXG4gICAgXTtcbiAgfVxuXG4gIEVhY2goeyB2YWx1ZSwga2V5LCBibG9jaywgaW52ZXJzZSB9OiBtaXIuRWFjaCk6IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5FYWNoIHtcbiAgICByZXR1cm4gW1xuICAgICAgU2V4cE9wY29kZXMuRWFjaCxcbiAgICAgIEVYUFIuZXhwcih2YWx1ZSksXG4gICAgICBrZXkgPyBFWFBSLmV4cHIoa2V5KSA6IG51bGwsXG4gICAgICBDT05URU5ULk5hbWVkQmxvY2soYmxvY2spWzFdLFxuICAgICAgaW52ZXJzZSA/IENPTlRFTlQuTmFtZWRCbG9jayhpbnZlcnNlKVsxXSA6IG51bGwsXG4gICAgXTtcbiAgfVxuXG4gIFdpdGgoeyB2YWx1ZSwgYmxvY2ssIGludmVyc2UgfTogbWlyLldpdGgpOiBXaXJlRm9ybWF0LlN0YXRlbWVudHMuV2l0aCB7XG4gICAgcmV0dXJuIFtcbiAgICAgIFNleHBPcGNvZGVzLldpdGgsXG4gICAgICBFWFBSLmV4cHIodmFsdWUpLFxuICAgICAgQ09OVEVOVC5OYW1lZEJsb2NrKGJsb2NrKVsxXSxcbiAgICAgIGludmVyc2UgPyBDT05URU5ULk5hbWVkQmxvY2soaW52ZXJzZSlbMV0gOiBudWxsLFxuICAgIF07XG4gIH1cblxuICBMZXQoeyBwb3NpdGlvbmFsLCBibG9jayB9OiBtaXIuTGV0KTogV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLkxldCB7XG4gICAgcmV0dXJuIFtTZXhwT3Bjb2Rlcy5MZXQsIEVYUFIuUG9zaXRpb25hbChwb3NpdGlvbmFsKSwgQ09OVEVOVC5OYW1lZEJsb2NrKGJsb2NrKVsxXV07XG4gIH1cblxuICBXaXRoRHluYW1pY1ZhcnMoeyBuYW1lZCwgYmxvY2sgfTogbWlyLldpdGhEeW5hbWljVmFycyk6IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5XaXRoRHluYW1pY1ZhcnMge1xuICAgIHJldHVybiBbU2V4cE9wY29kZXMuV2l0aER5bmFtaWNWYXJzLCBFWFBSLk5hbWVkQXJndW1lbnRzKG5hbWVkKSwgQ09OVEVOVC5OYW1lZEJsb2NrKGJsb2NrKVsxXV07XG4gIH1cblxuICBJbnZva2VDb21wb25lbnQoe1xuICAgIGRlZmluaXRpb24sXG4gICAgYXJncyxcbiAgICBibG9ja3MsXG4gIH06IG1pci5JbnZva2VDb21wb25lbnQpOiBXaXJlRm9ybWF0LlN0YXRlbWVudHMuSW52b2tlQ29tcG9uZW50IHtcbiAgICByZXR1cm4gW1xuICAgICAgU2V4cE9wY29kZXMuSW52b2tlQ29tcG9uZW50LFxuICAgICAgRVhQUi5leHByKGRlZmluaXRpb24pLFxuICAgICAgRVhQUi5Qb3NpdGlvbmFsKGFyZ3MucG9zaXRpb25hbCksXG4gICAgICBFWFBSLk5hbWVkQXJndW1lbnRzKGFyZ3MubmFtZWQpLFxuICAgICAgYmxvY2tzID8gQ09OVEVOVC5OYW1lZEJsb2NrcyhibG9ja3MpIDogbnVsbCxcbiAgICBdO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBDT05URU5UID0gbmV3IENvbnRlbnRFbmNvZGVyKCk7XG5cbmV4cG9ydCB0eXBlIFN0YXRpY0F0dHJBcmdzID0gW25hbWU6IHN0cmluZyB8IFdlbGxLbm93bkF0dHJOYW1lLCB2YWx1ZTogc3RyaW5nLCBuYW1lc3BhY2U/OiBzdHJpbmddO1xuXG5mdW5jdGlvbiBzdGF0aWNBdHRyKHsgbmFtZSwgdmFsdWUsIG5hbWVzcGFjZSB9OiBtaXIuU3RhdGljQXR0cik6IFN0YXRpY0F0dHJBcmdzIHtcbiAgbGV0IG91dDogU3RhdGljQXR0ckFyZ3MgPSBbZGVmbGF0ZUF0dHJOYW1lKG5hbWUuY2hhcnMpLCB2YWx1ZS5jaGFyc107XG5cbiAgaWYgKG5hbWVzcGFjZSkge1xuICAgIG91dC5wdXNoKG5hbWVzcGFjZSk7XG4gIH1cblxuICByZXR1cm4gb3V0O1xufVxuXG5leHBvcnQgdHlwZSBEeW5hbWljQXR0ckFyZ3MgPSBbXG4gIG5hbWU6IHN0cmluZyB8IFdlbGxLbm93bkF0dHJOYW1lLFxuICB2YWx1ZTogV2lyZUZvcm1hdC5FeHByZXNzaW9uLFxuICBuYW1lc3BhY2U/OiBzdHJpbmdcbl07XG5cbmZ1bmN0aW9uIGR5bmFtaWNBdHRyKHsgbmFtZSwgdmFsdWUsIG5hbWVzcGFjZSB9OiBtaXIuRHluYW1pY0F0dHIpOiBEeW5hbWljQXR0ckFyZ3Mge1xuICBsZXQgb3V0OiBEeW5hbWljQXR0ckFyZ3MgPSBbZGVmbGF0ZUF0dHJOYW1lKG5hbWUuY2hhcnMpLCBFWFBSLmV4cHIodmFsdWUpXTtcblxuICBpZiAobmFtZXNwYWNlKSB7XG4gICAgb3V0LnB1c2gobmFtZXNwYWNlKTtcbiAgfVxuXG4gIHJldHVybiBvdXQ7XG59XG5cbmZ1bmN0aW9uIHN0YXRpY0F0dHJPcChraW5kOiB7XG4gIGNvbXBvbmVudDogYm9vbGVhbjtcbn0pOiBTZXhwT3Bjb2Rlcy5TdGF0aWNBdHRyIHwgU2V4cE9wY29kZXMuU3RhdGljQ29tcG9uZW50QXR0cjtcbmZ1bmN0aW9uIHN0YXRpY0F0dHJPcChraW5kOiB7IGNvbXBvbmVudDogYm9vbGVhbiB9KTogV2lyZUZvcm1hdC5BdHRyT3Age1xuICBpZiAoa2luZC5jb21wb25lbnQpIHtcbiAgICByZXR1cm4gU2V4cE9wY29kZXMuU3RhdGljQ29tcG9uZW50QXR0cjtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gU2V4cE9wY29kZXMuU3RhdGljQXR0cjtcbiAgfVxufVxuXG5mdW5jdGlvbiBkeW5hbWljQXR0ck9wKFxuICBraW5kOiBtaXIuQXR0cktpbmRcbik6XG4gIHwgU2V4cE9wY29kZXMuVHJ1c3RpbmdDb21wb25lbnRBdHRyXG4gIHwgU2V4cE9wY29kZXMuVHJ1c3RpbmdEeW5hbWljQXR0clxuICB8IFNleHBPcGNvZGVzLkNvbXBvbmVudEF0dHJcbiAgfCBTZXhwT3Bjb2Rlcy5EeW5hbWljQXR0ciB7XG4gIGlmIChraW5kLmNvbXBvbmVudCkge1xuICAgIHJldHVybiBraW5kLnRydXN0aW5nID8gU2V4cE9wY29kZXMuVHJ1c3RpbmdDb21wb25lbnRBdHRyIDogU2V4cE9wY29kZXMuQ29tcG9uZW50QXR0cjtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4ga2luZC50cnVzdGluZyA/IFNleHBPcGNvZGVzLlRydXN0aW5nRHluYW1pY0F0dHIgOiBTZXhwT3Bjb2Rlcy5EeW5hbWljQXR0cjtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==