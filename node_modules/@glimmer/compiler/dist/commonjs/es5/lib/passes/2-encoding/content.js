"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.CONTENT = exports.ContentEncoder = void 0;

var _util = require("@glimmer/util");

var _utils = require("../../utils");

var _expressions = require("./expressions");

function _createForOfIteratorHelperLoose(o, allowArrayLike) {
  var it;

  if (typeof Symbol === "undefined" || o[Symbol.iterator] == null) {
    if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") {
      if (it) o = it;
      var i = 0;
      return function () {
        if (i >= o.length) return {
          done: true
        };
        return {
          done: false,
          value: o[i++]
        };
      };
    }

    throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
  }

  it = o[Symbol.iterator]();
  return it.next.bind(it);
}

function _unsupportedIterableToArray(o, minLen) {
  if (!o) return;
  if (typeof o === "string") return _arrayLikeToArray(o, minLen);
  var n = Object.prototype.toString.call(o).slice(8, -1);
  if (n === "Object" && o.constructor) n = o.constructor.name;
  if (n === "Map" || n === "Set") return Array.from(o);
  if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);
}

function _arrayLikeToArray(arr, len) {
  if (len == null || len > arr.length) len = arr.length;

  for (var i = 0, arr2 = new Array(len); i < len; i++) {
    arr2[i] = arr[i];
  }

  return arr2;
}

var WireStatements = /*#__PURE__*/function () {
  function WireStatements(statements) {
    this.statements = statements;
  }

  var _proto = WireStatements.prototype;

  _proto.toArray = function toArray() {
    return this.statements;
  };

  return WireStatements;
}();

var ContentEncoder = /*#__PURE__*/function () {
  function ContentEncoder() {}

  var _proto2 = ContentEncoder.prototype;

  _proto2.list = function list(statements) {
    var out = [];

    for (var _iterator = _createForOfIteratorHelperLoose(statements), _step; !(_step = _iterator()).done;) {
      var statement = _step.value;
      var result = CONTENT.content(statement);

      if (result && result instanceof WireStatements) {
        out.push.apply(out, result.toArray());
      } else {
        out.push(result);
      }
    }

    return out;
  };

  _proto2.content = function content(stmt) {
    if (false
    /* LOCAL_SHOULD_LOG */
    ) {
        _util.LOCAL_LOGGER.log("encoding", stmt);
      }

    return this.visitContent(stmt);
  };

  _proto2.visitContent = function visitContent(stmt) {
    switch (stmt.type) {
      case 'Debugger':
        return [26
        /* Debugger */
        , stmt.scope.getEvalInfo()];

      case 'AppendComment':
        return this.AppendComment(stmt);

      case 'AppendTextNode':
        return this.AppendTextNode(stmt);

      case 'AppendTrustedHTML':
        return this.AppendTrustedHTML(stmt);

      case 'Yield':
        return this.Yield(stmt);

      case 'Component':
        return this.Component(stmt);

      case 'SimpleElement':
        return this.SimpleElement(stmt);

      case 'InElement':
        return this.InElement(stmt);

      case 'InvokeBlock':
        return this.InvokeBlock(stmt);

      case 'If':
        return this.If(stmt);

      case 'Each':
        return this.Each(stmt);

      case 'With':
        return this.With(stmt);

      case 'Let':
        return this.Let(stmt);

      case 'WithDynamicVars':
        return this.WithDynamicVars(stmt);

      case 'InvokeComponent':
        return this.InvokeComponent(stmt);

      default:
        return (0, _util.exhausted)(stmt);
    }
  };

  _proto2.Yield = function Yield(_ref) {
    var to = _ref.to,
        positional = _ref.positional;
    return [18
    /* Yield */
    , to, _expressions.EXPR.Positional(positional)];
  };

  _proto2.InElement = function InElement(_ref2) {
    var guid = _ref2.guid,
        insertBefore = _ref2.insertBefore,
        destination = _ref2.destination,
        block = _ref2.block;
    var wireBlock = CONTENT.NamedBlock(block)[1]; // let guid = args.guid;

    var wireDestination = _expressions.EXPR.expr(destination);

    var wireInsertBefore = _expressions.EXPR.expr(insertBefore);

    if (wireInsertBefore === undefined) {
      return [40
      /* InElement */
      , wireBlock, guid, wireDestination];
    } else {
      return [40
      /* InElement */
      , wireBlock, guid, wireDestination, wireInsertBefore];
    }
  };

  _proto2.InvokeBlock = function InvokeBlock(_ref3) {
    var head = _ref3.head,
        args = _ref3.args,
        blocks = _ref3.blocks;
    return [6
    /* Block */
    , _expressions.EXPR.expr(head)].concat(_expressions.EXPR.Args(args), [CONTENT.NamedBlocks(blocks)]);
  };

  _proto2.AppendTrustedHTML = function AppendTrustedHTML(_ref4) {
    var html = _ref4.html;
    return [2
    /* TrustingAppend */
    , _expressions.EXPR.expr(html)];
  };

  _proto2.AppendTextNode = function AppendTextNode(_ref5) {
    var text = _ref5.text;
    return [1
    /* Append */
    , _expressions.EXPR.expr(text)];
  };

  _proto2.AppendComment = function AppendComment(_ref6) {
    var value = _ref6.value;
    return [3
    /* Comment */
    , value.chars];
  };

  _proto2.SimpleElement = function SimpleElement(_ref7) {
    var tag = _ref7.tag,
        params = _ref7.params,
        body = _ref7.body,
        dynamicFeatures = _ref7.dynamicFeatures;
    var op = dynamicFeatures ? 11
    /* OpenElementWithSplat */
    : 10
    /* OpenElement */
    ;
    return new WireStatements([[op, (0, _utils.deflateTagName)(tag.chars)]].concat(CONTENT.ElementParameters(params).toArray(), [[12
    /* FlushElement */
    ]], CONTENT.list(body), [[13
    /* CloseElement */
    ]]));
  };

  _proto2.Component = function Component(_ref8) {
    var tag = _ref8.tag,
        params = _ref8.params,
        args = _ref8.args,
        blocks = _ref8.blocks;

    var wireTag = _expressions.EXPR.expr(tag);

    var wirePositional = CONTENT.ElementParameters(params);

    var wireNamed = _expressions.EXPR.NamedArguments(args);

    var wireNamedBlocks = CONTENT.NamedBlocks(blocks);
    return [8
    /* Component */
    , wireTag, wirePositional.toPresentArray(), wireNamed, wireNamedBlocks];
  };

  _proto2.ElementParameters = function ElementParameters(_ref9) {
    var body = _ref9.body;
    return body.map(function (p) {
      return CONTENT.ElementParameter(p);
    });
  };

  _proto2.ElementParameter = function ElementParameter(param) {
    switch (param.type) {
      case 'SplatAttr':
        return [17
        /* AttrSplat */
        , param.symbol];

      case 'DynamicAttr':
        return [dynamicAttrOp(param.kind)].concat(dynamicAttr(param));

      case 'StaticAttr':
        return [staticAttrOp(param.kind)].concat(staticAttr(param));

      case 'Modifier':
        return [4
        /* Modifier */
        , _expressions.EXPR.expr(param.callee)].concat(_expressions.EXPR.Args(param.args));
    }
  };

  _proto2.NamedBlocks = function NamedBlocks(_ref10) {
    var blocks = _ref10.blocks;
    var names = [];
    var serializedBlocks = [];

    for (var _iterator2 = _createForOfIteratorHelperLoose(blocks.toArray()), _step2; !(_step2 = _iterator2()).done;) {
      var block = _step2.value;

      var _CONTENT$NamedBlock = CONTENT.NamedBlock(block),
          name = _CONTENT$NamedBlock[0],
          serializedBlock = _CONTENT$NamedBlock[1];

      names.push(name);
      serializedBlocks.push(serializedBlock);
    }

    return names.length > 0 ? [names, serializedBlocks] : null;
  };

  _proto2.NamedBlock = function NamedBlock(_ref11) {
    var name = _ref11.name,
        body = _ref11.body,
        scope = _ref11.scope;
    var nameChars = name.chars;

    if (nameChars === 'inverse') {
      nameChars = 'else';
    }

    return [nameChars, [CONTENT.list(body), scope.slots]];
  };

  _proto2.If = function If(_ref12) {
    var condition = _ref12.condition,
        block = _ref12.block,
        inverse = _ref12.inverse;
    return [41
    /* If */
    , _expressions.EXPR.expr(condition), CONTENT.NamedBlock(block)[1], inverse ? CONTENT.NamedBlock(inverse)[1] : null];
  };

  _proto2.Each = function Each(_ref13) {
    var value = _ref13.value,
        key = _ref13.key,
        block = _ref13.block,
        inverse = _ref13.inverse;
    return [42
    /* Each */
    , _expressions.EXPR.expr(value), key ? _expressions.EXPR.expr(key) : null, CONTENT.NamedBlock(block)[1], inverse ? CONTENT.NamedBlock(inverse)[1] : null];
  };

  _proto2.With = function With(_ref14) {
    var value = _ref14.value,
        block = _ref14.block,
        inverse = _ref14.inverse;
    return [43
    /* With */
    , _expressions.EXPR.expr(value), CONTENT.NamedBlock(block)[1], inverse ? CONTENT.NamedBlock(inverse)[1] : null];
  };

  _proto2.Let = function Let(_ref15) {
    var positional = _ref15.positional,
        block = _ref15.block;
    return [44
    /* Let */
    , _expressions.EXPR.Positional(positional), CONTENT.NamedBlock(block)[1]];
  };

  _proto2.WithDynamicVars = function WithDynamicVars(_ref16) {
    var named = _ref16.named,
        block = _ref16.block;
    return [45
    /* WithDynamicVars */
    , _expressions.EXPR.NamedArguments(named), CONTENT.NamedBlock(block)[1]];
  };

  _proto2.InvokeComponent = function InvokeComponent(_ref17) {
    var definition = _ref17.definition,
        args = _ref17.args,
        blocks = _ref17.blocks;
    return [46
    /* InvokeComponent */
    , _expressions.EXPR.expr(definition), _expressions.EXPR.Positional(args.positional), _expressions.EXPR.NamedArguments(args.named), blocks ? CONTENT.NamedBlocks(blocks) : null];
  };

  return ContentEncoder;
}();

exports.ContentEncoder = ContentEncoder;
var CONTENT = new ContentEncoder();
exports.CONTENT = CONTENT;

function staticAttr(_ref18) {
  var name = _ref18.name,
      value = _ref18.value,
      namespace = _ref18.namespace;
  var out = [(0, _utils.deflateAttrName)(name.chars), value.chars];

  if (namespace) {
    out.push(namespace);
  }

  return out;
}

function dynamicAttr(_ref19) {
  var name = _ref19.name,
      value = _ref19.value,
      namespace = _ref19.namespace;
  var out = [(0, _utils.deflateAttrName)(name.chars), _expressions.EXPR.expr(value)];

  if (namespace) {
    out.push(namespace);
  }

  return out;
}

function staticAttrOp(kind) {
  if (kind.component) {
    return 24
    /* StaticComponentAttr */
    ;
  } else {
      return 14
      /* StaticAttr */
      ;
    }
}

function dynamicAttrOp(kind) {
  if (kind.component) {
    return kind.trusting ? 23
    /* TrustingComponentAttr */
    : 16
    /* ComponentAttr */
    ;
  } else {
    return kind.trusting ? 22
    /* TrustingDynamicAttr */
    : 15
    /* DynamicAttr */
    ;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi9wYXNzZXMvMi1lbmNvZGluZy9jb250ZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFHQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQUdBLGM7QUFDRSxXQUFBLGNBQUEsQ0FBQSxVQUFBLEVBQTRDO0FBQXhCLFNBQUEsVUFBQSxHQUFBLFVBQUE7QUFBNEI7Ozs7U0FFaEQsTyxHQUFBLFNBQUEsT0FBQSxHQUFPO0FBQ0wsV0FBTyxLQUFQLFVBQUE7Ozs7OztBQUlKLElBQU0sY0FBTixHQUFBLGFBQUEsWUFBQTtBQUFBLFdBQUEsY0FBQSxHQUFBLENBQUE7O0FBQUEsTUFBQSxPQUFBLEdBQUEsY0FBQSxDQUFBLFNBQUE7O0FBQUEsRUFBQSxPQUFBLENBQUEsSUFBQSxHQUNFLFNBQUEsSUFBQSxDQUFBLFVBQUEsRUFBZ0M7QUFDOUIsUUFBSSxHQUFHLEdBQVAsRUFBQTs7QUFFQSxTQUFBLElBQUEsU0FBQSxHQUFBLCtCQUFBLENBQUEsVUFBQSxDQUFBLEVBQUEsS0FBQSxFQUFBLENBQUEsQ0FBQSxLQUFBLEdBQUEsU0FBQSxFQUFBLEVBQUEsSUFBQSxHQUFrQztBQUFBLFVBQWxDLFNBQWtDLEdBQUEsS0FBQSxDQUFBLEtBQUE7QUFDaEMsVUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFQLE9BQUEsQ0FBYixTQUFhLENBQWI7O0FBRUEsVUFBSSxNQUFNLElBQUksTUFBTSxZQUFwQixjQUFBLEVBQWdEO0FBQzlDLFFBQUEsR0FBRyxDQUFILElBQUEsQ0FBQSxLQUFBLENBQUEsR0FBQSxFQUFZLE1BQU0sQ0FBbEIsT0FBWSxFQUFaO0FBREYsT0FBQSxNQUVPO0FBQ0wsUUFBQSxHQUFHLENBQUgsSUFBQSxDQUFBLE1BQUE7QUFDRDtBQUNGOztBQUVELFdBQUEsR0FBQTtBQWRKLEdBQUE7O0FBQUEs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R0FBQSxNQUFBLENBQTVCLFNBQTRCO0FBQzlELE1BQUksR0FBRyxHQUFvQixDQUFDLDRCQUFnQixJQUFJLENBQXJCLEtBQUMsQ0FBRCxFQUE4QixrQkFBQSxJQUFBLENBQXpELEtBQXlELENBQTlCLENBQTNCOztBQUVBLE1BQUEsU0FBQSxFQUFlO0FBQ2IsSUFBQSxHQUFHLENBQUgsSUFBQSxDQUFBLFNBQUE7QUFDRDs7QUFFRCxTQUFBLEdBQUE7QUFDRDs7QUFLRCxTQUFBLFlBQUEsQ0FBQSxJQUFBLEVBQWtEO0FBQ2hELE1BQUksSUFBSSxDQUFSLFNBQUEsRUFBb0I7QUFDbEIsV0FBQTtBQUFBO0FBQUE7QUFERixHQUFBLE1BRU87QUFDTCxhQUFBO0FBQUE7QUFBQTtBQUNEO0FBQ0Y7O0FBRUQsU0FBQSxhQUFBLENBQUEsSUFBQSxFQUNvQjtBQU1sQixNQUFJLElBQUksQ0FBUixTQUFBLEVBQW9CO0FBQ2xCLFdBQU8sSUFBSSxDQUFKLFFBQUEsR0FBZTtBQUFBO0FBQWYsTUFBbUQ7QUFBQTtBQUExRDtBQURGLEdBQUEsTUFFTztBQUNMLFdBQU8sSUFBSSxDQUFKLFFBQUEsR0FBZTtBQUFBO0FBQWYsTUFBaUQ7QUFBQTtBQUF4RDtBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTZXhwT3Bjb2RlcywgV2VsbEtub3duQXR0ck5hbWUsIFdpcmVGb3JtYXQgfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IExPQ0FMX1NIT1VMRF9MT0cgfSBmcm9tICdAZ2xpbW1lci9sb2NhbC1kZWJ1Zy1mbGFncyc7XG5pbXBvcnQgeyBleGhhdXN0ZWQsIExPQ0FMX0xPR0dFUiB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5pbXBvcnQgeyBPcHRpb25hbExpc3QgfSBmcm9tICcuLi8uLi9zaGFyZWQvbGlzdCc7XG5pbXBvcnQgeyBkZWZsYXRlQXR0ck5hbWUsIGRlZmxhdGVUYWdOYW1lIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgRVhQUiB9IGZyb20gJy4vZXhwcmVzc2lvbnMnO1xuaW1wb3J0ICogYXMgbWlyIGZyb20gJy4vbWlyJztcblxuY2xhc3MgV2lyZVN0YXRlbWVudHM8UyBleHRlbmRzIFdpcmVGb3JtYXQuU3RhdGVtZW50ID0gV2lyZUZvcm1hdC5TdGF0ZW1lbnQ+IHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzdGF0ZW1lbnRzOiByZWFkb25seSBTW10pIHt9XG5cbiAgdG9BcnJheSgpOiByZWFkb25seSBTW10ge1xuICAgIHJldHVybiB0aGlzLnN0YXRlbWVudHM7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIENvbnRlbnRFbmNvZGVyIHtcbiAgbGlzdChzdGF0ZW1lbnRzOiBtaXIuU3RhdGVtZW50W10pOiBXaXJlRm9ybWF0LlN0YXRlbWVudFtdIHtcbiAgICBsZXQgb3V0OiBXaXJlRm9ybWF0LlN0YXRlbWVudFtdID0gW107XG5cbiAgICBmb3IgKGxldCBzdGF0ZW1lbnQgb2Ygc3RhdGVtZW50cykge1xuICAgICAgbGV0IHJlc3VsdCA9IENPTlRFTlQuY29udGVudChzdGF0ZW1lbnQpO1xuXG4gICAgICBpZiAocmVzdWx0ICYmIHJlc3VsdCBpbnN0YW5jZW9mIFdpcmVTdGF0ZW1lbnRzKSB7XG4gICAgICAgIG91dC5wdXNoKC4uLnJlc3VsdC50b0FycmF5KCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3V0LnB1c2gocmVzdWx0KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgY29udGVudChzdG10OiBtaXIuU3RhdGVtZW50KTogV2lyZUZvcm1hdC5TdGF0ZW1lbnQgfCBXaXJlU3RhdGVtZW50cyB7XG4gICAgaWYgKExPQ0FMX1NIT1VMRF9MT0cpIHtcbiAgICAgIExPQ0FMX0xPR0dFUi5sb2coYGVuY29kaW5nYCwgc3RtdCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudmlzaXRDb250ZW50KHN0bXQpO1xuICB9XG5cbiAgcHJpdmF0ZSB2aXNpdENvbnRlbnQoc3RtdDogbWlyLlN0YXRlbWVudCk6IFdpcmVGb3JtYXQuU3RhdGVtZW50IHwgV2lyZVN0YXRlbWVudHMge1xuICAgIHN3aXRjaCAoc3RtdC50eXBlKSB7XG4gICAgICBjYXNlICdEZWJ1Z2dlcic6XG4gICAgICAgIHJldHVybiBbU2V4cE9wY29kZXMuRGVidWdnZXIsIHN0bXQuc2NvcGUuZ2V0RXZhbEluZm8oKV07XG4gICAgICBjYXNlICdBcHBlbmRDb21tZW50JzpcbiAgICAgICAgcmV0dXJuIHRoaXMuQXBwZW5kQ29tbWVudChzdG10KTtcbiAgICAgIGNhc2UgJ0FwcGVuZFRleHROb2RlJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuQXBwZW5kVGV4dE5vZGUoc3RtdCk7XG4gICAgICBjYXNlICdBcHBlbmRUcnVzdGVkSFRNTCc6XG4gICAgICAgIHJldHVybiB0aGlzLkFwcGVuZFRydXN0ZWRIVE1MKHN0bXQpO1xuICAgICAgY2FzZSAnWWllbGQnOlxuICAgICAgICByZXR1cm4gdGhpcy5ZaWVsZChzdG10KTtcbiAgICAgIGNhc2UgJ0NvbXBvbmVudCc6XG4gICAgICAgIHJldHVybiB0aGlzLkNvbXBvbmVudChzdG10KTtcbiAgICAgIGNhc2UgJ1NpbXBsZUVsZW1lbnQnOlxuICAgICAgICByZXR1cm4gdGhpcy5TaW1wbGVFbGVtZW50KHN0bXQpO1xuICAgICAgY2FzZSAnSW5FbGVtZW50JzpcbiAgICAgICAgcmV0dXJuIHRoaXMuSW5FbGVtZW50KHN0bXQpO1xuICAgICAgY2FzZSAnSW52b2tlQmxvY2snOlxuICAgICAgICByZXR1cm4gdGhpcy5JbnZva2VCbG9jayhzdG10KTtcbiAgICAgIGNhc2UgJ0lmJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuSWYoc3RtdCk7XG4gICAgICBjYXNlICdFYWNoJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuRWFjaChzdG10KTtcbiAgICAgIGNhc2UgJ1dpdGgnOlxuICAgICAgICByZXR1cm4gdGhpcy5XaXRoKHN0bXQpO1xuICAgICAgY2FzZSAnTGV0JzpcbiAgICAgICAgcmV0dXJuIHRoaXMuTGV0KHN0bXQpO1xuICAgICAgY2FzZSAnV2l0aER5bmFtaWNWYXJzJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuV2l0aER5bmFtaWNWYXJzKHN0bXQpO1xuICAgICAgY2FzZSAnSW52b2tlQ29tcG9uZW50JzpcbiAgICAgICAgcmV0dXJuIHRoaXMuSW52b2tlQ29tcG9uZW50KHN0bXQpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIGV4aGF1c3RlZChzdG10KTtcbiAgICB9XG4gIH1cblxuICBZaWVsZCh7IHRvLCBwb3NpdGlvbmFsIH06IG1pci5ZaWVsZCk6IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5ZaWVsZCB7XG4gICAgcmV0dXJuIFtTZXhwT3Bjb2Rlcy5ZaWVsZCwgdG8sIEVYUFIuUG9zaXRpb25hbChwb3NpdGlvbmFsKV07XG4gIH1cblxuICBJbkVsZW1lbnQoe1xuICAgIGd1aWQsXG4gICAgaW5zZXJ0QmVmb3JlLFxuICAgIGRlc3RpbmF0aW9uLFxuICAgIGJsb2NrLFxuICB9OiBtaXIuSW5FbGVtZW50KTogV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLkluRWxlbWVudCB7XG4gICAgbGV0IHdpcmVCbG9jayA9IENPTlRFTlQuTmFtZWRCbG9jayhibG9jaylbMV07XG4gICAgLy8gbGV0IGd1aWQgPSBhcmdzLmd1aWQ7XG4gICAgbGV0IHdpcmVEZXN0aW5hdGlvbiA9IEVYUFIuZXhwcihkZXN0aW5hdGlvbik7XG4gICAgbGV0IHdpcmVJbnNlcnRCZWZvcmUgPSBFWFBSLmV4cHIoaW5zZXJ0QmVmb3JlKTtcblxuICAgIGlmICh3aXJlSW5zZXJ0QmVmb3JlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBbU2V4cE9wY29kZXMuSW5FbGVtZW50LCB3aXJlQmxvY2ssIGd1aWQsIHdpcmVEZXN0aW5hdGlvbl07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBbU2V4cE9wY29kZXMuSW5FbGVtZW50LCB3aXJlQmxvY2ssIGd1aWQsIHdpcmVEZXN0aW5hdGlvbiwgd2lyZUluc2VydEJlZm9yZV07XG4gICAgfVxuICB9XG5cbiAgSW52b2tlQmxvY2soeyBoZWFkLCBhcmdzLCBibG9ja3MgfTogbWlyLkludm9rZUJsb2NrKTogV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLkJsb2NrIHtcbiAgICByZXR1cm4gW1NleHBPcGNvZGVzLkJsb2NrLCBFWFBSLmV4cHIoaGVhZCksIC4uLkVYUFIuQXJncyhhcmdzKSwgQ09OVEVOVC5OYW1lZEJsb2NrcyhibG9ja3MpXTtcbiAgfVxuXG4gIEFwcGVuZFRydXN0ZWRIVE1MKHsgaHRtbCB9OiBtaXIuQXBwZW5kVHJ1c3RlZEhUTUwpOiBXaXJlRm9ybWF0LlN0YXRlbWVudHMuVHJ1c3RpbmdBcHBlbmQge1xuICAgIHJldHVybiBbU2V4cE9wY29kZXMuVHJ1c3RpbmdBcHBlbmQsIEVYUFIuZXhwcihodG1sKV07XG4gIH1cblxuICBBcHBlbmRUZXh0Tm9kZSh7IHRleHQgfTogbWlyLkFwcGVuZFRleHROb2RlKTogV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLkFwcGVuZCB7XG4gICAgcmV0dXJuIFtTZXhwT3Bjb2Rlcy5BcHBlbmQsIEVYUFIuZXhwcih0ZXh0KV07XG4gIH1cblxuICBBcHBlbmRDb21tZW50KHsgdmFsdWUgfTogbWlyLkFwcGVuZENvbW1lbnQpOiBXaXJlRm9ybWF0LlN0YXRlbWVudHMuQ29tbWVudCB7XG4gICAgcmV0dXJuIFtTZXhwT3Bjb2Rlcy5Db21tZW50LCB2YWx1ZS5jaGFyc107XG4gIH1cblxuICBTaW1wbGVFbGVtZW50KHsgdGFnLCBwYXJhbXMsIGJvZHksIGR5bmFtaWNGZWF0dXJlcyB9OiBtaXIuU2ltcGxlRWxlbWVudCk6IFdpcmVTdGF0ZW1lbnRzIHtcbiAgICBsZXQgb3AgPSBkeW5hbWljRmVhdHVyZXMgPyBTZXhwT3Bjb2Rlcy5PcGVuRWxlbWVudFdpdGhTcGxhdCA6IFNleHBPcGNvZGVzLk9wZW5FbGVtZW50O1xuICAgIHJldHVybiBuZXcgV2lyZVN0YXRlbWVudHM8V2lyZUZvcm1hdC5TdGF0ZW1lbnQgfCBXaXJlRm9ybWF0LkVsZW1lbnRQYXJhbWV0ZXI+KFtcbiAgICAgIFtvcCwgZGVmbGF0ZVRhZ05hbWUodGFnLmNoYXJzKV0sXG4gICAgICAuLi5DT05URU5ULkVsZW1lbnRQYXJhbWV0ZXJzKHBhcmFtcykudG9BcnJheSgpLFxuICAgICAgW1NleHBPcGNvZGVzLkZsdXNoRWxlbWVudF0sXG4gICAgICAuLi5DT05URU5ULmxpc3QoYm9keSksXG4gICAgICBbU2V4cE9wY29kZXMuQ2xvc2VFbGVtZW50XSxcbiAgICBdKTtcbiAgfVxuXG4gIENvbXBvbmVudCh7IHRhZywgcGFyYW1zLCBhcmdzLCBibG9ja3MgfTogbWlyLkNvbXBvbmVudCk6IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5Db21wb25lbnQge1xuICAgIGxldCB3aXJlVGFnID0gRVhQUi5leHByKHRhZyk7XG4gICAgbGV0IHdpcmVQb3NpdGlvbmFsID0gQ09OVEVOVC5FbGVtZW50UGFyYW1ldGVycyhwYXJhbXMpO1xuICAgIGxldCB3aXJlTmFtZWQgPSBFWFBSLk5hbWVkQXJndW1lbnRzKGFyZ3MpO1xuXG4gICAgbGV0IHdpcmVOYW1lZEJsb2NrcyA9IENPTlRFTlQuTmFtZWRCbG9ja3MoYmxvY2tzKTtcblxuICAgIHJldHVybiBbXG4gICAgICBTZXhwT3Bjb2Rlcy5Db21wb25lbnQsXG4gICAgICB3aXJlVGFnLFxuICAgICAgd2lyZVBvc2l0aW9uYWwudG9QcmVzZW50QXJyYXkoKSxcbiAgICAgIHdpcmVOYW1lZCxcbiAgICAgIHdpcmVOYW1lZEJsb2NrcyxcbiAgICBdO1xuICB9XG5cbiAgRWxlbWVudFBhcmFtZXRlcnMoeyBib2R5IH06IG1pci5FbGVtZW50UGFyYW1ldGVycyk6IE9wdGlvbmFsTGlzdDxXaXJlRm9ybWF0LkVsZW1lbnRQYXJhbWV0ZXI+IHtcbiAgICByZXR1cm4gYm9keS5tYXAoKHApID0+IENPTlRFTlQuRWxlbWVudFBhcmFtZXRlcihwKSk7XG4gIH1cblxuICBFbGVtZW50UGFyYW1ldGVyKHBhcmFtOiBtaXIuRWxlbWVudFBhcmFtZXRlcik6IFdpcmVGb3JtYXQuRWxlbWVudFBhcmFtZXRlciB7XG4gICAgc3dpdGNoIChwYXJhbS50eXBlKSB7XG4gICAgICBjYXNlICdTcGxhdEF0dHInOlxuICAgICAgICByZXR1cm4gW1NleHBPcGNvZGVzLkF0dHJTcGxhdCwgcGFyYW0uc3ltYm9sXTtcbiAgICAgIGNhc2UgJ0R5bmFtaWNBdHRyJzpcbiAgICAgICAgcmV0dXJuIFtkeW5hbWljQXR0ck9wKHBhcmFtLmtpbmQpLCAuLi5keW5hbWljQXR0cihwYXJhbSldO1xuICAgICAgY2FzZSAnU3RhdGljQXR0cic6XG4gICAgICAgIHJldHVybiBbc3RhdGljQXR0ck9wKHBhcmFtLmtpbmQpLCAuLi5zdGF0aWNBdHRyKHBhcmFtKV07XG4gICAgICBjYXNlICdNb2RpZmllcic6XG4gICAgICAgIHJldHVybiBbU2V4cE9wY29kZXMuTW9kaWZpZXIsIEVYUFIuZXhwcihwYXJhbS5jYWxsZWUpLCAuLi5FWFBSLkFyZ3MocGFyYW0uYXJncyldO1xuICAgIH1cbiAgfVxuXG4gIE5hbWVkQmxvY2tzKHsgYmxvY2tzIH06IG1pci5OYW1lZEJsb2Nrcyk6IFdpcmVGb3JtYXQuQ29yZS5CbG9ja3Mge1xuICAgIGxldCBuYW1lczogc3RyaW5nW10gPSBbXTtcbiAgICBsZXQgc2VyaWFsaXplZEJsb2NrczogV2lyZUZvcm1hdC5TZXJpYWxpemVkSW5saW5lQmxvY2tbXSA9IFtdO1xuXG4gICAgZm9yIChsZXQgYmxvY2sgb2YgYmxvY2tzLnRvQXJyYXkoKSkge1xuICAgICAgbGV0IFtuYW1lLCBzZXJpYWxpemVkQmxvY2tdID0gQ09OVEVOVC5OYW1lZEJsb2NrKGJsb2NrKTtcblxuICAgICAgbmFtZXMucHVzaChuYW1lKTtcbiAgICAgIHNlcmlhbGl6ZWRCbG9ja3MucHVzaChzZXJpYWxpemVkQmxvY2spO1xuICAgIH1cblxuICAgIHJldHVybiBuYW1lcy5sZW5ndGggPiAwID8gW25hbWVzLCBzZXJpYWxpemVkQmxvY2tzXSA6IG51bGw7XG4gIH1cblxuICBOYW1lZEJsb2NrKHsgbmFtZSwgYm9keSwgc2NvcGUgfTogbWlyLk5hbWVkQmxvY2spOiBXaXJlRm9ybWF0LkNvcmUuTmFtZWRCbG9jayB7XG4gICAgbGV0IG5hbWVDaGFycyA9IG5hbWUuY2hhcnM7XG4gICAgaWYgKG5hbWVDaGFycyA9PT0gJ2ludmVyc2UnKSB7XG4gICAgICBuYW1lQ2hhcnMgPSAnZWxzZSc7XG4gICAgfVxuICAgIHJldHVybiBbbmFtZUNoYXJzLCBbQ09OVEVOVC5saXN0KGJvZHkpLCBzY29wZS5zbG90c11dO1xuICB9XG5cbiAgSWYoeyBjb25kaXRpb24sIGJsb2NrLCBpbnZlcnNlIH06IG1pci5JZik6IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5JZiB7XG4gICAgcmV0dXJuIFtcbiAgICAgIFNleHBPcGNvZGVzLklmLFxuICAgICAgRVhQUi5leHByKGNvbmRpdGlvbiksXG4gICAgICBDT05URU5ULk5hbWVkQmxvY2soYmxvY2spWzFdLFxuICAgICAgaW52ZXJzZSA/IENPTlRFTlQuTmFtZWRCbG9jayhpbnZlcnNlKVsxXSA6IG51bGwsXG4gICAgXTtcbiAgfVxuXG4gIEVhY2goeyB2YWx1ZSwga2V5LCBibG9jaywgaW52ZXJzZSB9OiBtaXIuRWFjaCk6IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5FYWNoIHtcbiAgICByZXR1cm4gW1xuICAgICAgU2V4cE9wY29kZXMuRWFjaCxcbiAgICAgIEVYUFIuZXhwcih2YWx1ZSksXG4gICAgICBrZXkgPyBFWFBSLmV4cHIoa2V5KSA6IG51bGwsXG4gICAgICBDT05URU5ULk5hbWVkQmxvY2soYmxvY2spWzFdLFxuICAgICAgaW52ZXJzZSA/IENPTlRFTlQuTmFtZWRCbG9jayhpbnZlcnNlKVsxXSA6IG51bGwsXG4gICAgXTtcbiAgfVxuXG4gIFdpdGgoeyB2YWx1ZSwgYmxvY2ssIGludmVyc2UgfTogbWlyLldpdGgpOiBXaXJlRm9ybWF0LlN0YXRlbWVudHMuV2l0aCB7XG4gICAgcmV0dXJuIFtcbiAgICAgIFNleHBPcGNvZGVzLldpdGgsXG4gICAgICBFWFBSLmV4cHIodmFsdWUpLFxuICAgICAgQ09OVEVOVC5OYW1lZEJsb2NrKGJsb2NrKVsxXSxcbiAgICAgIGludmVyc2UgPyBDT05URU5ULk5hbWVkQmxvY2soaW52ZXJzZSlbMV0gOiBudWxsLFxuICAgIF07XG4gIH1cblxuICBMZXQoeyBwb3NpdGlvbmFsLCBibG9jayB9OiBtaXIuTGV0KTogV2lyZUZvcm1hdC5TdGF0ZW1lbnRzLkxldCB7XG4gICAgcmV0dXJuIFtTZXhwT3Bjb2Rlcy5MZXQsIEVYUFIuUG9zaXRpb25hbChwb3NpdGlvbmFsKSwgQ09OVEVOVC5OYW1lZEJsb2NrKGJsb2NrKVsxXV07XG4gIH1cblxuICBXaXRoRHluYW1pY1ZhcnMoeyBuYW1lZCwgYmxvY2sgfTogbWlyLldpdGhEeW5hbWljVmFycyk6IFdpcmVGb3JtYXQuU3RhdGVtZW50cy5XaXRoRHluYW1pY1ZhcnMge1xuICAgIHJldHVybiBbU2V4cE9wY29kZXMuV2l0aER5bmFtaWNWYXJzLCBFWFBSLk5hbWVkQXJndW1lbnRzKG5hbWVkKSwgQ09OVEVOVC5OYW1lZEJsb2NrKGJsb2NrKVsxXV07XG4gIH1cblxuICBJbnZva2VDb21wb25lbnQoe1xuICAgIGRlZmluaXRpb24sXG4gICAgYXJncyxcbiAgICBibG9ja3MsXG4gIH06IG1pci5JbnZva2VDb21wb25lbnQpOiBXaXJlRm9ybWF0LlN0YXRlbWVudHMuSW52b2tlQ29tcG9uZW50IHtcbiAgICByZXR1cm4gW1xuICAgICAgU2V4cE9wY29kZXMuSW52b2tlQ29tcG9uZW50LFxuICAgICAgRVhQUi5leHByKGRlZmluaXRpb24pLFxuICAgICAgRVhQUi5Qb3NpdGlvbmFsKGFyZ3MucG9zaXRpb25hbCksXG4gICAgICBFWFBSLk5hbWVkQXJndW1lbnRzKGFyZ3MubmFtZWQpLFxuICAgICAgYmxvY2tzID8gQ09OVEVOVC5OYW1lZEJsb2NrcyhibG9ja3MpIDogbnVsbCxcbiAgICBdO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBDT05URU5UID0gbmV3IENvbnRlbnRFbmNvZGVyKCk7XG5cbmV4cG9ydCB0eXBlIFN0YXRpY0F0dHJBcmdzID0gW25hbWU6IHN0cmluZyB8IFdlbGxLbm93bkF0dHJOYW1lLCB2YWx1ZTogc3RyaW5nLCBuYW1lc3BhY2U/OiBzdHJpbmddO1xuXG5mdW5jdGlvbiBzdGF0aWNBdHRyKHsgbmFtZSwgdmFsdWUsIG5hbWVzcGFjZSB9OiBtaXIuU3RhdGljQXR0cik6IFN0YXRpY0F0dHJBcmdzIHtcbiAgbGV0IG91dDogU3RhdGljQXR0ckFyZ3MgPSBbZGVmbGF0ZUF0dHJOYW1lKG5hbWUuY2hhcnMpLCB2YWx1ZS5jaGFyc107XG5cbiAgaWYgKG5hbWVzcGFjZSkge1xuICAgIG91dC5wdXNoKG5hbWVzcGFjZSk7XG4gIH1cblxuICByZXR1cm4gb3V0O1xufVxuXG5leHBvcnQgdHlwZSBEeW5hbWljQXR0ckFyZ3MgPSBbXG4gIG5hbWU6IHN0cmluZyB8IFdlbGxLbm93bkF0dHJOYW1lLFxuICB2YWx1ZTogV2lyZUZvcm1hdC5FeHByZXNzaW9uLFxuICBuYW1lc3BhY2U/OiBzdHJpbmdcbl07XG5cbmZ1bmN0aW9uIGR5bmFtaWNBdHRyKHsgbmFtZSwgdmFsdWUsIG5hbWVzcGFjZSB9OiBtaXIuRHluYW1pY0F0dHIpOiBEeW5hbWljQXR0ckFyZ3Mge1xuICBsZXQgb3V0OiBEeW5hbWljQXR0ckFyZ3MgPSBbZGVmbGF0ZUF0dHJOYW1lKG5hbWUuY2hhcnMpLCBFWFBSLmV4cHIodmFsdWUpXTtcblxuICBpZiAobmFtZXNwYWNlKSB7XG4gICAgb3V0LnB1c2gobmFtZXNwYWNlKTtcbiAgfVxuXG4gIHJldHVybiBvdXQ7XG59XG5cbmZ1bmN0aW9uIHN0YXRpY0F0dHJPcChraW5kOiB7XG4gIGNvbXBvbmVudDogYm9vbGVhbjtcbn0pOiBTZXhwT3Bjb2Rlcy5TdGF0aWNBdHRyIHwgU2V4cE9wY29kZXMuU3RhdGljQ29tcG9uZW50QXR0cjtcbmZ1bmN0aW9uIHN0YXRpY0F0dHJPcChraW5kOiB7IGNvbXBvbmVudDogYm9vbGVhbiB9KTogV2lyZUZvcm1hdC5BdHRyT3Age1xuICBpZiAoa2luZC5jb21wb25lbnQpIHtcbiAgICByZXR1cm4gU2V4cE9wY29kZXMuU3RhdGljQ29tcG9uZW50QXR0cjtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gU2V4cE9wY29kZXMuU3RhdGljQXR0cjtcbiAgfVxufVxuXG5mdW5jdGlvbiBkeW5hbWljQXR0ck9wKFxuICBraW5kOiBtaXIuQXR0cktpbmRcbik6XG4gIHwgU2V4cE9wY29kZXMuVHJ1c3RpbmdDb21wb25lbnRBdHRyXG4gIHwgU2V4cE9wY29kZXMuVHJ1c3RpbmdEeW5hbWljQXR0clxuICB8IFNleHBPcGNvZGVzLkNvbXBvbmVudEF0dHJcbiAgfCBTZXhwT3Bjb2Rlcy5EeW5hbWljQXR0ciB7XG4gIGlmIChraW5kLmNvbXBvbmVudCkge1xuICAgIHJldHVybiBraW5kLnRydXN0aW5nID8gU2V4cE9wY29kZXMuVHJ1c3RpbmdDb21wb25lbnRBdHRyIDogU2V4cE9wY29kZXMuQ29tcG9uZW50QXR0cjtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4ga2luZC50cnVzdGluZyA/IFNleHBPcGNvZGVzLlRydXN0aW5nRHluYW1pY0F0dHIgOiBTZXhwT3Bjb2Rlcy5EeW5hbWljQXR0cjtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==