"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ConstantsImpl = exports.RuntimeConstantsImpl = exports.CompileTimeConstantImpl = void 0;

var _util = require("@glimmer/util");

var _manager = require("@glimmer/manager");

var _opcodeCompiler = require("@glimmer/opcode-compiler");

var _defaultTemplate = require("./util/default-template");

const WELL_KNOWN_EMPTY_ARRAY = Object.freeze([]);
const STARTER_CONSTANTS = (0, _util.constants)(WELL_KNOWN_EMPTY_ARRAY);
const WELL_KNOWN_EMPTY_ARRAY_POSITION = STARTER_CONSTANTS.indexOf(WELL_KNOWN_EMPTY_ARRAY);

class CompileTimeConstantImpl {
  constructor() {
    // `0` means NULL
    this.values = STARTER_CONSTANTS.slice();
    this.indexMap = new Map(this.values.map((value, index) => [value, index]));
  }

  value(value) {
    let indexMap = this.indexMap;
    let index = indexMap.get(value);

    if (index === undefined) {
      index = this.values.push(value) - 1;
      indexMap.set(value, index);
    }

    return index;
  }

  array(values) {
    if (values.length === 0) {
      return WELL_KNOWN_EMPTY_ARRAY_POSITION;
    }

    let handles = new Array(values.length);

    for (let i = 0; i < values.length; i++) {
      handles[i] = this.value(values[i]);
    }

    return this.value(handles);
  }

  toPool() {
    return this.values;
  }

}

exports.CompileTimeConstantImpl = CompileTimeConstantImpl;

class RuntimeConstantsImpl {
  constructor(pool) {
    this.values = pool;
  }

  getValue(handle) {
    return this.values[handle];
  }

  getArray(value) {
    let handles = this.getValue(value);
    let reified = new Array(handles.length);

    for (let i = 0; i < handles.length; i++) {
      let n = handles[i];
      reified[i] = this.getValue(n);
    }

    return reified;
  }

}

exports.RuntimeConstantsImpl = RuntimeConstantsImpl;

class ConstantsImpl extends CompileTimeConstantImpl {
  constructor() {
    super(...arguments);
    this.reifiedArrs = {
      [WELL_KNOWN_EMPTY_ARRAY_POSITION]: WELL_KNOWN_EMPTY_ARRAY
    };
    this.defaultTemplate = (0, _opcodeCompiler.templateFactory)(_defaultTemplate.DEFAULT_TEMPLATE)(); // Used for tests and debugging purposes, and to be able to analyze large apps
    // This is why it's enabled even in production

    this.helperDefinitionCount = 0;
    this.modifierDefinitionCount = 0;
    this.componentDefinitionCount = 0;
    this.helperDefinitionCache = new WeakMap();
    this.modifierDefinitionCache = new WeakMap();
    this.componentDefinitionCache = new WeakMap();
  }

  helper(definitionState, // TODO: Add a way to expose resolved name for debugging
  _resolvedName = null, isOptional) {
    let handle = this.helperDefinitionCache.get(definitionState);

    if (handle === undefined) {
      let managerOrHelper = (0, _manager.getInternalHelperManager)(definitionState, isOptional);

      if (managerOrHelper === null) {
        this.helperDefinitionCache.set(definitionState, null);
        return null;
      }

      false && (0, _util.assert)(managerOrHelper, 'BUG: expected manager or helper');
      let helper = typeof managerOrHelper === 'function' ? managerOrHelper : managerOrHelper.getHelper(definitionState);
      handle = this.value(helper);
      this.helperDefinitionCache.set(definitionState, handle);
      this.helperDefinitionCount++;
    }

    return handle;
  }

  modifier(definitionState, resolvedName = null, isOptional) {
    let handle = this.modifierDefinitionCache.get(definitionState);

    if (handle === undefined) {
      let manager = (0, _manager.getInternalModifierManager)(definitionState, isOptional);

      if (manager === null) {
        this.modifierDefinitionCache.set(definitionState, null);
        return null;
      }

      let definition = {
        resolvedName,
        manager,
        state: definitionState
      };
      handle = this.value(definition);
      this.modifierDefinitionCache.set(definitionState, handle);
      this.modifierDefinitionCount++;
    }

    return handle;
  }

  component(definitionState, owner, isOptional) {
    var _a;

    let definition = this.componentDefinitionCache.get(definitionState);

    if (definition === undefined) {
      let manager = (0, _manager.getInternalComponentManager)(definitionState, isOptional);

      if (manager === null) {
        this.componentDefinitionCache.set(definitionState, null);
        return null;
      }

      false && (0, _util.assert)(manager, 'BUG: expected manager');
      let capabilities = (0, _manager.capabilityFlagsFrom)(manager.getCapabilities(definitionState));
      let templateFactory = (0, _manager.getComponentTemplate)(definitionState);
      let compilable = null;
      let template;

      if (!(0, _manager.managerHasCapability)(manager, capabilities, 1
      /* DynamicLayout */
      )) {
        template = (_a = templateFactory === null || templateFactory === void 0 ? void 0 : templateFactory(owner)) !== null && _a !== void 0 ? _a : this.defaultTemplate;
      } else {
        template = templateFactory === null || templateFactory === void 0 ? void 0 : templateFactory(owner);
      }

      if (template !== undefined) {
        template = (0, _util.unwrapTemplate)(template);
        compilable = (0, _manager.managerHasCapability)(manager, capabilities, 1024
        /* Wrapped */
        ) ? template.asWrappedLayout() : template.asLayout();
      }

      definition = {
        resolvedName: null,
        handle: -1,
        manager,
        capabilities,
        state: definitionState,
        compilable
      };
      definition.handle = this.value(definition);
      this.componentDefinitionCache.set(definitionState, definition);
      this.componentDefinitionCount++;
    }

    return definition;
  }

  resolvedComponent(resolvedDefinition, resolvedName) {
    let definition = this.componentDefinitionCache.get(resolvedDefinition);

    if (definition === undefined) {
      let {
        manager,
        state,
        template
      } = resolvedDefinition;
      let capabilities = (0, _manager.capabilityFlagsFrom)(manager.getCapabilities(resolvedDefinition));
      let compilable = null;

      if (!(0, _manager.managerHasCapability)(manager, capabilities, 1
      /* DynamicLayout */
      )) {
        template = template !== null && template !== void 0 ? template : this.defaultTemplate;
      }

      if (template !== null) {
        template = (0, _util.unwrapTemplate)(template);
        compilable = (0, _manager.managerHasCapability)(manager, capabilities, 1024
        /* Wrapped */
        ) ? template.asWrappedLayout() : template.asLayout();
      }

      definition = {
        resolvedName,
        handle: -1,
        manager,
        capabilities,
        state,
        compilable
      };
      definition.handle = this.value(definition);
      this.componentDefinitionCache.set(resolvedDefinition, definition);
      this.componentDefinitionCount++;
    }

    return definition;
  }

  getValue(index) {
    false && (0, _util.assert)(index >= 0, `cannot get value for handle: ${index}`);
    return this.values[index];
  }

  getArray(index) {
    let reifiedArrs = this.reifiedArrs;
    let reified = reifiedArrs[index];

    if (reified === undefined) {
      let names = this.getValue(index);
      reified = new Array(names.length);

      for (let i = 0; i < names.length; i++) {
        reified[i] = this.getValue(names[i]);
      }

      reifiedArrs[index] = reified;
    }

    return reified;
  }

}

exports.ConstantsImpl = ConstantsImpl;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3Byb2dyYW0vbGliL2NvbnN0YW50cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBYUE7O0FBQ0E7O0FBUUE7O0FBQ0E7O0FBRUEsTUFBTSxzQkFBc0IsR0FBWSxNQUFNLENBQU4sTUFBQSxDQUF4QyxFQUF3QyxDQUF4QztBQUNBLE1BQU0saUJBQWlCLEdBQUcscUJBQTFCLHNCQUEwQixDQUExQjtBQUNBLE1BQU0sK0JBQStCLEdBQVcsaUJBQWlCLENBQWpCLE9BQUEsQ0FBaEQsc0JBQWdELENBQWhEOztBQUVNLE1BQUEsdUJBQUEsQ0FBOEI7QUFBcEMsRUFBQSxXQUFBLEdBQUE7QUFDRTtBQUVVLFNBQUEsTUFBQSxHQUFvQixpQkFBaUIsQ0FBckMsS0FBb0IsRUFBcEI7QUFDQSxTQUFBLFFBQUEsR0FBaUMsSUFBQSxHQUFBLENBQ3pDLEtBQUEsTUFBQSxDQUFBLEdBQUEsQ0FBZ0IsQ0FBQSxLQUFBLEVBQUEsS0FBQSxLQUFrQixDQUFBLEtBQUEsRUFEMUIsS0FDMEIsQ0FBbEMsQ0FEeUMsQ0FBakM7QUFpQ1g7O0FBN0JDLEVBQUEsS0FBSyxDQUFBLEtBQUEsRUFBZTtBQUNsQixRQUFJLFFBQVEsR0FBRyxLQUFmLFFBQUE7QUFDQSxRQUFJLEtBQUssR0FBRyxRQUFRLENBQVIsR0FBQSxDQUFaLEtBQVksQ0FBWjs7QUFFQSxRQUFJLEtBQUssS0FBVCxTQUFBLEVBQXlCO0FBQ3ZCLE1BQUEsS0FBSyxHQUFHLEtBQUEsTUFBQSxDQUFBLElBQUEsQ0FBQSxLQUFBLElBQVIsQ0FBQTtBQUNBLE1BQUEsUUFBUSxDQUFSLEdBQUEsQ0FBQSxLQUFBLEVBQUEsS0FBQTtBQUNEOztBQUVELFdBQUEsS0FBQTtBQUNEOztBQUVELEVBQUEsS0FBSyxDQUFBLE1BQUEsRUFBa0I7QUFDckIsUUFBSSxNQUFNLENBQU4sTUFBQSxLQUFKLENBQUEsRUFBeUI7QUFDdkIsYUFBQSwrQkFBQTtBQUNEOztBQUVE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LENBQUEsa0JBQUEsRUFBQSxVQUFBO0FBQ0EsV0FBQSx3QkFBQTtBQUNEOztBQUVELFdBQUEsVUFBQTtBQUNEOztBQUVELEVBQUEsUUFBUSxDQUFBLEtBQUEsRUFBaUI7QUFBQSxhQUN2QixrQkFBTyxLQUFLLElBQU4sQ0FBTixFQUFtQixnQ0FBZ0MsS0FENUIsRUFDdkIsQ0FEdUI7QUFHdkIsV0FBTyxLQUFBLE1BQUEsQ0FBUCxLQUFPLENBQVA7QUFDRDs7QUFFRCxFQUFBLFFBQVEsQ0FBQSxLQUFBLEVBQWlCO0FBQ3ZCLFFBQUksV0FBVyxHQUFHLEtBQWxCLFdBQUE7QUFDQSxRQUFJLE9BQU8sR0FBRyxXQUFXLENBQXpCLEtBQXlCLENBQXpCOztBQUVBLFFBQUksT0FBTyxLQUFYLFNBQUEsRUFBMkI7QUFDekIsVUFBSSxLQUFLLEdBQWEsS0FBQSxRQUFBLENBQXRCLEtBQXNCLENBQXRCO0FBQ0EsTUFBQSxPQUFPLEdBQUcsSUFBQSxLQUFBLENBQVUsS0FBSyxDQUF6QixNQUFVLENBQVY7O0FBRUEsV0FBSyxJQUFJLENBQUMsR0FBVixDQUFBLEVBQWdCLENBQUMsR0FBRyxLQUFLLENBQXpCLE1BQUEsRUFBa0MsQ0FBbEMsRUFBQSxFQUF1QztBQUNyQyxRQUFBLE9BQU8sQ0FBUCxDQUFPLENBQVAsR0FBYSxLQUFBLFFBQUEsQ0FBYyxLQUFLLENBQWhDLENBQWdDLENBQW5CLENBQWI7QUFDRDs7QUFFRCxNQUFBLFdBQVcsQ0FBWCxLQUFXLENBQVgsR0FBQSxPQUFBO0FBQ0Q7O0FBRUQsV0FBQSxPQUFBO0FBQ0Q7O0FBeE84QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBpbGVUaW1lQ29uc3RhbnRzLFxuICBDb21wb25lbnREZWZpbml0aW9uU3RhdGUsXG4gIENvbnN0YW50UG9vbCxcbiAgSW50ZXJuYWxDb21wb25lbnRDYXBhYmlsaXR5LFxuICBDb21wb25lbnREZWZpbml0aW9uLFxuICBSZXNvbHV0aW9uVGltZUNvbnN0YW50cyxcbiAgUmVzb2x2ZWRDb21wb25lbnREZWZpbml0aW9uLFxuICBSdW50aW1lQ29uc3RhbnRzLFxuICBNb2RpZmllckRlZmluaXRpb25TdGF0ZSxcbiAgSGVscGVyRGVmaW5pdGlvblN0YXRlLFxuICBUZW1wbGF0ZSxcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBhc3NlcnQsIGNvbnN0YW50cywgZXhwZWN0LCB1bndyYXBUZW1wbGF0ZSB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHtcbiAgY2FwYWJpbGl0eUZsYWdzRnJvbSxcbiAgZ2V0Q29tcG9uZW50VGVtcGxhdGUsXG4gIGdldEludGVybmFsQ29tcG9uZW50TWFuYWdlcixcbiAgZ2V0SW50ZXJuYWxIZWxwZXJNYW5hZ2VyLFxuICBnZXRJbnRlcm5hbE1vZGlmaWVyTWFuYWdlcixcbiAgbWFuYWdlckhhc0NhcGFiaWxpdHksXG59IGZyb20gJ0BnbGltbWVyL21hbmFnZXInO1xuaW1wb3J0IHsgdGVtcGxhdGVGYWN0b3J5IH0gZnJvbSAnQGdsaW1tZXIvb3Bjb2RlLWNvbXBpbGVyJztcbmltcG9ydCB7IERFRkFVTFRfVEVNUExBVEUgfSBmcm9tICcuL3V0aWwvZGVmYXVsdC10ZW1wbGF0ZSc7XG5cbmNvbnN0IFdFTExfS05PV05fRU1QVFlfQVJSQVk6IHVua25vd24gPSBPYmplY3QuZnJlZXplKFtdKTtcbmNvbnN0IFNUQVJURVJfQ09OU1RBTlRTID0gY29uc3RhbnRzKFdFTExfS05PV05fRU1QVFlfQVJSQVkpO1xuY29uc3QgV0VMTF9LTk9XTl9FTVBUWV9BUlJBWV9QT1NJVElPTjogbnVtYmVyID0gU1RBUlRFUl9DT05TVEFOVFMuaW5kZXhPZihXRUxMX0tOT1dOX0VNUFRZX0FSUkFZKTtcblxuZXhwb3J0IGNsYXNzIENvbXBpbGVUaW1lQ29uc3RhbnRJbXBsIGltcGxlbWVudHMgQ29tcGlsZVRpbWVDb25zdGFudHMge1xuICAvLyBgMGAgbWVhbnMgTlVMTFxuXG4gIHByb3RlY3RlZCB2YWx1ZXM6IHVua25vd25bXSA9IFNUQVJURVJfQ09OU1RBTlRTLnNsaWNlKCk7XG4gIHByb3RlY3RlZCBpbmRleE1hcDogTWFwPHVua25vd24sIG51bWJlcj4gPSBuZXcgTWFwKFxuICAgIHRoaXMudmFsdWVzLm1hcCgodmFsdWUsIGluZGV4KSA9PiBbdmFsdWUsIGluZGV4XSlcbiAgKTtcblxuICB2YWx1ZSh2YWx1ZTogdW5rbm93bikge1xuICAgIGxldCBpbmRleE1hcCA9IHRoaXMuaW5kZXhNYXA7XG4gICAgbGV0IGluZGV4ID0gaW5kZXhNYXAuZ2V0KHZhbHVlKTtcblxuICAgIGlmIChpbmRleCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBpbmRleCA9IHRoaXMudmFsdWVzLnB1c2godmFsdWUpIC0gMTtcbiAgICAgIGluZGV4TWFwLnNldCh2YWx1ZSwgaW5kZXgpO1xuICAgIH1cblxuICAgIHJldHVybiBpbmRleDtcbiAgfVxuXG4gIGFycmF5KHZhbHVlczogdW5rbm93bltdKTogbnVtYmVyIHtcbiAgICBpZiAodmFsdWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFdFTExfS05PV05fRU1QVFlfQVJSQVlfUE9TSVRJT047XG4gICAgfVxuXG4gICAgbGV0IGhhbmRsZXM6IG51bWJlcltdID0gbmV3IEFycmF5KHZhbHVlcy5sZW5ndGgpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGhhbmRsZXNbaV0gPSB0aGlzLnZhbHVlKHZhbHVlc1tpXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudmFsdWUoaGFuZGxlcyk7XG4gIH1cblxuICB0b1Bvb2woKTogQ29uc3RhbnRQb29sIHtcbiAgICByZXR1cm4gdGhpcy52YWx1ZXM7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFJ1bnRpbWVDb25zdGFudHNJbXBsIGltcGxlbWVudHMgUnVudGltZUNvbnN0YW50cyB7XG4gIHByb3RlY3RlZCB2YWx1ZXM6IHVua25vd25bXTtcblxuICBjb25zdHJ1Y3Rvcihwb29sOiBDb25zdGFudFBvb2wpIHtcbiAgICB0aGlzLnZhbHVlcyA9IHBvb2w7XG4gIH1cblxuICBnZXRWYWx1ZTxUPihoYW5kbGU6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLnZhbHVlc1toYW5kbGVdIGFzIFQ7XG4gIH1cblxuICBnZXRBcnJheTxUPih2YWx1ZTogbnVtYmVyKTogVFtdIHtcbiAgICBsZXQgaGFuZGxlcyA9IHRoaXMuZ2V0VmFsdWUodmFsdWUpIGFzIG51bWJlcltdO1xuICAgIGxldCByZWlmaWVkOiBUW10gPSBuZXcgQXJyYXkoaGFuZGxlcy5sZW5ndGgpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoYW5kbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgbiA9IGhhbmRsZXNbaV07XG4gICAgICByZWlmaWVkW2ldID0gdGhpcy5nZXRWYWx1ZShuKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVpZmllZDtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQ29uc3RhbnRzSW1wbFxuICBleHRlbmRzIENvbXBpbGVUaW1lQ29uc3RhbnRJbXBsXG4gIGltcGxlbWVudHMgUnVudGltZUNvbnN0YW50cywgUmVzb2x1dGlvblRpbWVDb25zdGFudHMge1xuICBwcm90ZWN0ZWQgcmVpZmllZEFycnM6IHsgW2tleTogbnVtYmVyXTogdW5rbm93bltdIH0gPSB7XG4gICAgW1dFTExfS05PV05fRU1QVFlfQVJSQVlfUE9TSVRJT05dOiBXRUxMX0tOT1dOX0VNUFRZX0FSUkFZIGFzIHVua25vd25bXSxcbiAgfTtcblxuICBkZWZhdWx0VGVtcGxhdGU6IFRlbXBsYXRlID0gdGVtcGxhdGVGYWN0b3J5KERFRkFVTFRfVEVNUExBVEUpKCk7XG5cbiAgLy8gVXNlZCBmb3IgdGVzdHMgYW5kIGRlYnVnZ2luZyBwdXJwb3NlcywgYW5kIHRvIGJlIGFibGUgdG8gYW5hbHl6ZSBsYXJnZSBhcHBzXG4gIC8vIFRoaXMgaXMgd2h5IGl0J3MgZW5hYmxlZCBldmVuIGluIHByb2R1Y3Rpb25cbiAgaGVscGVyRGVmaW5pdGlvbkNvdW50ID0gMDtcbiAgbW9kaWZpZXJEZWZpbml0aW9uQ291bnQgPSAwO1xuICBjb21wb25lbnREZWZpbml0aW9uQ291bnQgPSAwO1xuXG4gIHByaXZhdGUgaGVscGVyRGVmaW5pdGlvbkNhY2hlID0gbmV3IFdlYWtNYXA8SGVscGVyRGVmaW5pdGlvblN0YXRlLCBudW1iZXIgfCBudWxsPigpO1xuXG4gIHByaXZhdGUgbW9kaWZpZXJEZWZpbml0aW9uQ2FjaGUgPSBuZXcgV2Vha01hcDxNb2RpZmllckRlZmluaXRpb25TdGF0ZSwgbnVtYmVyIHwgbnVsbD4oKTtcblxuICBwcml2YXRlIGNvbXBvbmVudERlZmluaXRpb25DYWNoZSA9IG5ldyBXZWFrTWFwPFxuICAgIENvbXBvbmVudERlZmluaXRpb25TdGF0ZSB8IFJlc29sdmVkQ29tcG9uZW50RGVmaW5pdGlvbixcbiAgICBDb21wb25lbnREZWZpbml0aW9uIHwgbnVsbFxuICA+KCk7XG5cbiAgaGVscGVyKFxuICAgIGRlZmluaXRpb25TdGF0ZTogSGVscGVyRGVmaW5pdGlvblN0YXRlLFxuXG4gICAgLy8gVE9ETzogQWRkIGEgd2F5IHRvIGV4cG9zZSByZXNvbHZlZCBuYW1lIGZvciBkZWJ1Z2dpbmdcbiAgICBfcmVzb2x2ZWROYW1lOiBzdHJpbmcgfCBudWxsLFxuICAgIGlzT3B0aW9uYWw6IHRydWVcbiAgKTogbnVtYmVyIHwgbnVsbDtcbiAgaGVscGVyKFxuICAgIGRlZmluaXRpb25TdGF0ZTogSGVscGVyRGVmaW5pdGlvblN0YXRlLFxuXG4gICAgLy8gVE9ETzogQWRkIGEgd2F5IHRvIGV4cG9zZSByZXNvbHZlZCBuYW1lIGZvciBkZWJ1Z2dpbmdcbiAgICBfcmVzb2x2ZWROYW1lPzogc3RyaW5nIHwgbnVsbFxuICApOiBudW1iZXI7XG4gIGhlbHBlcihcbiAgICBkZWZpbml0aW9uU3RhdGU6IEhlbHBlckRlZmluaXRpb25TdGF0ZSxcblxuICAgIC8vIFRPRE86IEFkZCBhIHdheSB0byBleHBvc2UgcmVzb2x2ZWQgbmFtZSBmb3IgZGVidWdnaW5nXG4gICAgX3Jlc29sdmVkTmFtZTogc3RyaW5nIHwgbnVsbCA9IG51bGwsXG4gICAgaXNPcHRpb25hbD86IHRydWVcbiAgKTogbnVtYmVyIHwgbnVsbCB7XG4gICAgbGV0IGhhbmRsZSA9IHRoaXMuaGVscGVyRGVmaW5pdGlvbkNhY2hlLmdldChkZWZpbml0aW9uU3RhdGUpO1xuXG4gICAgaWYgKGhhbmRsZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBsZXQgbWFuYWdlck9ySGVscGVyID0gZ2V0SW50ZXJuYWxIZWxwZXJNYW5hZ2VyKGRlZmluaXRpb25TdGF0ZSwgaXNPcHRpb25hbCk7XG5cbiAgICAgIGlmIChtYW5hZ2VyT3JIZWxwZXIgPT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5oZWxwZXJEZWZpbml0aW9uQ2FjaGUuc2V0KGRlZmluaXRpb25TdGF0ZSwgbnVsbCk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICBhc3NlcnQobWFuYWdlck9ySGVscGVyLCAnQlVHOiBleHBlY3RlZCBtYW5hZ2VyIG9yIGhlbHBlcicpO1xuXG4gICAgICBsZXQgaGVscGVyID1cbiAgICAgICAgdHlwZW9mIG1hbmFnZXJPckhlbHBlciA9PT0gJ2Z1bmN0aW9uJ1xuICAgICAgICAgID8gbWFuYWdlck9ySGVscGVyXG4gICAgICAgICAgOiBtYW5hZ2VyT3JIZWxwZXIuZ2V0SGVscGVyKGRlZmluaXRpb25TdGF0ZSk7XG5cbiAgICAgIGhhbmRsZSA9IHRoaXMudmFsdWUoaGVscGVyKTtcblxuICAgICAgdGhpcy5oZWxwZXJEZWZpbml0aW9uQ2FjaGUuc2V0KGRlZmluaXRpb25TdGF0ZSwgaGFuZGxlKTtcbiAgICAgIHRoaXMuaGVscGVyRGVmaW5pdGlvbkNvdW50Kys7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhhbmRsZTtcbiAgfVxuXG4gIG1vZGlmaWVyKFxuICAgIGRlZmluaXRpb25TdGF0ZTogTW9kaWZpZXJEZWZpbml0aW9uU3RhdGUsXG4gICAgcmVzb2x2ZWROYW1lOiBzdHJpbmcgfCBudWxsLFxuICAgIGlzT3B0aW9uYWw6IHRydWVcbiAgKTogbnVtYmVyIHwgbnVsbDtcbiAgbW9kaWZpZXIoZGVmaW5pdGlvblN0YXRlOiBNb2RpZmllckRlZmluaXRpb25TdGF0ZSwgcmVzb2x2ZWROYW1lPzogc3RyaW5nIHwgbnVsbCk6IG51bWJlcjtcbiAgbW9kaWZpZXIoXG4gICAgZGVmaW5pdGlvblN0YXRlOiBNb2RpZmllckRlZmluaXRpb25TdGF0ZSxcbiAgICByZXNvbHZlZE5hbWU6IHN0cmluZyB8IG51bGwgPSBudWxsLFxuICAgIGlzT3B0aW9uYWw/OiB0cnVlXG4gICk6IG51bWJlciB8IG51bGwge1xuICAgIGxldCBoYW5kbGUgPSB0aGlzLm1vZGlmaWVyRGVmaW5pdGlvbkNhY2hlLmdldChkZWZpbml0aW9uU3RhdGUpO1xuXG4gICAgaWYgKGhhbmRsZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBsZXQgbWFuYWdlciA9IGdldEludGVybmFsTW9kaWZpZXJNYW5hZ2VyKGRlZmluaXRpb25TdGF0ZSwgaXNPcHRpb25hbCk7XG5cbiAgICAgIGlmIChtYW5hZ2VyID09PSBudWxsKSB7XG4gICAgICAgIHRoaXMubW9kaWZpZXJEZWZpbml0aW9uQ2FjaGUuc2V0KGRlZmluaXRpb25TdGF0ZSwgbnVsbCk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICBsZXQgZGVmaW5pdGlvbiA9IHtcbiAgICAgICAgcmVzb2x2ZWROYW1lLFxuICAgICAgICBtYW5hZ2VyLFxuICAgICAgICBzdGF0ZTogZGVmaW5pdGlvblN0YXRlLFxuICAgICAgfTtcblxuICAgICAgaGFuZGxlID0gdGhpcy52YWx1ZShkZWZpbml0aW9uKTtcblxuICAgICAgdGhpcy5tb2RpZmllckRlZmluaXRpb25DYWNoZS5zZXQoZGVmaW5pdGlvblN0YXRlLCBoYW5kbGUpO1xuICAgICAgdGhpcy5tb2RpZmllckRlZmluaXRpb25Db3VudCsrO1xuICAgIH1cblxuICAgIHJldHVybiBoYW5kbGU7XG4gIH1cblxuICBjb21wb25lbnQoZGVmaW5pdGlvblN0YXRlOiBDb21wb25lbnREZWZpbml0aW9uU3RhdGUsIG93bmVyOiBvYmplY3QpOiBDb21wb25lbnREZWZpbml0aW9uO1xuICBjb21wb25lbnQoXG4gICAgZGVmaW5pdGlvblN0YXRlOiBDb21wb25lbnREZWZpbml0aW9uU3RhdGUsXG4gICAgb3duZXI6IG9iamVjdCxcbiAgICBpc09wdGlvbmFsPzogdHJ1ZVxuICApOiBDb21wb25lbnREZWZpbml0aW9uIHwgbnVsbCB7XG4gICAgbGV0IGRlZmluaXRpb24gPSB0aGlzLmNvbXBvbmVudERlZmluaXRpb25DYWNoZS5nZXQoZGVmaW5pdGlvblN0YXRlKTtcblxuICAgIGlmIChkZWZpbml0aW9uID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGxldCBtYW5hZ2VyID0gZ2V0SW50ZXJuYWxDb21wb25lbnRNYW5hZ2VyKGRlZmluaXRpb25TdGF0ZSwgaXNPcHRpb25hbCk7XG5cbiAgICAgIGlmIChtYW5hZ2VyID09PSBudWxsKSB7XG4gICAgICAgIHRoaXMuY29tcG9uZW50RGVmaW5pdGlvbkNhY2hlLnNldChkZWZpbml0aW9uU3RhdGUsIG51bGwpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgYXNzZXJ0KG1hbmFnZXIsICdCVUc6IGV4cGVjdGVkIG1hbmFnZXInKTtcblxuICAgICAgbGV0IGNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdHlGbGFnc0Zyb20obWFuYWdlci5nZXRDYXBhYmlsaXRpZXMoZGVmaW5pdGlvblN0YXRlKSk7XG5cbiAgICAgIGxldCB0ZW1wbGF0ZUZhY3RvcnkgPSBnZXRDb21wb25lbnRUZW1wbGF0ZShkZWZpbml0aW9uU3RhdGUpO1xuXG4gICAgICBsZXQgY29tcGlsYWJsZSA9IG51bGw7XG4gICAgICBsZXQgdGVtcGxhdGU7XG5cbiAgICAgIGlmICghbWFuYWdlckhhc0NhcGFiaWxpdHkobWFuYWdlciwgY2FwYWJpbGl0aWVzLCBJbnRlcm5hbENvbXBvbmVudENhcGFiaWxpdHkuRHluYW1pY0xheW91dCkpIHtcbiAgICAgICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZUZhY3Rvcnk/Lihvd25lcikgPz8gdGhpcy5kZWZhdWx0VGVtcGxhdGU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0ZW1wbGF0ZSA9IHRlbXBsYXRlRmFjdG9yeT8uKG93bmVyKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRlbXBsYXRlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGVtcGxhdGUgPSB1bndyYXBUZW1wbGF0ZSh0ZW1wbGF0ZSk7XG5cbiAgICAgICAgY29tcGlsYWJsZSA9IG1hbmFnZXJIYXNDYXBhYmlsaXR5KFxuICAgICAgICAgIG1hbmFnZXIsXG4gICAgICAgICAgY2FwYWJpbGl0aWVzLFxuICAgICAgICAgIEludGVybmFsQ29tcG9uZW50Q2FwYWJpbGl0eS5XcmFwcGVkXG4gICAgICAgIClcbiAgICAgICAgICA/IHRlbXBsYXRlLmFzV3JhcHBlZExheW91dCgpXG4gICAgICAgICAgOiB0ZW1wbGF0ZS5hc0xheW91dCgpO1xuICAgICAgfVxuXG4gICAgICBkZWZpbml0aW9uID0ge1xuICAgICAgICByZXNvbHZlZE5hbWU6IG51bGwsXG4gICAgICAgIGhhbmRsZTogLTEsIC8vIHJlcGxhY2VkIG1vbWVudGFyaWx5XG4gICAgICAgIG1hbmFnZXIsXG4gICAgICAgIGNhcGFiaWxpdGllcyxcbiAgICAgICAgc3RhdGU6IGRlZmluaXRpb25TdGF0ZSxcbiAgICAgICAgY29tcGlsYWJsZSxcbiAgICAgIH07XG5cbiAgICAgIGRlZmluaXRpb24hLmhhbmRsZSA9IHRoaXMudmFsdWUoZGVmaW5pdGlvbik7XG4gICAgICB0aGlzLmNvbXBvbmVudERlZmluaXRpb25DYWNoZS5zZXQoZGVmaW5pdGlvblN0YXRlLCBkZWZpbml0aW9uKTtcbiAgICAgIHRoaXMuY29tcG9uZW50RGVmaW5pdGlvbkNvdW50Kys7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlZmluaXRpb247XG4gIH1cblxuICByZXNvbHZlZENvbXBvbmVudChcbiAgICByZXNvbHZlZERlZmluaXRpb246IFJlc29sdmVkQ29tcG9uZW50RGVmaW5pdGlvbixcbiAgICByZXNvbHZlZE5hbWU6IHN0cmluZ1xuICApOiBDb21wb25lbnREZWZpbml0aW9uIHtcbiAgICBsZXQgZGVmaW5pdGlvbiA9IHRoaXMuY29tcG9uZW50RGVmaW5pdGlvbkNhY2hlLmdldChyZXNvbHZlZERlZmluaXRpb24pO1xuXG4gICAgaWYgKGRlZmluaXRpb24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgbGV0IHsgbWFuYWdlciwgc3RhdGUsIHRlbXBsYXRlIH0gPSByZXNvbHZlZERlZmluaXRpb247XG4gICAgICBsZXQgY2FwYWJpbGl0aWVzID0gY2FwYWJpbGl0eUZsYWdzRnJvbShtYW5hZ2VyLmdldENhcGFiaWxpdGllcyhyZXNvbHZlZERlZmluaXRpb24pKTtcblxuICAgICAgbGV0IGNvbXBpbGFibGUgPSBudWxsO1xuXG4gICAgICBpZiAoIW1hbmFnZXJIYXNDYXBhYmlsaXR5KG1hbmFnZXIsIGNhcGFiaWxpdGllcywgSW50ZXJuYWxDb21wb25lbnRDYXBhYmlsaXR5LkR5bmFtaWNMYXlvdXQpKSB7XG4gICAgICAgIHRlbXBsYXRlID0gdGVtcGxhdGUgPz8gdGhpcy5kZWZhdWx0VGVtcGxhdGU7XG4gICAgICB9XG5cbiAgICAgIGlmICh0ZW1wbGF0ZSAhPT0gbnVsbCkge1xuICAgICAgICB0ZW1wbGF0ZSA9IHVud3JhcFRlbXBsYXRlKHRlbXBsYXRlKTtcblxuICAgICAgICBjb21waWxhYmxlID0gbWFuYWdlckhhc0NhcGFiaWxpdHkoXG4gICAgICAgICAgbWFuYWdlcixcbiAgICAgICAgICBjYXBhYmlsaXRpZXMsXG4gICAgICAgICAgSW50ZXJuYWxDb21wb25lbnRDYXBhYmlsaXR5LldyYXBwZWRcbiAgICAgICAgKVxuICAgICAgICAgID8gdGVtcGxhdGUuYXNXcmFwcGVkTGF5b3V0KClcbiAgICAgICAgICA6IHRlbXBsYXRlLmFzTGF5b3V0KCk7XG4gICAgICB9XG5cbiAgICAgIGRlZmluaXRpb24gPSB7XG4gICAgICAgIHJlc29sdmVkTmFtZSxcbiAgICAgICAgaGFuZGxlOiAtMSwgLy8gcmVwbGFjZWQgbW9tZW50YXJpbHlcbiAgICAgICAgbWFuYWdlcixcbiAgICAgICAgY2FwYWJpbGl0aWVzLFxuICAgICAgICBzdGF0ZSxcbiAgICAgICAgY29tcGlsYWJsZSxcbiAgICAgIH07XG5cbiAgICAgIGRlZmluaXRpb24hLmhhbmRsZSA9IHRoaXMudmFsdWUoZGVmaW5pdGlvbik7XG4gICAgICB0aGlzLmNvbXBvbmVudERlZmluaXRpb25DYWNoZS5zZXQocmVzb2x2ZWREZWZpbml0aW9uLCBkZWZpbml0aW9uKTtcbiAgICAgIHRoaXMuY29tcG9uZW50RGVmaW5pdGlvbkNvdW50Kys7XG4gICAgfVxuXG4gICAgcmV0dXJuIGV4cGVjdChkZWZpbml0aW9uLCAnQlVHOiByZXNvbHZlZCBjb21wb25lbnQgZGVmaW5pdGlvbnMgY2Fubm90IGJlIG51bGwnKTtcbiAgfVxuXG4gIGdldFZhbHVlPFQ+KGluZGV4OiBudW1iZXIpIHtcbiAgICBhc3NlcnQoaW5kZXggPj0gMCwgYGNhbm5vdCBnZXQgdmFsdWUgZm9yIGhhbmRsZTogJHtpbmRleH1gKTtcblxuICAgIHJldHVybiB0aGlzLnZhbHVlc1tpbmRleF0gYXMgVDtcbiAgfVxuXG4gIGdldEFycmF5PFQ+KGluZGV4OiBudW1iZXIpOiBUW10ge1xuICAgIGxldCByZWlmaWVkQXJycyA9IHRoaXMucmVpZmllZEFycnM7XG4gICAgbGV0IHJlaWZpZWQgPSByZWlmaWVkQXJyc1tpbmRleF0gYXMgVFtdO1xuXG4gICAgaWYgKHJlaWZpZWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgbGV0IG5hbWVzOiBudW1iZXJbXSA9IHRoaXMuZ2V0VmFsdWUoaW5kZXgpO1xuICAgICAgcmVpZmllZCA9IG5ldyBBcnJheShuYW1lcy5sZW5ndGgpO1xuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHJlaWZpZWRbaV0gPSB0aGlzLmdldFZhbHVlKG5hbWVzW2ldKTtcbiAgICAgIH1cblxuICAgICAgcmVpZmllZEFycnNbaW5kZXhdID0gcmVpZmllZDtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVpZmllZDtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==