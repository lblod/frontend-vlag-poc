function _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }

import { assert, constants, unwrapTemplate } from '@glimmer/util';
import { capabilityFlagsFrom, getComponentTemplate, getInternalComponentManager, getInternalHelperManager, getInternalModifierManager, managerHasCapability } from '@glimmer/manager';
import { templateFactory } from '@glimmer/opcode-compiler';
import { DEFAULT_TEMPLATE } from './util/default-template';
var WELL_KNOWN_EMPTY_ARRAY = Object.freeze([]);
var STARTER_CONSTANTS = constants(WELL_KNOWN_EMPTY_ARRAY);
var WELL_KNOWN_EMPTY_ARRAY_POSITION = STARTER_CONSTANTS.indexOf(WELL_KNOWN_EMPTY_ARRAY);
export var CompileTimeConstantImpl = /*#__PURE__*/function () {
  function CompileTimeConstantImpl() {
    // `0` means NULL
    this.values = STARTER_CONSTANTS.slice();
    this.indexMap = new Map(this.values.map(function (value, index) {
      return [value, index];
    }));
  }

  var _proto = CompileTimeConstantImpl.prototype;

  _proto.value = function value(_value) {
    var indexMap = this.indexMap;
    var index = indexMap.get(_value);

    if (index === undefined) {
      index = this.values.push(_value) - 1;
      indexMap.set(_value, index);
    }

    return index;
  };

  _proto.array = function array(values) {
    if (values.length === 0) {
      return WELL_KNOWN_EMPTY_ARRAY_POSITION;
    }

    var handles = new Array(values.length);

    for (var i = 0; i < values.length; i++) {
      handles[i] = this.value(values[i]);
    }

    return this.value(handles);
  };

  _proto.toPool = function toPool() {
    return this.values;
  };

  return CompileTimeConstantImpl;
}();
export var RuntimeConstantsImpl = /*#__PURE__*/function () {
  function RuntimeConstantsImpl(pool) {
    this.values = pool;
  }

  var _proto2 = RuntimeConstantsImpl.prototype;

  _proto2.getValue = function getValue(handle) {
    return this.values[handle];
  };

  _proto2.getArray = function getArray(value) {
    var handles = this.getValue(value);
    var reified = new Array(handles.length);

    for (var i = 0; i < handles.length; i++) {
      var n = handles[i];
      reified[i] = this.getValue(n);
    }

    return reified;
  };

  return RuntimeConstantsImpl;
}();
export var ConstantsImpl = /*#__PURE__*/function (_CompileTimeConstantI) {
  _inheritsLoose(ConstantsImpl, _CompileTimeConstantI);

  function ConstantsImpl() {
    var _this$reifiedArrs;

    var _this;

    _this = _CompileTimeConstantI.apply(this, arguments) || this;
    _this.reifiedArrs = (_this$reifiedArrs = {}, _this$reifiedArrs[WELL_KNOWN_EMPTY_ARRAY_POSITION] = WELL_KNOWN_EMPTY_ARRAY, _this$reifiedArrs);
    _this.defaultTemplate = templateFactory(DEFAULT_TEMPLATE)(); // Used for tests and debugging purposes, and to be able to analyze large apps
    // This is why it's enabled even in production

    _this.helperDefinitionCount = 0;
    _this.modifierDefinitionCount = 0;
    _this.componentDefinitionCount = 0;
    _this.helperDefinitionCache = new WeakMap();
    _this.modifierDefinitionCache = new WeakMap();
    _this.componentDefinitionCache = new WeakMap();
    return _this;
  }

  var _proto3 = ConstantsImpl.prototype;

  _proto3.helper = function helper(definitionState, // TODO: Add a way to expose resolved name for debugging
  _resolvedName, isOptional) {
    if (_resolvedName === void 0) {
      _resolvedName = null;
    }

    var handle = this.helperDefinitionCache.get(definitionState);

    if (handle === undefined) {
      var managerOrHelper = getInternalHelperManager(definitionState, isOptional);

      if (managerOrHelper === null) {
        this.helperDefinitionCache.set(definitionState, null);
        return null;
      }

      false && assert(managerOrHelper, 'BUG: expected manager or helper');
      var helper = typeof managerOrHelper === 'function' ? managerOrHelper : managerOrHelper.getHelper(definitionState);
      handle = this.value(helper);
      this.helperDefinitionCache.set(definitionState, handle);
      this.helperDefinitionCount++;
    }

    return handle;
  };

  _proto3.modifier = function modifier(definitionState, resolvedName, isOptional) {
    if (resolvedName === void 0) {
      resolvedName = null;
    }

    var handle = this.modifierDefinitionCache.get(definitionState);

    if (handle === undefined) {
      var manager = getInternalModifierManager(definitionState, isOptional);

      if (manager === null) {
        this.modifierDefinitionCache.set(definitionState, null);
        return null;
      }

      var definition = {
        resolvedName: resolvedName,
        manager: manager,
        state: definitionState
      };
      handle = this.value(definition);
      this.modifierDefinitionCache.set(definitionState, handle);
      this.modifierDefinitionCount++;
    }

    return handle;
  };

  _proto3.component = function component(definitionState, owner, isOptional) {
    var _a;

    var definition = this.componentDefinitionCache.get(definitionState);

    if (definition === undefined) {
      var manager = getInternalComponentManager(definitionState, isOptional);

      if (manager === null) {
        this.componentDefinitionCache.set(definitionState, null);
        return null;
      }

      false && assert(manager, 'BUG: expected manager');
      var capabilities = capabilityFlagsFrom(manager.getCapabilities(definitionState));

      var _templateFactory = getComponentTemplate(definitionState);

      var compilable = null;
      var template;

      if (!managerHasCapability(manager, capabilities, 1
      /* DynamicLayout */
      )) {
        template = (_a = _templateFactory === null || _templateFactory === void 0 ? void 0 : _templateFactory(owner)) !== null && _a !== void 0 ? _a : this.defaultTemplate;
      } else {
        template = _templateFactory === null || _templateFactory === void 0 ? void 0 : _templateFactory(owner);
      }

      if (template !== undefined) {
        template = unwrapTemplate(template);
        compilable = managerHasCapability(manager, capabilities, 1024
        /* Wrapped */
        ) ? template.asWrappedLayout() : template.asLayout();
      }

      definition = {
        resolvedName: null,
        handle: -1,
        manager: manager,
        capabilities: capabilities,
        state: definitionState,
        compilable: compilable
      };
      definition.handle = this.value(definition);
      this.componentDefinitionCache.set(definitionState, definition);
      this.componentDefinitionCount++;
    }

    return definition;
  };

  _proto3.resolvedComponent = function resolvedComponent(resolvedDefinition, resolvedName) {
    var definition = this.componentDefinitionCache.get(resolvedDefinition);

    if (definition === undefined) {
      var manager = resolvedDefinition.manager,
          state = resolvedDefinition.state,
          template = resolvedDefinition.template;
      var capabilities = capabilityFlagsFrom(manager.getCapabilities(resolvedDefinition));
      var compilable = null;

      if (!managerHasCapability(manager, capabilities, 1
      /* DynamicLayout */
      )) {
        template = template !== null && template !== void 0 ? template : this.defaultTemplate;
      }

      if (template !== null) {
        template = unwrapTemplate(template);
        compilable = managerHasCapability(manager, capabilities, 1024
        /* Wrapped */
        ) ? template.asWrappedLayout() : template.asLayout();
      }

      definition = {
        resolvedName: resolvedName,
        handle: -1,
        manager: manager,
        capabilities: capabilities,
        state: state,
        compilable: compilable
      };
      definition.handle = this.value(definition);
      this.componentDefinitionCache.set(resolvedDefinition, definition);
      this.componentDefinitionCount++;
    }

    return definition;
  };

  _proto3.getValue = function getValue(index) {
    false && assert(index >= 0, "cannot get value for handle: " + index);
    return this.values[index];
  };

  _proto3.getArray = function getArray(index) {
    var reifiedArrs = this.reifiedArrs;
    var reified = reifiedArrs[index];

    if (reified === undefined) {
      var names = this.getValue(index);
      reified = new Array(names.length);

      for (var i = 0; i < names.length; i++) {
        reified[i] = this.getValue(names[i]);
      }

      reifiedArrs[index] = reified;
    }

    return reified;
  };

  return ConstantsImpl;
}(CompileTimeConstantImpl);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3Byb2dyYW0vbGliL2NvbnN0YW50cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQWFBLFNBQUEsTUFBQSxFQUFBLFNBQUEsRUFBQSxjQUFBLFFBQUEsZUFBQTtBQUNBLFNBQUEsbUJBQUEsRUFBQSxvQkFBQSxFQUFBLDJCQUFBLEVBQUEsd0JBQUEsRUFBQSwwQkFBQSxFQUFBLG9CQUFBLFFBQUEsa0JBQUE7QUFRQSxTQUFBLGVBQUEsUUFBQSwwQkFBQTtBQUNBLFNBQUEsZ0JBQUEsUUFBQSx5QkFBQTtBQUVBLElBQU0sc0JBQXNCLEdBQVksTUFBTSxDQUFOLE1BQUEsQ0FBeEMsRUFBd0MsQ0FBeEM7QUFDQSxJQUFNLGlCQUFpQixHQUFHLFNBQVMsQ0FBbkMsc0JBQW1DLENBQW5DO0FBQ0EsSUFBTSwrQkFBK0IsR0FBVyxpQkFBaUIsQ0FBakIsT0FBQSxDQUFoRCxzQkFBZ0QsQ0FBaEQ7QUFFQSxXQUFNLHVCQUFOO0FBQUEscUNBQUE7QUFDRTtBQUVVLFNBQUEsTUFBQSxHQUFvQixpQkFBaUIsQ0FBckMsS0FBb0IsRUFBcEI7QUFDQSxTQUFBLFFBQUEsR0FBaUMsSUFBQSxHQUFBLENBQ3pDLEtBQUEsTUFBQSxDQUFBLEdBQUEsQ0FBZ0IsVUFBQSxLQUFBLEVBQUEsS0FBQTtBQUFBLGFBQWtCLENBQUEsS0FBQSxFQUQxQixLQUMwQixDQUFsQjtBQUFBLEtBQWhCLENBRHlDLENBQWpDO0FBaUNYOztBQXJDRDs7QUFBQSxTQVFFLEtBUkYsR0FRRSxlQUFLLE1BQUwsRUFBb0I7QUFDbEIsUUFBSSxRQUFRLEdBQUcsS0FBZixRQUFBO0FBQ0EsUUFBSSxLQUFLLEdBQUcsUUFBUSxDQUFSLEdBQUEsQ0FBWixNQUFZLENBQVo7O0FBRUEsUUFBSSxLQUFLLEtBQVQsU0FBQSxFQUF5QjtBQUN2QixNQUFBLEtBQUssR0FBRyxLQUFBLE1BQUEsQ0FBQSxJQUFBLENBQUEsTUFBQSxJQUFSLENBQUE7QUFDQSxN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QVcsQ0FBekIsS0FBeUIsQ0FBekI7O0FBRUEsUUFBSSxPQUFPLEtBQVgsU0FBQSxFQUEyQjtBQUN6QixVQUFJLEtBQUssR0FBYSxLQUFBLFFBQUEsQ0FBdEIsS0FBc0IsQ0FBdEI7QUFDQSxNQUFBLE9BQU8sR0FBRyxJQUFBLEtBQUEsQ0FBVSxLQUFLLENBQXpCLE1BQVUsQ0FBVjs7QUFFQSxXQUFLLElBQUksQ0FBQyxHQUFWLENBQUEsRUFBZ0IsQ0FBQyxHQUFHLEtBQUssQ0FBekIsTUFBQSxFQUFrQyxDQUFsQyxFQUFBLEVBQXVDO0FBQ3JDLFFBQUEsT0FBTyxDQUFQLENBQU8sQ0FBUCxHQUFhLEtBQUEsUUFBQSxDQUFjLEtBQUssQ0FBaEMsQ0FBZ0MsQ0FBbkIsQ0FBYjtBQUNEOztBQUVELE1BQUEsV0FBVyxDQUFYLEtBQVcsQ0FBWCxHQUFBLE9BQUE7QUFDRDs7QUFFRCxXQUFBLE9BQUE7QUFDRCxHQXpPSDs7QUFBQTtBQUFBLEVBQU0sdUJBQU4iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21waWxlVGltZUNvbnN0YW50cyxcbiAgQ29tcG9uZW50RGVmaW5pdGlvblN0YXRlLFxuICBDb25zdGFudFBvb2wsXG4gIEludGVybmFsQ29tcG9uZW50Q2FwYWJpbGl0eSxcbiAgQ29tcG9uZW50RGVmaW5pdGlvbixcbiAgUmVzb2x1dGlvblRpbWVDb25zdGFudHMsXG4gIFJlc29sdmVkQ29tcG9uZW50RGVmaW5pdGlvbixcbiAgUnVudGltZUNvbnN0YW50cyxcbiAgTW9kaWZpZXJEZWZpbml0aW9uU3RhdGUsXG4gIEhlbHBlckRlZmluaXRpb25TdGF0ZSxcbiAgVGVtcGxhdGUsXG59IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgYXNzZXJ0LCBjb25zdGFudHMsIGV4cGVjdCwgdW53cmFwVGVtcGxhdGUgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7XG4gIGNhcGFiaWxpdHlGbGFnc0Zyb20sXG4gIGdldENvbXBvbmVudFRlbXBsYXRlLFxuICBnZXRJbnRlcm5hbENvbXBvbmVudE1hbmFnZXIsXG4gIGdldEludGVybmFsSGVscGVyTWFuYWdlcixcbiAgZ2V0SW50ZXJuYWxNb2RpZmllck1hbmFnZXIsXG4gIG1hbmFnZXJIYXNDYXBhYmlsaXR5LFxufSBmcm9tICdAZ2xpbW1lci9tYW5hZ2VyJztcbmltcG9ydCB7IHRlbXBsYXRlRmFjdG9yeSB9IGZyb20gJ0BnbGltbWVyL29wY29kZS1jb21waWxlcic7XG5pbXBvcnQgeyBERUZBVUxUX1RFTVBMQVRFIH0gZnJvbSAnLi91dGlsL2RlZmF1bHQtdGVtcGxhdGUnO1xuXG5jb25zdCBXRUxMX0tOT1dOX0VNUFRZX0FSUkFZOiB1bmtub3duID0gT2JqZWN0LmZyZWV6ZShbXSk7XG5jb25zdCBTVEFSVEVSX0NPTlNUQU5UUyA9IGNvbnN0YW50cyhXRUxMX0tOT1dOX0VNUFRZX0FSUkFZKTtcbmNvbnN0IFdFTExfS05PV05fRU1QVFlfQVJSQVlfUE9TSVRJT046IG51bWJlciA9IFNUQVJURVJfQ09OU1RBTlRTLmluZGV4T2YoV0VMTF9LTk9XTl9FTVBUWV9BUlJBWSk7XG5cbmV4cG9ydCBjbGFzcyBDb21waWxlVGltZUNvbnN0YW50SW1wbCBpbXBsZW1lbnRzIENvbXBpbGVUaW1lQ29uc3RhbnRzIHtcbiAgLy8gYDBgIG1lYW5zIE5VTExcblxuICBwcm90ZWN0ZWQgdmFsdWVzOiB1bmtub3duW10gPSBTVEFSVEVSX0NPTlNUQU5UUy5zbGljZSgpO1xuICBwcm90ZWN0ZWQgaW5kZXhNYXA6IE1hcDx1bmtub3duLCBudW1iZXI+ID0gbmV3IE1hcChcbiAgICB0aGlzLnZhbHVlcy5tYXAoKHZhbHVlLCBpbmRleCkgPT4gW3ZhbHVlLCBpbmRleF0pXG4gICk7XG5cbiAgdmFsdWUodmFsdWU6IHVua25vd24pIHtcbiAgICBsZXQgaW5kZXhNYXAgPSB0aGlzLmluZGV4TWFwO1xuICAgIGxldCBpbmRleCA9IGluZGV4TWFwLmdldCh2YWx1ZSk7XG5cbiAgICBpZiAoaW5kZXggPT09IHVuZGVmaW5lZCkge1xuICAgICAgaW5kZXggPSB0aGlzLnZhbHVlcy5wdXNoKHZhbHVlKSAtIDE7XG4gICAgICBpbmRleE1hcC5zZXQodmFsdWUsIGluZGV4KTtcbiAgICB9XG5cbiAgICByZXR1cm4gaW5kZXg7XG4gIH1cblxuICBhcnJheSh2YWx1ZXM6IHVua25vd25bXSk6IG51bWJlciB7XG4gICAgaWYgKHZhbHVlcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBXRUxMX0tOT1dOX0VNUFRZX0FSUkFZX1BPU0lUSU9OO1xuICAgIH1cblxuICAgIGxldCBoYW5kbGVzOiBudW1iZXJbXSA9IG5ldyBBcnJheSh2YWx1ZXMubGVuZ3RoKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBoYW5kbGVzW2ldID0gdGhpcy52YWx1ZSh2YWx1ZXNbaV0pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnZhbHVlKGhhbmRsZXMpO1xuICB9XG5cbiAgdG9Qb29sKCk6IENvbnN0YW50UG9vbCB7XG4gICAgcmV0dXJuIHRoaXMudmFsdWVzO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSdW50aW1lQ29uc3RhbnRzSW1wbCBpbXBsZW1lbnRzIFJ1bnRpbWVDb25zdGFudHMge1xuICBwcm90ZWN0ZWQgdmFsdWVzOiB1bmtub3duW107XG5cbiAgY29uc3RydWN0b3IocG9vbDogQ29uc3RhbnRQb29sKSB7XG4gICAgdGhpcy52YWx1ZXMgPSBwb29sO1xuICB9XG5cbiAgZ2V0VmFsdWU8VD4oaGFuZGxlOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy52YWx1ZXNbaGFuZGxlXSBhcyBUO1xuICB9XG5cbiAgZ2V0QXJyYXk8VD4odmFsdWU6IG51bWJlcik6IFRbXSB7XG4gICAgbGV0IGhhbmRsZXMgPSB0aGlzLmdldFZhbHVlKHZhbHVlKSBhcyBudW1iZXJbXTtcbiAgICBsZXQgcmVpZmllZDogVFtdID0gbmV3IEFycmF5KGhhbmRsZXMubGVuZ3RoKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGFuZGxlcy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IG4gPSBoYW5kbGVzW2ldO1xuICAgICAgcmVpZmllZFtpXSA9IHRoaXMuZ2V0VmFsdWUobik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlaWZpZWQ7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIENvbnN0YW50c0ltcGxcbiAgZXh0ZW5kcyBDb21waWxlVGltZUNvbnN0YW50SW1wbFxuICBpbXBsZW1lbnRzIFJ1bnRpbWVDb25zdGFudHMsIFJlc29sdXRpb25UaW1lQ29uc3RhbnRzIHtcbiAgcHJvdGVjdGVkIHJlaWZpZWRBcnJzOiB7IFtrZXk6IG51bWJlcl06IHVua25vd25bXSB9ID0ge1xuICAgIFtXRUxMX0tOT1dOX0VNUFRZX0FSUkFZX1BPU0lUSU9OXTogV0VMTF9LTk9XTl9FTVBUWV9BUlJBWSBhcyB1bmtub3duW10sXG4gIH07XG5cbiAgZGVmYXVsdFRlbXBsYXRlOiBUZW1wbGF0ZSA9IHRlbXBsYXRlRmFjdG9yeShERUZBVUxUX1RFTVBMQVRFKSgpO1xuXG4gIC8vIFVzZWQgZm9yIHRlc3RzIGFuZCBkZWJ1Z2dpbmcgcHVycG9zZXMsIGFuZCB0byBiZSBhYmxlIHRvIGFuYWx5emUgbGFyZ2UgYXBwc1xuICAvLyBUaGlzIGlzIHdoeSBpdCdzIGVuYWJsZWQgZXZlbiBpbiBwcm9kdWN0aW9uXG4gIGhlbHBlckRlZmluaXRpb25Db3VudCA9IDA7XG4gIG1vZGlmaWVyRGVmaW5pdGlvbkNvdW50ID0gMDtcbiAgY29tcG9uZW50RGVmaW5pdGlvbkNvdW50ID0gMDtcblxuICBwcml2YXRlIGhlbHBlckRlZmluaXRpb25DYWNoZSA9IG5ldyBXZWFrTWFwPEhlbHBlckRlZmluaXRpb25TdGF0ZSwgbnVtYmVyIHwgbnVsbD4oKTtcblxuICBwcml2YXRlIG1vZGlmaWVyRGVmaW5pdGlvbkNhY2hlID0gbmV3IFdlYWtNYXA8TW9kaWZpZXJEZWZpbml0aW9uU3RhdGUsIG51bWJlciB8IG51bGw+KCk7XG5cbiAgcHJpdmF0ZSBjb21wb25lbnREZWZpbml0aW9uQ2FjaGUgPSBuZXcgV2Vha01hcDxcbiAgICBDb21wb25lbnREZWZpbml0aW9uU3RhdGUgfCBSZXNvbHZlZENvbXBvbmVudERlZmluaXRpb24sXG4gICAgQ29tcG9uZW50RGVmaW5pdGlvbiB8IG51bGxcbiAgPigpO1xuXG4gIGhlbHBlcihcbiAgICBkZWZpbml0aW9uU3RhdGU6IEhlbHBlckRlZmluaXRpb25TdGF0ZSxcblxuICAgIC8vIFRPRE86IEFkZCBhIHdheSB0byBleHBvc2UgcmVzb2x2ZWQgbmFtZSBmb3IgZGVidWdnaW5nXG4gICAgX3Jlc29sdmVkTmFtZTogc3RyaW5nIHwgbnVsbCxcbiAgICBpc09wdGlvbmFsOiB0cnVlXG4gICk6IG51bWJlciB8IG51bGw7XG4gIGhlbHBlcihcbiAgICBkZWZpbml0aW9uU3RhdGU6IEhlbHBlckRlZmluaXRpb25TdGF0ZSxcblxuICAgIC8vIFRPRE86IEFkZCBhIHdheSB0byBleHBvc2UgcmVzb2x2ZWQgbmFtZSBmb3IgZGVidWdnaW5nXG4gICAgX3Jlc29sdmVkTmFtZT86IHN0cmluZyB8IG51bGxcbiAgKTogbnVtYmVyO1xuICBoZWxwZXIoXG4gICAgZGVmaW5pdGlvblN0YXRlOiBIZWxwZXJEZWZpbml0aW9uU3RhdGUsXG5cbiAgICAvLyBUT0RPOiBBZGQgYSB3YXkgdG8gZXhwb3NlIHJlc29sdmVkIG5hbWUgZm9yIGRlYnVnZ2luZ1xuICAgIF9yZXNvbHZlZE5hbWU6IHN0cmluZyB8IG51bGwgPSBudWxsLFxuICAgIGlzT3B0aW9uYWw/OiB0cnVlXG4gICk6IG51bWJlciB8IG51bGwge1xuICAgIGxldCBoYW5kbGUgPSB0aGlzLmhlbHBlckRlZmluaXRpb25DYWNoZS5nZXQoZGVmaW5pdGlvblN0YXRlKTtcblxuICAgIGlmIChoYW5kbGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgbGV0IG1hbmFnZXJPckhlbHBlciA9IGdldEludGVybmFsSGVscGVyTWFuYWdlcihkZWZpbml0aW9uU3RhdGUsIGlzT3B0aW9uYWwpO1xuXG4gICAgICBpZiAobWFuYWdlck9ySGVscGVyID09PSBudWxsKSB7XG4gICAgICAgIHRoaXMuaGVscGVyRGVmaW5pdGlvbkNhY2hlLnNldChkZWZpbml0aW9uU3RhdGUsIG51bGwpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgYXNzZXJ0KG1hbmFnZXJPckhlbHBlciwgJ0JVRzogZXhwZWN0ZWQgbWFuYWdlciBvciBoZWxwZXInKTtcblxuICAgICAgbGV0IGhlbHBlciA9XG4gICAgICAgIHR5cGVvZiBtYW5hZ2VyT3JIZWxwZXIgPT09ICdmdW5jdGlvbidcbiAgICAgICAgICA/IG1hbmFnZXJPckhlbHBlclxuICAgICAgICAgIDogbWFuYWdlck9ySGVscGVyLmdldEhlbHBlcihkZWZpbml0aW9uU3RhdGUpO1xuXG4gICAgICBoYW5kbGUgPSB0aGlzLnZhbHVlKGhlbHBlcik7XG5cbiAgICAgIHRoaXMuaGVscGVyRGVmaW5pdGlvbkNhY2hlLnNldChkZWZpbml0aW9uU3RhdGUsIGhhbmRsZSk7XG4gICAgICB0aGlzLmhlbHBlckRlZmluaXRpb25Db3VudCsrO1xuICAgIH1cblxuICAgIHJldHVybiBoYW5kbGU7XG4gIH1cblxuICBtb2RpZmllcihcbiAgICBkZWZpbml0aW9uU3RhdGU6IE1vZGlmaWVyRGVmaW5pdGlvblN0YXRlLFxuICAgIHJlc29sdmVkTmFtZTogc3RyaW5nIHwgbnVsbCxcbiAgICBpc09wdGlvbmFsOiB0cnVlXG4gICk6IG51bWJlciB8IG51bGw7XG4gIG1vZGlmaWVyKGRlZmluaXRpb25TdGF0ZTogTW9kaWZpZXJEZWZpbml0aW9uU3RhdGUsIHJlc29sdmVkTmFtZT86IHN0cmluZyB8IG51bGwpOiBudW1iZXI7XG4gIG1vZGlmaWVyKFxuICAgIGRlZmluaXRpb25TdGF0ZTogTW9kaWZpZXJEZWZpbml0aW9uU3RhdGUsXG4gICAgcmVzb2x2ZWROYW1lOiBzdHJpbmcgfCBudWxsID0gbnVsbCxcbiAgICBpc09wdGlvbmFsPzogdHJ1ZVxuICApOiBudW1iZXIgfCBudWxsIHtcbiAgICBsZXQgaGFuZGxlID0gdGhpcy5tb2RpZmllckRlZmluaXRpb25DYWNoZS5nZXQoZGVmaW5pdGlvblN0YXRlKTtcblxuICAgIGlmIChoYW5kbGUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgbGV0IG1hbmFnZXIgPSBnZXRJbnRlcm5hbE1vZGlmaWVyTWFuYWdlcihkZWZpbml0aW9uU3RhdGUsIGlzT3B0aW9uYWwpO1xuXG4gICAgICBpZiAobWFuYWdlciA9PT0gbnVsbCkge1xuICAgICAgICB0aGlzLm1vZGlmaWVyRGVmaW5pdGlvbkNhY2hlLnNldChkZWZpbml0aW9uU3RhdGUsIG51bGwpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgbGV0IGRlZmluaXRpb24gPSB7XG4gICAgICAgIHJlc29sdmVkTmFtZSxcbiAgICAgICAgbWFuYWdlcixcbiAgICAgICAgc3RhdGU6IGRlZmluaXRpb25TdGF0ZSxcbiAgICAgIH07XG5cbiAgICAgIGhhbmRsZSA9IHRoaXMudmFsdWUoZGVmaW5pdGlvbik7XG5cbiAgICAgIHRoaXMubW9kaWZpZXJEZWZpbml0aW9uQ2FjaGUuc2V0KGRlZmluaXRpb25TdGF0ZSwgaGFuZGxlKTtcbiAgICAgIHRoaXMubW9kaWZpZXJEZWZpbml0aW9uQ291bnQrKztcbiAgICB9XG5cbiAgICByZXR1cm4gaGFuZGxlO1xuICB9XG5cbiAgY29tcG9uZW50KGRlZmluaXRpb25TdGF0ZTogQ29tcG9uZW50RGVmaW5pdGlvblN0YXRlLCBvd25lcjogb2JqZWN0KTogQ29tcG9uZW50RGVmaW5pdGlvbjtcbiAgY29tcG9uZW50KFxuICAgIGRlZmluaXRpb25TdGF0ZTogQ29tcG9uZW50RGVmaW5pdGlvblN0YXRlLFxuICAgIG93bmVyOiBvYmplY3QsXG4gICAgaXNPcHRpb25hbD86IHRydWVcbiAgKTogQ29tcG9uZW50RGVmaW5pdGlvbiB8IG51bGwge1xuICAgIGxldCBkZWZpbml0aW9uID0gdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ2FjaGUuZ2V0KGRlZmluaXRpb25TdGF0ZSk7XG5cbiAgICBpZiAoZGVmaW5pdGlvbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBsZXQgbWFuYWdlciA9IGdldEludGVybmFsQ29tcG9uZW50TWFuYWdlcihkZWZpbml0aW9uU3RhdGUsIGlzT3B0aW9uYWwpO1xuXG4gICAgICBpZiAobWFuYWdlciA9PT0gbnVsbCkge1xuICAgICAgICB0aGlzLmNvbXBvbmVudERlZmluaXRpb25DYWNoZS5zZXQoZGVmaW5pdGlvblN0YXRlLCBudWxsKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGFzc2VydChtYW5hZ2VyLCAnQlVHOiBleHBlY3RlZCBtYW5hZ2VyJyk7XG5cbiAgICAgIGxldCBjYXBhYmlsaXRpZXMgPSBjYXBhYmlsaXR5RmxhZ3NGcm9tKG1hbmFnZXIuZ2V0Q2FwYWJpbGl0aWVzKGRlZmluaXRpb25TdGF0ZSkpO1xuXG4gICAgICBsZXQgdGVtcGxhdGVGYWN0b3J5ID0gZ2V0Q29tcG9uZW50VGVtcGxhdGUoZGVmaW5pdGlvblN0YXRlKTtcblxuICAgICAgbGV0IGNvbXBpbGFibGUgPSBudWxsO1xuICAgICAgbGV0IHRlbXBsYXRlO1xuXG4gICAgICBpZiAoIW1hbmFnZXJIYXNDYXBhYmlsaXR5KG1hbmFnZXIsIGNhcGFiaWxpdGllcywgSW50ZXJuYWxDb21wb25lbnRDYXBhYmlsaXR5LkR5bmFtaWNMYXlvdXQpKSB7XG4gICAgICAgIHRlbXBsYXRlID0gdGVtcGxhdGVGYWN0b3J5Py4ob3duZXIpID8/IHRoaXMuZGVmYXVsdFRlbXBsYXRlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZUZhY3Rvcnk/Lihvd25lcik7XG4gICAgICB9XG5cbiAgICAgIGlmICh0ZW1wbGF0ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRlbXBsYXRlID0gdW53cmFwVGVtcGxhdGUodGVtcGxhdGUpO1xuXG4gICAgICAgIGNvbXBpbGFibGUgPSBtYW5hZ2VySGFzQ2FwYWJpbGl0eShcbiAgICAgICAgICBtYW5hZ2VyLFxuICAgICAgICAgIGNhcGFiaWxpdGllcyxcbiAgICAgICAgICBJbnRlcm5hbENvbXBvbmVudENhcGFiaWxpdHkuV3JhcHBlZFxuICAgICAgICApXG4gICAgICAgICAgPyB0ZW1wbGF0ZS5hc1dyYXBwZWRMYXlvdXQoKVxuICAgICAgICAgIDogdGVtcGxhdGUuYXNMYXlvdXQoKTtcbiAgICAgIH1cblxuICAgICAgZGVmaW5pdGlvbiA9IHtcbiAgICAgICAgcmVzb2x2ZWROYW1lOiBudWxsLFxuICAgICAgICBoYW5kbGU6IC0xLCAvLyByZXBsYWNlZCBtb21lbnRhcmlseVxuICAgICAgICBtYW5hZ2VyLFxuICAgICAgICBjYXBhYmlsaXRpZXMsXG4gICAgICAgIHN0YXRlOiBkZWZpbml0aW9uU3RhdGUsXG4gICAgICAgIGNvbXBpbGFibGUsXG4gICAgICB9O1xuXG4gICAgICBkZWZpbml0aW9uIS5oYW5kbGUgPSB0aGlzLnZhbHVlKGRlZmluaXRpb24pO1xuICAgICAgdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ2FjaGUuc2V0KGRlZmluaXRpb25TdGF0ZSwgZGVmaW5pdGlvbik7XG4gICAgICB0aGlzLmNvbXBvbmVudERlZmluaXRpb25Db3VudCsrO1xuICAgIH1cblxuICAgIHJldHVybiBkZWZpbml0aW9uO1xuICB9XG5cbiAgcmVzb2x2ZWRDb21wb25lbnQoXG4gICAgcmVzb2x2ZWREZWZpbml0aW9uOiBSZXNvbHZlZENvbXBvbmVudERlZmluaXRpb24sXG4gICAgcmVzb2x2ZWROYW1lOiBzdHJpbmdcbiAgKTogQ29tcG9uZW50RGVmaW5pdGlvbiB7XG4gICAgbGV0IGRlZmluaXRpb24gPSB0aGlzLmNvbXBvbmVudERlZmluaXRpb25DYWNoZS5nZXQocmVzb2x2ZWREZWZpbml0aW9uKTtcblxuICAgIGlmIChkZWZpbml0aW9uID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGxldCB7IG1hbmFnZXIsIHN0YXRlLCB0ZW1wbGF0ZSB9ID0gcmVzb2x2ZWREZWZpbml0aW9uO1xuICAgICAgbGV0IGNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdHlGbGFnc0Zyb20obWFuYWdlci5nZXRDYXBhYmlsaXRpZXMocmVzb2x2ZWREZWZpbml0aW9uKSk7XG5cbiAgICAgIGxldCBjb21waWxhYmxlID0gbnVsbDtcblxuICAgICAgaWYgKCFtYW5hZ2VySGFzQ2FwYWJpbGl0eShtYW5hZ2VyLCBjYXBhYmlsaXRpZXMsIEludGVybmFsQ29tcG9uZW50Q2FwYWJpbGl0eS5EeW5hbWljTGF5b3V0KSkge1xuICAgICAgICB0ZW1wbGF0ZSA9IHRlbXBsYXRlID8/IHRoaXMuZGVmYXVsdFRlbXBsYXRlO1xuICAgICAgfVxuXG4gICAgICBpZiAodGVtcGxhdGUgIT09IG51bGwpIHtcbiAgICAgICAgdGVtcGxhdGUgPSB1bndyYXBUZW1wbGF0ZSh0ZW1wbGF0ZSk7XG5cbiAgICAgICAgY29tcGlsYWJsZSA9IG1hbmFnZXJIYXNDYXBhYmlsaXR5KFxuICAgICAgICAgIG1hbmFnZXIsXG4gICAgICAgICAgY2FwYWJpbGl0aWVzLFxuICAgICAgICAgIEludGVybmFsQ29tcG9uZW50Q2FwYWJpbGl0eS5XcmFwcGVkXG4gICAgICAgIClcbiAgICAgICAgICA/IHRlbXBsYXRlLmFzV3JhcHBlZExheW91dCgpXG4gICAgICAgICAgOiB0ZW1wbGF0ZS5hc0xheW91dCgpO1xuICAgICAgfVxuXG4gICAgICBkZWZpbml0aW9uID0ge1xuICAgICAgICByZXNvbHZlZE5hbWUsXG4gICAgICAgIGhhbmRsZTogLTEsIC8vIHJlcGxhY2VkIG1vbWVudGFyaWx5XG4gICAgICAgIG1hbmFnZXIsXG4gICAgICAgIGNhcGFiaWxpdGllcyxcbiAgICAgICAgc3RhdGUsXG4gICAgICAgIGNvbXBpbGFibGUsXG4gICAgICB9O1xuXG4gICAgICBkZWZpbml0aW9uIS5oYW5kbGUgPSB0aGlzLnZhbHVlKGRlZmluaXRpb24pO1xuICAgICAgdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ2FjaGUuc2V0KHJlc29sdmVkRGVmaW5pdGlvbiwgZGVmaW5pdGlvbik7XG4gICAgICB0aGlzLmNvbXBvbmVudERlZmluaXRpb25Db3VudCsrO1xuICAgIH1cblxuICAgIHJldHVybiBleHBlY3QoZGVmaW5pdGlvbiwgJ0JVRzogcmVzb2x2ZWQgY29tcG9uZW50IGRlZmluaXRpb25zIGNhbm5vdCBiZSBudWxsJyk7XG4gIH1cblxuICBnZXRWYWx1ZTxUPihpbmRleDogbnVtYmVyKSB7XG4gICAgYXNzZXJ0KGluZGV4ID49IDAsIGBjYW5ub3QgZ2V0IHZhbHVlIGZvciBoYW5kbGU6ICR7aW5kZXh9YCk7XG5cbiAgICByZXR1cm4gdGhpcy52YWx1ZXNbaW5kZXhdIGFzIFQ7XG4gIH1cblxuICBnZXRBcnJheTxUPihpbmRleDogbnVtYmVyKTogVFtdIHtcbiAgICBsZXQgcmVpZmllZEFycnMgPSB0aGlzLnJlaWZpZWRBcnJzO1xuICAgIGxldCByZWlmaWVkID0gcmVpZmllZEFycnNbaW5kZXhdIGFzIFRbXTtcblxuICAgIGlmIChyZWlmaWVkID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGxldCBuYW1lczogbnVtYmVyW10gPSB0aGlzLmdldFZhbHVlKGluZGV4KTtcbiAgICAgIHJlaWZpZWQgPSBuZXcgQXJyYXkobmFtZXMubGVuZ3RoKTtcblxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuYW1lcy5sZW5ndGg7IGkrKykge1xuICAgICAgICByZWlmaWVkW2ldID0gdGhpcy5nZXRWYWx1ZShuYW1lc1tpXSk7XG4gICAgICB9XG5cbiAgICAgIHJlaWZpZWRBcnJzW2luZGV4XSA9IHJlaWZpZWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlaWZpZWQ7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=