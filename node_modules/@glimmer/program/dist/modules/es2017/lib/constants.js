import { assert, constants, unwrapTemplate } from '@glimmer/util';
import { capabilityFlagsFrom, getComponentTemplate, getInternalComponentManager, getInternalHelperManager, getInternalModifierManager, managerHasCapability } from '@glimmer/manager';
import { templateFactory } from '@glimmer/opcode-compiler';
import { DEFAULT_TEMPLATE } from './util/default-template';
const WELL_KNOWN_EMPTY_ARRAY = Object.freeze([]);
const STARTER_CONSTANTS = constants(WELL_KNOWN_EMPTY_ARRAY);
const WELL_KNOWN_EMPTY_ARRAY_POSITION = STARTER_CONSTANTS.indexOf(WELL_KNOWN_EMPTY_ARRAY);
export class CompileTimeConstantImpl {
  constructor() {
    // `0` means NULL
    this.values = STARTER_CONSTANTS.slice();
    this.indexMap = new Map(this.values.map((value, index) => [value, index]));
  }

  value(value) {
    let indexMap = this.indexMap;
    let index = indexMap.get(value);

    if (index === undefined) {
      index = this.values.push(value) - 1;
      indexMap.set(value, index);
    }

    return index;
  }

  array(values) {
    if (values.length === 0) {
      return WELL_KNOWN_EMPTY_ARRAY_POSITION;
    }

    let handles = new Array(values.length);

    for (let i = 0; i < values.length; i++) {
      handles[i] = this.value(values[i]);
    }

    return this.value(handles);
  }

  toPool() {
    return this.values;
  }

}
export class RuntimeConstantsImpl {
  constructor(pool) {
    this.values = pool;
  }

  getValue(handle) {
    return this.values[handle];
  }

  getArray(value) {
    let handles = this.getValue(value);
    let reified = new Array(handles.length);

    for (let i = 0; i < handles.length; i++) {
      let n = handles[i];
      reified[i] = this.getValue(n);
    }

    return reified;
  }

}
export class ConstantsImpl extends CompileTimeConstantImpl {
  constructor() {
    super(...arguments);
    this.reifiedArrs = {
      [WELL_KNOWN_EMPTY_ARRAY_POSITION]: WELL_KNOWN_EMPTY_ARRAY
    };
    this.defaultTemplate = templateFactory(DEFAULT_TEMPLATE)(); // Used for tests and debugging purposes, and to be able to analyze large apps
    // This is why it's enabled even in production

    this.helperDefinitionCount = 0;
    this.modifierDefinitionCount = 0;
    this.componentDefinitionCount = 0;
    this.helperDefinitionCache = new WeakMap();
    this.modifierDefinitionCache = new WeakMap();
    this.componentDefinitionCache = new WeakMap();
  }

  helper(definitionState, // TODO: Add a way to expose resolved name for debugging
  _resolvedName = null, isOptional) {
    let handle = this.helperDefinitionCache.get(definitionState);

    if (handle === undefined) {
      let managerOrHelper = getInternalHelperManager(definitionState, isOptional);

      if (managerOrHelper === null) {
        this.helperDefinitionCache.set(definitionState, null);
        return null;
      }

      (false && assert(managerOrHelper, 'BUG: expected manager or helper'));
      let helper = typeof managerOrHelper === 'function' ? managerOrHelper : managerOrHelper.getHelper(definitionState);
      handle = this.value(helper);
      this.helperDefinitionCache.set(definitionState, handle);
      this.helperDefinitionCount++;
    }

    return handle;
  }

  modifier(definitionState, resolvedName = null, isOptional) {
    let handle = this.modifierDefinitionCache.get(definitionState);

    if (handle === undefined) {
      let manager = getInternalModifierManager(definitionState, isOptional);

      if (manager === null) {
        this.modifierDefinitionCache.set(definitionState, null);
        return null;
      }

      let definition = {
        resolvedName,
        manager,
        state: definitionState
      };
      handle = this.value(definition);
      this.modifierDefinitionCache.set(definitionState, handle);
      this.modifierDefinitionCount++;
    }

    return handle;
  }

  component(definitionState, owner, isOptional) {
    var _a;

    let definition = this.componentDefinitionCache.get(definitionState);

    if (definition === undefined) {
      let manager = getInternalComponentManager(definitionState, isOptional);

      if (manager === null) {
        this.componentDefinitionCache.set(definitionState, null);
        return null;
      }

      (false && assert(manager, 'BUG: expected manager'));
      let capabilities = capabilityFlagsFrom(manager.getCapabilities(definitionState));
      let templateFactory = getComponentTemplate(definitionState);
      let compilable = null;
      let template;

      if (!managerHasCapability(manager, capabilities, 1
      /* DynamicLayout */
      )) {
        template = (_a = templateFactory === null || templateFactory === void 0 ? void 0 : templateFactory(owner)) !== null && _a !== void 0 ? _a : this.defaultTemplate;
      } else {
        template = templateFactory === null || templateFactory === void 0 ? void 0 : templateFactory(owner);
      }

      if (template !== undefined) {
        template = unwrapTemplate(template);
        compilable = managerHasCapability(manager, capabilities, 1024
        /* Wrapped */
        ) ? template.asWrappedLayout() : template.asLayout();
      }

      definition = {
        resolvedName: null,
        handle: -1,
        manager,
        capabilities,
        state: definitionState,
        compilable
      };
      definition.handle = this.value(definition);
      this.componentDefinitionCache.set(definitionState, definition);
      this.componentDefinitionCount++;
    }

    return definition;
  }

  resolvedComponent(resolvedDefinition, resolvedName) {
    let definition = this.componentDefinitionCache.get(resolvedDefinition);

    if (definition === undefined) {
      let {
        manager,
        state,
        template
      } = resolvedDefinition;
      let capabilities = capabilityFlagsFrom(manager.getCapabilities(resolvedDefinition));
      let compilable = null;

      if (!managerHasCapability(manager, capabilities, 1
      /* DynamicLayout */
      )) {
        template = template !== null && template !== void 0 ? template : this.defaultTemplate;
      }

      if (template !== null) {
        template = unwrapTemplate(template);
        compilable = managerHasCapability(manager, capabilities, 1024
        /* Wrapped */
        ) ? template.asWrappedLayout() : template.asLayout();
      }

      definition = {
        resolvedName,
        handle: -1,
        manager,
        capabilities,
        state,
        compilable
      };
      definition.handle = this.value(definition);
      this.componentDefinitionCache.set(resolvedDefinition, definition);
      this.componentDefinitionCount++;
    }

    return definition;
  }

  getValue(index) {
    (false && assert(index >= 0, `cannot get value for handle: ${index}`));
    return this.values[index];
  }

  getArray(index) {
    let reifiedArrs = this.reifiedArrs;
    let reified = reifiedArrs[index];

    if (reified === undefined) {
      let names = this.getValue(index);
      reified = new Array(names.length);

      for (let i = 0; i < names.length; i++) {
        reified[i] = this.getValue(names[i]);
      }

      reifiedArrs[index] = reified;
    }

    return reified;
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3Byb2dyYW0vbGliL2NvbnN0YW50cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFhQSxTQUFTLE1BQVQsRUFBaUIsU0FBakIsRUFBb0MsY0FBcEMsUUFBMEQsZUFBMUQ7QUFDQSxTQUNFLG1CQURGLEVBRUUsb0JBRkYsRUFHRSwyQkFIRixFQUlFLHdCQUpGLEVBS0UsMEJBTEYsRUFNRSxvQkFORixRQU9PLGtCQVBQO0FBUUEsU0FBUyxlQUFULFFBQWdDLDBCQUFoQztBQUNBLFNBQVMsZ0JBQVQsUUFBaUMseUJBQWpDO0FBRUEsTUFBTSxzQkFBc0IsR0FBWSxNQUFNLENBQUMsTUFBUCxDQUFjLEVBQWQsQ0FBeEM7QUFDQSxNQUFNLGlCQUFpQixHQUFHLFNBQVMsQ0FBQyxzQkFBRCxDQUFuQztBQUNBLE1BQU0sK0JBQStCLEdBQVcsaUJBQWlCLENBQUMsT0FBbEIsQ0FBMEIsc0JBQTFCLENBQWhEO0FBRUEsT0FBTSxNQUFPLHVCQUFQLENBQThCO0FBQXBDLEVBQUEsV0FBQSxHQUFBO0FBQ0U7QUFFVSxTQUFBLE1BQUEsR0FBb0IsaUJBQWlCLENBQUMsS0FBbEIsRUFBcEI7QUFDQSxTQUFBLFFBQUEsR0FBaUMsSUFBSSxHQUFKLENBQ3pDLEtBQUssTUFBTCxDQUFZLEdBQVosQ0FBZ0IsQ0FBQyxLQUFELEVBQVEsS0FBUixLQUFrQixDQUFDLEtBQUQsRUFBUSxLQUFSLENBQWxDLENBRHlDLENBQWpDO0FBaUNYOztBQTdCQyxFQUFBLEtBQUssQ0FBQyxLQUFELEVBQWU7QUFDbEIsUUFBSSxRQUFRLEdBQUcsS0FBSyxRQUFwQjtBQUNBLFFBQUksS0FBSyxHQUFHLFFBQVEsQ0FBQyxHQUFULENBQWEsS0FBYixDQUFaOztBQUVBLFFBQUksS0FBSyxLQUFLLFNBQWQsRUFBeUI7QUFDdkIsTUFBQSxLQUFLLEdBQUcsS0FBSyxNQUFMLENBQVksSUFBWixDQUFpQixLQUFqQixJQUEwQixDQUFsQztBQUNBLE1B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TCxDQUFjLEtBQUssQ0FBQyxDQUFELENBQW5CLENBQWI7QUFDRDs7QUFFRCxNQUFBLFdBQVcsQ0FBQyxLQUFELENBQVgsR0FBcUIsT0FBckI7QUFDRDs7QUFFRCxXQUFPLE9BQVA7QUFDRDs7QUF4TzhCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcGlsZVRpbWVDb25zdGFudHMsXG4gIENvbXBvbmVudERlZmluaXRpb25TdGF0ZSxcbiAgQ29uc3RhbnRQb29sLFxuICBJbnRlcm5hbENvbXBvbmVudENhcGFiaWxpdHksXG4gIENvbXBvbmVudERlZmluaXRpb24sXG4gIFJlc29sdXRpb25UaW1lQ29uc3RhbnRzLFxuICBSZXNvbHZlZENvbXBvbmVudERlZmluaXRpb24sXG4gIFJ1bnRpbWVDb25zdGFudHMsXG4gIE1vZGlmaWVyRGVmaW5pdGlvblN0YXRlLFxuICBIZWxwZXJEZWZpbml0aW9uU3RhdGUsXG4gIFRlbXBsYXRlLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGFzc2VydCwgY29uc3RhbnRzLCBleHBlY3QsIHVud3JhcFRlbXBsYXRlIH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQge1xuICBjYXBhYmlsaXR5RmxhZ3NGcm9tLFxuICBnZXRDb21wb25lbnRUZW1wbGF0ZSxcbiAgZ2V0SW50ZXJuYWxDb21wb25lbnRNYW5hZ2VyLFxuICBnZXRJbnRlcm5hbEhlbHBlck1hbmFnZXIsXG4gIGdldEludGVybmFsTW9kaWZpZXJNYW5hZ2VyLFxuICBtYW5hZ2VySGFzQ2FwYWJpbGl0eSxcbn0gZnJvbSAnQGdsaW1tZXIvbWFuYWdlcic7XG5pbXBvcnQgeyB0ZW1wbGF0ZUZhY3RvcnkgfSBmcm9tICdAZ2xpbW1lci9vcGNvZGUtY29tcGlsZXInO1xuaW1wb3J0IHsgREVGQVVMVF9URU1QTEFURSB9IGZyb20gJy4vdXRpbC9kZWZhdWx0LXRlbXBsYXRlJztcblxuY29uc3QgV0VMTF9LTk9XTl9FTVBUWV9BUlJBWTogdW5rbm93biA9IE9iamVjdC5mcmVlemUoW10pO1xuY29uc3QgU1RBUlRFUl9DT05TVEFOVFMgPSBjb25zdGFudHMoV0VMTF9LTk9XTl9FTVBUWV9BUlJBWSk7XG5jb25zdCBXRUxMX0tOT1dOX0VNUFRZX0FSUkFZX1BPU0lUSU9OOiBudW1iZXIgPSBTVEFSVEVSX0NPTlNUQU5UUy5pbmRleE9mKFdFTExfS05PV05fRU1QVFlfQVJSQVkpO1xuXG5leHBvcnQgY2xhc3MgQ29tcGlsZVRpbWVDb25zdGFudEltcGwgaW1wbGVtZW50cyBDb21waWxlVGltZUNvbnN0YW50cyB7XG4gIC8vIGAwYCBtZWFucyBOVUxMXG5cbiAgcHJvdGVjdGVkIHZhbHVlczogdW5rbm93bltdID0gU1RBUlRFUl9DT05TVEFOVFMuc2xpY2UoKTtcbiAgcHJvdGVjdGVkIGluZGV4TWFwOiBNYXA8dW5rbm93biwgbnVtYmVyPiA9IG5ldyBNYXAoXG4gICAgdGhpcy52YWx1ZXMubWFwKCh2YWx1ZSwgaW5kZXgpID0+IFt2YWx1ZSwgaW5kZXhdKVxuICApO1xuXG4gIHZhbHVlKHZhbHVlOiB1bmtub3duKSB7XG4gICAgbGV0IGluZGV4TWFwID0gdGhpcy5pbmRleE1hcDtcbiAgICBsZXQgaW5kZXggPSBpbmRleE1hcC5nZXQodmFsdWUpO1xuXG4gICAgaWYgKGluZGV4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGluZGV4ID0gdGhpcy52YWx1ZXMucHVzaCh2YWx1ZSkgLSAxO1xuICAgICAgaW5kZXhNYXAuc2V0KHZhbHVlLCBpbmRleCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGluZGV4O1xuICB9XG5cbiAgYXJyYXkodmFsdWVzOiB1bmtub3duW10pOiBudW1iZXIge1xuICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gV0VMTF9LTk9XTl9FTVBUWV9BUlJBWV9QT1NJVElPTjtcbiAgICB9XG5cbiAgICBsZXQgaGFuZGxlczogbnVtYmVyW10gPSBuZXcgQXJyYXkodmFsdWVzLmxlbmd0aCk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykge1xuICAgICAgaGFuZGxlc1tpXSA9IHRoaXMudmFsdWUodmFsdWVzW2ldKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy52YWx1ZShoYW5kbGVzKTtcbiAgfVxuXG4gIHRvUG9vbCgpOiBDb25zdGFudFBvb2wge1xuICAgIHJldHVybiB0aGlzLnZhbHVlcztcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUnVudGltZUNvbnN0YW50c0ltcGwgaW1wbGVtZW50cyBSdW50aW1lQ29uc3RhbnRzIHtcbiAgcHJvdGVjdGVkIHZhbHVlczogdW5rbm93bltdO1xuXG4gIGNvbnN0cnVjdG9yKHBvb2w6IENvbnN0YW50UG9vbCkge1xuICAgIHRoaXMudmFsdWVzID0gcG9vbDtcbiAgfVxuXG4gIGdldFZhbHVlPFQ+KGhhbmRsZTogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMudmFsdWVzW2hhbmRsZV0gYXMgVDtcbiAgfVxuXG4gIGdldEFycmF5PFQ+KHZhbHVlOiBudW1iZXIpOiBUW10ge1xuICAgIGxldCBoYW5kbGVzID0gdGhpcy5nZXRWYWx1ZSh2YWx1ZSkgYXMgbnVtYmVyW107XG4gICAgbGV0IHJlaWZpZWQ6IFRbXSA9IG5ldyBBcnJheShoYW5kbGVzLmxlbmd0aCk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhhbmRsZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBuID0gaGFuZGxlc1tpXTtcbiAgICAgIHJlaWZpZWRbaV0gPSB0aGlzLmdldFZhbHVlKG4pO1xuICAgIH1cblxuICAgIHJldHVybiByZWlmaWVkO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDb25zdGFudHNJbXBsXG4gIGV4dGVuZHMgQ29tcGlsZVRpbWVDb25zdGFudEltcGxcbiAgaW1wbGVtZW50cyBSdW50aW1lQ29uc3RhbnRzLCBSZXNvbHV0aW9uVGltZUNvbnN0YW50cyB7XG4gIHByb3RlY3RlZCByZWlmaWVkQXJyczogeyBba2V5OiBudW1iZXJdOiB1bmtub3duW10gfSA9IHtcbiAgICBbV0VMTF9LTk9XTl9FTVBUWV9BUlJBWV9QT1NJVElPTl06IFdFTExfS05PV05fRU1QVFlfQVJSQVkgYXMgdW5rbm93bltdLFxuICB9O1xuXG4gIGRlZmF1bHRUZW1wbGF0ZTogVGVtcGxhdGUgPSB0ZW1wbGF0ZUZhY3RvcnkoREVGQVVMVF9URU1QTEFURSkoKTtcblxuICAvLyBVc2VkIGZvciB0ZXN0cyBhbmQgZGVidWdnaW5nIHB1cnBvc2VzLCBhbmQgdG8gYmUgYWJsZSB0byBhbmFseXplIGxhcmdlIGFwcHNcbiAgLy8gVGhpcyBpcyB3aHkgaXQncyBlbmFibGVkIGV2ZW4gaW4gcHJvZHVjdGlvblxuICBoZWxwZXJEZWZpbml0aW9uQ291bnQgPSAwO1xuICBtb2RpZmllckRlZmluaXRpb25Db3VudCA9IDA7XG4gIGNvbXBvbmVudERlZmluaXRpb25Db3VudCA9IDA7XG5cbiAgcHJpdmF0ZSBoZWxwZXJEZWZpbml0aW9uQ2FjaGUgPSBuZXcgV2Vha01hcDxIZWxwZXJEZWZpbml0aW9uU3RhdGUsIG51bWJlciB8IG51bGw+KCk7XG5cbiAgcHJpdmF0ZSBtb2RpZmllckRlZmluaXRpb25DYWNoZSA9IG5ldyBXZWFrTWFwPE1vZGlmaWVyRGVmaW5pdGlvblN0YXRlLCBudW1iZXIgfCBudWxsPigpO1xuXG4gIHByaXZhdGUgY29tcG9uZW50RGVmaW5pdGlvbkNhY2hlID0gbmV3IFdlYWtNYXA8XG4gICAgQ29tcG9uZW50RGVmaW5pdGlvblN0YXRlIHwgUmVzb2x2ZWRDb21wb25lbnREZWZpbml0aW9uLFxuICAgIENvbXBvbmVudERlZmluaXRpb24gfCBudWxsXG4gID4oKTtcblxuICBoZWxwZXIoXG4gICAgZGVmaW5pdGlvblN0YXRlOiBIZWxwZXJEZWZpbml0aW9uU3RhdGUsXG5cbiAgICAvLyBUT0RPOiBBZGQgYSB3YXkgdG8gZXhwb3NlIHJlc29sdmVkIG5hbWUgZm9yIGRlYnVnZ2luZ1xuICAgIF9yZXNvbHZlZE5hbWU6IHN0cmluZyB8IG51bGwsXG4gICAgaXNPcHRpb25hbDogdHJ1ZVxuICApOiBudW1iZXIgfCBudWxsO1xuICBoZWxwZXIoXG4gICAgZGVmaW5pdGlvblN0YXRlOiBIZWxwZXJEZWZpbml0aW9uU3RhdGUsXG5cbiAgICAvLyBUT0RPOiBBZGQgYSB3YXkgdG8gZXhwb3NlIHJlc29sdmVkIG5hbWUgZm9yIGRlYnVnZ2luZ1xuICAgIF9yZXNvbHZlZE5hbWU/OiBzdHJpbmcgfCBudWxsXG4gICk6IG51bWJlcjtcbiAgaGVscGVyKFxuICAgIGRlZmluaXRpb25TdGF0ZTogSGVscGVyRGVmaW5pdGlvblN0YXRlLFxuXG4gICAgLy8gVE9ETzogQWRkIGEgd2F5IHRvIGV4cG9zZSByZXNvbHZlZCBuYW1lIGZvciBkZWJ1Z2dpbmdcbiAgICBfcmVzb2x2ZWROYW1lOiBzdHJpbmcgfCBudWxsID0gbnVsbCxcbiAgICBpc09wdGlvbmFsPzogdHJ1ZVxuICApOiBudW1iZXIgfCBudWxsIHtcbiAgICBsZXQgaGFuZGxlID0gdGhpcy5oZWxwZXJEZWZpbml0aW9uQ2FjaGUuZ2V0KGRlZmluaXRpb25TdGF0ZSk7XG5cbiAgICBpZiAoaGFuZGxlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGxldCBtYW5hZ2VyT3JIZWxwZXIgPSBnZXRJbnRlcm5hbEhlbHBlck1hbmFnZXIoZGVmaW5pdGlvblN0YXRlLCBpc09wdGlvbmFsKTtcblxuICAgICAgaWYgKG1hbmFnZXJPckhlbHBlciA9PT0gbnVsbCkge1xuICAgICAgICB0aGlzLmhlbHBlckRlZmluaXRpb25DYWNoZS5zZXQoZGVmaW5pdGlvblN0YXRlLCBudWxsKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGFzc2VydChtYW5hZ2VyT3JIZWxwZXIsICdCVUc6IGV4cGVjdGVkIG1hbmFnZXIgb3IgaGVscGVyJyk7XG5cbiAgICAgIGxldCBoZWxwZXIgPVxuICAgICAgICB0eXBlb2YgbWFuYWdlck9ySGVscGVyID09PSAnZnVuY3Rpb24nXG4gICAgICAgICAgPyBtYW5hZ2VyT3JIZWxwZXJcbiAgICAgICAgICA6IG1hbmFnZXJPckhlbHBlci5nZXRIZWxwZXIoZGVmaW5pdGlvblN0YXRlKTtcblxuICAgICAgaGFuZGxlID0gdGhpcy52YWx1ZShoZWxwZXIpO1xuXG4gICAgICB0aGlzLmhlbHBlckRlZmluaXRpb25DYWNoZS5zZXQoZGVmaW5pdGlvblN0YXRlLCBoYW5kbGUpO1xuICAgICAgdGhpcy5oZWxwZXJEZWZpbml0aW9uQ291bnQrKztcbiAgICB9XG5cbiAgICByZXR1cm4gaGFuZGxlO1xuICB9XG5cbiAgbW9kaWZpZXIoXG4gICAgZGVmaW5pdGlvblN0YXRlOiBNb2RpZmllckRlZmluaXRpb25TdGF0ZSxcbiAgICByZXNvbHZlZE5hbWU6IHN0cmluZyB8IG51bGwsXG4gICAgaXNPcHRpb25hbDogdHJ1ZVxuICApOiBudW1iZXIgfCBudWxsO1xuICBtb2RpZmllcihkZWZpbml0aW9uU3RhdGU6IE1vZGlmaWVyRGVmaW5pdGlvblN0YXRlLCByZXNvbHZlZE5hbWU/OiBzdHJpbmcgfCBudWxsKTogbnVtYmVyO1xuICBtb2RpZmllcihcbiAgICBkZWZpbml0aW9uU3RhdGU6IE1vZGlmaWVyRGVmaW5pdGlvblN0YXRlLFxuICAgIHJlc29sdmVkTmFtZTogc3RyaW5nIHwgbnVsbCA9IG51bGwsXG4gICAgaXNPcHRpb25hbD86IHRydWVcbiAgKTogbnVtYmVyIHwgbnVsbCB7XG4gICAgbGV0IGhhbmRsZSA9IHRoaXMubW9kaWZpZXJEZWZpbml0aW9uQ2FjaGUuZ2V0KGRlZmluaXRpb25TdGF0ZSk7XG5cbiAgICBpZiAoaGFuZGxlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGxldCBtYW5hZ2VyID0gZ2V0SW50ZXJuYWxNb2RpZmllck1hbmFnZXIoZGVmaW5pdGlvblN0YXRlLCBpc09wdGlvbmFsKTtcblxuICAgICAgaWYgKG1hbmFnZXIgPT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5tb2RpZmllckRlZmluaXRpb25DYWNoZS5zZXQoZGVmaW5pdGlvblN0YXRlLCBudWxsKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGxldCBkZWZpbml0aW9uID0ge1xuICAgICAgICByZXNvbHZlZE5hbWUsXG4gICAgICAgIG1hbmFnZXIsXG4gICAgICAgIHN0YXRlOiBkZWZpbml0aW9uU3RhdGUsXG4gICAgICB9O1xuXG4gICAgICBoYW5kbGUgPSB0aGlzLnZhbHVlKGRlZmluaXRpb24pO1xuXG4gICAgICB0aGlzLm1vZGlmaWVyRGVmaW5pdGlvbkNhY2hlLnNldChkZWZpbml0aW9uU3RhdGUsIGhhbmRsZSk7XG4gICAgICB0aGlzLm1vZGlmaWVyRGVmaW5pdGlvbkNvdW50Kys7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhhbmRsZTtcbiAgfVxuXG4gIGNvbXBvbmVudChkZWZpbml0aW9uU3RhdGU6IENvbXBvbmVudERlZmluaXRpb25TdGF0ZSwgb3duZXI6IG9iamVjdCk6IENvbXBvbmVudERlZmluaXRpb247XG4gIGNvbXBvbmVudChcbiAgICBkZWZpbml0aW9uU3RhdGU6IENvbXBvbmVudERlZmluaXRpb25TdGF0ZSxcbiAgICBvd25lcjogb2JqZWN0LFxuICAgIGlzT3B0aW9uYWw/OiB0cnVlXG4gICk6IENvbXBvbmVudERlZmluaXRpb24gfCBudWxsIHtcbiAgICBsZXQgZGVmaW5pdGlvbiA9IHRoaXMuY29tcG9uZW50RGVmaW5pdGlvbkNhY2hlLmdldChkZWZpbml0aW9uU3RhdGUpO1xuXG4gICAgaWYgKGRlZmluaXRpb24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgbGV0IG1hbmFnZXIgPSBnZXRJbnRlcm5hbENvbXBvbmVudE1hbmFnZXIoZGVmaW5pdGlvblN0YXRlLCBpc09wdGlvbmFsKTtcblxuICAgICAgaWYgKG1hbmFnZXIgPT09IG51bGwpIHtcbiAgICAgICAgdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ2FjaGUuc2V0KGRlZmluaXRpb25TdGF0ZSwgbnVsbCk7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICBhc3NlcnQobWFuYWdlciwgJ0JVRzogZXhwZWN0ZWQgbWFuYWdlcicpO1xuXG4gICAgICBsZXQgY2FwYWJpbGl0aWVzID0gY2FwYWJpbGl0eUZsYWdzRnJvbShtYW5hZ2VyLmdldENhcGFiaWxpdGllcyhkZWZpbml0aW9uU3RhdGUpKTtcblxuICAgICAgbGV0IHRlbXBsYXRlRmFjdG9yeSA9IGdldENvbXBvbmVudFRlbXBsYXRlKGRlZmluaXRpb25TdGF0ZSk7XG5cbiAgICAgIGxldCBjb21waWxhYmxlID0gbnVsbDtcbiAgICAgIGxldCB0ZW1wbGF0ZTtcblxuICAgICAgaWYgKCFtYW5hZ2VySGFzQ2FwYWJpbGl0eShtYW5hZ2VyLCBjYXBhYmlsaXRpZXMsIEludGVybmFsQ29tcG9uZW50Q2FwYWJpbGl0eS5EeW5hbWljTGF5b3V0KSkge1xuICAgICAgICB0ZW1wbGF0ZSA9IHRlbXBsYXRlRmFjdG9yeT8uKG93bmVyKSA/PyB0aGlzLmRlZmF1bHRUZW1wbGF0ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRlbXBsYXRlID0gdGVtcGxhdGVGYWN0b3J5Py4ob3duZXIpO1xuICAgICAgfVxuXG4gICAgICBpZiAodGVtcGxhdGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0ZW1wbGF0ZSA9IHVud3JhcFRlbXBsYXRlKHRlbXBsYXRlKTtcblxuICAgICAgICBjb21waWxhYmxlID0gbWFuYWdlckhhc0NhcGFiaWxpdHkoXG4gICAgICAgICAgbWFuYWdlcixcbiAgICAgICAgICBjYXBhYmlsaXRpZXMsXG4gICAgICAgICAgSW50ZXJuYWxDb21wb25lbnRDYXBhYmlsaXR5LldyYXBwZWRcbiAgICAgICAgKVxuICAgICAgICAgID8gdGVtcGxhdGUuYXNXcmFwcGVkTGF5b3V0KClcbiAgICAgICAgICA6IHRlbXBsYXRlLmFzTGF5b3V0KCk7XG4gICAgICB9XG5cbiAgICAgIGRlZmluaXRpb24gPSB7XG4gICAgICAgIHJlc29sdmVkTmFtZTogbnVsbCxcbiAgICAgICAgaGFuZGxlOiAtMSwgLy8gcmVwbGFjZWQgbW9tZW50YXJpbHlcbiAgICAgICAgbWFuYWdlcixcbiAgICAgICAgY2FwYWJpbGl0aWVzLFxuICAgICAgICBzdGF0ZTogZGVmaW5pdGlvblN0YXRlLFxuICAgICAgICBjb21waWxhYmxlLFxuICAgICAgfTtcblxuICAgICAgZGVmaW5pdGlvbiEuaGFuZGxlID0gdGhpcy52YWx1ZShkZWZpbml0aW9uKTtcbiAgICAgIHRoaXMuY29tcG9uZW50RGVmaW5pdGlvbkNhY2hlLnNldChkZWZpbml0aW9uU3RhdGUsIGRlZmluaXRpb24pO1xuICAgICAgdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ291bnQrKztcbiAgICB9XG5cbiAgICByZXR1cm4gZGVmaW5pdGlvbjtcbiAgfVxuXG4gIHJlc29sdmVkQ29tcG9uZW50KFxuICAgIHJlc29sdmVkRGVmaW5pdGlvbjogUmVzb2x2ZWRDb21wb25lbnREZWZpbml0aW9uLFxuICAgIHJlc29sdmVkTmFtZTogc3RyaW5nXG4gICk6IENvbXBvbmVudERlZmluaXRpb24ge1xuICAgIGxldCBkZWZpbml0aW9uID0gdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ2FjaGUuZ2V0KHJlc29sdmVkRGVmaW5pdGlvbik7XG5cbiAgICBpZiAoZGVmaW5pdGlvbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBsZXQgeyBtYW5hZ2VyLCBzdGF0ZSwgdGVtcGxhdGUgfSA9IHJlc29sdmVkRGVmaW5pdGlvbjtcbiAgICAgIGxldCBjYXBhYmlsaXRpZXMgPSBjYXBhYmlsaXR5RmxhZ3NGcm9tKG1hbmFnZXIuZ2V0Q2FwYWJpbGl0aWVzKHJlc29sdmVkRGVmaW5pdGlvbikpO1xuXG4gICAgICBsZXQgY29tcGlsYWJsZSA9IG51bGw7XG5cbiAgICAgIGlmICghbWFuYWdlckhhc0NhcGFiaWxpdHkobWFuYWdlciwgY2FwYWJpbGl0aWVzLCBJbnRlcm5hbENvbXBvbmVudENhcGFiaWxpdHkuRHluYW1pY0xheW91dCkpIHtcbiAgICAgICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZSA/PyB0aGlzLmRlZmF1bHRUZW1wbGF0ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRlbXBsYXRlICE9PSBudWxsKSB7XG4gICAgICAgIHRlbXBsYXRlID0gdW53cmFwVGVtcGxhdGUodGVtcGxhdGUpO1xuXG4gICAgICAgIGNvbXBpbGFibGUgPSBtYW5hZ2VySGFzQ2FwYWJpbGl0eShcbiAgICAgICAgICBtYW5hZ2VyLFxuICAgICAgICAgIGNhcGFiaWxpdGllcyxcbiAgICAgICAgICBJbnRlcm5hbENvbXBvbmVudENhcGFiaWxpdHkuV3JhcHBlZFxuICAgICAgICApXG4gICAgICAgICAgPyB0ZW1wbGF0ZS5hc1dyYXBwZWRMYXlvdXQoKVxuICAgICAgICAgIDogdGVtcGxhdGUuYXNMYXlvdXQoKTtcbiAgICAgIH1cblxuICAgICAgZGVmaW5pdGlvbiA9IHtcbiAgICAgICAgcmVzb2x2ZWROYW1lLFxuICAgICAgICBoYW5kbGU6IC0xLCAvLyByZXBsYWNlZCBtb21lbnRhcmlseVxuICAgICAgICBtYW5hZ2VyLFxuICAgICAgICBjYXBhYmlsaXRpZXMsXG4gICAgICAgIHN0YXRlLFxuICAgICAgICBjb21waWxhYmxlLFxuICAgICAgfTtcblxuICAgICAgZGVmaW5pdGlvbiEuaGFuZGxlID0gdGhpcy52YWx1ZShkZWZpbml0aW9uKTtcbiAgICAgIHRoaXMuY29tcG9uZW50RGVmaW5pdGlvbkNhY2hlLnNldChyZXNvbHZlZERlZmluaXRpb24sIGRlZmluaXRpb24pO1xuICAgICAgdGhpcy5jb21wb25lbnREZWZpbml0aW9uQ291bnQrKztcbiAgICB9XG5cbiAgICByZXR1cm4gZXhwZWN0KGRlZmluaXRpb24sICdCVUc6IHJlc29sdmVkIGNvbXBvbmVudCBkZWZpbml0aW9ucyBjYW5ub3QgYmUgbnVsbCcpO1xuICB9XG5cbiAgZ2V0VmFsdWU8VD4oaW5kZXg6IG51bWJlcikge1xuICAgIGFzc2VydChpbmRleCA+PSAwLCBgY2Fubm90IGdldCB2YWx1ZSBmb3IgaGFuZGxlOiAke2luZGV4fWApO1xuXG4gICAgcmV0dXJuIHRoaXMudmFsdWVzW2luZGV4XSBhcyBUO1xuICB9XG5cbiAgZ2V0QXJyYXk8VD4oaW5kZXg6IG51bWJlcik6IFRbXSB7XG4gICAgbGV0IHJlaWZpZWRBcnJzID0gdGhpcy5yZWlmaWVkQXJycztcbiAgICBsZXQgcmVpZmllZCA9IHJlaWZpZWRBcnJzW2luZGV4XSBhcyBUW107XG5cbiAgICBpZiAocmVpZmllZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBsZXQgbmFtZXM6IG51bWJlcltdID0gdGhpcy5nZXRWYWx1ZShpbmRleCk7XG4gICAgICByZWlmaWVkID0gbmV3IEFycmF5KG5hbWVzLmxlbmd0aCk7XG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcmVpZmllZFtpXSA9IHRoaXMuZ2V0VmFsdWUobmFtZXNbaV0pO1xuICAgICAgfVxuXG4gICAgICByZWlmaWVkQXJyc1tpbmRleF0gPSByZWlmaWVkO1xuICAgIH1cblxuICAgIHJldHVybiByZWlmaWVkO1xuICB9XG59XG4iXSwic291cmNlUm9vdCI6IiJ9