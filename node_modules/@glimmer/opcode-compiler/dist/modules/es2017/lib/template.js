import { assign } from '@glimmer/util';
import { compilable } from './compilable-template';
import { WrappedBuilder } from './wrapped-component';
let clientId = 0;
export let templateCacheCounters = {
  cacheHit: 0,
  cacheMiss: 0
};
/**
 * Wraps a template js in a template module to change it into a factory
 * that handles lazy parsing the template and to create per env singletons
 * of the template.
 */

export default function templateFactory({
  id: templateId,
  moduleName,
  block,
  scope,
  isStrictMode
}) {
  // TODO(template-refactors): This should be removed in the near future, as it
  // appears that id is unused. It is currently kept for backwards compat reasons.
  let id = templateId || `client-${clientId++}`; // TODO: This caches JSON serialized output once in case a template is
  // compiled by multiple owners, but we haven't verified if this is actually
  // helpful. We should benchmark this in the future.

  let parsedBlock;
  let ownerlessTemplate = null;
  let templateCache = new WeakMap();

  let factory = owner => {
    if (parsedBlock === undefined) {
      parsedBlock = JSON.parse(block);
    }

    if (owner === undefined) {
      if (ownerlessTemplate === null) {
        templateCacheCounters.cacheMiss++;
        ownerlessTemplate = new TemplateImpl({
          id,
          block: parsedBlock,
          moduleName,
          owner: null,
          scope,
          isStrictMode
        });
      } else {
        templateCacheCounters.cacheHit++;
      }

      return ownerlessTemplate;
    }

    let result = templateCache.get(owner);

    if (result === undefined) {
      templateCacheCounters.cacheMiss++;
      result = new TemplateImpl({
        id,
        block: parsedBlock,
        moduleName,
        owner,
        scope,
        isStrictMode
      });
      templateCache.set(owner, result);
    } else {
      templateCacheCounters.cacheHit++;
    }

    return result;
  };

  factory.__id = id;
  factory.__meta = {
    moduleName
  };
  return factory;
}

class TemplateImpl {
  constructor(parsedLayout) {
    this.parsedLayout = parsedLayout;
    this.result = 'ok';
    this.layout = null;
    this.wrappedLayout = null;
  }

  get moduleName() {
    return this.parsedLayout.moduleName;
  }

  get id() {
    return this.parsedLayout.id;
  } // TODO(template-refactors): This should be removed in the near future, it is
  // only being exposed for backwards compatibility


  get referrer() {
    return {
      moduleName: this.parsedLayout.moduleName,
      owner: this.parsedLayout.owner
    };
  }

  asLayout() {
    if (this.layout) return this.layout;
    return this.layout = compilable(assign({}, this.parsedLayout), this.moduleName);
  }

  asWrappedLayout() {
    if (this.wrappedLayout) return this.wrappedLayout;
    return this.wrappedLayout = new WrappedBuilder(assign({}, this.parsedLayout), this.moduleName);
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL29wY29kZS1jb21waWxlci9saWIvdGVtcGxhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBV0EsU0FBUyxNQUFULFFBQXVCLGVBQXZCO0FBQ0EsU0FBUyxVQUFULFFBQTJCLHVCQUEzQjtBQUNBLFNBQVMsY0FBVCxRQUErQixxQkFBL0I7QUFFQSxJQUFJLFFBQVEsR0FBRyxDQUFmO0FBRUEsT0FBTyxJQUFJLHFCQUFxQixHQUFHO0FBQ2pDLEVBQUEsUUFBUSxFQUFFLENBRHVCO0FBRWpDLEVBQUEsU0FBUyxFQUFFO0FBRnNCLENBQTVCO0FBbUJQOzs7Ozs7QUFLQSxlQUFjLFNBQVUsZUFBVixDQUEwQjtBQUN0QyxFQUFBLEVBQUUsRUFBRSxVQURrQztBQUV0QyxFQUFBLFVBRnNDO0FBR3RDLEVBQUEsS0FIc0M7QUFJdEMsRUFBQSxLQUpzQztBQUt0QyxFQUFBO0FBTHNDLENBQTFCLEVBTW9CO0FBQ2hDO0FBQ0E7QUFDQSxNQUFJLEVBQUUsR0FBRyxVQUFVLElBQUksVUFBVSxRQUFRLEVBQUUsRUFBM0MsQ0FIZ0MsQ0FLaEM7QUFDQTtBQUNBOztBQUNBLE1BQUksV0FBSjtBQUVBLE1BQUksaUJBQWlCLEdBQW9CLElBQXpDO0FBQ0EsTUFBSSxhQUFhLEdBQUcsSUFBSSxPQUFKLEVBQXBCOztBQUVBLE1BQUksT0FBTyxHQUFrQyxLQUFELElBQWtCO0FBQzVELFFBQUksV0FBVyxLQUFLLFNBQXBCLEVBQStCO0FBQzdCLE1BQUEsV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFMLENBQVcsS0FBWCxDQUFkO0FBQ0Q7O0FBRUQsUUFBSSxLQUFLLEtBQUssU0FBZCxFQUF5QjtBQUN2QixVQUFJLGlCQUFpQixLQUFLLElBQTFCLEVBQWdDO0FBQzlCLFFBQUEscUJBQXFCLENBQUMsU0FBdEI7QUFDQSxRQUFBLGlCQUFpQixHQUFHLElBQUksWUFBSixDQUFpQjtBQUNuQyxVQUFBLEVBRG1DO0FBRW5DLFVBQUEsS0FBSyxFQUFFLFdBRjRCO0FBR25DLFVBQUEsVUFIbUM7QUFJbkMsVUFBQSxLQUFLLEVBQUUsSUFKNEI7QUFLbkMsVUFBQSxLQUxtQztBQU1uQyxVQUFBO0FBTm1DLFNBQWpCLENBQXBCO0FBUUQsT0FWRCxNQVVPO0FBQ0wsUUFBQSxxQkFBcUIsQ0FBQyxRQUF0QjtBQUNEOztBQUVELGFBQU8saUJBQVA7QUFDRDs7QUFFRCxRQUFJLE1BQU0sR0FBRyxhQUFhLENBQUMsR0FBZCxDQUFrQixLQUFsQixDQUFiOztBQUVBLFFBQUksTUFBTSxLQUFLLFNBQWYsRUFBMEI7QUFDeEIsTUFBQSxxQkFBcUIsQ0FBQyxTQUF0QjtBQUNBLE1BQUEsTUFBTSxHQUFHLElBQUksWUFBSixDQUFpQjtBQUFFLFFBQUEsRUFBRjtBQUFNLFFBQUEsS0FBSyxFQUFFLFdBQWI7QUFBMEIsUUFBQSxVQUExQjtBQUFzQyxRQUFBLEtBQXRDO0FBQTZDLFFBQUEsS0FBN0M7QUFBb0QsUUFBQTtBQUFwRCxPQUFqQixDQUFUO0FBQ0EsTUFBQSxhQUFhLENBQUMsR0FBZCxDQUFrQixLQUFsQixFQUF5QixNQUF6QjtBQUNELEtBSkQsTUFJTztBQUNMLE1BQUEscUJBQXFCLENBQUMsUUFBdEI7QUFDRDs7QUFFRCxXQUFPLE1BQVA7QUFDRCxHQWxDRDs7QUFvQ0EsRUFBQSxPQUFPLENBQUMsSUFBUixHQUFlLEVBQWY7QUFDQSxFQUFBLE9BQU8sQ0FBQyxNQUFSLEdBQWlCO0FBQUUsSUFBQTtBQUFGLEdBQWpCO0FBRUEsU0FBTyxPQUFQO0FBQ0Q7O0FBRUQsTUFBTSxZQUFOLENBQWtCO0FBTWhCLEVBQUEsV0FBQSxDQUFvQixZQUFwQixFQUFtRDtBQUEvQixTQUFBLFlBQUEsR0FBQSxZQUFBO0FBTFgsU0FBQSxNQUFBLEdBQVMsSUFBVDtBQUVELFNBQUEsTUFBQSxHQUFvQyxJQUFwQztBQUNBLFNBQUEsYUFBQSxHQUEyQyxJQUEzQztBQUUrQzs7QUFFdkQsTUFBSSxVQUFKLEdBQWM7QUFDWixXQUFPLEtBQUssWUFBTCxDQUFrQixVQUF6QjtBQUNEOztBQUVELE1BQUksRUFBSixHQUFNO0FBQ0osV0FBTyxLQUFLLFlBQUwsQ0FBa0IsRUFBekI7QUFDRCxHQWRlLENBZ0JoQjtBQUNBOzs7QUFDQSxNQUFJLFFBQUosR0FBWTtBQUNWLFdBQU87QUFDTCxNQUFBLFVBQVUsRUFBRSxLQUFLLFlBQUwsQ0FBa0IsVUFEekI7QUFFTCxNQUFBLEtBQUssRUFBRSxLQUFLLFlBQUwsQ0FBa0I7QUFGcEIsS0FBUDtBQUlEOztBQUVELEVBQUEsUUFBUSxHQUFBO0FBQ04sUUFBSSxLQUFLLE1BQVQsRUFBaUIsT0FBTyxLQUFLLE1BQVo7QUFDakIsV0FBUSxLQUFLLE1BQUwsR0FBYyxVQUFVLENBQUMsTUFBTSxDQUFDLEVBQUQsRUFBSyxLQUFLLFlBQVYsQ0FBUCxFQUFnQyxLQUFLLFVBQXJDLENBQWhDO0FBQ0Q7O0FBRUQsRUFBQSxlQUFlLEdBQUE7QUFDYixRQUFJLEtBQUssYUFBVCxFQUF3QixPQUFPLEtBQUssYUFBWjtBQUN4QixXQUFRLEtBQUssYUFBTCxHQUFxQixJQUFJLGNBQUosQ0FDM0IsTUFBTSxDQUFDLEVBQUQsRUFBSyxLQUFLLFlBQVYsQ0FEcUIsRUFFM0IsS0FBSyxVQUZzQixDQUE3QjtBQUlEOztBQXBDZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBpbGFibGVQcm9ncmFtLFxuICBMYXlvdXRXaXRoQ29udGV4dCxcbiAgT3B0aW9uLFxuICBPd25lcixcbiAgU2VyaWFsaXplZFRlbXBsYXRlQmxvY2ssXG4gIFNlcmlhbGl6ZWRUZW1wbGF0ZVdpdGhMYXp5QmxvY2ssXG4gIFRlbXBsYXRlLFxuICBUZW1wbGF0ZUZhY3RvcnksXG4gIFRlbXBsYXRlT2ssXG59IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgYXNzaWduIH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBjb21waWxhYmxlIH0gZnJvbSAnLi9jb21waWxhYmxlLXRlbXBsYXRlJztcbmltcG9ydCB7IFdyYXBwZWRCdWlsZGVyIH0gZnJvbSAnLi93cmFwcGVkLWNvbXBvbmVudCc7XG5cbmxldCBjbGllbnRJZCA9IDA7XG5cbmV4cG9ydCBsZXQgdGVtcGxhdGVDYWNoZUNvdW50ZXJzID0ge1xuICBjYWNoZUhpdDogMCxcbiAgY2FjaGVNaXNzOiAwLFxufTtcblxuLy8gVGhlc2UgaW50ZXJmYWNlcyBhcmUgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBzb21lIGFkZG9ucyB1c2UgdGhlc2UgaW50aW1hdGUgQVBJc1xuZXhwb3J0IGludGVyZmFjZSBUZW1wbGF0ZUZhY3RvcnlXaXRoSWRBbmRNZXRhIGV4dGVuZHMgVGVtcGxhdGVGYWN0b3J5IHtcbiAgX19pZD86IHN0cmluZztcbiAgX19tZXRhPzogeyBtb2R1bGVOYW1lOiBzdHJpbmcgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUZW1wbGF0ZVdpdGhJZEFuZFJlZmVycmVyIGV4dGVuZHMgVGVtcGxhdGVPayB7XG4gIGlkOiBzdHJpbmc7XG4gIHJlZmVycmVyOiB7XG4gICAgbW9kdWxlTmFtZTogc3RyaW5nO1xuICAgIG93bmVyOiBPd25lciB8IG51bGw7XG4gIH07XG59XG5cbi8qKlxuICogV3JhcHMgYSB0ZW1wbGF0ZSBqcyBpbiBhIHRlbXBsYXRlIG1vZHVsZSB0byBjaGFuZ2UgaXQgaW50byBhIGZhY3RvcnlcbiAqIHRoYXQgaGFuZGxlcyBsYXp5IHBhcnNpbmcgdGhlIHRlbXBsYXRlIGFuZCB0byBjcmVhdGUgcGVyIGVudiBzaW5nbGV0b25zXG4gKiBvZiB0aGUgdGVtcGxhdGUuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHRlbXBsYXRlRmFjdG9yeSh7XG4gIGlkOiB0ZW1wbGF0ZUlkLFxuICBtb2R1bGVOYW1lLFxuICBibG9jayxcbiAgc2NvcGUsXG4gIGlzU3RyaWN0TW9kZSxcbn06IFNlcmlhbGl6ZWRUZW1wbGF0ZVdpdGhMYXp5QmxvY2spOiBUZW1wbGF0ZUZhY3Rvcnkge1xuICAvLyBUT0RPKHRlbXBsYXRlLXJlZmFjdG9ycyk6IFRoaXMgc2hvdWxkIGJlIHJlbW92ZWQgaW4gdGhlIG5lYXIgZnV0dXJlLCBhcyBpdFxuICAvLyBhcHBlYXJzIHRoYXQgaWQgaXMgdW51c2VkLiBJdCBpcyBjdXJyZW50bHkga2VwdCBmb3IgYmFja3dhcmRzIGNvbXBhdCByZWFzb25zLlxuICBsZXQgaWQgPSB0ZW1wbGF0ZUlkIHx8IGBjbGllbnQtJHtjbGllbnRJZCsrfWA7XG5cbiAgLy8gVE9ETzogVGhpcyBjYWNoZXMgSlNPTiBzZXJpYWxpemVkIG91dHB1dCBvbmNlIGluIGNhc2UgYSB0ZW1wbGF0ZSBpc1xuICAvLyBjb21waWxlZCBieSBtdWx0aXBsZSBvd25lcnMsIGJ1dCB3ZSBoYXZlbid0IHZlcmlmaWVkIGlmIHRoaXMgaXMgYWN0dWFsbHlcbiAgLy8gaGVscGZ1bC4gV2Ugc2hvdWxkIGJlbmNobWFyayB0aGlzIGluIHRoZSBmdXR1cmUuXG4gIGxldCBwYXJzZWRCbG9jazogU2VyaWFsaXplZFRlbXBsYXRlQmxvY2s7XG5cbiAgbGV0IG93bmVybGVzc1RlbXBsYXRlOiBUZW1wbGF0ZSB8IG51bGwgPSBudWxsO1xuICBsZXQgdGVtcGxhdGVDYWNoZSA9IG5ldyBXZWFrTWFwPG9iamVjdCwgVGVtcGxhdGU+KCk7XG5cbiAgbGV0IGZhY3Rvcnk6IFRlbXBsYXRlRmFjdG9yeVdpdGhJZEFuZE1ldGEgPSAob3duZXI/OiBPd25lcikgPT4ge1xuICAgIGlmIChwYXJzZWRCbG9jayA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBwYXJzZWRCbG9jayA9IEpTT04ucGFyc2UoYmxvY2spO1xuICAgIH1cblxuICAgIGlmIChvd25lciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBpZiAob3duZXJsZXNzVGVtcGxhdGUgPT09IG51bGwpIHtcbiAgICAgICAgdGVtcGxhdGVDYWNoZUNvdW50ZXJzLmNhY2hlTWlzcysrO1xuICAgICAgICBvd25lcmxlc3NUZW1wbGF0ZSA9IG5ldyBUZW1wbGF0ZUltcGwoe1xuICAgICAgICAgIGlkLFxuICAgICAgICAgIGJsb2NrOiBwYXJzZWRCbG9jayxcbiAgICAgICAgICBtb2R1bGVOYW1lLFxuICAgICAgICAgIG93bmVyOiBudWxsLFxuICAgICAgICAgIHNjb3BlLFxuICAgICAgICAgIGlzU3RyaWN0TW9kZSxcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0ZW1wbGF0ZUNhY2hlQ291bnRlcnMuY2FjaGVIaXQrKztcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG93bmVybGVzc1RlbXBsYXRlO1xuICAgIH1cblxuICAgIGxldCByZXN1bHQgPSB0ZW1wbGF0ZUNhY2hlLmdldChvd25lcikgYXMgVGVtcGxhdGU7XG5cbiAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRlbXBsYXRlQ2FjaGVDb3VudGVycy5jYWNoZU1pc3MrKztcbiAgICAgIHJlc3VsdCA9IG5ldyBUZW1wbGF0ZUltcGwoeyBpZCwgYmxvY2s6IHBhcnNlZEJsb2NrLCBtb2R1bGVOYW1lLCBvd25lciwgc2NvcGUsIGlzU3RyaWN0TW9kZSB9KTtcbiAgICAgIHRlbXBsYXRlQ2FjaGUuc2V0KG93bmVyLCByZXN1bHQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0ZW1wbGF0ZUNhY2hlQ291bnRlcnMuY2FjaGVIaXQrKztcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIGZhY3RvcnkuX19pZCA9IGlkO1xuICBmYWN0b3J5Ll9fbWV0YSA9IHsgbW9kdWxlTmFtZSB9O1xuXG4gIHJldHVybiBmYWN0b3J5O1xufVxuXG5jbGFzcyBUZW1wbGF0ZUltcGwgaW1wbGVtZW50cyBUZW1wbGF0ZVdpdGhJZEFuZFJlZmVycmVyIHtcbiAgcmVhZG9ubHkgcmVzdWx0ID0gJ29rJztcblxuICBwcml2YXRlIGxheW91dDogT3B0aW9uPENvbXBpbGFibGVQcm9ncmFtPiA9IG51bGw7XG4gIHByaXZhdGUgd3JhcHBlZExheW91dDogT3B0aW9uPENvbXBpbGFibGVQcm9ncmFtPiA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBwYXJzZWRMYXlvdXQ6IExheW91dFdpdGhDb250ZXh0KSB7fVxuXG4gIGdldCBtb2R1bGVOYW1lKCkge1xuICAgIHJldHVybiB0aGlzLnBhcnNlZExheW91dC5tb2R1bGVOYW1lO1xuICB9XG5cbiAgZ2V0IGlkKCkge1xuICAgIHJldHVybiB0aGlzLnBhcnNlZExheW91dC5pZDtcbiAgfVxuXG4gIC8vIFRPRE8odGVtcGxhdGUtcmVmYWN0b3JzKTogVGhpcyBzaG91bGQgYmUgcmVtb3ZlZCBpbiB0aGUgbmVhciBmdXR1cmUsIGl0IGlzXG4gIC8vIG9ubHkgYmVpbmcgZXhwb3NlZCBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHlcbiAgZ2V0IHJlZmVycmVyKCkge1xuICAgIHJldHVybiB7XG4gICAgICBtb2R1bGVOYW1lOiB0aGlzLnBhcnNlZExheW91dC5tb2R1bGVOYW1lLFxuICAgICAgb3duZXI6IHRoaXMucGFyc2VkTGF5b3V0Lm93bmVyLFxuICAgIH07XG4gIH1cblxuICBhc0xheW91dCgpOiBDb21waWxhYmxlUHJvZ3JhbSB7XG4gICAgaWYgKHRoaXMubGF5b3V0KSByZXR1cm4gdGhpcy5sYXlvdXQ7XG4gICAgcmV0dXJuICh0aGlzLmxheW91dCA9IGNvbXBpbGFibGUoYXNzaWduKHt9LCB0aGlzLnBhcnNlZExheW91dCksIHRoaXMubW9kdWxlTmFtZSkpO1xuICB9XG5cbiAgYXNXcmFwcGVkTGF5b3V0KCk6IENvbXBpbGFibGVQcm9ncmFtIHtcbiAgICBpZiAodGhpcy53cmFwcGVkTGF5b3V0KSByZXR1cm4gdGhpcy53cmFwcGVkTGF5b3V0O1xuICAgIHJldHVybiAodGhpcy53cmFwcGVkTGF5b3V0ID0gbmV3IFdyYXBwZWRCdWlsZGVyKFxuICAgICAgYXNzaWduKHt9LCB0aGlzLnBhcnNlZExheW91dCksXG4gICAgICB0aGlzLm1vZHVsZU5hbWVcbiAgICApKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==