import { $v0 } from '@glimmer/vm';
import { assert, deprecate } from '@glimmer/global-context';
import { expr } from '../opcode-builder/helpers/expr';
import { isGetFreeHelper } from '../opcode-builder/helpers/resolution';
import { SimpleArgs } from '../opcode-builder/helpers/shared';
import { Call, CallDynamic, Curry, PushPrimitiveReference } from '../opcode-builder/helpers/vm';
import { Compilers } from './compilers';
export const EXPRESSIONS = new Compilers();
EXPRESSIONS.add(29
/* Concat */
, (op, [, parts]) => {
  for (let part of parts) {
    expr(op, part);
  }

  op(27
  /* Concat */
  , parts.length);
});
EXPRESSIONS.add(28
/* Call */
, (op, [, expression, positional, named]) => {
  if (isGetFreeHelper(expression)) {
    op(1005
    /* ResolveHelper */
    , expression, handle => {
      Call(op, handle, positional, named);
    });
  } else {
    expr(op, expression);
    CallDynamic(op, positional, named);
  }
});
EXPRESSIONS.add(50
/* Curry */
, (op, [, expr, type, positional, named]) => {
  Curry(op, type, expr, positional, named);
});
EXPRESSIONS.add(30
/* GetSymbol */
, (op, [, sym, path]) => {
  op(21
  /* GetVariable */
  , sym);
  withPath(op, path);
});
EXPRESSIONS.add(32
/* GetTemplateSymbol */
, (op, [, sym, path]) => {
  op(1011
  /* ResolveTemplateLocal */
  , sym, handle => {
    op(29
    /* ConstantReference */
    , handle);
    withPath(op, path);
  });
});
EXPRESSIONS.add(31
/* GetStrictFree */
, (op, [, sym, _path]) => {
  op(1009
  /* ResolveFree */
  , sym, _handle => {// TODO: Implement in strict mode
  });
});
EXPRESSIONS.add(34
/* GetFreeAsComponentOrHelperHeadOrThisFallback */
, () => {
  // TODO: The logic for this opcode currently exists in STATEMENTS.Append, since
  // we want different wrapping logic depending on if we are invoking a component,
  // helper, or {{this}} fallback. Eventually we fix the opcodes so that we can
  // traverse the subexpression tree like normal in this location.
  throw new Error('unimplemented opcode');
});
EXPRESSIONS.add(36
/* GetFreeAsHelperHeadOrThisFallback */
, (op, expr) => {
  // <div id={{baz}}>
  op(1010
  /* ResolveLocal */
  , expr[1], _name => {
    op(1006
    /* ResolveOptionalHelper */
    , expr, {
      ifHelper: handle => {
        Call(op, handle, null, null);
      }
    });
  });
});
EXPRESSIONS.add(99
/* GetFreeAsDeprecatedHelperHeadOrThisFallback */
, (op, expr) => {
  // <Foo @bar={{baz}}>
  op(1010
  /* ResolveLocal */
  , expr[1], _name => {
    op(1006
    /* ResolveOptionalHelper */
    , expr, {
      ifHelper: (handle, name, moduleName) => {
        assert(expr[2] && expr[2].length === 1, '[BUG] Missing argument name');
        let arg = expr[2][0];
        deprecate(`The \`${name}\` helper was used in the \`${moduleName}\` template as \`${arg}={{${name}}}\`. ` + `This is ambigious between wanting the \`${arg}\` argument to be the \`${name}\` helper itself, ` + `or the result of invoking the \`${name}\` helper (current behavior). ` + `This implicit invocation behavior has been deprecated.\n\n` + `Instead, please explicitly invoke the helper with parenthesis, i.e. \`${arg}={{(${name})}}\`.\n\n` + `Note: the parenthesis are only required in this exact scenario where an ambiguity is present â€“ where ` + `\`${name}\` referes to a global helper (as opposed to a local variable), AND ` + `the \`${name}\` helper invocation does not take any arguments, AND ` + `this occurs in a named argument position of a component invocation.\n\n` + `We expect this combination to be quite rare, as most helpers require at least one argument. ` + `There is no need to refactor helper invocations in cases where this deprecation was not triggered.`, false, {
          id: 'argument-less-helper-paren-less-invocation'
        });
        Call(op, handle, null, null);
      }
    });
  });
});

function withPath(op, path) {
  if (path === undefined || path.length === 0) return;

  for (let i = 0; i < path.length; i++) {
    op(22
    /* GetProperty */
    , path[i]);
  }
}

EXPRESSIONS.add(27
/* Undefined */
, op => PushPrimitiveReference(op, undefined));
EXPRESSIONS.add(48
/* HasBlock */
, (op, [, block]) => {
  expr(op, block);
  op(25
  /* HasBlock */
  );
});
EXPRESSIONS.add(49
/* HasBlockParams */
, (op, [, block]) => {
  expr(op, block);
  op(24
  /* SpreadBlock */
  );
  op(61
  /* CompileBlock */
  );
  op(26
  /* HasBlockParams */
  );
});
EXPRESSIONS.add(52
/* IfInline */
, (op, [, condition, truthy, falsy]) => {
  // Push in reverse order
  expr(op, falsy);
  expr(op, truthy);
  expr(op, condition);
  op(109
  /* IfInline */
  );
});
EXPRESSIONS.add(51
/* Not */
, (op, [, value]) => {
  expr(op, value);
  op(110
  /* Not */
  );
});
EXPRESSIONS.add(53
/* GetDynamicVar */
, (op, [, expression]) => {
  expr(op, expression);
  op(111
  /* GetDynamicVar */
  );
});
EXPRESSIONS.add(54
/* Log */
, (op, [, positional]) => {
  op(0
  /* PushFrame */
  );
  SimpleArgs(op, positional, null, false);
  op(112
  /* Log */
  );
  op(1
  /* PopFrame */
  );
  op(36
  /* Fetch */
  , $v0);
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL29wY29kZS1jb21waWxlci9saWIvc3ludGF4L2V4cHJlc3Npb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQU9BLFNBQVMsR0FBVCxRQUFvQixhQUFwQjtBQUNBLFNBQVMsTUFBVCxFQUFpQixTQUFqQixRQUFrQyx5QkFBbEM7QUFDQSxTQUFTLElBQVQsUUFBcUIsZ0NBQXJCO0FBQ0EsU0FBUyxlQUFULFFBQWdDLHNDQUFoQztBQUNBLFNBQVMsVUFBVCxRQUEyQixrQ0FBM0I7QUFDQSxTQUFTLElBQVQsRUFBZSxXQUFmLEVBQTRCLEtBQTVCLEVBQW1DLHNCQUFuQyxRQUFpRSw4QkFBakU7QUFDQSxTQUFTLFNBQVQsUUFBNEMsYUFBNUM7QUFFQSxPQUFPLE1BQU0sV0FBVyxHQUFHLElBQUksU0FBSixFQUFwQjtBQUVQLFdBQVcsQ0FBQyxHQUFaLENBQWU7QUFBQTtBQUFmLEVBQW9DLENBQUMsRUFBRCxFQUFLLEdBQUcsS0FBSCxDQUFMLEtBQWtCO0FBQ3BELE9BQUssSUFBSSxJQUFULElBQWlCLEtBQWpCLEVBQXdCO0FBQ3RCLElBQUEsSUFBSSxDQUFDLEVBQUQsRUFBSyxJQUFMLENBQUo7QUFDRDs7QUFFRCxFQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsSUFBWSxLQUFLLENBQUMsTUFBbEIsQ0FBRjtBQUNELENBTkQ7QUFRQSxXQUFXLENBQUMsR0FBWixDQUFlO0FBQUE7QUFBZixFQUFrQyxDQUFDLEVBQUQsRUFBSyxHQUFHLFVBQUgsRUFBZSxVQUFmLEVBQTJCLEtBQTNCLENBQUwsS0FBMEM7QUFDMUUsTUFBSSxlQUFlLENBQUMsVUFBRCxDQUFuQixFQUFpQztBQUMvQixJQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsTUFBMEMsVUFBMUMsRUFBdUQsTUFBRCxJQUFtQjtBQUN6RSxNQUFBLElBQUksQ0FBQyxFQUFELEVBQUssTUFBTCxFQUFhLFVBQWIsRUFBeUIsS0FBekIsQ0FBSjtBQUNE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LENBQUMsR0FBWixDQUFlO0FBQUE7QUFBZixFQUFpQyxDQUFDLEVBQUQsRUFBSyxHQUFHLFVBQUgsQ0FBTCxLQUF1QjtBQUN0RCxFQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsR0FBRjtBQUNBLEVBQUEsVUFBVSxDQUFDLEVBQUQsRUFBSyxVQUFMLEVBQWlCLElBQWpCLEVBQXVCLEtBQXZCLENBQVY7QUFDQSxFQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsR0FBRjtBQUNBLEVBQUEsRUFBRSxDQUFBO0FBQUE7QUFBQSxHQUFGO0FBQ0EsRUFBQSxFQUFFLENBQUE7QUFBQTtBQUFBLElBQVcsR0FBWCxDQUFGO0FBQ0QsQ0FORCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEV4cHJlc3Npb25TZXhwT3Bjb2RlLFxuICBIaWdoTGV2ZWxSZXNvbHV0aW9uT3Bjb2RlLFxuICBNYWNoaW5lT3AsXG4gIE9wLFxuICBTZXhwT3Bjb2Rlcyxcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyAkdjAgfSBmcm9tICdAZ2xpbW1lci92bSc7XG5pbXBvcnQgeyBhc3NlcnQsIGRlcHJlY2F0ZSB9IGZyb20gJ0BnbGltbWVyL2dsb2JhbC1jb250ZXh0JztcbmltcG9ydCB7IGV4cHIgfSBmcm9tICcuLi9vcGNvZGUtYnVpbGRlci9oZWxwZXJzL2V4cHInO1xuaW1wb3J0IHsgaXNHZXRGcmVlSGVscGVyIH0gZnJvbSAnLi4vb3Bjb2RlLWJ1aWxkZXIvaGVscGVycy9yZXNvbHV0aW9uJztcbmltcG9ydCB7IFNpbXBsZUFyZ3MgfSBmcm9tICcuLi9vcGNvZGUtYnVpbGRlci9oZWxwZXJzL3NoYXJlZCc7XG5pbXBvcnQgeyBDYWxsLCBDYWxsRHluYW1pYywgQ3VycnksIFB1c2hQcmltaXRpdmVSZWZlcmVuY2UgfSBmcm9tICcuLi9vcGNvZGUtYnVpbGRlci9oZWxwZXJzL3ZtJztcbmltcG9ydCB7IENvbXBpbGVycywgUHVzaEV4cHJlc3Npb25PcCB9IGZyb20gJy4vY29tcGlsZXJzJztcblxuZXhwb3J0IGNvbnN0IEVYUFJFU1NJT05TID0gbmV3IENvbXBpbGVyczxQdXNoRXhwcmVzc2lvbk9wLCBFeHByZXNzaW9uU2V4cE9wY29kZT4oKTtcblxuRVhQUkVTU0lPTlMuYWRkKFNleHBPcGNvZGVzLkNvbmNhdCwgKG9wLCBbLCBwYXJ0c10pID0+IHtcbiAgZm9yIChsZXQgcGFydCBvZiBwYXJ0cykge1xuICAgIGV4cHIob3AsIHBhcnQpO1xuICB9XG5cbiAgb3AoT3AuQ29uY2F0LCBwYXJ0cy5sZW5ndGgpO1xufSk7XG5cbkVYUFJFU1NJT05TLmFkZChTZXhwT3Bjb2Rlcy5DYWxsLCAob3AsIFssIGV4cHJlc3Npb24sIHBvc2l0aW9uYWwsIG5hbWVkXSkgPT4ge1xuICBpZiAoaXNHZXRGcmVlSGVscGVyKGV4cHJlc3Npb24pKSB7XG4gICAgb3AoSGlnaExldmVsUmVzb2x1dGlvbk9wY29kZS5SZXNvbHZlSGVscGVyLCBleHByZXNzaW9uLCAoaGFuZGxlOiBudW1iZXIpID0+IHtcbiAgICAgIENhbGwob3AsIGhhbmRsZSwgcG9zaXRpb25hbCwgbmFtZWQpO1xuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIGV4cHIob3AsIGV4cHJlc3Npb24pO1xuICAgIENhbGxEeW5hbWljKG9wLCBwb3NpdGlvbmFsLCBuYW1lZCk7XG4gIH1cbn0pO1xuXG5FWFBSRVNTSU9OUy5hZGQoU2V4cE9wY29kZXMuQ3VycnksIChvcCwgWywgZXhwciwgdHlwZSwgcG9zaXRpb25hbCwgbmFtZWRdKSA9PiB7XG4gIEN1cnJ5KG9wLCB0eXBlLCBleHByLCBwb3NpdGlvbmFsLCBuYW1lZCk7XG59KTtcblxuRVhQUkVTU0lPTlMuYWRkKFNleHBPcGNvZGVzLkdldFN5bWJvbCwgKG9wLCBbLCBzeW0sIHBhdGhdKSA9PiB7XG4gIG9wKE9wLkdldFZhcmlhYmxlLCBzeW0pO1xuICB3aXRoUGF0aChvcCwgcGF0aCk7XG59KTtcblxuRVhQUkVTU0lPTlMuYWRkKFNleHBPcGNvZGVzLkdldFRlbXBsYXRlU3ltYm9sLCAob3AsIFssIHN5bSwgcGF0aF0pID0+IHtcbiAgb3AoSGlnaExldmVsUmVzb2x1dGlvbk9wY29kZS5SZXNvbHZlVGVtcGxhdGVMb2NhbCwgc3ltLCAoaGFuZGxlOiBudW1iZXIpID0+IHtcbiAgICBvcChPcC5Db25zdGFudFJlZmVyZW5jZSwgaGFuZGxlKTtcbiAgICB3aXRoUGF0aChvcCwgcGF0aCk7XG4gIH0pO1xufSk7XG5cbkVYUFJFU1NJT05TLmFkZChTZXhwT3Bjb2Rlcy5HZXRTdHJpY3RGcmVlLCAob3AsIFssIHN5bSwgX3BhdGhdKSA9PiB7XG4gIG9wKEhpZ2hMZXZlbFJlc29sdXRpb25PcGNvZGUuUmVzb2x2ZUZyZWUsIHN5bSwgKF9oYW5kbGU6IHVua25vd24pID0+IHtcbiAgICAvLyBUT0RPOiBJbXBsZW1lbnQgaW4gc3RyaWN0IG1vZGVcbiAgfSk7XG59KTtcblxuRVhQUkVTU0lPTlMuYWRkKFNleHBPcGNvZGVzLkdldEZyZWVBc0NvbXBvbmVudE9ySGVscGVySGVhZE9yVGhpc0ZhbGxiYWNrLCAoKSA9PiB7XG4gIC8vIFRPRE86IFRoZSBsb2dpYyBmb3IgdGhpcyBvcGNvZGUgY3VycmVudGx5IGV4aXN0cyBpbiBTVEFURU1FTlRTLkFwcGVuZCwgc2luY2VcbiAgLy8gd2Ugd2FudCBkaWZmZXJlbnQgd3JhcHBpbmcgbG9naWMgZGVwZW5kaW5nIG9uIGlmIHdlIGFyZSBpbnZva2luZyBhIGNvbXBvbmVudCxcbiAgLy8gaGVscGVyLCBvciB7e3RoaXN9fSBmYWxsYmFjay4gRXZlbnR1YWxseSB3ZSBmaXggdGhlIG9wY29kZXMgc28gdGhhdCB3ZSBjYW5cbiAgLy8gdHJhdmVyc2UgdGhlIHN1YmV4cHJlc3Npb24gdHJlZSBsaWtlIG5vcm1hbCBpbiB0aGlzIGxvY2F0aW9uLlxuICB0aHJvdyBuZXcgRXJyb3IoJ3VuaW1wbGVtZW50ZWQgb3Bjb2RlJyk7XG59KTtcblxuRVhQUkVTU0lPTlMuYWRkKFNleHBPcGNvZGVzLkdldEZyZWVBc0hlbHBlckhlYWRPclRoaXNGYWxsYmFjaywgKG9wLCBleHByKSA9PiB7XG4gIC8vIDxkaXYgaWQ9e3tiYXp9fT5cblxuICBvcChIaWdoTGV2ZWxSZXNvbHV0aW9uT3Bjb2RlLlJlc29sdmVMb2NhbCwgZXhwclsxXSwgKF9uYW1lOiBzdHJpbmcpID0+IHtcbiAgICBvcChIaWdoTGV2ZWxSZXNvbHV0aW9uT3Bjb2RlLlJlc29sdmVPcHRpb25hbEhlbHBlciwgZXhwciwge1xuICAgICAgaWZIZWxwZXI6IChoYW5kbGU6IG51bWJlcikgPT4ge1xuICAgICAgICBDYWxsKG9wLCBoYW5kbGUsIG51bGwsIG51bGwpO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG59KTtcblxuRVhQUkVTU0lPTlMuYWRkKFNleHBPcGNvZGVzLkdldEZyZWVBc0RlcHJlY2F0ZWRIZWxwZXJIZWFkT3JUaGlzRmFsbGJhY2ssIChvcCwgZXhwcikgPT4ge1xuICAvLyA8Rm9vIEBiYXI9e3tiYXp9fT5cblxuICBvcChIaWdoTGV2ZWxSZXNvbHV0aW9uT3Bjb2RlLlJlc29sdmVMb2NhbCwgZXhwclsxXSwgKF9uYW1lOiBzdHJpbmcpID0+IHtcbiAgICBvcChIaWdoTGV2ZWxSZXNvbHV0aW9uT3Bjb2RlLlJlc29sdmVPcHRpb25hbEhlbHBlciwgZXhwciwge1xuICAgICAgaWZIZWxwZXI6IChoYW5kbGU6IG51bWJlciwgbmFtZTogc3RyaW5nLCBtb2R1bGVOYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgICAgYXNzZXJ0KGV4cHJbMl0gJiYgZXhwclsyXS5sZW5ndGggPT09IDEsICdbQlVHXSBNaXNzaW5nIGFyZ3VtZW50IG5hbWUnKTtcblxuICAgICAgICBsZXQgYXJnID0gZXhwclsyXVswXTtcblxuICAgICAgICBkZXByZWNhdGUoXG4gICAgICAgICAgYFRoZSBcXGAke25hbWV9XFxgIGhlbHBlciB3YXMgdXNlZCBpbiB0aGUgXFxgJHttb2R1bGVOYW1lfVxcYCB0ZW1wbGF0ZSBhcyBcXGAke2FyZ309e3ske25hbWV9fX1cXGAuIGAgK1xuICAgICAgICAgICAgYFRoaXMgaXMgYW1iaWdpb3VzIGJldHdlZW4gd2FudGluZyB0aGUgXFxgJHthcmd9XFxgIGFyZ3VtZW50IHRvIGJlIHRoZSBcXGAke25hbWV9XFxgIGhlbHBlciBpdHNlbGYsIGAgK1xuICAgICAgICAgICAgYG9yIHRoZSByZXN1bHQgb2YgaW52b2tpbmcgdGhlIFxcYCR7bmFtZX1cXGAgaGVscGVyIChjdXJyZW50IGJlaGF2aW9yKS4gYCArXG4gICAgICAgICAgICBgVGhpcyBpbXBsaWNpdCBpbnZvY2F0aW9uIGJlaGF2aW9yIGhhcyBiZWVuIGRlcHJlY2F0ZWQuXFxuXFxuYCArXG4gICAgICAgICAgICBgSW5zdGVhZCwgcGxlYXNlIGV4cGxpY2l0bHkgaW52b2tlIHRoZSBoZWxwZXIgd2l0aCBwYXJlbnRoZXNpcywgaS5lLiBcXGAke2FyZ309e3soJHtuYW1lfSl9fVxcYC5cXG5cXG5gICtcbiAgICAgICAgICAgIGBOb3RlOiB0aGUgcGFyZW50aGVzaXMgYXJlIG9ubHkgcmVxdWlyZWQgaW4gdGhpcyBleGFjdCBzY2VuYXJpbyB3aGVyZSBhbiBhbWJpZ3VpdHkgaXMgcHJlc2VudCDigJMgd2hlcmUgYCArXG4gICAgICAgICAgICBgXFxgJHtuYW1lfVxcYCByZWZlcmVzIHRvIGEgZ2xvYmFsIGhlbHBlciAoYXMgb3Bwb3NlZCB0byBhIGxvY2FsIHZhcmlhYmxlKSwgQU5EIGAgK1xuICAgICAgICAgICAgYHRoZSBcXGAke25hbWV9XFxgIGhlbHBlciBpbnZvY2F0aW9uIGRvZXMgbm90IHRha2UgYW55IGFyZ3VtZW50cywgQU5EIGAgK1xuICAgICAgICAgICAgYHRoaXMgb2NjdXJzIGluIGEgbmFtZWQgYXJndW1lbnQgcG9zaXRpb24gb2YgYSBjb21wb25lbnQgaW52b2NhdGlvbi5cXG5cXG5gICtcbiAgICAgICAgICAgIGBXZSBleHBlY3QgdGhpcyBjb21iaW5hdGlvbiB0byBiZSBxdWl0ZSByYXJlLCBhcyBtb3N0IGhlbHBlcnMgcmVxdWlyZSBhdCBsZWFzdCBvbmUgYXJndW1lbnQuIGAgK1xuICAgICAgICAgICAgYFRoZXJlIGlzIG5vIG5lZWQgdG8gcmVmYWN0b3IgaGVscGVyIGludm9jYXRpb25zIGluIGNhc2VzIHdoZXJlIHRoaXMgZGVwcmVjYXRpb24gd2FzIG5vdCB0cmlnZ2VyZWQuYCxcbiAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpZDogJ2FyZ3VtZW50LWxlc3MtaGVscGVyLXBhcmVuLWxlc3MtaW52b2NhdGlvbicsXG4gICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIENhbGwob3AsIGhhbmRsZSwgbnVsbCwgbnVsbCk7XG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcbn0pO1xuXG5mdW5jdGlvbiB3aXRoUGF0aChvcDogUHVzaEV4cHJlc3Npb25PcCwgcGF0aD86IHN0cmluZ1tdKSB7XG4gIGlmIChwYXRoID09PSB1bmRlZmluZWQgfHwgcGF0aC5sZW5ndGggPT09IDApIHJldHVybjtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IHBhdGgubGVuZ3RoOyBpKyspIHtcbiAgICBvcChPcC5HZXRQcm9wZXJ0eSwgcGF0aFtpXSk7XG4gIH1cbn1cblxuRVhQUkVTU0lPTlMuYWRkKFNleHBPcGNvZGVzLlVuZGVmaW5lZCwgKG9wKSA9PiBQdXNoUHJpbWl0aXZlUmVmZXJlbmNlKG9wLCB1bmRlZmluZWQpKTtcbkVYUFJFU1NJT05TLmFkZChTZXhwT3Bjb2Rlcy5IYXNCbG9jaywgKG9wLCBbLCBibG9ja10pID0+IHtcbiAgZXhwcihvcCwgYmxvY2spO1xuICBvcChPcC5IYXNCbG9jayk7XG59KTtcblxuRVhQUkVTU0lPTlMuYWRkKFNleHBPcGNvZGVzLkhhc0Jsb2NrUGFyYW1zLCAob3AsIFssIGJsb2NrXSkgPT4ge1xuICBleHByKG9wLCBibG9jayk7XG4gIG9wKE9wLlNwcmVhZEJsb2NrKTtcbiAgb3AoT3AuQ29tcGlsZUJsb2NrKTtcbiAgb3AoT3AuSGFzQmxvY2tQYXJhbXMpO1xufSk7XG5cbkVYUFJFU1NJT05TLmFkZChTZXhwT3Bjb2Rlcy5JZklubGluZSwgKG9wLCBbLCBjb25kaXRpb24sIHRydXRoeSwgZmFsc3ldKSA9PiB7XG4gIC8vIFB1c2ggaW4gcmV2ZXJzZSBvcmRlclxuICBleHByKG9wLCBmYWxzeSk7XG4gIGV4cHIob3AsIHRydXRoeSk7XG4gIGV4cHIob3AsIGNvbmRpdGlvbik7XG4gIG9wKE9wLklmSW5saW5lKTtcbn0pO1xuXG5FWFBSRVNTSU9OUy5hZGQoU2V4cE9wY29kZXMuTm90LCAob3AsIFssIHZhbHVlXSkgPT4ge1xuICBleHByKG9wLCB2YWx1ZSk7XG4gIG9wKE9wLk5vdCk7XG59KTtcblxuRVhQUkVTU0lPTlMuYWRkKFNleHBPcGNvZGVzLkdldER5bmFtaWNWYXIsIChvcCwgWywgZXhwcmVzc2lvbl0pID0+IHtcbiAgZXhwcihvcCwgZXhwcmVzc2lvbik7XG4gIG9wKE9wLkdldER5bmFtaWNWYXIpO1xufSk7XG5cbkVYUFJFU1NJT05TLmFkZChTZXhwT3Bjb2Rlcy5Mb2csIChvcCwgWywgcG9zaXRpb25hbF0pID0+IHtcbiAgb3AoTWFjaGluZU9wLlB1c2hGcmFtZSk7XG4gIFNpbXBsZUFyZ3Mob3AsIHBvc2l0aW9uYWwsIG51bGwsIGZhbHNlKTtcbiAgb3AoT3AuTG9nKTtcbiAgb3AoTWFjaGluZU9wLlBvcEZyYW1lKTtcbiAgb3AoT3AuRmV0Y2gsICR2MCk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiIn0=