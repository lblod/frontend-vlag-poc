import { $fp, $v0 } from '@glimmer/vm';
import { encodeImmediate, isSmallInt } from '@glimmer/util';
import { SimpleArgs } from './shared';
import { isStrictMode, nonSmallIntOperand } from '../operands';
import { expr } from './expr';
/**
 * Push a reference onto the stack corresponding to a statically known primitive
 * @param value A JavaScript primitive (undefined, null, boolean, number or string)
 */

export function PushPrimitiveReference(op, value) {
  PushPrimitive(op, value);
  op(31
  /* PrimitiveReference */
  );
}
/**
 * Push an encoded representation of a JavaScript primitive on the stack
 *
 * @param value A JavaScript primitive (undefined, null, boolean, number or string)
 */

export function PushPrimitive(op, primitive) {
  let p = primitive;

  if (typeof p === 'number') {
    p = isSmallInt(p) ? encodeImmediate(p) : nonSmallIntOperand(p);
  }

  op(30
  /* Primitive */
  , p);
}
/**
 * Invoke a foreign function (a "helper") based on a statically known handle
 *
 * @param op The op creation function
 * @param handle A handle
 * @param positional An optional list of expressions to compile
 * @param named An optional list of named arguments (name + expression) to compile
 */

export function Call(op, handle, positional, named) {
  op(0
  /* PushFrame */
  );
  SimpleArgs(op, positional, named, false);
  op(16
  /* Helper */
  , handle);
  op(1
  /* PopFrame */
  );
  op(36
  /* Fetch */
  , $v0);
}
/**
 * Invoke a foreign function (a "helper") based on a dynamically loaded definition
 *
 * @param op The op creation function
 * @param positional An optional list of expressions to compile
 * @param named An optional list of named arguments (name + expression) to compile
 */

export function CallDynamic(op, positional, named, append) {
  op(0
  /* PushFrame */
  );
  SimpleArgs(op, positional, named, false);
  op(33
  /* Dup */
  , $fp, 1);
  op(107
  /* DynamicHelper */
  );

  if (append) {
    op(36
    /* Fetch */
    , $v0);
    append();
    op(1
    /* PopFrame */
    );
    op(34
    /* Pop */
    , 1);
  } else {
    op(1
    /* PopFrame */
    );
    op(34
    /* Pop */
    , 1);
    op(36
    /* Fetch */
    , $v0);
  }
}
/**
 * Evaluate statements in the context of new dynamic scope entries. Move entries from the
 * stack into named entries in the dynamic scope, then evaluate the statements, then pop
 * the dynamic scope
 *
 * @param names a list of dynamic scope names
 * @param block a function that returns a list of statements to evaluate
 */

export function DynamicScope(op, names, block) {
  op(59
  /* PushDynamicScope */
  );
  op(58
  /* BindDynamicScope */
  , names);
  block();
  op(60
  /* PopDynamicScope */
  );
}
export function Curry(op, type, definition, positional, named) {
  op(0
  /* PushFrame */
  );
  SimpleArgs(op, positional, named, false);
  op(86
  /* CaptureArgs */
  );
  expr(op, definition);
  op(77
  /* Curry */
  , type, isStrictMode());
  op(1
  /* PopFrame */
  );
  op(36
  /* Fetch */
  , $v0);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL29wY29kZS1jb21waWxlci9saWIvb3Bjb2RlLWJ1aWxkZXIvaGVscGVycy92bS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxTQUFTLEdBQVQsRUFBYyxHQUFkLFFBQXlCLGFBQXpCO0FBU0EsU0FBUyxlQUFULEVBQTBCLFVBQTFCLFFBQTRDLGVBQTVDO0FBQ0EsU0FBUyxVQUFULFFBQTJCLFVBQTNCO0FBRUEsU0FBUyxZQUFULEVBQXVCLGtCQUF2QixRQUFpRCxhQUFqRDtBQUNBLFNBQVMsSUFBVCxRQUFxQixRQUFyQjtBQVVBOzs7OztBQUlBLE9BQU0sU0FBVSxzQkFBVixDQUFpQyxFQUFqQyxFQUF1RCxLQUF2RCxFQUF1RTtBQUMzRSxFQUFBLGFBQWEsQ0FBQyxFQUFELEVBQUssS0FBTCxDQUFiO0FBQ0EsRUFBQSxFQUFFLENBQUE7QUFBQTtBQUFBLEdBQUY7QUFDRDtBQUVEOzs7Ozs7QUFLQSxPQUFNLFNBQVUsYUFBVixDQUF3QixFQUF4QixFQUE4QyxTQUE5QyxFQUFrRTtBQUN0RSxNQUFJLENBQUMsR0FBbUMsU0FBeEM7O0FBRUEsTUFBSSxPQUFPLENBQVAsS0FBYSxRQUFqQixFQUEyQjtBQUN6QixJQUFBLENBQUMsR0FBRyxVQUFVLENBQUMsQ0FBRCxDQUFWLEdBQWdCLGVBQWUsQ0FBQyxDQUFELENBQS9CLEdBQXFDLGtCQUFrQixDQUFDLENBQUQsQ0FBM0Q7QUFDRDs7QUFFRCxFQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsSUFBZSxDQUFmLENBQUY7QUFDRDtBQUVEOzs7Ozs7Ozs7QUFRQSxPQUFNLFNBQVUsSUFBVixDQUNKLEVBREksRUFFSixNQUZJLEVBR0osVUFISSxFQUlKLEtBSkksRUFJdUI7QUFFM0IsRUFBQSxFQUFFLENBQUE7QUFBQTtBQUFBLEdBQUY7QUFDQSxFQUFBLFVBQVUsQ0FBQyxFQUFELEVBQUssVUFBTCxFQUFpQixLQUFqQixFQUF3QixLQUF4QixDQUFWO0FBQ0EsRUFBQSxFQUFFLENBQUE7QUFBQTtBQUFBLElBQVksTUFBWixDQUFGO0FBQ0EsRUFBQSxFQUFFLENBQUE7QUFBQTtBQUFBLEdBQUY7QUFDQSxFQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsSUFBVyxHQUFYLENBQUY7QUFDRDtBQUVEOzs7Ozs7OztBQU9BLE9BQU0sU0FBVSxXQUFWLENBQ0osRUFESSxFQUVKLFVBRkksRUFHSixLQUhJLEVBSUosTUFKSSxFQUllO0FBRW5CLEVBQUEsRUFBRSxDQUFBO0FBQUE7QUFBQSxHQUFGO0FBQ0EsRUFBQSxVQUFVLENBQUMsRUFBRCxFQUFLLFVBQUwsRUFBaUIsS0FBakIsRUFBd0IsS0FBeEIsQ0FBVjtBQUNBLEVBQUEsRUFBRSxDQUFBO0FBQUE7QUFBQSxJQUFTLEdBQVQsRUFBYyxDQUFkLENBQUY7QUFDQSxFQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsR0FBRjs7QUFDQSxNQUFJLE1BQUosRUFBWTtBQUNWLElBQUEsRUFBRSxDQUFBO0FBQUE7QUFBQSxNQUFXLEdBQVgsQ0FBRjtBQUNBLElBQUEsTUFBTTtBQUNOLElBQUEsRUFBRSxDQUFBO0FBQUE7QUFBQSxLQUFGO0FBQ0EsSUFBQSxFQUFFLENBQUE7QUFBQTtBQUFBLE1BQVMsQ0FBVCxDQUFGO0FBQ0QsR0FMRCxNQUtPO0FBQ0wsSUFBQSxFQUFFLENBQUE7QUFBQTtBQUFBLEtBQUY7QUFDQSxJQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsTUFBUyxDQUFULENBQUY7QUFDQSxJQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsTUFBVyxHQUFYLENBQUY7QUFDRDtBQUNGO0FBRUQ7Ozs7Ozs7OztBQVFBLE9BQU0sU0FBVSxZQUFWLENBQXVCLEVBQXZCLEVBQTRDLEtBQTVDLEVBQTZELEtBQTdELEVBQThFO0FBQ2xGLEVBQUEsRUFBRSxDQUFBO0FBQUE7QUFBQSxHQUFGO0FBQ0EsRUFBQSxFQUFFLENBQUE7QUFBQTtBQUFBLElBQXNCLEtBQXRCLENBQUY7QUFDQSxFQUFBLEtBQUs7QUFDTCxFQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsR0FBRjtBQUNEO0FBRUQsT0FBTSxTQUFVLEtBQVYsQ0FDSixFQURJLEVBRUosSUFGSSxFQUdKLFVBSEksRUFJSixVQUpJLEVBS0osS0FMSSxFQUt1QjtBQUUzQixFQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsR0FBRjtBQUNBLEVBQUEsVUFBVSxDQUFDLEVBQUQsRUFBSyxVQUFMLEVBQWlCLEtBQWpCLEVBQXdCLEtBQXhCLENBQVY7QUFDQSxFQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsR0FBRjtBQUNBLEVBQUEsSUFBSSxDQUFDLEVBQUQsRUFBSyxVQUFMLENBQUo7QUFDQSxFQUFBLEVBQUUsQ0FBQTtBQUFBO0FBQUEsSUFBVyxJQUFYLEVBQWlCLFlBQVksRUFBN0IsQ0FBRjtBQUNBLEVBQUEsRUFBRSxDQUFBO0FBQUE7QUFBQSxHQUFGO0FBQ0EsRUFBQSxFQUFFLENBQUE7QUFBQTtBQUFBLElBQVcsR0FBWCxDQUFGO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyAkZnAsICR2MCB9IGZyb20gJ0BnbGltbWVyL3ZtJztcbmltcG9ydCB7XG4gIE9wdGlvbixcbiAgT3AsXG4gIE1hY2hpbmVPcCxcbiAgV2lyZUZvcm1hdCxcbiAgTm9uU21hbGxJbnRPcGVyYW5kLFxuICBDdXJyaWVkVHlwZSxcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBlbmNvZGVJbW1lZGlhdGUsIGlzU21hbGxJbnQgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IFNpbXBsZUFyZ3MgfSBmcm9tICcuL3NoYXJlZCc7XG5pbXBvcnQgeyBQdXNoRXhwcmVzc2lvbk9wLCBQdXNoU3RhdGVtZW50T3AgfSBmcm9tICcuLi8uLi9zeW50YXgvY29tcGlsZXJzJztcbmltcG9ydCB7IGlzU3RyaWN0TW9kZSwgbm9uU21hbGxJbnRPcGVyYW5kIH0gZnJvbSAnLi4vb3BlcmFuZHMnO1xuaW1wb3J0IHsgZXhwciB9IGZyb20gJy4vZXhwcic7XG5cbmV4cG9ydCB0eXBlIFByaW1pdGl2ZSA9IHVuZGVmaW5lZCB8IG51bGwgfCBib29sZWFuIHwgbnVtYmVyIHwgc3RyaW5nO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbXBpbGVIZWxwZXIge1xuICBoYW5kbGU6IG51bWJlcjtcbiAgcG9zaXRpb25hbDogT3B0aW9uPFdpcmVGb3JtYXQuQ29yZS5QYXJhbXM+O1xuICBuYW1lZDogV2lyZUZvcm1hdC5Db3JlLkhhc2g7XG59XG5cbi8qKlxuICogUHVzaCBhIHJlZmVyZW5jZSBvbnRvIHRoZSBzdGFjayBjb3JyZXNwb25kaW5nIHRvIGEgc3RhdGljYWxseSBrbm93biBwcmltaXRpdmVcbiAqIEBwYXJhbSB2YWx1ZSBBIEphdmFTY3JpcHQgcHJpbWl0aXZlICh1bmRlZmluZWQsIG51bGwsIGJvb2xlYW4sIG51bWJlciBvciBzdHJpbmcpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBQdXNoUHJpbWl0aXZlUmVmZXJlbmNlKG9wOiBQdXNoRXhwcmVzc2lvbk9wLCB2YWx1ZTogUHJpbWl0aXZlKTogdm9pZCB7XG4gIFB1c2hQcmltaXRpdmUob3AsIHZhbHVlKTtcbiAgb3AoT3AuUHJpbWl0aXZlUmVmZXJlbmNlKTtcbn1cblxuLyoqXG4gKiBQdXNoIGFuIGVuY29kZWQgcmVwcmVzZW50YXRpb24gb2YgYSBKYXZhU2NyaXB0IHByaW1pdGl2ZSBvbiB0aGUgc3RhY2tcbiAqXG4gKiBAcGFyYW0gdmFsdWUgQSBKYXZhU2NyaXB0IHByaW1pdGl2ZSAodW5kZWZpbmVkLCBudWxsLCBib29sZWFuLCBudW1iZXIgb3Igc3RyaW5nKVxuICovXG5leHBvcnQgZnVuY3Rpb24gUHVzaFByaW1pdGl2ZShvcDogUHVzaEV4cHJlc3Npb25PcCwgcHJpbWl0aXZlOiBQcmltaXRpdmUpOiB2b2lkIHtcbiAgbGV0IHA6IFByaW1pdGl2ZSB8IE5vblNtYWxsSW50T3BlcmFuZCA9IHByaW1pdGl2ZTtcblxuICBpZiAodHlwZW9mIHAgPT09ICdudW1iZXInKSB7XG4gICAgcCA9IGlzU21hbGxJbnQocCkgPyBlbmNvZGVJbW1lZGlhdGUocCkgOiBub25TbWFsbEludE9wZXJhbmQocCk7XG4gIH1cblxuICBvcChPcC5QcmltaXRpdmUsIHApO1xufVxuXG4vKipcbiAqIEludm9rZSBhIGZvcmVpZ24gZnVuY3Rpb24gKGEgXCJoZWxwZXJcIikgYmFzZWQgb24gYSBzdGF0aWNhbGx5IGtub3duIGhhbmRsZVxuICpcbiAqIEBwYXJhbSBvcCBUaGUgb3AgY3JlYXRpb24gZnVuY3Rpb25cbiAqIEBwYXJhbSBoYW5kbGUgQSBoYW5kbGVcbiAqIEBwYXJhbSBwb3NpdGlvbmFsIEFuIG9wdGlvbmFsIGxpc3Qgb2YgZXhwcmVzc2lvbnMgdG8gY29tcGlsZVxuICogQHBhcmFtIG5hbWVkIEFuIG9wdGlvbmFsIGxpc3Qgb2YgbmFtZWQgYXJndW1lbnRzIChuYW1lICsgZXhwcmVzc2lvbikgdG8gY29tcGlsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gQ2FsbChcbiAgb3A6IFB1c2hFeHByZXNzaW9uT3AsXG4gIGhhbmRsZTogbnVtYmVyLFxuICBwb3NpdGlvbmFsOiBXaXJlRm9ybWF0LkNvcmUuUGFyYW1zLFxuICBuYW1lZDogV2lyZUZvcm1hdC5Db3JlLkhhc2hcbik6IHZvaWQge1xuICBvcChNYWNoaW5lT3AuUHVzaEZyYW1lKTtcbiAgU2ltcGxlQXJncyhvcCwgcG9zaXRpb25hbCwgbmFtZWQsIGZhbHNlKTtcbiAgb3AoT3AuSGVscGVyLCBoYW5kbGUpO1xuICBvcChNYWNoaW5lT3AuUG9wRnJhbWUpO1xuICBvcChPcC5GZXRjaCwgJHYwKTtcbn1cblxuLyoqXG4gKiBJbnZva2UgYSBmb3JlaWduIGZ1bmN0aW9uIChhIFwiaGVscGVyXCIpIGJhc2VkIG9uIGEgZHluYW1pY2FsbHkgbG9hZGVkIGRlZmluaXRpb25cbiAqXG4gKiBAcGFyYW0gb3AgVGhlIG9wIGNyZWF0aW9uIGZ1bmN0aW9uXG4gKiBAcGFyYW0gcG9zaXRpb25hbCBBbiBvcHRpb25hbCBsaXN0IG9mIGV4cHJlc3Npb25zIHRvIGNvbXBpbGVcbiAqIEBwYXJhbSBuYW1lZCBBbiBvcHRpb25hbCBsaXN0IG9mIG5hbWVkIGFyZ3VtZW50cyAobmFtZSArIGV4cHJlc3Npb24pIHRvIGNvbXBpbGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIENhbGxEeW5hbWljKFxuICBvcDogUHVzaEV4cHJlc3Npb25PcCxcbiAgcG9zaXRpb25hbDogV2lyZUZvcm1hdC5Db3JlLlBhcmFtcyxcbiAgbmFtZWQ6IFdpcmVGb3JtYXQuQ29yZS5IYXNoLFxuICBhcHBlbmQ/OiAoKSA9PiB2b2lkXG4pOiB2b2lkIHtcbiAgb3AoTWFjaGluZU9wLlB1c2hGcmFtZSk7XG4gIFNpbXBsZUFyZ3Mob3AsIHBvc2l0aW9uYWwsIG5hbWVkLCBmYWxzZSk7XG4gIG9wKE9wLkR1cCwgJGZwLCAxKTtcbiAgb3AoT3AuRHluYW1pY0hlbHBlcik7XG4gIGlmIChhcHBlbmQpIHtcbiAgICBvcChPcC5GZXRjaCwgJHYwKTtcbiAgICBhcHBlbmQoKTtcbiAgICBvcChNYWNoaW5lT3AuUG9wRnJhbWUpO1xuICAgIG9wKE9wLlBvcCwgMSk7XG4gIH0gZWxzZSB7XG4gICAgb3AoTWFjaGluZU9wLlBvcEZyYW1lKTtcbiAgICBvcChPcC5Qb3AsIDEpO1xuICAgIG9wKE9wLkZldGNoLCAkdjApO1xuICB9XG59XG5cbi8qKlxuICogRXZhbHVhdGUgc3RhdGVtZW50cyBpbiB0aGUgY29udGV4dCBvZiBuZXcgZHluYW1pYyBzY29wZSBlbnRyaWVzLiBNb3ZlIGVudHJpZXMgZnJvbSB0aGVcbiAqIHN0YWNrIGludG8gbmFtZWQgZW50cmllcyBpbiB0aGUgZHluYW1pYyBzY29wZSwgdGhlbiBldmFsdWF0ZSB0aGUgc3RhdGVtZW50cywgdGhlbiBwb3BcbiAqIHRoZSBkeW5hbWljIHNjb3BlXG4gKlxuICogQHBhcmFtIG5hbWVzIGEgbGlzdCBvZiBkeW5hbWljIHNjb3BlIG5hbWVzXG4gKiBAcGFyYW0gYmxvY2sgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYSBsaXN0IG9mIHN0YXRlbWVudHMgdG8gZXZhbHVhdGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIER5bmFtaWNTY29wZShvcDogUHVzaFN0YXRlbWVudE9wLCBuYW1lczogc3RyaW5nW10sIGJsb2NrOiAoKSA9PiB2b2lkKTogdm9pZCB7XG4gIG9wKE9wLlB1c2hEeW5hbWljU2NvcGUpO1xuICBvcChPcC5CaW5kRHluYW1pY1Njb3BlLCBuYW1lcyk7XG4gIGJsb2NrKCk7XG4gIG9wKE9wLlBvcER5bmFtaWNTY29wZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBDdXJyeShcbiAgb3A6IFB1c2hFeHByZXNzaW9uT3AsXG4gIHR5cGU6IEN1cnJpZWRUeXBlLFxuICBkZWZpbml0aW9uOiBXaXJlRm9ybWF0LkV4cHJlc3Npb24sXG4gIHBvc2l0aW9uYWw6IFdpcmVGb3JtYXQuQ29yZS5QYXJhbXMsXG4gIG5hbWVkOiBXaXJlRm9ybWF0LkNvcmUuSGFzaFxuKTogdm9pZCB7XG4gIG9wKE1hY2hpbmVPcC5QdXNoRnJhbWUpO1xuICBTaW1wbGVBcmdzKG9wLCBwb3NpdGlvbmFsLCBuYW1lZCwgZmFsc2UpO1xuICBvcChPcC5DYXB0dXJlQXJncyk7XG4gIGV4cHIob3AsIGRlZmluaXRpb24pO1xuICBvcChPcC5DdXJyeSwgdHlwZSwgaXNTdHJpY3RNb2RlKCkpO1xuICBvcChNYWNoaW5lT3AuUG9wRnJhbWUpO1xuICBvcChPcC5GZXRjaCwgJHYwKTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=