"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = templateFactory;
exports.templateCacheCounters = void 0;

var _util = require("@glimmer/util");

var _compilableTemplate = require("./compilable-template");

var _wrappedComponent = require("./wrapped-component");

function _defineProperties(target, props) {
  for (var i = 0; i < props.length; i++) {
    var descriptor = props[i];
    descriptor.enumerable = descriptor.enumerable || false;
    descriptor.configurable = true;
    if ("value" in descriptor) descriptor.writable = true;
    Object.defineProperty(target, descriptor.key, descriptor);
  }
}

function _createClass(Constructor, protoProps, staticProps) {
  if (protoProps) _defineProperties(Constructor.prototype, protoProps);
  if (staticProps) _defineProperties(Constructor, staticProps);
  return Constructor;
}

var clientId = 0;
var templateCacheCounters = {
  cacheHit: 0,
  cacheMiss: 0
};
/**
 * Wraps a template js in a template module to change it into a factory
 * that handles lazy parsing the template and to create per env singletons
 * of the template.
 */

exports.templateCacheCounters = templateCacheCounters;

function templateFactory(_ref) {
  var templateId = _ref.id,
      moduleName = _ref.moduleName,
      block = _ref.block,
      scope = _ref.scope,
      isStrictMode = _ref.isStrictMode; // TODO(template-refactors): This should be removed in the near future, as it
  // appears that id is unused. It is currently kept for backwards compat reasons.

  var id = templateId || "client-" + clientId++; // TODO: This caches JSON serialized output once in case a template is
  // compiled by multiple owners, but we haven't verified if this is actually
  // helpful. We should benchmark this in the future.

  var parsedBlock;
  var ownerlessTemplate = null;
  var templateCache = new WeakMap();

  var factory = function factory(owner) {
    if (parsedBlock === undefined) {
      parsedBlock = JSON.parse(block);
    }

    if (owner === undefined) {
      if (ownerlessTemplate === null) {
        templateCacheCounters.cacheMiss++;
        ownerlessTemplate = new TemplateImpl({
          id: id,
          block: parsedBlock,
          moduleName: moduleName,
          owner: null,
          scope: scope,
          isStrictMode: isStrictMode
        });
      } else {
        templateCacheCounters.cacheHit++;
      }

      return ownerlessTemplate;
    }

    var result = templateCache.get(owner);

    if (result === undefined) {
      templateCacheCounters.cacheMiss++;
      result = new TemplateImpl({
        id: id,
        block: parsedBlock,
        moduleName: moduleName,
        owner: owner,
        scope: scope,
        isStrictMode: isStrictMode
      });
      templateCache.set(owner, result);
    } else {
      templateCacheCounters.cacheHit++;
    }

    return result;
  };

  factory.__id = id;
  factory.__meta = {
    moduleName: moduleName
  };
  return factory;
}

var TemplateImpl = /*#__PURE__*/function () {
  function TemplateImpl(parsedLayout) {
    this.parsedLayout = parsedLayout;
    this.result = 'ok';
    this.layout = null;
    this.wrappedLayout = null;
  }

  var _proto = TemplateImpl.prototype;

  _proto.asLayout = function asLayout() {
    if (this.layout) return this.layout;
    return this.layout = (0, _compilableTemplate.compilable)((0, _util.assign)({}, this.parsedLayout), this.moduleName);
  };

  _proto.asWrappedLayout = function asWrappedLayout() {
    if (this.wrappedLayout) return this.wrappedLayout;
    return this.wrappedLayout = new _wrappedComponent.WrappedBuilder((0, _util.assign)({}, this.parsedLayout), this.moduleName);
  };

  _createClass(TemplateImpl, [{
    key: "moduleName",
    get: function get() {
      return this.parsedLayout.moduleName;
    }
  }, {
    key: "id",
    get: function get() {
      return this.parsedLayout.id;
    } // TODO(template-refactors): This should be removed in the near future, it is
    // only being exposed for backwards compatibility

  }, {
    key: "referrer",
    get: function get() {
      return {
        moduleName: this.parsedLayout.moduleName,
        owner: this.parsedLayout.owner
      };
    }
  }]);

  return TemplateImpl;
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL29wY29kZS1jb21waWxlci9saWIvdGVtcGxhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFXQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsSUFBSSxRQUFRLEdBQVosQ0FBQTtBQUVPLElBQUkscUJBQXFCLEdBQUc7QUFDakMsRUFBQSxRQUFRLEVBRHlCLENBQUE7QUFFakMsRUFBQSxTQUFTLEVBQUU7QUFGc0IsQ0FBNUI7QUFtQlA7Ozs7Ozs7O0FBS2MsU0FBQSxlQUFBLENBQUEsSUFBQSxFQU1vQjtBQUFBLE1BTk0sVUFNTixHQUFBLElBQUEsQ0FMaEMsRUFLZ0M7QUFBQSxNQU5NLFVBTU4sR0FBQSxJQUFBLENBTk0sVUFNTjtBQUFBLE1BTk0sS0FNTixHQUFBLElBQUEsQ0FOTSxLQU1OO0FBQUEsTUFOTSxLQU1OLEdBQUEsSUFBQSxDQU5NLEtBTU47QUFBQSxNQURoQyxZQUNnQyxHQUFBLElBQUEsQ0FEaEMsWUFDZ0MsQ0FBQSxDQUNoQztBQUNBOztBQUNBLE1BQUksRUFBRSxHQUFHLFVBQVUsSUFBQSxZQUFjLFFBSEQsRUFHaEMsQ0FIZ0MsQ0FLaEM7QUFDQTtBQUNBOztBQUNBLE1BQUEsV0FBQTtBQUVBLE1BQUksaUJBQWlCLEdBQXJCLElBQUE7QUFDQSxNQUFJLGFBQWEsR0FBRyxJQUFwQixPQUFvQixFQUFwQjs7QUFFQSxNQUFJLE9BQU8sR0FBa0MsU0FBekMsT0FBeUMsQ0FBRCxLQUFDLEVBQWlCO0FBQzVELFFBQUksV0FBVyxLQUFmLFNBQUEsRUFBK0I7QUFDN0IsTUFBQSxXQUFXLEdBQUcsSUFBSSxDQUFKLEtBQUEsQ0FBZCxLQUFjLENBQWQ7QUFDRDs7QUFFRCxRQUFJLEtBQUssS0FBVCxTQUFBLEVBQXlCO0FBQ3ZCLFVBQUksaUJBQWlCLEtBQXJCLElBQUEsRUFBZ0M7QUFDOUIsUUFBQSxxQkFBcUIsQ0FBckIsU0FBQTtBQUNBLFFBQUEsaUJBQWlCLEdBQUcsSUFBQSxZQUFBLENBQWlCO0FBQ25DLFVBQUEsRUFEbUMsRUFBQSxFQUFBO0FBRW5DLFVBQUEsS0FBSyxFQUY4QixXQUFBO0FBR25DLFVBQUEsVUFIbUMsRUFBQSxVQUFBO0FBSW5DLFVBQUEsS0FBSyxFQUo4QixJQUFBO0FBS25DLFVBQUEsS0FMbUMsRUFBQSxLQUFBO0FBTW5DLFVBQUEsWUFBQSxFQUFBO0FBTm1DLFNBQWpCLENBQXBCO0FBRkYsT0FBQSxNQVVPO0FBQ0wsUUFBQSxxQkFBcUIsQ0FBckIsUUFBQTtBQUNEOztBQUVELGFBQUEsaUJBQUE7QUFDRDs7QUFFRCxRQUFJLE1BQU0sR0FBRyxhQUFhLENBQWIsR0FBQSxDQUFiLEtBQWEsQ0FBYjs7QUFFQSxRQUFJLE1BQU0sS0FBVixTQUFBLEVBQTBCO0FBQ3hCLE1BQUEscUJBQXFCLENBQXJCLFNBQUE7QUFDQSxNQUFBLE1BQU0sR0FBRyxJQUFBLFlBQUEsQ0FBaUI7QUFBRSxRQUFBLEVBQUYsRUFBQSxFQUFBO0FBQU0sUUFBQSxLQUFLLEVBQVgsV0FBQTtBQUEwQixRQUFBLFVBQTFCLEVBQUEsVUFBQTtBQUFzQyxRQUFBLEtBQXRDLEVBQUEsS0FBQTtBQUE2QyxRQUFBLEtBQTdDLEVBQUEsS0FBQTtBQUFvRCxRQUFBLFlBQUEsRUFBQTtBQUFwRCxPQUFqQixDQUFUO0FBQ0EsTUFBQSxhQUFhLENBQWIsR0FBQSxDQUFBLEtBQUEsRUFBQSxNQUFBO0FBSEYsS0FBQSxNQUlPO0FBQ0wsTUFBQSxxQkFBcUIsQ0FBckIsUUFBQTtBQUNEOztBQUVELFdBQUEsTUFBQTtBQWpDRixHQUFBOztBQW9DQSxFQUFBLE9BQU8sQ0FBUCxJQUFBLEdBQUEsRUFBQTtBQUNBLEVBQUEsT0FBTyxDQUFQLE1BQUEsR0FBaUI7QUFBRSxJQUFBLFVBQUEsRUFBQTtBQUFGLEdBQWpCO0FBRUEsU0FBQSxPQUFBO0FBQ0Q7O0lBRUQsWTtBQU1FLFdBQUEsWUFBQSxDQUFBLFlBQUEsRUFBbUQ7QUFBL0IsU0FBQSxZQUFBLEdBQUEsWUFBQTtBQUxYLFNBQUEsTUFBQSxHQUFBLElBQUE7QUFFRCxTQUFBLE1BQUEsR0FBQSxJQUFBO0FBQ0EsU0FBQSxhQUFBLEdBQUEsSUFBQTtBQUUrQzs7OztTQW1CdkQsUSxHQUFBLFNBQUEsUUFBQSxHQUFRO0FBQ04sUUFBSSxLQUFKLE1BQUEsRUFBaUIsT0FBTyxLQUFQLE1BQUE7QUFDakIsV0FBUSxLQUFBLE1BQUEsR0FBYyxvQ0FBVyxrQkFBTSxFQUFOLEVBQVcsS0FBWixZQUFDLENBQVgsRUFBMEMsS0FBaEUsVUFBc0IsQ0FBdEI7OztTQUdGLGUsR0FBQSxTQUFBLGVBQUEsR0FBZTtBQUNiLFFBQUksS0FBSixhQUFBLEVBQXdCLE9BQU8sS0FBUCxhQUFBO0FBQ3hCLFdBQVEsS0FBQSxhQUFBLEdBQXFCLElBQUEsZ0NBQUEsQ0FDM0Isa0JBQU0sRUFBTixFQUFXLEtBRGdCLFlBQzNCLENBRDJCLEVBRTNCLEtBRkYsVUFBNkIsQ0FBN0I7Ozs7O3dCQXhCWTtBQUNaLGFBQU8sS0FBQSxZQUFBLENBQVAsVUFBQTtBQUNEOzs7d0JBRUs7QUFDSixhQUFPLEtBQUEsWUFBQSxDQUFQLEVBQUE7TUFHRjtBQUNBOzs7O3dCQUNZO0FBQ1YsYUFBTztBQUNMLFFBQUEsVUFBVSxFQUFFLEtBQUEsWUFBQSxDQURQLFVBQUE7QUFFTCxRQUFBLEtBQUssRUFBRSxLQUFBLFlBQUEsQ0FBa0I7QUFGcEIsT0FBUDtBQUlEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcGlsYWJsZVByb2dyYW0sXG4gIExheW91dFdpdGhDb250ZXh0LFxuICBPcHRpb24sXG4gIE93bmVyLFxuICBTZXJpYWxpemVkVGVtcGxhdGVCbG9jayxcbiAgU2VyaWFsaXplZFRlbXBsYXRlV2l0aExhenlCbG9jayxcbiAgVGVtcGxhdGUsXG4gIFRlbXBsYXRlRmFjdG9yeSxcbiAgVGVtcGxhdGVPayxcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBhc3NpZ24gfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IGNvbXBpbGFibGUgfSBmcm9tICcuL2NvbXBpbGFibGUtdGVtcGxhdGUnO1xuaW1wb3J0IHsgV3JhcHBlZEJ1aWxkZXIgfSBmcm9tICcuL3dyYXBwZWQtY29tcG9uZW50JztcblxubGV0IGNsaWVudElkID0gMDtcblxuZXhwb3J0IGxldCB0ZW1wbGF0ZUNhY2hlQ291bnRlcnMgPSB7XG4gIGNhY2hlSGl0OiAwLFxuICBjYWNoZU1pc3M6IDAsXG59O1xuXG4vLyBUaGVzZSBpbnRlcmZhY2VzIGFyZSBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIHNvbWUgYWRkb25zIHVzZSB0aGVzZSBpbnRpbWF0ZSBBUElzXG5leHBvcnQgaW50ZXJmYWNlIFRlbXBsYXRlRmFjdG9yeVdpdGhJZEFuZE1ldGEgZXh0ZW5kcyBUZW1wbGF0ZUZhY3Rvcnkge1xuICBfX2lkPzogc3RyaW5nO1xuICBfX21ldGE/OiB7IG1vZHVsZU5hbWU6IHN0cmluZyB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRlbXBsYXRlV2l0aElkQW5kUmVmZXJyZXIgZXh0ZW5kcyBUZW1wbGF0ZU9rIHtcbiAgaWQ6IHN0cmluZztcbiAgcmVmZXJyZXI6IHtcbiAgICBtb2R1bGVOYW1lOiBzdHJpbmc7XG4gICAgb3duZXI6IE93bmVyIHwgbnVsbDtcbiAgfTtcbn1cblxuLyoqXG4gKiBXcmFwcyBhIHRlbXBsYXRlIGpzIGluIGEgdGVtcGxhdGUgbW9kdWxlIHRvIGNoYW5nZSBpdCBpbnRvIGEgZmFjdG9yeVxuICogdGhhdCBoYW5kbGVzIGxhenkgcGFyc2luZyB0aGUgdGVtcGxhdGUgYW5kIHRvIGNyZWF0ZSBwZXIgZW52IHNpbmdsZXRvbnNcbiAqIG9mIHRoZSB0ZW1wbGF0ZS5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdGVtcGxhdGVGYWN0b3J5KHtcbiAgaWQ6IHRlbXBsYXRlSWQsXG4gIG1vZHVsZU5hbWUsXG4gIGJsb2NrLFxuICBzY29wZSxcbiAgaXNTdHJpY3RNb2RlLFxufTogU2VyaWFsaXplZFRlbXBsYXRlV2l0aExhenlCbG9jayk6IFRlbXBsYXRlRmFjdG9yeSB7XG4gIC8vIFRPRE8odGVtcGxhdGUtcmVmYWN0b3JzKTogVGhpcyBzaG91bGQgYmUgcmVtb3ZlZCBpbiB0aGUgbmVhciBmdXR1cmUsIGFzIGl0XG4gIC8vIGFwcGVhcnMgdGhhdCBpZCBpcyB1bnVzZWQuIEl0IGlzIGN1cnJlbnRseSBrZXB0IGZvciBiYWNrd2FyZHMgY29tcGF0IHJlYXNvbnMuXG4gIGxldCBpZCA9IHRlbXBsYXRlSWQgfHwgYGNsaWVudC0ke2NsaWVudElkKyt9YDtcblxuICAvLyBUT0RPOiBUaGlzIGNhY2hlcyBKU09OIHNlcmlhbGl6ZWQgb3V0cHV0IG9uY2UgaW4gY2FzZSBhIHRlbXBsYXRlIGlzXG4gIC8vIGNvbXBpbGVkIGJ5IG11bHRpcGxlIG93bmVycywgYnV0IHdlIGhhdmVuJ3QgdmVyaWZpZWQgaWYgdGhpcyBpcyBhY3R1YWxseVxuICAvLyBoZWxwZnVsLiBXZSBzaG91bGQgYmVuY2htYXJrIHRoaXMgaW4gdGhlIGZ1dHVyZS5cbiAgbGV0IHBhcnNlZEJsb2NrOiBTZXJpYWxpemVkVGVtcGxhdGVCbG9jaztcblxuICBsZXQgb3duZXJsZXNzVGVtcGxhdGU6IFRlbXBsYXRlIHwgbnVsbCA9IG51bGw7XG4gIGxldCB0ZW1wbGF0ZUNhY2hlID0gbmV3IFdlYWtNYXA8b2JqZWN0LCBUZW1wbGF0ZT4oKTtcblxuICBsZXQgZmFjdG9yeTogVGVtcGxhdGVGYWN0b3J5V2l0aElkQW5kTWV0YSA9IChvd25lcj86IE93bmVyKSA9PiB7XG4gICAgaWYgKHBhcnNlZEJsb2NrID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHBhcnNlZEJsb2NrID0gSlNPTi5wYXJzZShibG9jayk7XG4gICAgfVxuXG4gICAgaWYgKG93bmVyID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmIChvd25lcmxlc3NUZW1wbGF0ZSA9PT0gbnVsbCkge1xuICAgICAgICB0ZW1wbGF0ZUNhY2hlQ291bnRlcnMuY2FjaGVNaXNzKys7XG4gICAgICAgIG93bmVybGVzc1RlbXBsYXRlID0gbmV3IFRlbXBsYXRlSW1wbCh7XG4gICAgICAgICAgaWQsXG4gICAgICAgICAgYmxvY2s6IHBhcnNlZEJsb2NrLFxuICAgICAgICAgIG1vZHVsZU5hbWUsXG4gICAgICAgICAgb3duZXI6IG51bGwsXG4gICAgICAgICAgc2NvcGUsXG4gICAgICAgICAgaXNTdHJpY3RNb2RlLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRlbXBsYXRlQ2FjaGVDb3VudGVycy5jYWNoZUhpdCsrO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gb3duZXJsZXNzVGVtcGxhdGU7XG4gICAgfVxuXG4gICAgbGV0IHJlc3VsdCA9IHRlbXBsYXRlQ2FjaGUuZ2V0KG93bmVyKSBhcyBUZW1wbGF0ZTtcblxuICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGVtcGxhdGVDYWNoZUNvdW50ZXJzLmNhY2hlTWlzcysrO1xuICAgICAgcmVzdWx0ID0gbmV3IFRlbXBsYXRlSW1wbCh7IGlkLCBibG9jazogcGFyc2VkQmxvY2ssIG1vZHVsZU5hbWUsIG93bmVyLCBzY29wZSwgaXNTdHJpY3RNb2RlIH0pO1xuICAgICAgdGVtcGxhdGVDYWNoZS5zZXQob3duZXIsIHJlc3VsdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRlbXBsYXRlQ2FjaGVDb3VudGVycy5jYWNoZUhpdCsrO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgZmFjdG9yeS5fX2lkID0gaWQ7XG4gIGZhY3RvcnkuX19tZXRhID0geyBtb2R1bGVOYW1lIH07XG5cbiAgcmV0dXJuIGZhY3Rvcnk7XG59XG5cbmNsYXNzIFRlbXBsYXRlSW1wbCBpbXBsZW1lbnRzIFRlbXBsYXRlV2l0aElkQW5kUmVmZXJyZXIge1xuICByZWFkb25seSByZXN1bHQgPSAnb2snO1xuXG4gIHByaXZhdGUgbGF5b3V0OiBPcHRpb248Q29tcGlsYWJsZVByb2dyYW0+ID0gbnVsbDtcbiAgcHJpdmF0ZSB3cmFwcGVkTGF5b3V0OiBPcHRpb248Q29tcGlsYWJsZVByb2dyYW0+ID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBhcnNlZExheW91dDogTGF5b3V0V2l0aENvbnRleHQpIHt9XG5cbiAgZ2V0IG1vZHVsZU5hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFyc2VkTGF5b3V0Lm1vZHVsZU5hbWU7XG4gIH1cblxuICBnZXQgaWQoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFyc2VkTGF5b3V0LmlkO1xuICB9XG5cbiAgLy8gVE9ETyh0ZW1wbGF0ZS1yZWZhY3RvcnMpOiBUaGlzIHNob3VsZCBiZSByZW1vdmVkIGluIHRoZSBuZWFyIGZ1dHVyZSwgaXQgaXNcbiAgLy8gb25seSBiZWluZyBleHBvc2VkIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eVxuICBnZXQgcmVmZXJyZXIoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG1vZHVsZU5hbWU6IHRoaXMucGFyc2VkTGF5b3V0Lm1vZHVsZU5hbWUsXG4gICAgICBvd25lcjogdGhpcy5wYXJzZWRMYXlvdXQub3duZXIsXG4gICAgfTtcbiAgfVxuXG4gIGFzTGF5b3V0KCk6IENvbXBpbGFibGVQcm9ncmFtIHtcbiAgICBpZiAodGhpcy5sYXlvdXQpIHJldHVybiB0aGlzLmxheW91dDtcbiAgICByZXR1cm4gKHRoaXMubGF5b3V0ID0gY29tcGlsYWJsZShhc3NpZ24oe30sIHRoaXMucGFyc2VkTGF5b3V0KSwgdGhpcy5tb2R1bGVOYW1lKSk7XG4gIH1cblxuICBhc1dyYXBwZWRMYXlvdXQoKTogQ29tcGlsYWJsZVByb2dyYW0ge1xuICAgIGlmICh0aGlzLndyYXBwZWRMYXlvdXQpIHJldHVybiB0aGlzLndyYXBwZWRMYXlvdXQ7XG4gICAgcmV0dXJuICh0aGlzLndyYXBwZWRMYXlvdXQgPSBuZXcgV3JhcHBlZEJ1aWxkZXIoXG4gICAgICBhc3NpZ24oe30sIHRoaXMucGFyc2VkTGF5b3V0KSxcbiAgICAgIHRoaXMubW9kdWxlTmFtZVxuICAgICkpO1xuICB9XG59XG4iXSwic291cmNlUm9vdCI6IiJ9