"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.encodeOp = encodeOp;
exports.EncoderImpl = exports.Labels = void 0;

var _encoder = require("@glimmer/encoder");

var _vm = require("@glimmer/vm");

var _util = require("@glimmer/util");

var _resolution = require("./helpers/resolution");

var _compilableTemplate = require("../compilable-template");

var _env = require("@glimmer/env");

function _defineProperties(target, props) {
  for (var i = 0; i < props.length; i++) {
    var descriptor = props[i];
    descriptor.enumerable = descriptor.enumerable || false;
    descriptor.configurable = true;
    if ("value" in descriptor) descriptor.writable = true;
    Object.defineProperty(target, descriptor.key, descriptor);
  }
}

function _createClass(Constructor, protoProps, staticProps) {
  if (protoProps) _defineProperties(Constructor.prototype, protoProps);
  if (staticProps) _defineProperties(Constructor, staticProps);
  return Constructor;
}

var Labels = /*#__PURE__*/function () {
  function Labels() {
    this.labels = (0, _util.dict)();
    this.targets = [];
  }

  var _proto = Labels.prototype;

  _proto.label = function label(name, index) {
    this.labels[name] = index;
  };

  _proto.target = function target(at, _target) {
    this.targets.push({
      at: at,
      target: _target
    });
  };

  _proto.patch = function patch(heap) {
    var targets = this.targets,
        labels = this.labels;

    for (var i = 0; i < targets.length; i++) {
      var _targets$i = targets[i],
          at = _targets$i.at,
          target = _targets$i.target;
      var address = labels[target] - at;
      false && (0, _util.assert)(heap.getbyaddr(at) === -1, 'Expected heap to contain a placeholder, but it did not');
      heap.setbyaddr(at, address);
    }
  };

  return Labels;
}();

exports.Labels = Labels;

function encodeOp(encoder, constants, resolver, meta, op) {
  if (isBuilderOpcode(op[0])) {
    var type = op[0],
        operands = op.slice(1);
    encoder.push.apply(encoder, [constants, type].concat(operands));
  } else {
    switch (op[0]) {
      case 1000
      /* Label */
      :
        return encoder.label(op[1]);

      case 1001
      /* StartLabels */
      :
        return encoder.startLabels();

      case 1002
      /* StopLabels */
      :
        return encoder.stopLabels();

      case 1004
      /* ResolveComponent */
      :
        return (0, _resolution.resolveComponent)(resolver, constants, meta, op);

      case 1003
      /* ResolveModifier */
      :
        return (0, _resolution.resolveModifier)(resolver, constants, meta, op);

      case 1005
      /* ResolveHelper */
      :
        return (0, _resolution.resolveHelper)(resolver, constants, meta, op);

      case 1007
      /* ResolveComponentOrHelper */
      :
        return (0, _resolution.resolveComponentOrHelper)(resolver, constants, meta, op);

      case 1006
      /* ResolveOptionalHelper */
      :
        return (0, _resolution.resolveOptionalHelper)(resolver, constants, meta, op);

      case 1008
      /* ResolveOptionalComponentOrHelper */
      :
        return (0, _resolution.resolveOptionalComponentOrHelper)(resolver, constants, meta, op);

      case 1010
      /* ResolveLocal */
      :
        var freeVar = op[1];
        var name = meta.upvars[freeVar];
        var andThen = op[2];
        andThen(name, meta.moduleName);
        break;

      case 1011
      /* ResolveTemplateLocal */
      :
        var valueIndex = op[1],
            then = op[2];
        var value = meta.scopeValues[valueIndex];
        then(constants.value(value));
        break;

      case 1009
      /* ResolveFree */
      :
        if (_env.DEBUG) {
          var upvarIndex = op[1];
          var freeName = meta.upvars[upvarIndex];
          throw new Error("Attempted to resolve a value in a strict mode template, but that value was not in scope: " + freeName);
        }

        break;

      default:
        throw new Error("Unexpected high level opcode " + op[0]);
    }
  }
}

var EncoderImpl = /*#__PURE__*/function () {
  function EncoderImpl(heap, meta, stdlib) {
    this.heap = heap;
    this.meta = meta;
    this.stdlib = stdlib;
    this.labelsStack = new _util.Stack();
    this.encoder = new _encoder.InstructionEncoderImpl([]);
    this.errors = [];
    this.handle = heap.malloc();
  }

  var _proto2 = EncoderImpl.prototype;

  _proto2.error = function error(_error) {
    this.encoder.encode(30
    /* Primitive */
    , 0);
    this.errors.push(_error);
  };

  _proto2.commit = function commit(size) {
    var handle = this.handle;
    this.heap.push(5
    /* Return */
    | 1024
    /* MACHINE_MASK */
    );
    this.heap.finishMalloc(handle, size);

    if (this.errors.length) {
      return {
        errors: this.errors,
        handle: handle
      };
    } else {
      return handle;
    }
  };

  _proto2.push = function push(constants, type) {
    var heap = this.heap;

    if (_env.DEBUG && type > 255
    /* TYPE_SIZE */
    ) {
        throw new Error("Opcode type over 8-bits. Got " + type + ".");
      }

    var machine = (0, _vm.isMachineOp)(type) ? 1024
    /* MACHINE_MASK */
    : 0;
    var first = type | machine | (arguments.length <= 2 ? 0 : arguments.length - 2) << 8
    /* ARG_SHIFT */
    ;
    heap.push(first);

    for (var i = 0; i < (arguments.length <= 2 ? 0 : arguments.length - 2); i++) {
      var op = i + 2 < 2 || arguments.length <= i + 2 ? undefined : arguments[i + 2];
      heap.push(this.operand(constants, op));
    }
  };

  _proto2.operand = function operand(constants, _operand) {
    if (typeof _operand === 'number') {
      return _operand;
    }

    if (typeof _operand === 'object' && _operand !== null) {
      if (Array.isArray(_operand)) {
        return (0, _util.encodeHandle)(constants.array(_operand));
      } else {
        switch (_operand.type) {
          case 1
          /* Label */
          :
            this.currentLabels.target(this.heap.offset, _operand.value);
            return -1;

          case 2
          /* IsStrictMode */
          :
            return (0, _util.encodeHandle)(constants.value(this.meta.isStrictMode));

          case 3
          /* EvalSymbols */
          :
            return (0, _util.encodeHandle)(constants.array(this.meta.evalSymbols || _util.EMPTY_STRING_ARRAY));

          case 4
          /* Block */
          :
            return (0, _util.encodeHandle)(constants.value((0, _compilableTemplate.compilableBlock)(_operand.value, this.meta)));

          case 5
          /* StdLib */
          :
            return this.stdlib[_operand.value];

          case 6
          /* NonSmallInt */
          :
          case 7
          /* SymbolTable */
          :
          case 8
          /* Layout */
          :
            return constants.value(_operand.value);
        }
      }
    }

    return (0, _util.encodeHandle)(constants.value(_operand));
  };

  _proto2.label = function label(name) {
    this.currentLabels.label(name, this.heap.offset + 1);
  };

  _proto2.startLabels = function startLabels() {
    this.labelsStack.push(new Labels());
  };

  _proto2.stopLabels = function stopLabels() {
    var label = this.labelsStack.pop();
    label.patch(this.heap);
  };

  _createClass(EncoderImpl, [{
    key: "currentLabels",
    get: function get() {
      return this.labelsStack.current;
    }
  }]);

  return EncoderImpl;
}();

exports.EncoderImpl = EncoderImpl;

function isBuilderOpcode(op) {
  return op < 1000
  /* Start */
  ;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL29wY29kZS1jb21waWxlci9saWIvb3Bjb2RlLWJ1aWxkZXIvZW5jb2Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOztBQXlCQTs7QUFDQTs7QUFDQTs7QUFRQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTSxNQUFOLEdBQUEsYUFBQSxZQUFBO0FBQUEsV0FBQSxNQUFBLEdBQUE7QUFDRSxTQUFBLE1BQUEsR0FBQSxpQkFBQTtBQUNBLFNBQUEsT0FBQSxHQUFBLEVBQUE7QUFxQkQ7O0FBdkJELE1BQUEsTUFBQSxHQUFBLE1BQUEsQ0FBQSxTQUFBOztBQUFBLEVBQUEsTUFBQSxDQUFBLEtBQUEsR0FJRSxTQUFBLEtBQUEsQ0FBQSxJQUFBLEVBQUEsS0FBQSxFQUFpQztBQUMvQixTQUFBLE1BQUEsQ0FBQSxJQUFBLElBQUEsS0FBQTtBQUxKLEdBQUE7O0FBQUEsRUFBQSxNQUFBLENBQUEsTUFBQSxHQVFFLFNBQUEsTUFBQSxDQUFBLEVBQUEsRUFBQSxPQUFBLEVBQWlDO0FBQy9CLFNBQUEsT0FBQSxDQUFBLElBQUEsQ0FBa0I7QUFBRSxNQUFBLEVBQUYsRUFBQSxFQUFBO0FBQU0sTUFBQSxNQUFBLEVBQUE7QUFBTixLQUFsQjtBQVRKLEdBQUE7O0FBQUEsRUFBQSxNQUFBLENBQUEsS0FBQSxHQVlFLFNBQUEsS0FBQSxDQUFBLElBQUEsRUFBMkI7QUFBQSxRQUNyQixPQURxQixHQUFBLEtBQUEsT0FBQTtBQUFBLFFBQ1YsTUFEVSxHQUFBLEtBQUEsTUFBQTs7QUFFekIsU0FBSyxJQUFJLENBQUMsR0FBVixDQUFBLEVBQWdCLENBQUMsR0FBRyxPQUFPLENBQTNCLE1BQUEsRUFBb0MsQ0FBcEMsRUFBQSxFQUF5QztBQUFBLFVBQUEsVUFBQSxHQUNsQixPQUFPLENBRFcsQ0FDWCxDQURXO0FBQUEsVUFDbkMsRUFEbUMsR0FBQSxVQUFBLENBQUEsRUFBQTtBQUFB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LG1CQUFPLFNBQVMsQ0FBVCxLQUFBLENBQWdCLFFBQU8sQ0FBOUIsS0FBTyxDQUFQO0FBdkJKO0FBeUJEO0FBQ0Y7O0FBRUQsV0FBTyx3QkFBYSxTQUFTLENBQVQsS0FBQSxDQUFwQixRQUFvQixDQUFiLENBQVA7QUEzRkosR0FBQTs7QUFBQSxFQUFBLE9BQUEsQ0FBQSxLQUFBLEdBa0dFLFNBQUEsS0FBQSxDQUFBLElBQUEsRUFBa0I7QUFDaEIsU0FBQSxhQUFBLENBQUEsS0FBQSxDQUFBLElBQUEsRUFBK0IsS0FBQSxJQUFBLENBQUEsTUFBQSxHQUEvQixDQUFBO0FBbkdKLEdBQUE7O0FBQUEsRUFBQSxPQUFBLENBQUEsV0FBQSxHQXNHRSxTQUFBLFdBQUEsR0FBVztBQUNULFNBQUEsV0FBQSxDQUFBLElBQUEsQ0FBc0IsSUFBdEIsTUFBc0IsRUFBdEI7QUF2R0osR0FBQTs7QUFBQSxFQUFBLE9BQUEsQ0FBQSxVQUFBLEdBMEdFLFNBQUEsVUFBQSxHQUFVO0FBQ1IsUUFBSSxLQUFLLEdBQVUsS0FBQSxXQUFBLENBQW5CLEdBQW1CLEVBQW5CO0FBQ0EsSUFBQSxLQUFLLENBQUwsS0FBQSxDQUFZLEtBQVosSUFBQTtBQTVHSixHQUFBOztBQUFBLEVBQUEsWUFBQSxDQUFBLFdBQUEsRUFBQSxDQUFBO0FBQUEsSUFBQSxHQUFBLEVBQUEsZUFBQTtBQUFBLElBQUEsR0FBQSxFQUFBLFNBQUEsR0FBQSxHQThGMkI7QUFDdkIsYUFBYyxLQUFBLFdBQUEsQ0FBZCxPQUFBO0FBQ0Q7QUFoR0gsR0FBQSxDQUFBLENBQUE7O0FBQUEsU0FBQSxXQUFBO0FBQUEsQ0FBQSxFQUFBOzs7O0FBZ0hBLFNBQUEsZUFBQSxDQUFBLEVBQUEsRUFBbUM7QUFDakMsU0FBTyxFQUFFLEdBQUE7QUFBQTtBQUFUO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbnN0cnVjdGlvbkVuY29kZXJJbXBsIH0gZnJvbSAnQGdsaW1tZXIvZW5jb2Rlcic7XG5pbXBvcnQge1xuICBDb21waWxlVGltZUNvbnN0YW50cyxcbiAgT3BlcmFuZCxcbiAgQ29tcGlsZVRpbWVIZWFwLFxuICBPcCxcbiAgQnVpbGRlck9wY29kZSxcbiAgSGlnaExldmVsQnVpbGRlck9wY29kZSxcbiAgTWFjaGluZU9wLFxuICBTaW5nbGVCdWlsZGVyT3BlcmFuZCxcbiAgRW5jb2RlcixcbiAgSGlnaExldmVsUmVzb2x1dGlvbk9wY29kZSxcbiAgSGlnaExldmVsT3AsXG4gIE9wY29kZVNpemUsXG4gIEluc3RydWN0aW9uRW5jb2RlcixcbiAgRGljdCxcbiAgRW5jb2RlckVycm9yLFxuICBIYW5kbGVSZXN1bHQsXG4gIEJ1aWxkZXJPcCxcbiAgQ29tcGlsZVRpbWVSZXNvbHZlcixcbiAgQ29udGFpbmluZ01ldGFkYXRhLFxuICBIaWdoTGV2ZWxPcGVyYW5kLFxuICBTVERMaWIsXG4gIFJlc29sdXRpb25UaW1lQ29uc3RhbnRzLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGlzTWFjaGluZU9wIH0gZnJvbSAnQGdsaW1tZXIvdm0nO1xuaW1wb3J0IHsgU3RhY2ssIGRpY3QsIGV4cGVjdCwgRU1QVFlfU1RSSU5HX0FSUkFZLCBlbmNvZGVIYW5kbGUsIGFzc2VydCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHtcbiAgcmVzb2x2ZUNvbXBvbmVudCxcbiAgcmVzb2x2ZUNvbXBvbmVudE9ySGVscGVyLFxuICByZXNvbHZlSGVscGVyLFxuICByZXNvbHZlTW9kaWZpZXIsXG4gIHJlc29sdmVPcHRpb25hbENvbXBvbmVudE9ySGVscGVyLFxuICByZXNvbHZlT3B0aW9uYWxIZWxwZXIsXG59IGZyb20gJy4vaGVscGVycy9yZXNvbHV0aW9uJztcbmltcG9ydCB7IGNvbXBpbGFibGVCbG9jayB9IGZyb20gJy4uL2NvbXBpbGFibGUtdGVtcGxhdGUnO1xuaW1wb3J0IHsgREVCVUcgfSBmcm9tICdAZ2xpbW1lci9lbnYnO1xuXG5leHBvcnQgY2xhc3MgTGFiZWxzIHtcbiAgbGFiZWxzOiBEaWN0PG51bWJlcj4gPSBkaWN0KCk7XG4gIHRhcmdldHM6IEFycmF5PHsgYXQ6IG51bWJlcjsgdGFyZ2V0OiBzdHJpbmcgfT4gPSBbXTtcblxuICBsYWJlbChuYW1lOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpIHtcbiAgICB0aGlzLmxhYmVsc1tuYW1lXSA9IGluZGV4O1xuICB9XG5cbiAgdGFyZ2V0KGF0OiBudW1iZXIsIHRhcmdldDogc3RyaW5nKSB7XG4gICAgdGhpcy50YXJnZXRzLnB1c2goeyBhdCwgdGFyZ2V0IH0pO1xuICB9XG5cbiAgcGF0Y2goaGVhcDogQ29tcGlsZVRpbWVIZWFwKTogdm9pZCB7XG4gICAgbGV0IHsgdGFyZ2V0cywgbGFiZWxzIH0gPSB0aGlzO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFyZ2V0cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IHsgYXQsIHRhcmdldCB9ID0gdGFyZ2V0c1tpXTtcbiAgICAgIGxldCBhZGRyZXNzID0gbGFiZWxzW3RhcmdldF0gLSBhdDtcblxuICAgICAgYXNzZXJ0KGhlYXAuZ2V0YnlhZGRyKGF0KSA9PT0gLTEsICdFeHBlY3RlZCBoZWFwIHRvIGNvbnRhaW4gYSBwbGFjZWhvbGRlciwgYnV0IGl0IGRpZCBub3QnKTtcblxuICAgICAgaGVhcC5zZXRieWFkZHIoYXQsIGFkZHJlc3MpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZW5jb2RlT3AoXG4gIGVuY29kZXI6IEVuY29kZXIsXG4gIGNvbnN0YW50czogQ29tcGlsZVRpbWVDb25zdGFudHMgJiBSZXNvbHV0aW9uVGltZUNvbnN0YW50cyxcbiAgcmVzb2x2ZXI6IENvbXBpbGVUaW1lUmVzb2x2ZXIsXG4gIG1ldGE6IENvbnRhaW5pbmdNZXRhZGF0YSxcbiAgb3A6IEJ1aWxkZXJPcCB8IEhpZ2hMZXZlbE9wXG4pOiB2b2lkIHtcbiAgaWYgKGlzQnVpbGRlck9wY29kZShvcFswXSkpIHtcbiAgICBsZXQgW3R5cGUsIC4uLm9wZXJhbmRzXSA9IG9wO1xuICAgIGVuY29kZXIucHVzaChjb25zdGFudHMsIHR5cGUsIC4uLihvcGVyYW5kcyBhcyBTaW5nbGVCdWlsZGVyT3BlcmFuZFtdKSk7XG4gIH0gZWxzZSB7XG4gICAgc3dpdGNoIChvcFswXSkge1xuICAgICAgY2FzZSBIaWdoTGV2ZWxCdWlsZGVyT3Bjb2RlLkxhYmVsOlxuICAgICAgICByZXR1cm4gZW5jb2Rlci5sYWJlbChvcFsxXSk7XG4gICAgICBjYXNlIEhpZ2hMZXZlbEJ1aWxkZXJPcGNvZGUuU3RhcnRMYWJlbHM6XG4gICAgICAgIHJldHVybiBlbmNvZGVyLnN0YXJ0TGFiZWxzKCk7XG4gICAgICBjYXNlIEhpZ2hMZXZlbEJ1aWxkZXJPcGNvZGUuU3RvcExhYmVsczpcbiAgICAgICAgcmV0dXJuIGVuY29kZXIuc3RvcExhYmVscygpO1xuXG4gICAgICBjYXNlIEhpZ2hMZXZlbFJlc29sdXRpb25PcGNvZGUuUmVzb2x2ZUNvbXBvbmVudDpcbiAgICAgICAgcmV0dXJuIHJlc29sdmVDb21wb25lbnQocmVzb2x2ZXIsIGNvbnN0YW50cywgbWV0YSwgb3ApO1xuICAgICAgY2FzZSBIaWdoTGV2ZWxSZXNvbHV0aW9uT3Bjb2RlLlJlc29sdmVNb2RpZmllcjpcbiAgICAgICAgcmV0dXJuIHJlc29sdmVNb2RpZmllcihyZXNvbHZlciwgY29uc3RhbnRzLCBtZXRhLCBvcCk7XG4gICAgICBjYXNlIEhpZ2hMZXZlbFJlc29sdXRpb25PcGNvZGUuUmVzb2x2ZUhlbHBlcjpcbiAgICAgICAgcmV0dXJuIHJlc29sdmVIZWxwZXIocmVzb2x2ZXIsIGNvbnN0YW50cywgbWV0YSwgb3ApO1xuICAgICAgY2FzZSBIaWdoTGV2ZWxSZXNvbHV0aW9uT3Bjb2RlLlJlc29sdmVDb21wb25lbnRPckhlbHBlcjpcbiAgICAgICAgcmV0dXJuIHJlc29sdmVDb21wb25lbnRPckhlbHBlcihyZXNvbHZlciwgY29uc3RhbnRzLCBtZXRhLCBvcCk7XG4gICAgICBjYXNlIEhpZ2hMZXZlbFJlc29sdXRpb25PcGNvZGUuUmVzb2x2ZU9wdGlvbmFsSGVscGVyOlxuICAgICAgICByZXR1cm4gcmVzb2x2ZU9wdGlvbmFsSGVscGVyKHJlc29sdmVyLCBjb25zdGFudHMsIG1ldGEsIG9wKTtcbiAgICAgIGNhc2UgSGlnaExldmVsUmVzb2x1dGlvbk9wY29kZS5SZXNvbHZlT3B0aW9uYWxDb21wb25lbnRPckhlbHBlcjpcbiAgICAgICAgcmV0dXJuIHJlc29sdmVPcHRpb25hbENvbXBvbmVudE9ySGVscGVyKHJlc29sdmVyLCBjb25zdGFudHMsIG1ldGEsIG9wKTtcblxuICAgICAgY2FzZSBIaWdoTGV2ZWxSZXNvbHV0aW9uT3Bjb2RlLlJlc29sdmVMb2NhbDpcbiAgICAgICAgbGV0IGZyZWVWYXIgPSBvcFsxXTtcbiAgICAgICAgbGV0IG5hbWUgPSBleHBlY3QobWV0YS51cHZhcnMsICdCVUc6IGF0dGVtcHRlZCB0byByZXNvbHZlIHZhbHVlIGJ1dCBubyB1cHZhcnMgZm91bmQnKVtcbiAgICAgICAgICBmcmVlVmFyXG4gICAgICAgIF07XG5cbiAgICAgICAgbGV0IGFuZFRoZW4gPSBvcFsyXTtcblxuICAgICAgICBhbmRUaGVuKG5hbWUsIG1ldGEubW9kdWxlTmFtZSk7XG5cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgSGlnaExldmVsUmVzb2x1dGlvbk9wY29kZS5SZXNvbHZlVGVtcGxhdGVMb2NhbDpcbiAgICAgICAgbGV0IFssIHZhbHVlSW5kZXgsIHRoZW5dID0gb3A7XG4gICAgICAgIGxldCB2YWx1ZSA9IGV4cGVjdChcbiAgICAgICAgICBtZXRhLnNjb3BlVmFsdWVzLFxuICAgICAgICAgICdCVUc6IEF0dGVtcHRlZCB0byBnZWN0IGEgdGVtcGxhdGUgbG9jYWwsIGJ1dCB0ZW1wbGF0ZSBkb2VzIG5vdCBoYXZlIGFueSdcbiAgICAgICAgKVt2YWx1ZUluZGV4XTtcblxuICAgICAgICB0aGVuKGNvbnN0YW50cy52YWx1ZSh2YWx1ZSkpO1xuXG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEhpZ2hMZXZlbFJlc29sdXRpb25PcGNvZGUuUmVzb2x2ZUZyZWU6XG4gICAgICAgIGlmIChERUJVRykge1xuICAgICAgICAgIGxldCBbLCB1cHZhckluZGV4XSA9IG9wO1xuICAgICAgICAgIGxldCBmcmVlTmFtZSA9IGV4cGVjdChtZXRhLnVwdmFycywgJ0JVRzogYXR0ZW1wdGVkIHRvIHJlc29sdmUgdmFsdWUgYnV0IG5vIHVwdmFycyBmb3VuZCcpW1xuICAgICAgICAgICAgdXB2YXJJbmRleFxuICAgICAgICAgIF07XG5cbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgQXR0ZW1wdGVkIHRvIHJlc29sdmUgYSB2YWx1ZSBpbiBhIHN0cmljdCBtb2RlIHRlbXBsYXRlLCBidXQgdGhhdCB2YWx1ZSB3YXMgbm90IGluIHNjb3BlOiAke2ZyZWVOYW1lfWBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgaGlnaCBsZXZlbCBvcGNvZGUgJHtvcFswXX1gKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEVuY29kZXJJbXBsIGltcGxlbWVudHMgRW5jb2RlciB7XG4gIHByaXZhdGUgbGFiZWxzU3RhY2sgPSBuZXcgU3RhY2s8TGFiZWxzPigpO1xuICBwcml2YXRlIGVuY29kZXI6IEluc3RydWN0aW9uRW5jb2RlciA9IG5ldyBJbnN0cnVjdGlvbkVuY29kZXJJbXBsKFtdKTtcbiAgcHJpdmF0ZSBlcnJvcnM6IEVuY29kZXJFcnJvcltdID0gW107XG4gIHByaXZhdGUgaGFuZGxlOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBoZWFwOiBDb21waWxlVGltZUhlYXAsXG4gICAgcHJpdmF0ZSBtZXRhOiBDb250YWluaW5nTWV0YWRhdGEsXG4gICAgcHJpdmF0ZSBzdGRsaWI/OiBTVERMaWJcbiAgKSB7XG4gICAgdGhpcy5oYW5kbGUgPSBoZWFwLm1hbGxvYygpO1xuICB9XG5cbiAgZXJyb3IoZXJyb3I6IEVuY29kZXJFcnJvcik6IHZvaWQge1xuICAgIHRoaXMuZW5jb2Rlci5lbmNvZGUoT3AuUHJpbWl0aXZlLCAwKTtcbiAgICB0aGlzLmVycm9ycy5wdXNoKGVycm9yKTtcbiAgfVxuXG4gIGNvbW1pdChzaXplOiBudW1iZXIpOiBIYW5kbGVSZXN1bHQge1xuICAgIGxldCBoYW5kbGUgPSB0aGlzLmhhbmRsZTtcblxuICAgIHRoaXMuaGVhcC5wdXNoKE1hY2hpbmVPcC5SZXR1cm4gfCBPcGNvZGVTaXplLk1BQ0hJTkVfTUFTSyk7XG4gICAgdGhpcy5oZWFwLmZpbmlzaE1hbGxvYyhoYW5kbGUsIHNpemUpO1xuXG4gICAgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHsgZXJyb3JzOiB0aGlzLmVycm9ycywgaGFuZGxlIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBoYW5kbGU7XG4gICAgfVxuICB9XG5cbiAgcHVzaChcbiAgICBjb25zdGFudHM6IENvbXBpbGVUaW1lQ29uc3RhbnRzLFxuICAgIHR5cGU6IEJ1aWxkZXJPcGNvZGUsXG4gICAgLi4uYXJnczogU2luZ2xlQnVpbGRlck9wZXJhbmRbXVxuICApOiB2b2lkIHtcbiAgICBsZXQgeyBoZWFwIH0gPSB0aGlzO1xuXG4gICAgaWYgKERFQlVHICYmICh0eXBlIGFzIG51bWJlcikgPiBPcGNvZGVTaXplLlRZUEVfU0laRSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcGNvZGUgdHlwZSBvdmVyIDgtYml0cy4gR290ICR7dHlwZX0uYCk7XG4gICAgfVxuXG4gICAgbGV0IG1hY2hpbmUgPSBpc01hY2hpbmVPcCh0eXBlKSA/IE9wY29kZVNpemUuTUFDSElORV9NQVNLIDogMDtcbiAgICBsZXQgZmlyc3QgPSB0eXBlIHwgbWFjaGluZSB8IChhcmdzLmxlbmd0aCA8PCBPcGNvZGVTaXplLkFSR19TSElGVCk7XG5cbiAgICBoZWFwLnB1c2goZmlyc3QpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgb3AgPSBhcmdzW2ldO1xuICAgICAgaGVhcC5wdXNoKHRoaXMub3BlcmFuZChjb25zdGFudHMsIG9wKSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvcGVyYW5kKGNvbnN0YW50czogQ29tcGlsZVRpbWVDb25zdGFudHMsIG9wZXJhbmQ6IFNpbmdsZUJ1aWxkZXJPcGVyYW5kKTogT3BlcmFuZCB7XG4gICAgaWYgKHR5cGVvZiBvcGVyYW5kID09PSAnbnVtYmVyJykge1xuICAgICAgcmV0dXJuIG9wZXJhbmQ7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBvcGVyYW5kID09PSAnb2JqZWN0JyAmJiBvcGVyYW5kICE9PSBudWxsKSB7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShvcGVyYW5kKSkge1xuICAgICAgICByZXR1cm4gZW5jb2RlSGFuZGxlKGNvbnN0YW50cy5hcnJheShvcGVyYW5kKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzd2l0Y2ggKG9wZXJhbmQudHlwZSkge1xuICAgICAgICAgIGNhc2UgSGlnaExldmVsT3BlcmFuZC5MYWJlbDpcbiAgICAgICAgICAgIHRoaXMuY3VycmVudExhYmVscy50YXJnZXQodGhpcy5oZWFwLm9mZnNldCwgb3BlcmFuZC52YWx1ZSk7XG4gICAgICAgICAgICByZXR1cm4gLTE7XG5cbiAgICAgICAgICBjYXNlIEhpZ2hMZXZlbE9wZXJhbmQuSXNTdHJpY3RNb2RlOlxuICAgICAgICAgICAgcmV0dXJuIGVuY29kZUhhbmRsZShjb25zdGFudHMudmFsdWUodGhpcy5tZXRhLmlzU3RyaWN0TW9kZSkpO1xuXG4gICAgICAgICAgY2FzZSBIaWdoTGV2ZWxPcGVyYW5kLkV2YWxTeW1ib2xzOlxuICAgICAgICAgICAgcmV0dXJuIGVuY29kZUhhbmRsZShjb25zdGFudHMuYXJyYXkodGhpcy5tZXRhLmV2YWxTeW1ib2xzIHx8IEVNUFRZX1NUUklOR19BUlJBWSkpO1xuXG4gICAgICAgICAgY2FzZSBIaWdoTGV2ZWxPcGVyYW5kLkJsb2NrOlxuICAgICAgICAgICAgcmV0dXJuIGVuY29kZUhhbmRsZShjb25zdGFudHMudmFsdWUoY29tcGlsYWJsZUJsb2NrKG9wZXJhbmQudmFsdWUsIHRoaXMubWV0YSkpKTtcblxuICAgICAgICAgIGNhc2UgSGlnaExldmVsT3BlcmFuZC5TdGRMaWI6XG4gICAgICAgICAgICByZXR1cm4gZXhwZWN0KFxuICAgICAgICAgICAgICB0aGlzLnN0ZGxpYixcbiAgICAgICAgICAgICAgJ2F0dGVtcHRlZCB0byBlbmNvZGUgYSBzdGRsaWIgb3BlcmFuZCwgYnV0IHRoZSBlbmNvZGVyIGRpZCBub3QgaGF2ZSBhIHN0ZGxpYi4gQXJlIHlvdSBjdXJyZW50bHkgYnVpbGRpbmcgdGhlIHN0ZGxpYj8nXG4gICAgICAgICAgICApW29wZXJhbmQudmFsdWVdO1xuXG4gICAgICAgICAgY2FzZSBIaWdoTGV2ZWxPcGVyYW5kLk5vblNtYWxsSW50OlxuICAgICAgICAgIGNhc2UgSGlnaExldmVsT3BlcmFuZC5TeW1ib2xUYWJsZTpcbiAgICAgICAgICBjYXNlIEhpZ2hMZXZlbE9wZXJhbmQuTGF5b3V0OlxuICAgICAgICAgICAgcmV0dXJuIGNvbnN0YW50cy52YWx1ZShvcGVyYW5kLnZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBlbmNvZGVIYW5kbGUoY29uc3RhbnRzLnZhbHVlKG9wZXJhbmQpKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGN1cnJlbnRMYWJlbHMoKTogTGFiZWxzIHtcbiAgICByZXR1cm4gZXhwZWN0KHRoaXMubGFiZWxzU3RhY2suY3VycmVudCwgJ2J1Zzogbm90IGluIGEgbGFiZWwgc3RhY2snKTtcbiAgfVxuXG4gIGxhYmVsKG5hbWU6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudExhYmVscy5sYWJlbChuYW1lLCB0aGlzLmhlYXAub2Zmc2V0ICsgMSk7XG4gIH1cblxuICBzdGFydExhYmVscygpIHtcbiAgICB0aGlzLmxhYmVsc1N0YWNrLnB1c2gobmV3IExhYmVscygpKTtcbiAgfVxuXG4gIHN0b3BMYWJlbHMoKSB7XG4gICAgbGV0IGxhYmVsID0gZXhwZWN0KHRoaXMubGFiZWxzU3RhY2sucG9wKCksICd1bmJhbGFuY2VkIHB1c2ggYW5kIHBvcCBsYWJlbHMnKTtcbiAgICBsYWJlbC5wYXRjaCh0aGlzLmhlYXApO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzQnVpbGRlck9wY29kZShvcDogbnVtYmVyKTogb3AgaXMgQnVpbGRlck9wY29kZSB7XG4gIHJldHVybiBvcCA8IEhpZ2hMZXZlbEJ1aWxkZXJPcGNvZGUuU3RhcnQ7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9