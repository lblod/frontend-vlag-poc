"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = templateFactory;
exports.templateCacheCounters = void 0;

var _util = require("@glimmer/util");

var _compilableTemplate = require("./compilable-template");

var _wrappedComponent = require("./wrapped-component");

let clientId = 0;
let templateCacheCounters = {
  cacheHit: 0,
  cacheMiss: 0
};
/**
 * Wraps a template js in a template module to change it into a factory
 * that handles lazy parsing the template and to create per env singletons
 * of the template.
 */

exports.templateCacheCounters = templateCacheCounters;

function templateFactory({
  id: templateId,
  moduleName,
  block,
  scope,
  isStrictMode
}) {
  // TODO(template-refactors): This should be removed in the near future, as it
  // appears that id is unused. It is currently kept for backwards compat reasons.
  let id = templateId || `client-${clientId++}`; // TODO: This caches JSON serialized output once in case a template is
  // compiled by multiple owners, but we haven't verified if this is actually
  // helpful. We should benchmark this in the future.

  let parsedBlock;
  let ownerlessTemplate = null;
  let templateCache = new WeakMap();

  let factory = owner => {
    if (parsedBlock === undefined) {
      parsedBlock = JSON.parse(block);
    }

    if (owner === undefined) {
      if (ownerlessTemplate === null) {
        templateCacheCounters.cacheMiss++;
        ownerlessTemplate = new TemplateImpl({
          id,
          block: parsedBlock,
          moduleName,
          owner: null,
          scope,
          isStrictMode
        });
      } else {
        templateCacheCounters.cacheHit++;
      }

      return ownerlessTemplate;
    }

    let result = templateCache.get(owner);

    if (result === undefined) {
      templateCacheCounters.cacheMiss++;
      result = new TemplateImpl({
        id,
        block: parsedBlock,
        moduleName,
        owner,
        scope,
        isStrictMode
      });
      templateCache.set(owner, result);
    } else {
      templateCacheCounters.cacheHit++;
    }

    return result;
  };

  factory.__id = id;
  factory.__meta = {
    moduleName
  };
  return factory;
}

class TemplateImpl {
  constructor(parsedLayout) {
    this.parsedLayout = parsedLayout;
    this.result = 'ok';
    this.layout = null;
    this.wrappedLayout = null;
  }

  get moduleName() {
    return this.parsedLayout.moduleName;
  }

  get id() {
    return this.parsedLayout.id;
  } // TODO(template-refactors): This should be removed in the near future, it is
  // only being exposed for backwards compatibility


  get referrer() {
    return {
      moduleName: this.parsedLayout.moduleName,
      owner: this.parsedLayout.owner
    };
  }

  asLayout() {
    if (this.layout) return this.layout;
    return this.layout = (0, _compilableTemplate.compilable)((0, _util.assign)({}, this.parsedLayout), this.moduleName);
  }

  asWrappedLayout() {
    if (this.wrappedLayout) return this.wrappedLayout;
    return this.wrappedLayout = new _wrappedComponent.WrappedBuilder((0, _util.assign)({}, this.parsedLayout), this.moduleName);
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL29wY29kZS1jb21waWxlci9saWIvdGVtcGxhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFXQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJLFFBQVEsR0FBWixDQUFBO0FBRU8sSUFBSSxxQkFBcUIsR0FBRztBQUNqQyxFQUFBLFFBQVEsRUFEeUIsQ0FBQTtBQUVqQyxFQUFBLFNBQVMsRUFBRTtBQUZzQixDQUE1QjtBQW1CUDs7Ozs7Ozs7QUFLYyxTQUFBLGVBQUEsQ0FBMEI7QUFDdEMsRUFBQSxFQUFFLEVBRG9DLFVBQUE7QUFBQSxFQUFBLFVBQUE7QUFBQSxFQUFBLEtBQUE7QUFBQSxFQUFBLEtBQUE7QUFLdEMsRUFBQTtBQUxzQyxDQUExQixFQU1vQjtBQUNoQztBQUNBO0FBQ0EsTUFBSSxFQUFFLEdBQUcsVUFBVSxJQUFJLFVBQVUsUUFBUSxFQUhULEVBR2hDLENBSGdDLENBS2hDO0FBQ0E7QUFDQTs7QUFDQSxNQUFBLFdBQUE7QUFFQSxNQUFJLGlCQUFpQixHQUFyQixJQUFBO0FBQ0EsTUFBSSxhQUFhLEdBQUcsSUFBcEIsT0FBb0IsRUFBcEI7O0FBRUEsTUFBSSxPQUFPLEdBQWtDLEtBQUQsSUFBa0I7QUFDNUQsUUFBSSxXQUFXLEtBQWYsU0FBQSxFQUErQjtBQUM3QixNQUFBLFdBQVcsR0FBRyxJQUFJLENBQUosS0FBQSxDQUFkLEtBQWMsQ0FBZDtBQUNEOztBQUVELFFBQUksS0FBSyxLQUFULFNBQUEsRUFBeUI7QUFDdkIsVUFBSSxpQkFBaUIsS0FBckIsSUFBQSxFQUFnQztBQUM5QixRQUFBLHFCQUFxQixDQUFyQixTQUFBO0FBQ0EsUUFBQSxpQkFBaUIsR0FBRyxJQUFBLFlBQUEsQ0FBaUI7QUFBQSxVQUFBLEVBQUE7QUFFbkMsVUFBQSxLQUFLLEVBRjhCLFdBQUE7QUFBQSxVQUFBLFVBQUE7QUFJbkMsVUFBQSxLQUFLLEVBSjhCLElBQUE7QUFBQSxVQUFBLEtBQUE7QUFNbkMsVUFBQTtBQU5tQyxTQUFqQixDQUFwQjtBQUZGLE9BQUEsTUFVTztBQUNMLFFBQUEscUJBQXFCLENBQXJCLFFBQUE7QUFDRDs7QUFFRCxhQUFBLGlCQUFBO0FBQ0Q7O0FBRUQsUUFBSSxNQUFNLEdBQUcsYUFBYSxDQUFiLEdBQUEsQ0FBYixLQUFhLENBQWI7O0FBRUEsUUFBSSxNQUFNLEtBQVYsU0FBQSxFQUEwQjtBQUN4QixNQUFBLHFCQUFxQixDQUFyQixTQUFBO0FBQ0EsTUFBQSxNQUFNLEdBQUcsSUFBQSxZQUFBLENBQWlCO0FBQUEsUUFBQSxFQUFBO0FBQU0sUUFBQSxLQUFLLEVBQVgsV0FBQTtBQUFBLFFBQUEsVUFBQTtBQUFBLFFBQUEsS0FBQTtBQUFBLFFBQUEsS0FBQTtBQUFvRCxRQUFBO0FBQXBELE9BQWpCLENBQVQ7QUFDQSxNQUFBLGFBQWEsQ0FBYixHQUFBLENBQUEsS0FBQSxFQUFBLE1BQUE7QUFIRixLQUFBLE1BSU87QUFDTCxNQUFBLHFCQUFxQixDQUFyQixRQUFBO0FBQ0Q7O0FBRUQsV0FBQSxNQUFBO0FBakNGLEdBQUE7O0FBb0NBLEVBQUEsT0FBTyxDQUFQLElBQUEsR0FBQSxFQUFBO0FBQ0EsRUFBQSxPQUFPLENBQVAsTUFBQSxHQUFpQjtBQUFFLElBQUE7QUFBRixHQUFqQjtBQUVBLFNBQUEsT0FBQTtBQUNEOztBQUVELE1BQUEsWUFBQSxDQUFrQjtBQU1oQixFQUFBLFdBQUEsQ0FBQSxZQUFBLEVBQW1EO0FBQS9CLFNBQUEsWUFBQSxHQUFBLFlBQUE7QUFMWCxTQUFBLE1BQUEsR0FBQSxJQUFBO0FBRUQsU0FBQSxNQUFBLEdBQUEsSUFBQTtBQUNBLFNBQUEsYUFBQSxHQUFBLElBQUE7QUFFK0M7O0FBRXZELE1BQUEsVUFBQSxHQUFjO0FBQ1osV0FBTyxLQUFBLFlBQUEsQ0FBUCxVQUFBO0FBQ0Q7O0FBRUQsTUFBQSxFQUFBLEdBQU07QUFDSixXQUFPLEtBQUEsWUFBQSxDQUFQLEVBQUE7QUFiYyxHQUFBLENBZ0JoQjtBQUNBOzs7QUFDQSxNQUFBLFFBQUEsR0FBWTtBQUNWLFdBQU87QUFDTCxNQUFBLFVBQVUsRUFBRSxLQUFBLFlBQUEsQ0FEUCxVQUFBO0FBRUwsTUFBQSxLQUFLLEVBQUUsS0FBQSxZQUFBLENBQWtCO0FBRnBCLEtBQVA7QUFJRDs7QUFFRCxFQUFBLFFBQVEsR0FBQTtBQUNOLFFBQUksS0FBSixNQUFBLEVBQWlCLE9BQU8sS0FBUCxNQUFBO0FBQ2pCLFdBQVEsS0FBQSxNQUFBLEdBQWMsb0NBQVcsa0JBQU0sRUFBTixFQUFXLEtBQVosWUFBQyxDQUFYLEVBQTBDLEtBQWhFLFVBQXNCLENBQXRCO0FBQ0Q7O0FBRUQsRUFBQSxlQUFlLEdBQUE7QUFDYixRQUFJLEtBQUosYUFBQSxFQUF3QixPQUFPLEtBQVAsYUFBQTtBQUN4QixXQUFRLEtBQUEsYUFBQSxHQUFxQixJQUFBLGdDQUFBLENBQzNCLGtCQUFNLEVBQU4sRUFBVyxLQURnQixZQUMzQixDQUQyQixFQUUzQixLQUZGLFVBQTZCLENBQTdCO0FBSUQ7O0FBcENlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcGlsYWJsZVByb2dyYW0sXG4gIExheW91dFdpdGhDb250ZXh0LFxuICBPcHRpb24sXG4gIE93bmVyLFxuICBTZXJpYWxpemVkVGVtcGxhdGVCbG9jayxcbiAgU2VyaWFsaXplZFRlbXBsYXRlV2l0aExhenlCbG9jayxcbiAgVGVtcGxhdGUsXG4gIFRlbXBsYXRlRmFjdG9yeSxcbiAgVGVtcGxhdGVPayxcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBhc3NpZ24gfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IGNvbXBpbGFibGUgfSBmcm9tICcuL2NvbXBpbGFibGUtdGVtcGxhdGUnO1xuaW1wb3J0IHsgV3JhcHBlZEJ1aWxkZXIgfSBmcm9tICcuL3dyYXBwZWQtY29tcG9uZW50JztcblxubGV0IGNsaWVudElkID0gMDtcblxuZXhwb3J0IGxldCB0ZW1wbGF0ZUNhY2hlQ291bnRlcnMgPSB7XG4gIGNhY2hlSGl0OiAwLFxuICBjYWNoZU1pc3M6IDAsXG59O1xuXG4vLyBUaGVzZSBpbnRlcmZhY2VzIGFyZSBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIHNvbWUgYWRkb25zIHVzZSB0aGVzZSBpbnRpbWF0ZSBBUElzXG5leHBvcnQgaW50ZXJmYWNlIFRlbXBsYXRlRmFjdG9yeVdpdGhJZEFuZE1ldGEgZXh0ZW5kcyBUZW1wbGF0ZUZhY3Rvcnkge1xuICBfX2lkPzogc3RyaW5nO1xuICBfX21ldGE/OiB7IG1vZHVsZU5hbWU6IHN0cmluZyB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRlbXBsYXRlV2l0aElkQW5kUmVmZXJyZXIgZXh0ZW5kcyBUZW1wbGF0ZU9rIHtcbiAgaWQ6IHN0cmluZztcbiAgcmVmZXJyZXI6IHtcbiAgICBtb2R1bGVOYW1lOiBzdHJpbmc7XG4gICAgb3duZXI6IE93bmVyIHwgbnVsbDtcbiAgfTtcbn1cblxuLyoqXG4gKiBXcmFwcyBhIHRlbXBsYXRlIGpzIGluIGEgdGVtcGxhdGUgbW9kdWxlIHRvIGNoYW5nZSBpdCBpbnRvIGEgZmFjdG9yeVxuICogdGhhdCBoYW5kbGVzIGxhenkgcGFyc2luZyB0aGUgdGVtcGxhdGUgYW5kIHRvIGNyZWF0ZSBwZXIgZW52IHNpbmdsZXRvbnNcbiAqIG9mIHRoZSB0ZW1wbGF0ZS5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdGVtcGxhdGVGYWN0b3J5KHtcbiAgaWQ6IHRlbXBsYXRlSWQsXG4gIG1vZHVsZU5hbWUsXG4gIGJsb2NrLFxuICBzY29wZSxcbiAgaXNTdHJpY3RNb2RlLFxufTogU2VyaWFsaXplZFRlbXBsYXRlV2l0aExhenlCbG9jayk6IFRlbXBsYXRlRmFjdG9yeSB7XG4gIC8vIFRPRE8odGVtcGxhdGUtcmVmYWN0b3JzKTogVGhpcyBzaG91bGQgYmUgcmVtb3ZlZCBpbiB0aGUgbmVhciBmdXR1cmUsIGFzIGl0XG4gIC8vIGFwcGVhcnMgdGhhdCBpZCBpcyB1bnVzZWQuIEl0IGlzIGN1cnJlbnRseSBrZXB0IGZvciBiYWNrd2FyZHMgY29tcGF0IHJlYXNvbnMuXG4gIGxldCBpZCA9IHRlbXBsYXRlSWQgfHwgYGNsaWVudC0ke2NsaWVudElkKyt9YDtcblxuICAvLyBUT0RPOiBUaGlzIGNhY2hlcyBKU09OIHNlcmlhbGl6ZWQgb3V0cHV0IG9uY2UgaW4gY2FzZSBhIHRlbXBsYXRlIGlzXG4gIC8vIGNvbXBpbGVkIGJ5IG11bHRpcGxlIG93bmVycywgYnV0IHdlIGhhdmVuJ3QgdmVyaWZpZWQgaWYgdGhpcyBpcyBhY3R1YWxseVxuICAvLyBoZWxwZnVsLiBXZSBzaG91bGQgYmVuY2htYXJrIHRoaXMgaW4gdGhlIGZ1dHVyZS5cbiAgbGV0IHBhcnNlZEJsb2NrOiBTZXJpYWxpemVkVGVtcGxhdGVCbG9jaztcblxuICBsZXQgb3duZXJsZXNzVGVtcGxhdGU6IFRlbXBsYXRlIHwgbnVsbCA9IG51bGw7XG4gIGxldCB0ZW1wbGF0ZUNhY2hlID0gbmV3IFdlYWtNYXA8b2JqZWN0LCBUZW1wbGF0ZT4oKTtcblxuICBsZXQgZmFjdG9yeTogVGVtcGxhdGVGYWN0b3J5V2l0aElkQW5kTWV0YSA9IChvd25lcj86IE93bmVyKSA9PiB7XG4gICAgaWYgKHBhcnNlZEJsb2NrID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHBhcnNlZEJsb2NrID0gSlNPTi5wYXJzZShibG9jayk7XG4gICAgfVxuXG4gICAgaWYgKG93bmVyID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmIChvd25lcmxlc3NUZW1wbGF0ZSA9PT0gbnVsbCkge1xuICAgICAgICB0ZW1wbGF0ZUNhY2hlQ291bnRlcnMuY2FjaGVNaXNzKys7XG4gICAgICAgIG93bmVybGVzc1RlbXBsYXRlID0gbmV3IFRlbXBsYXRlSW1wbCh7XG4gICAgICAgICAgaWQsXG4gICAgICAgICAgYmxvY2s6IHBhcnNlZEJsb2NrLFxuICAgICAgICAgIG1vZHVsZU5hbWUsXG4gICAgICAgICAgb3duZXI6IG51bGwsXG4gICAgICAgICAgc2NvcGUsXG4gICAgICAgICAgaXNTdHJpY3RNb2RlLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRlbXBsYXRlQ2FjaGVDb3VudGVycy5jYWNoZUhpdCsrO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gb3duZXJsZXNzVGVtcGxhdGU7XG4gICAgfVxuXG4gICAgbGV0IHJlc3VsdCA9IHRlbXBsYXRlQ2FjaGUuZ2V0KG93bmVyKSBhcyBUZW1wbGF0ZTtcblxuICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGVtcGxhdGVDYWNoZUNvdW50ZXJzLmNhY2hlTWlzcysrO1xuICAgICAgcmVzdWx0ID0gbmV3IFRlbXBsYXRlSW1wbCh7IGlkLCBibG9jazogcGFyc2VkQmxvY2ssIG1vZHVsZU5hbWUsIG93bmVyLCBzY29wZSwgaXNTdHJpY3RNb2RlIH0pO1xuICAgICAgdGVtcGxhdGVDYWNoZS5zZXQob3duZXIsIHJlc3VsdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRlbXBsYXRlQ2FjaGVDb3VudGVycy5jYWNoZUhpdCsrO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgZmFjdG9yeS5fX2lkID0gaWQ7XG4gIGZhY3RvcnkuX19tZXRhID0geyBtb2R1bGVOYW1lIH07XG5cbiAgcmV0dXJuIGZhY3Rvcnk7XG59XG5cbmNsYXNzIFRlbXBsYXRlSW1wbCBpbXBsZW1lbnRzIFRlbXBsYXRlV2l0aElkQW5kUmVmZXJyZXIge1xuICByZWFkb25seSByZXN1bHQgPSAnb2snO1xuXG4gIHByaXZhdGUgbGF5b3V0OiBPcHRpb248Q29tcGlsYWJsZVByb2dyYW0+ID0gbnVsbDtcbiAgcHJpdmF0ZSB3cmFwcGVkTGF5b3V0OiBPcHRpb248Q29tcGlsYWJsZVByb2dyYW0+ID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBhcnNlZExheW91dDogTGF5b3V0V2l0aENvbnRleHQpIHt9XG5cbiAgZ2V0IG1vZHVsZU5hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFyc2VkTGF5b3V0Lm1vZHVsZU5hbWU7XG4gIH1cblxuICBnZXQgaWQoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFyc2VkTGF5b3V0LmlkO1xuICB9XG5cbiAgLy8gVE9ETyh0ZW1wbGF0ZS1yZWZhY3RvcnMpOiBUaGlzIHNob3VsZCBiZSByZW1vdmVkIGluIHRoZSBuZWFyIGZ1dHVyZSwgaXQgaXNcbiAgLy8gb25seSBiZWluZyBleHBvc2VkIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eVxuICBnZXQgcmVmZXJyZXIoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG1vZHVsZU5hbWU6IHRoaXMucGFyc2VkTGF5b3V0Lm1vZHVsZU5hbWUsXG4gICAgICBvd25lcjogdGhpcy5wYXJzZWRMYXlvdXQub3duZXIsXG4gICAgfTtcbiAgfVxuXG4gIGFzTGF5b3V0KCk6IENvbXBpbGFibGVQcm9ncmFtIHtcbiAgICBpZiAodGhpcy5sYXlvdXQpIHJldHVybiB0aGlzLmxheW91dDtcbiAgICByZXR1cm4gKHRoaXMubGF5b3V0ID0gY29tcGlsYWJsZShhc3NpZ24oe30sIHRoaXMucGFyc2VkTGF5b3V0KSwgdGhpcy5tb2R1bGVOYW1lKSk7XG4gIH1cblxuICBhc1dyYXBwZWRMYXlvdXQoKTogQ29tcGlsYWJsZVByb2dyYW0ge1xuICAgIGlmICh0aGlzLndyYXBwZWRMYXlvdXQpIHJldHVybiB0aGlzLndyYXBwZWRMYXlvdXQ7XG4gICAgcmV0dXJuICh0aGlzLndyYXBwZWRMYXlvdXQgPSBuZXcgV3JhcHBlZEJ1aWxkZXIoXG4gICAgICBhc3NpZ24oe30sIHRoaXMucGFyc2VkTGF5b3V0KSxcbiAgICAgIHRoaXMubW9kdWxlTmFtZVxuICAgICkpO1xuICB9XG59XG4iXSwic291cmNlUm9vdCI6IiJ9