"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.encodeOp = encodeOp;
exports.EncoderImpl = exports.Labels = void 0;

var _encoder = require("@glimmer/encoder");

var _vm = require("@glimmer/vm");

var _util = require("@glimmer/util");

var _resolution = require("./helpers/resolution");

var _compilableTemplate = require("../compilable-template");

var _env = require("@glimmer/env");

class Labels {
  constructor() {
    this.labels = (0, _util.dict)();
    this.targets = [];
  }

  label(name, index) {
    this.labels[name] = index;
  }

  target(at, target) {
    this.targets.push({
      at,
      target
    });
  }

  patch(heap) {
    let {
      targets,
      labels
    } = this;

    for (let i = 0; i < targets.length; i++) {
      let {
        at,
        target
      } = targets[i];
      let address = labels[target] - at;
      false && (0, _util.assert)(heap.getbyaddr(at) === -1, 'Expected heap to contain a placeholder, but it did not');
      heap.setbyaddr(at, address);
    }
  }

}

exports.Labels = Labels;

function encodeOp(encoder, constants, resolver, meta, op) {
  if (isBuilderOpcode(op[0])) {
    let [type, ...operands] = op;
    encoder.push(constants, type, ...operands);
  } else {
    switch (op[0]) {
      case 1000
      /* Label */
      :
        return encoder.label(op[1]);

      case 1001
      /* StartLabels */
      :
        return encoder.startLabels();

      case 1002
      /* StopLabels */
      :
        return encoder.stopLabels();

      case 1004
      /* ResolveComponent */
      :
        return (0, _resolution.resolveComponent)(resolver, constants, meta, op);

      case 1003
      /* ResolveModifier */
      :
        return (0, _resolution.resolveModifier)(resolver, constants, meta, op);

      case 1005
      /* ResolveHelper */
      :
        return (0, _resolution.resolveHelper)(resolver, constants, meta, op);

      case 1007
      /* ResolveComponentOrHelper */
      :
        return (0, _resolution.resolveComponentOrHelper)(resolver, constants, meta, op);

      case 1006
      /* ResolveOptionalHelper */
      :
        return (0, _resolution.resolveOptionalHelper)(resolver, constants, meta, op);

      case 1008
      /* ResolveOptionalComponentOrHelper */
      :
        return (0, _resolution.resolveOptionalComponentOrHelper)(resolver, constants, meta, op);

      case 1010
      /* ResolveLocal */
      :
        let freeVar = op[1];
        let name = meta.upvars[freeVar];
        let andThen = op[2];
        andThen(name, meta.moduleName);
        break;

      case 1011
      /* ResolveTemplateLocal */
      :
        let [, valueIndex, then] = op;
        let value = meta.scopeValues[valueIndex];
        then(constants.value(value));
        break;

      case 1009
      /* ResolveFree */
      :
        if (_env.DEBUG) {
          let [, upvarIndex] = op;
          let freeName = meta.upvars[upvarIndex];
          throw new Error(`Attempted to resolve a value in a strict mode template, but that value was not in scope: ${freeName}`);
        }

        break;

      default:
        throw new Error(`Unexpected high level opcode ${op[0]}`);
    }
  }
}

class EncoderImpl {
  constructor(heap, meta, stdlib) {
    this.heap = heap;
    this.meta = meta;
    this.stdlib = stdlib;
    this.labelsStack = new _util.Stack();
    this.encoder = new _encoder.InstructionEncoderImpl([]);
    this.errors = [];
    this.handle = heap.malloc();
  }

  error(error) {
    this.encoder.encode(30
    /* Primitive */
    , 0);
    this.errors.push(error);
  }

  commit(size) {
    let handle = this.handle;
    this.heap.push(5
    /* Return */
    | 1024
    /* MACHINE_MASK */
    );
    this.heap.finishMalloc(handle, size);

    if (this.errors.length) {
      return {
        errors: this.errors,
        handle
      };
    } else {
      return handle;
    }
  }

  push(constants, type, ...args) {
    let {
      heap
    } = this;

    if (_env.DEBUG && type > 255
    /* TYPE_SIZE */
    ) {
        throw new Error(`Opcode type over 8-bits. Got ${type}.`);
      }

    let machine = (0, _vm.isMachineOp)(type) ? 1024
    /* MACHINE_MASK */
    : 0;
    let first = type | machine | args.length << 8
    /* ARG_SHIFT */
    ;
    heap.push(first);

    for (let i = 0; i < args.length; i++) {
      let op = args[i];
      heap.push(this.operand(constants, op));
    }
  }

  operand(constants, operand) {
    if (typeof operand === 'number') {
      return operand;
    }

    if (typeof operand === 'object' && operand !== null) {
      if (Array.isArray(operand)) {
        return (0, _util.encodeHandle)(constants.array(operand));
      } else {
        switch (operand.type) {
          case 1
          /* Label */
          :
            this.currentLabels.target(this.heap.offset, operand.value);
            return -1;

          case 2
          /* IsStrictMode */
          :
            return (0, _util.encodeHandle)(constants.value(this.meta.isStrictMode));

          case 3
          /* EvalSymbols */
          :
            return (0, _util.encodeHandle)(constants.array(this.meta.evalSymbols || _util.EMPTY_STRING_ARRAY));

          case 4
          /* Block */
          :
            return (0, _util.encodeHandle)(constants.value((0, _compilableTemplate.compilableBlock)(operand.value, this.meta)));

          case 5
          /* StdLib */
          :
            return this.stdlib[operand.value];

          case 6
          /* NonSmallInt */
          :
          case 7
          /* SymbolTable */
          :
          case 8
          /* Layout */
          :
            return constants.value(operand.value);
        }
      }
    }

    return (0, _util.encodeHandle)(constants.value(operand));
  }

  get currentLabels() {
    return this.labelsStack.current;
  }

  label(name) {
    this.currentLabels.label(name, this.heap.offset + 1);
  }

  startLabels() {
    this.labelsStack.push(new Labels());
  }

  stopLabels() {
    let label = this.labelsStack.pop();
    label.patch(this.heap);
  }

}

exports.EncoderImpl = EncoderImpl;

function isBuilderOpcode(op) {
  return op < 1000
  /* Start */
  ;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL29wY29kZS1jb21waWxlci9saWIvb3Bjb2RlLWJ1aWxkZXIvZW5jb2Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOztBQXlCQTs7QUFDQTs7QUFDQTs7QUFRQTs7QUFDQTs7QUFFTSxNQUFBLE1BQUEsQ0FBYTtBQUFuQixFQUFBLFdBQUEsR0FBQTtBQUNFLFNBQUEsTUFBQSxHQUFBLGlCQUFBO0FBQ0EsU0FBQSxPQUFBLEdBQUEsRUFBQTtBQXFCRDs7QUFuQkMsRUFBQSxLQUFLLENBQUEsSUFBQSxFQUFBLEtBQUEsRUFBNEI7QUFDL0IsU0FBQSxNQUFBLENBQUEsSUFBQSxJQUFBLEtBQUE7QUFDRDs7QUFFRCxFQUFBLE1BQU0sQ0FBQSxFQUFBLEVBQUEsTUFBQSxFQUEyQjtBQUMvQixTQUFBLE9BQUEsQ0FBQSxJQUFBLENBQWtCO0FBQUEsTUFBQSxFQUFBO0FBQU0sTUFBQTtBQUFOLEtBQWxCO0FBQ0Q7O0FBRUQsRUFBQSxLQUFLLENBQUEsSUFBQSxFQUFzQjtBQUN6QixRQUFJO0FBQUEsTUFBQSxPQUFBO0FBQVcsTUFBQTtBQUFYLFFBQUosSUFBQTs7QUFDQSxTQUFLLElBQUksQ0FBQyxHQUFWLENBQUEsRUFBZ0IsQ0FBQyxHQUFHLE9BQU8sQ0FBM0IsTUFBQSxFQUFvQyxDQUFwQyxFQUFBLEVBQXlDO0FBQ3ZDLFVBQUk7QUFBQSxRQUFBLEVBQUE7QUFBTSxRQUFBO0FBQU4sVUFBaUIsT0FBTyxDQUE1QixDQUE0QixDQUE1QjtBQUNBLFVBQUksT0FBTyxHQUFHLE1BQU0sQ0FBTixNQUFNLENBQU4sR0FBZCxFQUFBO0FBRnVDLGVBSXZDLGtCQUFPLElBQUksQ0FBSixTQUFBLENBQUEsRUFBQSxNQUF1QixDQUF4QixDQUFOLEVBSnVDLHdEQUl2QyxDQUp1QztBQU12QyxNQUFBLElBQUksQ0FBSixTQUFBLENBQUEsRUFBQSxFQUFBLE9BQUE7QUFDRDtBQUNGOztBQXRC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RSxJQUFvQyxDQUFoQixDQUFiLENBQVA7O0FBRUYsZUFBQTtBQUFBO0FBQUE7QUFDRSxtQkFDRSxLQURLLE1BQ0wsQ0FFQSxPQUFPLENBSFQsS0FDRSxDQURGOztBQUtGLGVBQUE7QUFBQTtBQUFBO0FBQ0EsZUFBQTtBQUFBO0FBQUE7QUFDQSxlQUFBO0FBQUE7QUFBQTtBQUNFLG1CQUFPLFNBQVMsQ0FBVCxLQUFBLENBQWdCLE9BQU8sQ0FBOUIsS0FBTyxDQUFQO0FBdkJKO0FBeUJEO0FBQ0Y7O0FBRUQsV0FBTyx3QkFBYSxTQUFTLENBQVQsS0FBQSxDQUFwQixPQUFvQixDQUFiLENBQVA7QUFDRDs7QUFFRCxNQUFBLGFBQUEsR0FBeUI7QUFDdkIsV0FBYyxLQUFBLFdBQUEsQ0FBZCxPQUFBO0FBQ0Q7O0FBRUQsRUFBQSxLQUFLLENBQUEsSUFBQSxFQUFhO0FBQ2hCLFNBQUEsYUFBQSxDQUFBLEtBQUEsQ0FBQSxJQUFBLEVBQStCLEtBQUEsSUFBQSxDQUFBLE1BQUEsR0FBL0IsQ0FBQTtBQUNEOztBQUVELEVBQUEsV0FBVyxHQUFBO0FBQ1QsU0FBQSxXQUFBLENBQUEsSUFBQSxDQUFzQixJQUF0QixNQUFzQixFQUF0QjtBQUNEOztBQUVELEVBQUEsVUFBVSxHQUFBO0FBQ1IsUUFBSSxLQUFLLEdBQVUsS0FBQSxXQUFBLENBQW5CLEdBQW1CLEVBQW5CO0FBQ0EsSUFBQSxLQUFLLENBQUwsS0FBQSxDQUFZLEtBQVosSUFBQTtBQUNEOztBQTdHcUI7Ozs7QUFnSHhCLFNBQUEsZUFBQSxDQUFBLEVBQUEsRUFBbUM7QUFDakMsU0FBTyxFQUFFLEdBQUE7QUFBQTtBQUFUO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbnN0cnVjdGlvbkVuY29kZXJJbXBsIH0gZnJvbSAnQGdsaW1tZXIvZW5jb2Rlcic7XG5pbXBvcnQge1xuICBDb21waWxlVGltZUNvbnN0YW50cyxcbiAgT3BlcmFuZCxcbiAgQ29tcGlsZVRpbWVIZWFwLFxuICBPcCxcbiAgQnVpbGRlck9wY29kZSxcbiAgSGlnaExldmVsQnVpbGRlck9wY29kZSxcbiAgTWFjaGluZU9wLFxuICBTaW5nbGVCdWlsZGVyT3BlcmFuZCxcbiAgRW5jb2RlcixcbiAgSGlnaExldmVsUmVzb2x1dGlvbk9wY29kZSxcbiAgSGlnaExldmVsT3AsXG4gIE9wY29kZVNpemUsXG4gIEluc3RydWN0aW9uRW5jb2RlcixcbiAgRGljdCxcbiAgRW5jb2RlckVycm9yLFxuICBIYW5kbGVSZXN1bHQsXG4gIEJ1aWxkZXJPcCxcbiAgQ29tcGlsZVRpbWVSZXNvbHZlcixcbiAgQ29udGFpbmluZ01ldGFkYXRhLFxuICBIaWdoTGV2ZWxPcGVyYW5kLFxuICBTVERMaWIsXG4gIFJlc29sdXRpb25UaW1lQ29uc3RhbnRzLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IGlzTWFjaGluZU9wIH0gZnJvbSAnQGdsaW1tZXIvdm0nO1xuaW1wb3J0IHsgU3RhY2ssIGRpY3QsIGV4cGVjdCwgRU1QVFlfU1RSSU5HX0FSUkFZLCBlbmNvZGVIYW5kbGUsIGFzc2VydCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHtcbiAgcmVzb2x2ZUNvbXBvbmVudCxcbiAgcmVzb2x2ZUNvbXBvbmVudE9ySGVscGVyLFxuICByZXNvbHZlSGVscGVyLFxuICByZXNvbHZlTW9kaWZpZXIsXG4gIHJlc29sdmVPcHRpb25hbENvbXBvbmVudE9ySGVscGVyLFxuICByZXNvbHZlT3B0aW9uYWxIZWxwZXIsXG59IGZyb20gJy4vaGVscGVycy9yZXNvbHV0aW9uJztcbmltcG9ydCB7IGNvbXBpbGFibGVCbG9jayB9IGZyb20gJy4uL2NvbXBpbGFibGUtdGVtcGxhdGUnO1xuaW1wb3J0IHsgREVCVUcgfSBmcm9tICdAZ2xpbW1lci9lbnYnO1xuXG5leHBvcnQgY2xhc3MgTGFiZWxzIHtcbiAgbGFiZWxzOiBEaWN0PG51bWJlcj4gPSBkaWN0KCk7XG4gIHRhcmdldHM6IEFycmF5PHsgYXQ6IG51bWJlcjsgdGFyZ2V0OiBzdHJpbmcgfT4gPSBbXTtcblxuICBsYWJlbChuYW1lOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpIHtcbiAgICB0aGlzLmxhYmVsc1tuYW1lXSA9IGluZGV4O1xuICB9XG5cbiAgdGFyZ2V0KGF0OiBudW1iZXIsIHRhcmdldDogc3RyaW5nKSB7XG4gICAgdGhpcy50YXJnZXRzLnB1c2goeyBhdCwgdGFyZ2V0IH0pO1xuICB9XG5cbiAgcGF0Y2goaGVhcDogQ29tcGlsZVRpbWVIZWFwKTogdm9pZCB7XG4gICAgbGV0IHsgdGFyZ2V0cywgbGFiZWxzIH0gPSB0aGlzO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFyZ2V0cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IHsgYXQsIHRhcmdldCB9ID0gdGFyZ2V0c1tpXTtcbiAgICAgIGxldCBhZGRyZXNzID0gbGFiZWxzW3RhcmdldF0gLSBhdDtcblxuICAgICAgYXNzZXJ0KGhlYXAuZ2V0YnlhZGRyKGF0KSA9PT0gLTEsICdFeHBlY3RlZCBoZWFwIHRvIGNvbnRhaW4gYSBwbGFjZWhvbGRlciwgYnV0IGl0IGRpZCBub3QnKTtcblxuICAgICAgaGVhcC5zZXRieWFkZHIoYXQsIGFkZHJlc3MpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZW5jb2RlT3AoXG4gIGVuY29kZXI6IEVuY29kZXIsXG4gIGNvbnN0YW50czogQ29tcGlsZVRpbWVDb25zdGFudHMgJiBSZXNvbHV0aW9uVGltZUNvbnN0YW50cyxcbiAgcmVzb2x2ZXI6IENvbXBpbGVUaW1lUmVzb2x2ZXIsXG4gIG1ldGE6IENvbnRhaW5pbmdNZXRhZGF0YSxcbiAgb3A6IEJ1aWxkZXJPcCB8IEhpZ2hMZXZlbE9wXG4pOiB2b2lkIHtcbiAgaWYgKGlzQnVpbGRlck9wY29kZShvcFswXSkpIHtcbiAgICBsZXQgW3R5cGUsIC4uLm9wZXJhbmRzXSA9IG9wO1xuICAgIGVuY29kZXIucHVzaChjb25zdGFudHMsIHR5cGUsIC4uLihvcGVyYW5kcyBhcyBTaW5nbGVCdWlsZGVyT3BlcmFuZFtdKSk7XG4gIH0gZWxzZSB7XG4gICAgc3dpdGNoIChvcFswXSkge1xuICAgICAgY2FzZSBIaWdoTGV2ZWxCdWlsZGVyT3Bjb2RlLkxhYmVsOlxuICAgICAgICByZXR1cm4gZW5jb2Rlci5sYWJlbChvcFsxXSk7XG4gICAgICBjYXNlIEhpZ2hMZXZlbEJ1aWxkZXJPcGNvZGUuU3RhcnRMYWJlbHM6XG4gICAgICAgIHJldHVybiBlbmNvZGVyLnN0YXJ0TGFiZWxzKCk7XG4gICAgICBjYXNlIEhpZ2hMZXZlbEJ1aWxkZXJPcGNvZGUuU3RvcExhYmVsczpcbiAgICAgICAgcmV0dXJuIGVuY29kZXIuc3RvcExhYmVscygpO1xuXG4gICAgICBjYXNlIEhpZ2hMZXZlbFJlc29sdXRpb25PcGNvZGUuUmVzb2x2ZUNvbXBvbmVudDpcbiAgICAgICAgcmV0dXJuIHJlc29sdmVDb21wb25lbnQocmVzb2x2ZXIsIGNvbnN0YW50cywgbWV0YSwgb3ApO1xuICAgICAgY2FzZSBIaWdoTGV2ZWxSZXNvbHV0aW9uT3Bjb2RlLlJlc29sdmVNb2RpZmllcjpcbiAgICAgICAgcmV0dXJuIHJlc29sdmVNb2RpZmllcihyZXNvbHZlciwgY29uc3RhbnRzLCBtZXRhLCBvcCk7XG4gICAgICBjYXNlIEhpZ2hMZXZlbFJlc29sdXRpb25PcGNvZGUuUmVzb2x2ZUhlbHBlcjpcbiAgICAgICAgcmV0dXJuIHJlc29sdmVIZWxwZXIocmVzb2x2ZXIsIGNvbnN0YW50cywgbWV0YSwgb3ApO1xuICAgICAgY2FzZSBIaWdoTGV2ZWxSZXNvbHV0aW9uT3Bjb2RlLlJlc29sdmVDb21wb25lbnRPckhlbHBlcjpcbiAgICAgICAgcmV0dXJuIHJlc29sdmVDb21wb25lbnRPckhlbHBlcihyZXNvbHZlciwgY29uc3RhbnRzLCBtZXRhLCBvcCk7XG4gICAgICBjYXNlIEhpZ2hMZXZlbFJlc29sdXRpb25PcGNvZGUuUmVzb2x2ZU9wdGlvbmFsSGVscGVyOlxuICAgICAgICByZXR1cm4gcmVzb2x2ZU9wdGlvbmFsSGVscGVyKHJlc29sdmVyLCBjb25zdGFudHMsIG1ldGEsIG9wKTtcbiAgICAgIGNhc2UgSGlnaExldmVsUmVzb2x1dGlvbk9wY29kZS5SZXNvbHZlT3B0aW9uYWxDb21wb25lbnRPckhlbHBlcjpcbiAgICAgICAgcmV0dXJuIHJlc29sdmVPcHRpb25hbENvbXBvbmVudE9ySGVscGVyKHJlc29sdmVyLCBjb25zdGFudHMsIG1ldGEsIG9wKTtcblxuICAgICAgY2FzZSBIaWdoTGV2ZWxSZXNvbHV0aW9uT3Bjb2RlLlJlc29sdmVMb2NhbDpcbiAgICAgICAgbGV0IGZyZWVWYXIgPSBvcFsxXTtcbiAgICAgICAgbGV0IG5hbWUgPSBleHBlY3QobWV0YS51cHZhcnMsICdCVUc6IGF0dGVtcHRlZCB0byByZXNvbHZlIHZhbHVlIGJ1dCBubyB1cHZhcnMgZm91bmQnKVtcbiAgICAgICAgICBmcmVlVmFyXG4gICAgICAgIF07XG5cbiAgICAgICAgbGV0IGFuZFRoZW4gPSBvcFsyXTtcblxuICAgICAgICBhbmRUaGVuKG5hbWUsIG1ldGEubW9kdWxlTmFtZSk7XG5cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgSGlnaExldmVsUmVzb2x1dGlvbk9wY29kZS5SZXNvbHZlVGVtcGxhdGVMb2NhbDpcbiAgICAgICAgbGV0IFssIHZhbHVlSW5kZXgsIHRoZW5dID0gb3A7XG4gICAgICAgIGxldCB2YWx1ZSA9IGV4cGVjdChcbiAgICAgICAgICBtZXRhLnNjb3BlVmFsdWVzLFxuICAgICAgICAgICdCVUc6IEF0dGVtcHRlZCB0byBnZWN0IGEgdGVtcGxhdGUgbG9jYWwsIGJ1dCB0ZW1wbGF0ZSBkb2VzIG5vdCBoYXZlIGFueSdcbiAgICAgICAgKVt2YWx1ZUluZGV4XTtcblxuICAgICAgICB0aGVuKGNvbnN0YW50cy52YWx1ZSh2YWx1ZSkpO1xuXG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEhpZ2hMZXZlbFJlc29sdXRpb25PcGNvZGUuUmVzb2x2ZUZyZWU6XG4gICAgICAgIGlmIChERUJVRykge1xuICAgICAgICAgIGxldCBbLCB1cHZhckluZGV4XSA9IG9wO1xuICAgICAgICAgIGxldCBmcmVlTmFtZSA9IGV4cGVjdChtZXRhLnVwdmFycywgJ0JVRzogYXR0ZW1wdGVkIHRvIHJlc29sdmUgdmFsdWUgYnV0IG5vIHVwdmFycyBmb3VuZCcpW1xuICAgICAgICAgICAgdXB2YXJJbmRleFxuICAgICAgICAgIF07XG5cbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgQXR0ZW1wdGVkIHRvIHJlc29sdmUgYSB2YWx1ZSBpbiBhIHN0cmljdCBtb2RlIHRlbXBsYXRlLCBidXQgdGhhdCB2YWx1ZSB3YXMgbm90IGluIHNjb3BlOiAke2ZyZWVOYW1lfWBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgaGlnaCBsZXZlbCBvcGNvZGUgJHtvcFswXX1gKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEVuY29kZXJJbXBsIGltcGxlbWVudHMgRW5jb2RlciB7XG4gIHByaXZhdGUgbGFiZWxzU3RhY2sgPSBuZXcgU3RhY2s8TGFiZWxzPigpO1xuICBwcml2YXRlIGVuY29kZXI6IEluc3RydWN0aW9uRW5jb2RlciA9IG5ldyBJbnN0cnVjdGlvbkVuY29kZXJJbXBsKFtdKTtcbiAgcHJpdmF0ZSBlcnJvcnM6IEVuY29kZXJFcnJvcltdID0gW107XG4gIHByaXZhdGUgaGFuZGxlOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBoZWFwOiBDb21waWxlVGltZUhlYXAsXG4gICAgcHJpdmF0ZSBtZXRhOiBDb250YWluaW5nTWV0YWRhdGEsXG4gICAgcHJpdmF0ZSBzdGRsaWI/OiBTVERMaWJcbiAgKSB7XG4gICAgdGhpcy5oYW5kbGUgPSBoZWFwLm1hbGxvYygpO1xuICB9XG5cbiAgZXJyb3IoZXJyb3I6IEVuY29kZXJFcnJvcik6IHZvaWQge1xuICAgIHRoaXMuZW5jb2Rlci5lbmNvZGUoT3AuUHJpbWl0aXZlLCAwKTtcbiAgICB0aGlzLmVycm9ycy5wdXNoKGVycm9yKTtcbiAgfVxuXG4gIGNvbW1pdChzaXplOiBudW1iZXIpOiBIYW5kbGVSZXN1bHQge1xuICAgIGxldCBoYW5kbGUgPSB0aGlzLmhhbmRsZTtcblxuICAgIHRoaXMuaGVhcC5wdXNoKE1hY2hpbmVPcC5SZXR1cm4gfCBPcGNvZGVTaXplLk1BQ0hJTkVfTUFTSyk7XG4gICAgdGhpcy5oZWFwLmZpbmlzaE1hbGxvYyhoYW5kbGUsIHNpemUpO1xuXG4gICAgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHsgZXJyb3JzOiB0aGlzLmVycm9ycywgaGFuZGxlIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBoYW5kbGU7XG4gICAgfVxuICB9XG5cbiAgcHVzaChcbiAgICBjb25zdGFudHM6IENvbXBpbGVUaW1lQ29uc3RhbnRzLFxuICAgIHR5cGU6IEJ1aWxkZXJPcGNvZGUsXG4gICAgLi4uYXJnczogU2luZ2xlQnVpbGRlck9wZXJhbmRbXVxuICApOiB2b2lkIHtcbiAgICBsZXQgeyBoZWFwIH0gPSB0aGlzO1xuXG4gICAgaWYgKERFQlVHICYmICh0eXBlIGFzIG51bWJlcikgPiBPcGNvZGVTaXplLlRZUEVfU0laRSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcGNvZGUgdHlwZSBvdmVyIDgtYml0cy4gR290ICR7dHlwZX0uYCk7XG4gICAgfVxuXG4gICAgbGV0IG1hY2hpbmUgPSBpc01hY2hpbmVPcCh0eXBlKSA/IE9wY29kZVNpemUuTUFDSElORV9NQVNLIDogMDtcbiAgICBsZXQgZmlyc3QgPSB0eXBlIHwgbWFjaGluZSB8IChhcmdzLmxlbmd0aCA8PCBPcGNvZGVTaXplLkFSR19TSElGVCk7XG5cbiAgICBoZWFwLnB1c2goZmlyc3QpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgb3AgPSBhcmdzW2ldO1xuICAgICAgaGVhcC5wdXNoKHRoaXMub3BlcmFuZChjb25zdGFudHMsIG9wKSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvcGVyYW5kKGNvbnN0YW50czogQ29tcGlsZVRpbWVDb25zdGFudHMsIG9wZXJhbmQ6IFNpbmdsZUJ1aWxkZXJPcGVyYW5kKTogT3BlcmFuZCB7XG4gICAgaWYgKHR5cGVvZiBvcGVyYW5kID09PSAnbnVtYmVyJykge1xuICAgICAgcmV0dXJuIG9wZXJhbmQ7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBvcGVyYW5kID09PSAnb2JqZWN0JyAmJiBvcGVyYW5kICE9PSBudWxsKSB7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShvcGVyYW5kKSkge1xuICAgICAgICByZXR1cm4gZW5jb2RlSGFuZGxlKGNvbnN0YW50cy5hcnJheShvcGVyYW5kKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzd2l0Y2ggKG9wZXJhbmQudHlwZSkge1xuICAgICAgICAgIGNhc2UgSGlnaExldmVsT3BlcmFuZC5MYWJlbDpcbiAgICAgICAgICAgIHRoaXMuY3VycmVudExhYmVscy50YXJnZXQodGhpcy5oZWFwLm9mZnNldCwgb3BlcmFuZC52YWx1ZSk7XG4gICAgICAgICAgICByZXR1cm4gLTE7XG5cbiAgICAgICAgICBjYXNlIEhpZ2hMZXZlbE9wZXJhbmQuSXNTdHJpY3RNb2RlOlxuICAgICAgICAgICAgcmV0dXJuIGVuY29kZUhhbmRsZShjb25zdGFudHMudmFsdWUodGhpcy5tZXRhLmlzU3RyaWN0TW9kZSkpO1xuXG4gICAgICAgICAgY2FzZSBIaWdoTGV2ZWxPcGVyYW5kLkV2YWxTeW1ib2xzOlxuICAgICAgICAgICAgcmV0dXJuIGVuY29kZUhhbmRsZShjb25zdGFudHMuYXJyYXkodGhpcy5tZXRhLmV2YWxTeW1ib2xzIHx8IEVNUFRZX1NUUklOR19BUlJBWSkpO1xuXG4gICAgICAgICAgY2FzZSBIaWdoTGV2ZWxPcGVyYW5kLkJsb2NrOlxuICAgICAgICAgICAgcmV0dXJuIGVuY29kZUhhbmRsZShjb25zdGFudHMudmFsdWUoY29tcGlsYWJsZUJsb2NrKG9wZXJhbmQudmFsdWUsIHRoaXMubWV0YSkpKTtcblxuICAgICAgICAgIGNhc2UgSGlnaExldmVsT3BlcmFuZC5TdGRMaWI6XG4gICAgICAgICAgICByZXR1cm4gZXhwZWN0KFxuICAgICAgICAgICAgICB0aGlzLnN0ZGxpYixcbiAgICAgICAgICAgICAgJ2F0dGVtcHRlZCB0byBlbmNvZGUgYSBzdGRsaWIgb3BlcmFuZCwgYnV0IHRoZSBlbmNvZGVyIGRpZCBub3QgaGF2ZSBhIHN0ZGxpYi4gQXJlIHlvdSBjdXJyZW50bHkgYnVpbGRpbmcgdGhlIHN0ZGxpYj8nXG4gICAgICAgICAgICApW29wZXJhbmQudmFsdWVdO1xuXG4gICAgICAgICAgY2FzZSBIaWdoTGV2ZWxPcGVyYW5kLk5vblNtYWxsSW50OlxuICAgICAgICAgIGNhc2UgSGlnaExldmVsT3BlcmFuZC5TeW1ib2xUYWJsZTpcbiAgICAgICAgICBjYXNlIEhpZ2hMZXZlbE9wZXJhbmQuTGF5b3V0OlxuICAgICAgICAgICAgcmV0dXJuIGNvbnN0YW50cy52YWx1ZShvcGVyYW5kLnZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBlbmNvZGVIYW5kbGUoY29uc3RhbnRzLnZhbHVlKG9wZXJhbmQpKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGN1cnJlbnRMYWJlbHMoKTogTGFiZWxzIHtcbiAgICByZXR1cm4gZXhwZWN0KHRoaXMubGFiZWxzU3RhY2suY3VycmVudCwgJ2J1Zzogbm90IGluIGEgbGFiZWwgc3RhY2snKTtcbiAgfVxuXG4gIGxhYmVsKG5hbWU6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudExhYmVscy5sYWJlbChuYW1lLCB0aGlzLmhlYXAub2Zmc2V0ICsgMSk7XG4gIH1cblxuICBzdGFydExhYmVscygpIHtcbiAgICB0aGlzLmxhYmVsc1N0YWNrLnB1c2gobmV3IExhYmVscygpKTtcbiAgfVxuXG4gIHN0b3BMYWJlbHMoKSB7XG4gICAgbGV0IGxhYmVsID0gZXhwZWN0KHRoaXMubGFiZWxzU3RhY2sucG9wKCksICd1bmJhbGFuY2VkIHB1c2ggYW5kIHBvcCBsYWJlbHMnKTtcbiAgICBsYWJlbC5wYXRjaCh0aGlzLmhlYXApO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzQnVpbGRlck9wY29kZShvcDogbnVtYmVyKTogb3AgaXMgQnVpbGRlck9wY29kZSB7XG4gIHJldHVybiBvcCA8IEhpZ2hMZXZlbEJ1aWxkZXJPcGNvZGUuU3RhcnQ7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9