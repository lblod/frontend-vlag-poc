"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.associateDestroyableChild = associateDestroyableChild;
exports.registerDestructor = registerDestructor;
exports.unregisterDestructor = unregisterDestructor;
exports.destroy = destroy;
exports.destroyChildren = destroyChildren;
exports._hasDestroyableChildren = _hasDestroyableChildren;
exports.isDestroying = isDestroying;
exports.isDestroyed = isDestroyed;
exports.assertDestroyablesDestroyed = exports.enableDestroyableTracking = void 0;

var _env = require("@glimmer/env");

var _util = require("@glimmer/util");

var _globalContext = require("@glimmer/global-context");

var DESTROYABLE_META = new WeakMap();

function push(collection, newItem) {
  if (collection === null) {
    return newItem;
  } else if (Array.isArray(collection)) {
    collection.push(newItem);
    return collection;
  } else {
    return [collection, newItem];
  }
}

function iterate(collection, fn) {
  if (Array.isArray(collection)) {
    for (var i = 0; i < collection.length; i++) {
      fn(collection[i]);
    }
  } else if (collection !== null) {
    fn(collection);
  }
}

function remove(collection, item, message) {
  if (_env.DEBUG) {
    var collectionIsItem = collection === item;
    var collectionContainsItem = Array.isArray(collection) && collection.indexOf(item) !== -1;

    if (!collectionIsItem && !collectionContainsItem) {
      throw new Error(String(message));
    }
  }

  if (Array.isArray(collection) && collection.length > 1) {
    var index = collection.indexOf(item);
    collection.splice(index, 1);
    return collection;
  } else {
    return null;
  }
}

function getDestroyableMeta(destroyable) {
  var meta = DESTROYABLE_META.get(destroyable);

  if (meta === undefined) {
    meta = {
      parents: null,
      children: null,
      eagerDestructors: null,
      destructors: null,
      state: 0
      /* Live */

    };

    if (_env.DEBUG) {
      meta.source = destroyable;
    }

    DESTROYABLE_META.set(destroyable, meta);
  }

  return meta;
}

function associateDestroyableChild(parent, child) {
  if (_env.DEBUG && isDestroying(parent)) {
    throw new Error('Attempted to associate a destroyable child with an object that is already destroying or destroyed');
  }

  var parentMeta = getDestroyableMeta(parent);
  var childMeta = getDestroyableMeta(child);
  parentMeta.children = push(parentMeta.children, child);
  childMeta.parents = push(childMeta.parents, parent);
  return child;
}

function registerDestructor(destroyable, destructor, eager) {
  if (eager === void 0) {
    eager = false;
  }

  if (_env.DEBUG && isDestroying(destroyable)) {
    throw new Error('Attempted to register a destructor with an object that is already destroying or destroyed');
  }

  var meta = getDestroyableMeta(destroyable);
  var destructorsKey = eager === true ? 'eagerDestructors' : 'destructors';
  meta[destructorsKey] = push(meta[destructorsKey], destructor);
  return destructor;
}

function unregisterDestructor(destroyable, destructor, eager) {
  if (eager === void 0) {
    eager = false;
  }

  if (_env.DEBUG && isDestroying(destroyable)) {
    throw new Error('Attempted to unregister a destructor with an object that is already destroying or destroyed');
  }

  var meta = getDestroyableMeta(destroyable);
  var destructorsKey = eager === true ? 'eagerDestructors' : 'destructors';
  meta[destructorsKey] = remove(meta[destructorsKey], destructor, _env.DEBUG && 'attempted to remove a destructor that was not registered with the destroyable');
} ////////////


function destroy(destroyable) {
  var meta = getDestroyableMeta(destroyable);
  if (meta.state >= 1
  /* Destroying */
  ) return;
  var parents = meta.parents,
      children = meta.children,
      eagerDestructors = meta.eagerDestructors,
      destructors = meta.destructors;
  meta.state = 1
  /* Destroying */
  ;
  iterate(children, destroy);
  iterate(eagerDestructors, function (destructor) {
    return destructor(destroyable);
  });
  iterate(destructors, function (destructor) {
    return (0, _globalContext.scheduleDestroy)(destroyable, destructor);
  });
  (0, _globalContext.scheduleDestroyed)(function () {
    iterate(parents, function (parent) {
      return removeChildFromParent(destroyable, parent);
    });
    meta.state = 2
    /* Destroyed */
    ;
  });
}

function removeChildFromParent(child, parent) {
  var parentMeta = getDestroyableMeta(parent);

  if (parentMeta.state === 0
  /* Live */
  ) {
      parentMeta.children = remove(parentMeta.children, child, _env.DEBUG && "attempted to remove child from parent, but the parent's children did not contain the child. This is likely a bug with destructors.");
    }
}

function destroyChildren(destroyable) {
  var _getDestroyableMeta = getDestroyableMeta(destroyable),
      children = _getDestroyableMeta.children;

  iterate(children, destroy);
}

function _hasDestroyableChildren(destroyable) {
  var meta = DESTROYABLE_META.get(destroyable);
  return meta === undefined ? false : meta.children !== null;
}

function isDestroying(destroyable) {
  var meta = DESTROYABLE_META.get(destroyable);
  return meta === undefined ? false : meta.state >= 1
  /* Destroying */
  ;
}

function isDestroyed(destroyable) {
  var meta = DESTROYABLE_META.get(destroyable);
  return meta === undefined ? false : meta.state >= 2
  /* Destroyed */
  ;
} ////////////


var enableDestroyableTracking;
exports.enableDestroyableTracking = enableDestroyableTracking;
var assertDestroyablesDestroyed;
exports.assertDestroyablesDestroyed = assertDestroyablesDestroyed;

if (_env.DEBUG) {
  var isTesting = false;

  exports.enableDestroyableTracking = enableDestroyableTracking = function enableDestroyableTracking() {
    if (isTesting) {
      // Reset destroyable meta just in case, before throwing the error
      DESTROYABLE_META = new WeakMap();
      throw new Error('Attempted to start destroyable testing, but you did not end the previous destroyable test. Did you forget to call `assertDestroyablesDestroyed()`');
    }

    isTesting = true;
    DESTROYABLE_META = new Map();
  };

  exports.assertDestroyablesDestroyed = assertDestroyablesDestroyed = function assertDestroyablesDestroyed() {
    if (!isTesting) {
      throw new Error('Attempted to assert destroyables destroyed, but you did not start a destroyable test. Did you forget to call `enableDestroyableTracking()`');
    }

    isTesting = false;
    var map = DESTROYABLE_META;
    DESTROYABLE_META = new WeakMap();
    var undestroyed = [];
    map.forEach(function (meta) {
      if (meta.state !== 2
      /* Destroyed */
      ) {
          undestroyed.push(meta.source);
        }
    });

    if (undestroyed.length > 0) {
      var objectsToString = undestroyed.map(_util.debugToString).join('\n    ');
      var error = new Error("Some destroyables were not destroyed during this test:\n    " + objectsToString);
      error.destroyables = undestroyed;
      throw error;
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2Rlc3Ryb3lhYmxlL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBOztBQUNBOztBQXVCQSxJQUFJLGdCQUFnQixHQUVxQyxJQUZ6RCxPQUV5RCxFQUZ6RDs7QUFJQSxTQUFBLElBQUEsQ0FBQSxVQUFBLEVBQUEsT0FBQSxFQUFvRTtBQUNsRSxNQUFJLFVBQVUsS0FBZCxJQUFBLEVBQXlCO0FBQ3ZCLFdBQUEsT0FBQTtBQURGLEdBQUEsTUFFTyxJQUFJLEtBQUssQ0FBTCxPQUFBLENBQUosVUFBSSxDQUFKLEVBQStCO0FBQ3BDLElBQUEsVUFBVSxDQUFWLElBQUEsQ0FBQSxPQUFBO0FBQ0EsV0FBQSxVQUFBO0FBRkssR0FBQSxNQUdBO0FBQ0wsV0FBTyxDQUFBLFVBQUEsRUFBUCxPQUFPLENBQVA7QUFDRDtBQUNGOztBQUVELFNBQUEsT0FBQSxDQUFBLFVBQUEsRUFBQSxFQUFBLEVBQWtGO0FBQ2hGLE1BQUksS0FBSyxDQUFMLE9BQUEsQ0FBSixVQUFJLENBQUosRUFBK0I7QUFDN0IsU0FBSyxJQUFJLENBQUMsR0FBVixDQUFBLEVBQWdCLENBQUMsR0FBRyxVQUFVLENBQTlCLE1BQUEsRUFBdUMsQ0FBdkMsRUFBQSxFQUE0QztBQUMxQyxNQUFBLEVBQUUsQ0FBQyxVQUFVLENBQWIsQ0FBYSxDQUFYLENBQUY7QUFDRDtBQUhILEdBQUEsTUFJTyxJQUFJLFVBQVUsS0FBZCxJQUFBLEVBQXlCO0FBQzlCLElBQUEsRUFBRSxDQUFGLFVBQUUsQ0FBRjtBQUNEO0FBQ0Y7O0FBRUQsU0FBQSxNQUFBLENBQUEsVUFBQSxFQUFBLElBQUEsRUFBQSxPQUFBLEVBQTRGO0FBQzFGLE1BQUEsVUFBQSxFQUFXO0FBQ1QsUUFBSSxnQkFBZ0IsR0FBRyxVQUFVLEtBQWpDLElBQUE7QUFDQSxRQUFJLHNCQUFzQixHQUFHLEtBQUssQ0FBTCxPQUFBLENBQUEsVUFBQSxLQUE2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LEtBQUssQ0FBTCxZQUFBLEdBQUEsV0FBQTtBQUVBLFlBQUEsS0FBQTtBQUNEO0FBN0JILEdBQUE7QUErQkQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBERUJVRyB9IGZyb20gJ0BnbGltbWVyL2Vudic7XG5pbXBvcnQgeyBEZXN0cm95YWJsZSwgRGVzdHJ1Y3RvciB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgZGVidWdUb1N0cmluZyB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgc2NoZWR1bGVEZXN0cm95LCBzY2hlZHVsZURlc3Ryb3llZCB9IGZyb20gJ0BnbGltbWVyL2dsb2JhbC1jb250ZXh0JztcblxuY29uc3QgZW51bSBEZXN0cm95aW5nU3RhdGUge1xuICBMaXZlID0gMCxcbiAgRGVzdHJveWluZyA9IDEsXG4gIERlc3Ryb3llZCA9IDIsXG59XG5cbnR5cGUgT25lT3JNYW55PFQ+ID0gbnVsbCB8IFQgfCBUW107XG5cbmludGVyZmFjZSBEZXN0cm95YWJsZU1ldGE8VCBleHRlbmRzIERlc3Ryb3lhYmxlPiB7XG4gIHNvdXJjZT86IFQ7XG4gIHBhcmVudHM6IE9uZU9yTWFueTxEZXN0cm95YWJsZT47XG4gIGNoaWxkcmVuOiBPbmVPck1hbnk8RGVzdHJveWFibGU+O1xuICBlYWdlckRlc3RydWN0b3JzOiBPbmVPck1hbnk8RGVzdHJ1Y3RvcjxUPj47XG4gIGRlc3RydWN0b3JzOiBPbmVPck1hbnk8RGVzdHJ1Y3RvcjxUPj47XG4gIHN0YXRlOiBEZXN0cm95aW5nU3RhdGU7XG59XG5cbmludGVyZmFjZSBVbmRlc3Ryb3llZERlc3Ryb3lhYmxlc0Vycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBkZXN0cm95YWJsZXM6IG9iamVjdFtdO1xufVxuXG5sZXQgREVTVFJPWUFCTEVfTUVUQTpcbiAgfCBNYXA8RGVzdHJveWFibGUsIERlc3Ryb3lhYmxlTWV0YTxEZXN0cm95YWJsZT4+XG4gIHwgV2Vha01hcDxEZXN0cm95YWJsZSwgRGVzdHJveWFibGVNZXRhPERlc3Ryb3lhYmxlPj4gPSBuZXcgV2Vha01hcCgpO1xuXG5mdW5jdGlvbiBwdXNoPFQgZXh0ZW5kcyBvYmplY3Q+KGNvbGxlY3Rpb246IE9uZU9yTWFueTxUPiwgbmV3SXRlbTogVCk6IE9uZU9yTWFueTxUPiB7XG4gIGlmIChjb2xsZWN0aW9uID09PSBudWxsKSB7XG4gICAgcmV0dXJuIG5ld0l0ZW07XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShjb2xsZWN0aW9uKSkge1xuICAgIGNvbGxlY3Rpb24ucHVzaChuZXdJdGVtKTtcbiAgICByZXR1cm4gY29sbGVjdGlvbjtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gW2NvbGxlY3Rpb24sIG5ld0l0ZW1dO1xuICB9XG59XG5cbmZ1bmN0aW9uIGl0ZXJhdGU8VCBleHRlbmRzIG9iamVjdD4oY29sbGVjdGlvbjogT25lT3JNYW55PFQ+LCBmbjogKGl0ZW06IFQpID0+IHZvaWQpIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkoY29sbGVjdGlvbikpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbGxlY3Rpb24ubGVuZ3RoOyBpKyspIHtcbiAgICAgIGZuKGNvbGxlY3Rpb25baV0pO1xuICAgIH1cbiAgfSBlbHNlIGlmIChjb2xsZWN0aW9uICE9PSBudWxsKSB7XG4gICAgZm4oY29sbGVjdGlvbik7XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlPFQgZXh0ZW5kcyBvYmplY3Q+KGNvbGxlY3Rpb246IE9uZU9yTWFueTxUPiwgaXRlbTogVCwgbWVzc2FnZTogc3RyaW5nIHwgZmFsc2UpIHtcbiAgaWYgKERFQlVHKSB7XG4gICAgbGV0IGNvbGxlY3Rpb25Jc0l0ZW0gPSBjb2xsZWN0aW9uID09PSBpdGVtO1xuICAgIGxldCBjb2xsZWN0aW9uQ29udGFpbnNJdGVtID0gQXJyYXkuaXNBcnJheShjb2xsZWN0aW9uKSAmJiBjb2xsZWN0aW9uLmluZGV4T2YoaXRlbSkgIT09IC0xO1xuXG4gICAgaWYgKCFjb2xsZWN0aW9uSXNJdGVtICYmICFjb2xsZWN0aW9uQ29udGFpbnNJdGVtKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoU3RyaW5nKG1lc3NhZ2UpKTtcbiAgICB9XG4gIH1cblxuICBpZiAoQXJyYXkuaXNBcnJheShjb2xsZWN0aW9uKSAmJiBjb2xsZWN0aW9uLmxlbmd0aCA+IDEpIHtcbiAgICBsZXQgaW5kZXggPSBjb2xsZWN0aW9uIS5pbmRleE9mKGl0ZW0pO1xuICAgIGNvbGxlY3Rpb24hLnNwbGljZShpbmRleCwgMSk7XG4gICAgcmV0dXJuIGNvbGxlY3Rpb247XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0RGVzdHJveWFibGVNZXRhPFQgZXh0ZW5kcyBEZXN0cm95YWJsZT4oZGVzdHJveWFibGU6IFQpOiBEZXN0cm95YWJsZU1ldGE8VD4ge1xuICBsZXQgbWV0YSA9IERFU1RST1lBQkxFX01FVEEuZ2V0KGRlc3Ryb3lhYmxlKTtcblxuICBpZiAobWV0YSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgbWV0YSA9IHtcbiAgICAgIHBhcmVudHM6IG51bGwsXG4gICAgICBjaGlsZHJlbjogbnVsbCxcbiAgICAgIGVhZ2VyRGVzdHJ1Y3RvcnM6IG51bGwsXG4gICAgICBkZXN0cnVjdG9yczogbnVsbCxcbiAgICAgIHN0YXRlOiBEZXN0cm95aW5nU3RhdGUuTGl2ZSxcbiAgICB9O1xuXG4gICAgaWYgKERFQlVHKSB7XG4gICAgICBtZXRhLnNvdXJjZSA9IGRlc3Ryb3lhYmxlIGFzIG9iamVjdDtcbiAgICB9XG5cbiAgICBERVNUUk9ZQUJMRV9NRVRBLnNldChkZXN0cm95YWJsZSwgbWV0YSk7XG4gIH1cblxuICByZXR1cm4gKG1ldGEgYXMgdW5rbm93bikgYXMgRGVzdHJveWFibGVNZXRhPFQ+O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXNzb2NpYXRlRGVzdHJveWFibGVDaGlsZDxUIGV4dGVuZHMgRGVzdHJveWFibGU+KHBhcmVudDogRGVzdHJveWFibGUsIGNoaWxkOiBUKTogVCB7XG4gIGlmIChERUJVRyAmJiBpc0Rlc3Ryb3lpbmcocGFyZW50KSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdBdHRlbXB0ZWQgdG8gYXNzb2NpYXRlIGEgZGVzdHJveWFibGUgY2hpbGQgd2l0aCBhbiBvYmplY3QgdGhhdCBpcyBhbHJlYWR5IGRlc3Ryb3lpbmcgb3IgZGVzdHJveWVkJ1xuICAgICk7XG4gIH1cblxuICBsZXQgcGFyZW50TWV0YSA9IGdldERlc3Ryb3lhYmxlTWV0YShwYXJlbnQpO1xuICBsZXQgY2hpbGRNZXRhID0gZ2V0RGVzdHJveWFibGVNZXRhKGNoaWxkKTtcblxuICBwYXJlbnRNZXRhLmNoaWxkcmVuID0gcHVzaChwYXJlbnRNZXRhLmNoaWxkcmVuLCBjaGlsZCk7XG4gIGNoaWxkTWV0YS5wYXJlbnRzID0gcHVzaChjaGlsZE1ldGEucGFyZW50cywgcGFyZW50KTtcblxuICByZXR1cm4gY2hpbGQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWdpc3RlckRlc3RydWN0b3I8VCBleHRlbmRzIERlc3Ryb3lhYmxlPihcbiAgZGVzdHJveWFibGU6IFQsXG4gIGRlc3RydWN0b3I6IERlc3RydWN0b3I8VD4sXG4gIGVhZ2VyID0gZmFsc2Vcbik6IERlc3RydWN0b3I8VD4ge1xuICBpZiAoREVCVUcgJiYgaXNEZXN0cm95aW5nKGRlc3Ryb3lhYmxlKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdBdHRlbXB0ZWQgdG8gcmVnaXN0ZXIgYSBkZXN0cnVjdG9yIHdpdGggYW4gb2JqZWN0IHRoYXQgaXMgYWxyZWFkeSBkZXN0cm95aW5nIG9yIGRlc3Ryb3llZCdcbiAgICApO1xuICB9XG5cbiAgbGV0IG1ldGEgPSBnZXREZXN0cm95YWJsZU1ldGEoZGVzdHJveWFibGUpO1xuXG4gIGxldCBkZXN0cnVjdG9yc0tleTogJ2VhZ2VyRGVzdHJ1Y3RvcnMnIHwgJ2Rlc3RydWN0b3JzJyA9XG4gICAgZWFnZXIgPT09IHRydWUgPyAnZWFnZXJEZXN0cnVjdG9ycycgOiAnZGVzdHJ1Y3RvcnMnO1xuXG4gIG1ldGFbZGVzdHJ1Y3RvcnNLZXldID0gcHVzaChtZXRhW2Rlc3RydWN0b3JzS2V5XSwgZGVzdHJ1Y3Rvcik7XG5cbiAgcmV0dXJuIGRlc3RydWN0b3I7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1bnJlZ2lzdGVyRGVzdHJ1Y3RvcjxUIGV4dGVuZHMgRGVzdHJveWFibGU+KFxuICBkZXN0cm95YWJsZTogVCxcbiAgZGVzdHJ1Y3RvcjogRGVzdHJ1Y3RvcjxUPixcbiAgZWFnZXIgPSBmYWxzZVxuKTogdm9pZCB7XG4gIGlmIChERUJVRyAmJiBpc0Rlc3Ryb3lpbmcoZGVzdHJveWFibGUpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgJ0F0dGVtcHRlZCB0byB1bnJlZ2lzdGVyIGEgZGVzdHJ1Y3RvciB3aXRoIGFuIG9iamVjdCB0aGF0IGlzIGFscmVhZHkgZGVzdHJveWluZyBvciBkZXN0cm95ZWQnXG4gICAgKTtcbiAgfVxuXG4gIGxldCBtZXRhID0gZ2V0RGVzdHJveWFibGVNZXRhKGRlc3Ryb3lhYmxlKTtcblxuICBsZXQgZGVzdHJ1Y3RvcnNLZXk6ICdlYWdlckRlc3RydWN0b3JzJyB8ICdkZXN0cnVjdG9ycycgPVxuICAgIGVhZ2VyID09PSB0cnVlID8gJ2VhZ2VyRGVzdHJ1Y3RvcnMnIDogJ2Rlc3RydWN0b3JzJztcblxuICBtZXRhW2Rlc3RydWN0b3JzS2V5XSA9IHJlbW92ZShcbiAgICBtZXRhW2Rlc3RydWN0b3JzS2V5XSxcbiAgICBkZXN0cnVjdG9yLFxuICAgIERFQlVHICYmICdhdHRlbXB0ZWQgdG8gcmVtb3ZlIGEgZGVzdHJ1Y3RvciB0aGF0IHdhcyBub3QgcmVnaXN0ZXJlZCB3aXRoIHRoZSBkZXN0cm95YWJsZSdcbiAgKTtcbn1cblxuLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBmdW5jdGlvbiBkZXN0cm95KGRlc3Ryb3lhYmxlOiBEZXN0cm95YWJsZSkge1xuICBsZXQgbWV0YSA9IGdldERlc3Ryb3lhYmxlTWV0YShkZXN0cm95YWJsZSk7XG5cbiAgaWYgKG1ldGEuc3RhdGUgPj0gRGVzdHJveWluZ1N0YXRlLkRlc3Ryb3lpbmcpIHJldHVybjtcblxuICBsZXQgeyBwYXJlbnRzLCBjaGlsZHJlbiwgZWFnZXJEZXN0cnVjdG9ycywgZGVzdHJ1Y3RvcnMgfSA9IG1ldGE7XG5cbiAgbWV0YS5zdGF0ZSA9IERlc3Ryb3lpbmdTdGF0ZS5EZXN0cm95aW5nO1xuXG4gIGl0ZXJhdGUoY2hpbGRyZW4sIGRlc3Ryb3kpO1xuICBpdGVyYXRlKGVhZ2VyRGVzdHJ1Y3RvcnMsIChkZXN0cnVjdG9yKSA9PiBkZXN0cnVjdG9yKGRlc3Ryb3lhYmxlKSk7XG4gIGl0ZXJhdGUoZGVzdHJ1Y3RvcnMsIChkZXN0cnVjdG9yKSA9PiBzY2hlZHVsZURlc3Ryb3koZGVzdHJveWFibGUsIGRlc3RydWN0b3IpKTtcblxuICBzY2hlZHVsZURlc3Ryb3llZCgoKSA9PiB7XG4gICAgaXRlcmF0ZShwYXJlbnRzLCAocGFyZW50KSA9PiByZW1vdmVDaGlsZEZyb21QYXJlbnQoZGVzdHJveWFibGUsIHBhcmVudCkpO1xuXG4gICAgbWV0YS5zdGF0ZSA9IERlc3Ryb3lpbmdTdGF0ZS5EZXN0cm95ZWQ7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiByZW1vdmVDaGlsZEZyb21QYXJlbnQoY2hpbGQ6IERlc3Ryb3lhYmxlLCBwYXJlbnQ6IERlc3Ryb3lhYmxlKSB7XG4gIGxldCBwYXJlbnRNZXRhID0gZ2V0RGVzdHJveWFibGVNZXRhKHBhcmVudCk7XG5cbiAgaWYgKHBhcmVudE1ldGEuc3RhdGUgPT09IERlc3Ryb3lpbmdTdGF0ZS5MaXZlKSB7XG4gICAgcGFyZW50TWV0YS5jaGlsZHJlbiA9IHJlbW92ZShcbiAgICAgIHBhcmVudE1ldGEuY2hpbGRyZW4sXG4gICAgICBjaGlsZCxcbiAgICAgIERFQlVHICYmXG4gICAgICAgIFwiYXR0ZW1wdGVkIHRvIHJlbW92ZSBjaGlsZCBmcm9tIHBhcmVudCwgYnV0IHRoZSBwYXJlbnQncyBjaGlsZHJlbiBkaWQgbm90IGNvbnRhaW4gdGhlIGNoaWxkLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyB3aXRoIGRlc3RydWN0b3JzLlwiXG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVzdHJveUNoaWxkcmVuKGRlc3Ryb3lhYmxlOiBEZXN0cm95YWJsZSkge1xuICBsZXQgeyBjaGlsZHJlbiB9ID0gZ2V0RGVzdHJveWFibGVNZXRhKGRlc3Ryb3lhYmxlKTtcblxuICBpdGVyYXRlKGNoaWxkcmVuLCBkZXN0cm95KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9oYXNEZXN0cm95YWJsZUNoaWxkcmVuKGRlc3Ryb3lhYmxlOiBEZXN0cm95YWJsZSkge1xuICBsZXQgbWV0YSA9IERFU1RST1lBQkxFX01FVEEuZ2V0KGRlc3Ryb3lhYmxlKTtcblxuICByZXR1cm4gbWV0YSA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBtZXRhLmNoaWxkcmVuICE9PSBudWxsO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNEZXN0cm95aW5nKGRlc3Ryb3lhYmxlOiBEZXN0cm95YWJsZSkge1xuICBsZXQgbWV0YSA9IERFU1RST1lBQkxFX01FVEEuZ2V0KGRlc3Ryb3lhYmxlKTtcblxuICByZXR1cm4gbWV0YSA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBtZXRhLnN0YXRlID49IERlc3Ryb3lpbmdTdGF0ZS5EZXN0cm95aW5nO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNEZXN0cm95ZWQoZGVzdHJveWFibGU6IERlc3Ryb3lhYmxlKSB7XG4gIGxldCBtZXRhID0gREVTVFJPWUFCTEVfTUVUQS5nZXQoZGVzdHJveWFibGUpO1xuXG4gIHJldHVybiBtZXRhID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IG1ldGEuc3RhdGUgPj0gRGVzdHJveWluZ1N0YXRlLkRlc3Ryb3llZDtcbn1cblxuLy8vLy8vLy8vLy8vXG5cbmV4cG9ydCBsZXQgZW5hYmxlRGVzdHJveWFibGVUcmFja2luZzogdW5kZWZpbmVkIHwgKCgpID0+IHZvaWQpO1xuZXhwb3J0IGxldCBhc3NlcnREZXN0cm95YWJsZXNEZXN0cm95ZWQ6IHVuZGVmaW5lZCB8ICgoKSA9PiB2b2lkKTtcblxuaWYgKERFQlVHKSB7XG4gIGxldCBpc1Rlc3RpbmcgPSBmYWxzZTtcblxuICBlbmFibGVEZXN0cm95YWJsZVRyYWNraW5nID0gKCkgPT4ge1xuICAgIGlmIChpc1Rlc3RpbmcpIHtcbiAgICAgIC8vIFJlc2V0IGRlc3Ryb3lhYmxlIG1ldGEganVzdCBpbiBjYXNlLCBiZWZvcmUgdGhyb3dpbmcgdGhlIGVycm9yXG4gICAgICBERVNUUk9ZQUJMRV9NRVRBID0gbmV3IFdlYWtNYXAoKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0F0dGVtcHRlZCB0byBzdGFydCBkZXN0cm95YWJsZSB0ZXN0aW5nLCBidXQgeW91IGRpZCBub3QgZW5kIHRoZSBwcmV2aW91cyBkZXN0cm95YWJsZSB0ZXN0LiBEaWQgeW91IGZvcmdldCB0byBjYWxsIGBhc3NlcnREZXN0cm95YWJsZXNEZXN0cm95ZWQoKWAnXG4gICAgICApO1xuICAgIH1cblxuICAgIGlzVGVzdGluZyA9IHRydWU7XG4gICAgREVTVFJPWUFCTEVfTUVUQSA9IG5ldyBNYXAoKTtcbiAgfTtcblxuICBhc3NlcnREZXN0cm95YWJsZXNEZXN0cm95ZWQgPSAoKSA9PiB7XG4gICAgaWYgKCFpc1Rlc3RpbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0F0dGVtcHRlZCB0byBhc3NlcnQgZGVzdHJveWFibGVzIGRlc3Ryb3llZCwgYnV0IHlvdSBkaWQgbm90IHN0YXJ0IGEgZGVzdHJveWFibGUgdGVzdC4gRGlkIHlvdSBmb3JnZXQgdG8gY2FsbCBgZW5hYmxlRGVzdHJveWFibGVUcmFja2luZygpYCdcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaXNUZXN0aW5nID0gZmFsc2U7XG5cbiAgICBsZXQgbWFwID0gREVTVFJPWUFCTEVfTUVUQSBhcyBNYXA8RGVzdHJveWFibGUsIERlc3Ryb3lhYmxlTWV0YTxEZXN0cm95YWJsZT4+O1xuICAgIERFU1RST1lBQkxFX01FVEEgPSBuZXcgV2Vha01hcCgpO1xuXG4gICAgbGV0IHVuZGVzdHJveWVkOiBvYmplY3RbXSA9IFtdO1xuXG4gICAgbWFwLmZvckVhY2goKG1ldGEpID0+IHtcbiAgICAgIGlmIChtZXRhLnN0YXRlICE9PSBEZXN0cm95aW5nU3RhdGUuRGVzdHJveWVkKSB7XG4gICAgICAgIHVuZGVzdHJveWVkLnB1c2gobWV0YS5zb3VyY2UhKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmICh1bmRlc3Ryb3llZC5sZW5ndGggPiAwKSB7XG4gICAgICBsZXQgb2JqZWN0c1RvU3RyaW5nID0gdW5kZXN0cm95ZWQubWFwKGRlYnVnVG9TdHJpbmchKS5qb2luKCdcXG4gICAgJyk7XG4gICAgICBsZXQgZXJyb3IgPSBuZXcgRXJyb3IoXG4gICAgICAgIGBTb21lIGRlc3Ryb3lhYmxlcyB3ZXJlIG5vdCBkZXN0cm95ZWQgZHVyaW5nIHRoaXMgdGVzdDpcXG4gICAgJHtvYmplY3RzVG9TdHJpbmd9YFxuICAgICAgKSBhcyBVbmRlc3Ryb3llZERlc3Ryb3lhYmxlc0Vycm9yO1xuXG4gICAgICBlcnJvci5kZXN0cm95YWJsZXMgPSB1bmRlc3Ryb3llZDtcblxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9O1xufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==